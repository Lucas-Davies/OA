V3 - Picker

<!DOCTYPE html>
<html lang="en-AU">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="color-scheme" content="dark" />
<title>Media Picker â€” FAOA</title>
<style>
:root{
  --ink:#eef3ff; --ink-dim:#cfd3e1; --muted:rgba(238,243,255,.78);
  --bg:#000; --panel:#0a0c10; --stroke:rgba(255,255,255,.18);
  --blue:#0A84FF; --green:#32d74b; --red:#ff3b30; --amber:#ff9f0a;
  --chip:#1b1f2a; --shadow:0 10px 30px rgba(0,0,0,.5);
  --r:14px; --gap:12px; --maxw:1240px; --nav-h:64px; --btn-h:40px;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font:16px/1.45 -apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,Segoe UI,Roboto,Helvetica,Arial;
}
.wrap{ max-width:var(--maxw); margin:0 auto; padding:0 16px 24px }

/* ==== Top bar (matches Home feel) ==== */
.nav{
  position:sticky; top:0; z-index:1000;
  background:linear-gradient(180deg,rgba(0,0,0,.9),rgba(0,0,0,.55) 60%,rgba(0,0,0,.3));
  -webkit-backdrop-filter:blur(12px); backdrop-filter:blur(12px);
  border-bottom:1px solid var(--stroke);
}
.nav-inner{ display:flex; align-items:center; gap:10px; padding:10px 4px; min-height:var(--nav-h); }
.title{ font-weight:900; letter-spacing:.3px; margin-right:auto; padding:0 8px; }

.search{
  display:flex; align-items:center; gap:8px; padding:0 10px;
  border:1px solid var(--stroke); border-radius:12px; height:var(--btn-h);
  background:rgba(255,255,255,.03); min-width:220px; flex:1 1 320px;
}
.search input{ background:transparent; border:0; outline:0; color:var(--ink); width:100%; font-size:14px; }
.btn{
  height:var(--btn-h); border-radius:12px; border:1px solid var(--stroke);
  background:#141821; color:#e7eaf0; display:inline-flex; align-items:center; gap:8px;
  padding:0 12px; cursor:pointer; user-select:none; font-weight:800;
}
.btn.primary{ background:var(--blue); color:#fff; border-color:transparent }
.btn[disabled]{ opacity:.6; cursor:not-allowed }

/* ==== Grid (uniform cropped like iOS Photos) ==== */
.grid{ display:grid; gap:8px; margin:12px 0 16px;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
.card{
  position:relative; border-radius:12px; overflow:hidden; background:#0b0d10; border:1px solid var(--stroke);
  cursor:pointer;
}
.thumb{ width:100%; aspect-ratio:1/1; background:#000; }
.thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

/* No overlays on thumbs â€” clean gallery */
.meta{ display:none }

/* Selection outline (double-click / long-press) */
.card.sel{ outline:3px solid var(--blue); outline-offset:-3px; }

/* ==== Footer ==== */
.footer{
  position:sticky; bottom:0; z-index:1000;
  background:linear-gradient(0deg, rgba(0,0,0,.72), rgba(0,0,0,.35) 60%, transparent);
  border-top:1px solid var(--stroke);
}
.footer-inner{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 4px; }
.count{ color:var(--ink-dim); font-size:14px }

/* ==== Preview Sheet ==== */
.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1500 }
.modal.open{ display:flex }
.backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.6) }
.sheet{
  position:relative; width:min(980px,96vw); max-height:92vh; background:var(--panel); border:1px solid var(--stroke);
  border-radius:18px; overflow:hidden; box-shadow:var(--shadow); display:grid; grid-template-rows:auto 1fr auto;
}
.bar{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-bottom:1px solid var(--stroke) }
.view{ position:relative; background:#000; display:grid; place-items:center; overflow:auto }
.view img{ max-width:100%; max-height:100%; }
.controls{ display:flex; gap:8px; align-items:center; justify-content:space-between; padding:10px 12px; border-top:1px solid var(--stroke) }
.controls .left{ display:flex; gap:8px; align-items:center }
.controls .right{ display:flex; gap:8px; align-items:center }

/* ==== Toast ==== */
.toast{
  position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
  background:#0c1610; color:#79ffa0; border:1px solid #1e3a22; border-radius:12px;
  padding:10px 14px; font-weight:800; z-index:2000; box-shadow:var(--shadow);
  display:none;
}
.toast.show{ display:block }
</style>
</head>
<body>
  <div class="nav">
    <div class="wrap nav-inner">
      <div class="title">Media Picker</div>
      <div class="search" role="search">
        <span style="opacity:.85">ðŸ”Ž</span>
        <input id="q" type="search" placeholder="Search nameâ€¦" autocomplete="off" />
      </div>
      <button id="applyBtn" class="btn primary" disabled>Apply Image</button>
    </div>
  </div>

  <div class="wrap">
    <div id="grid" class="grid" aria-live="polite"></div>
  </div>

  <div class="footer">
    <div class="wrap footer-inner">
      <div class="count" id="count">0 items â€¢ 0 selected</div>
      <div style="display:flex; gap:8px">
        <button id="cancelBtn" class="btn">Cancel</button>
        <button id="applyBtn2" class="btn primary" disabled>Apply Image</button>
      </div>
    </div>
  </div>

  <!-- Preview -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-label="Preview">
    <div class="backdrop" data-close></div>
    <div class="sheet">
      <div class="bar">
        <button class="btn" id="prevBtn">â—€ï¸Ž Previous</button>
        <div id="pvName" style="font-weight:900">Preview</div>
        <button class="btn" id="nextBtn">Next â–¶ï¸Ž</button>
      </div>
      <div class="view"><img id="pvImg" alt=""></div>
      <div class="controls">
        <div class="left">
          <button class="btn" id="selectFromPreview">Select</button>
          <a class="btn" id="openNew" target="_blank" rel="noreferrer noopener">Open</a>
        </div>
        <div class="right">
          <button class="btn primary" id="applyFromPreview">Apply Image</button>
          <button class="btn" data-close>Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Applied âœ“</div>

<script>
(function(){
  /** ===== Config & Parent Communication ===== */
  const params = new URL(location.href).searchParams;
  let openerOrigin = params.get('origin') || '*';
  const DEFAULT_BASE = '/OA/images/'; // <-- current repo location

  /** @typedef {{url:string,name?:string,type?:string,size?:number,mtime?:number}} MediaItem */
  let items = [];      // full list
  let view = [];       // filtered list
  const selected = new Set(); // urls
  let currentIndex = -1;

  // Elements
  const els = {
    grid: g('grid'), q: g('q'), count: g('count'),
    applyBtn: g('applyBtn'), applyBtn2: g('applyBtn2'),
    cancelBtn: g('cancelBtn'),
    modal: g('modal'), pvImg: g('pvImg'), pvName: g('pvName'),
    prevBtn: g('prevBtn'), nextBtn: g('nextBtn'),
    selectFromPreview: g('selectFromPreview'),
    applyFromPreview: g('applyFromPreview'),
    openNew: g('openNew'),
    toast: g('toast')
  };

  function g(id){ return document.getElementById(id); }
  const fmt = n=>`${n} item${n!==1?'s':''}`;

  /** ===== Rendering ===== */
  function render(){
    const q = els.q.value.trim().toLowerCase();
    view = items.filter(it=>!q || (it.name||'').toLowerCase().includes(q));
    els.grid.innerHTML = '';
    const frag = document.createDocumentFragment();
    for(const it of view){
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.url = it.url;
      card.dataset.name = it.name;
      const t = document.createElement('div');
      t.className = 'thumb';
      const img = document.createElement('img');
      img.loading = 'lazy'; img.src = it.url; img.alt = it.name||'';
      t.appendChild(img);
      card.appendChild(t);
      if(selected.has(it.url)) card.classList.add('sel');
      frag.appendChild(card);
    }
    els.grid.appendChild(frag);
    updateFooter();
  }
  function updateFooter(){
    const total = view.length, sel = selected.size;
    els.count.textContent = `${fmt(total)} â€¢ ${sel} selected`;
    els.applyBtn.disabled = sel===0;
    els.applyBtn2.disabled = sel===0;
    els.applyFromPreview.disabled = sel===0 && currentIndex<0;
  }

  /** ===== Interactions ===== */
  // Single click => open preview
  els.grid.addEventListener('click', e=>{
    const card = e.target.closest('.card'); if(!card) return;
    const idx = view.findIndex(i=>i.url===card.dataset.url);
    openPreview(idx);
  });

  // Double click / long press => toggle select
  let tapTimer=null;
  els.grid.addEventListener('dblclick', e=>{
    const card = e.target.closest('.card'); if(!card) return;
    toggleSelect(card.dataset.url); render();
  });
  els.grid.addEventListener('touchstart', e=>{
    const card = e.target.closest('.card'); if(!card) return;
    clearTimeout(tapTimer);
    tapTimer = setTimeout(()=>{ toggleSelect(card.dataset.url); render(); }, 350);
  }, {passive:true});
  els.grid.addEventListener('touchend', ()=>{ clearTimeout(tapTimer); }, {passive:true});

  function toggleSelect(url){
    if(selected.has(url)) selected.delete(url); else selected.add(url);
  }

  // Preview navigation & actions
  function openPreview(idx){
    if(idx<0 || idx>=view.length) return;
    currentIndex = idx;
    const it = view[idx];
    els.pvImg.src = it.url; els.pvImg.alt = it.name||'';
    els.pvName.textContent = it.name||'';
    els.openNew.href = it.url;
    els.modal.classList.add('open');
    updateFooter();
  }
  function closePreview(){ els.modal.classList.remove('open'); }
  els.modal.addEventListener('click', e=>{ if(e.target.hasAttribute('data-close')) closePreview(); });
  els.prevBtn.addEventListener('click', ()=>{ if(currentIndex>0) openPreview(currentIndex-1); });
  els.nextBtn.addEventListener('click', ()=>{ if(currentIndex<view.length-1) openPreview(currentIndex+1); });
  els.selectFromPreview.addEventListener('click', ()=>{
    const it = view[currentIndex]; if(!it) return;
    toggleSelect(it.url); render();
  });

  // Search
  els.q.addEventListener('input', render);

  /** ===== Apply Image (single "Apply Image" action) ===== */
  function applyImage(){
    // Choose the first selected or current preview item
    let chosen = null;
    if(selected.size>0){
      const firstUrl = [...selected][0];
      chosen = items.find(i=>i.url===firstUrl);
    }else if(currentIndex>=0){
      chosen = view[currentIndex];
    }
    if(!chosen) return;

    // Normalize to current repo path (/OA/images/filename)
    const fileName = (chosen.name || chosen.url.split('/').pop() || '').replace(/^\/+/, '');
    const normalized = DEFAULT_BASE + fileName;

    const msg = { type:'content-picker:select', payload:{ url: normalized } };
    try{ if (window.parent !== window) window.parent.postMessage(msg, openerOrigin); }catch{}
    try{ if (window.opener) window.opener.postMessage(msg, openerOrigin); }catch{}

    showToast('Applied âœ“');

    // Give user a beat to see the confirmation, then close
    setTimeout(()=>{
      try{ if (window.parent !== window) window.parent.postMessage({type:'content-picker:close'}, openerOrigin); }catch{}
      try{ if (window.opener) window.opener.postMessage({type:'content-picker:close'}, openerOrigin); }catch{}
      // optional: window.close();
    }, 500);
  }
  els.applyBtn.addEventListener('click', applyImage);
  els.applyBtn2.addEventListener('click', applyImage);
  els.applyFromPreview.addEventListener('click', applyImage);
  els.cancelBtn.addEventListener('click', ()=>{
    try{ if (window.parent !== window) window.parent.postMessage({type:'content-picker:close'}, openerOrigin); }catch{}
    try{ if (window.opener) window.opener.postMessage({type:'content-picker:close'}, openerOrigin); }catch{}
  });

  /** ===== Data loading =====
   * Accepts:
   *  1) ?manifest= URL -> JSON array or {items:[]}
   *  2) window.__MEDIA__ = []
   *  3) postMessage {type:'media-picker:init', items:[...]}
   */
  async function tryLoad(){
    const manifest = params.get('manifest');
    if(manifest){
      try{
        const res = await fetch(manifest, {cache:'no-store'});
        const data = await res.json();
        if(Array.isArray(data)) setItems(data);
        else if(Array.isArray(data.items)) setItems(data.items);
        else setItems([]);
        return;
      }catch{ setItems([]); }
    }
    if(Array.isArray(window.__MEDIA__)){ setItems(window.__MEDIA__); return; }
    // else wait for postMessage
  }
  function setItems(arr){
    items = sanitize(arr);
    selected.clear();
    render();
  }
  function sanitize(arr){
    return (arr||[]).map(it=>{
      const o = {...it};
      if(!o.name) o.name = (o.url||'').split('/').pop() || 'file';
      if(!o.url) o.url = DEFAULT_BASE + o.name;
      return o;
    });
  }

  /** ===== Messaging ===== */
  window.addEventListener('message', (e)=>{
    const d = e.data;
    if(!d || typeof d!=='object') return;
    if(d.type==='media-picker:init'){
      if(Array.isArray(d.items)) setItems(d.items);
      if(d.origin) openerOrigin = d.origin;
    }
    if(d.type==='media-picker:set-selection'){
      selected.clear();
      (d.urls||[]).forEach(u=>selected.add(u));
      render();
    }
  });

  /** ===== Toast ===== */
  function showToast(text){
    els.toast.textContent = text || 'Done';
    els.toast.classList.add('show');
    setTimeout(()=>els.toast.classList.remove('show'), 1400);
  }

  tryLoad();
})();
</script>
</body>
</html>