<!DOCTYPE html>
<html lang="en-AU">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="color-scheme" content="dark" />
<title>Media Picker ‚Äî FAOA</title>
<style>
/* ===== FAOA-ish design tokens (aligned to your Home.html look) ===== */
:root{
  --ink:#eef3ff; --ink-dim:#cfd3e1; --muted:rgba(238,243,255,.78);
  --bg:#000; --panel:#0a0c10; --stroke:rgba(255,255,255,.18);
  --blue:#0A84FF; --green:#32d74b; --red:#ff3b30; --amber:#ff9f0a;
  --chip:#1b1f2a;
  --gap:12px; --r:14px; --maxw:1240px; --nav-h:64px;
  --btn-h:40px; --chip-h:32px;
  --shadow:0 8px 28px rgba(0,0,0,.45);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font:16px/1.45 -apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
}
.wrap{ max-width:var(--maxw); margin:0 auto; padding:0 16px 24px }

/* ===== Top bar ===== */
.nav{
  position:sticky; top:0; z-index:10;
  backdrop-filter:saturate(180%) blur(12px);
  background:linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.35) 60%, transparent);
  border-bottom:1px solid var(--stroke);
}
.nav-inner{
  display:flex; align-items:center; gap:10px; padding:10px 4px; min-height:var(--nav-h);
}
.title{ font-weight:900; letter-spacing:.3px; margin-right:auto; padding:0 8px; }

/* Filters row */
.filters{ display:flex; align-items:center; gap:8px; padding:8px 4px 12px }
.btn, .chip, .seg input+label{
  height:var(--btn-h); border-radius:12px; border:1px solid var(--stroke);
  background:transparent; color:var(--ink); display:inline-flex; align-items:center; gap:8px;
  padding:0 12px; cursor:pointer; user-select:none;
}
.btn.primary{ background:var(--blue); color:#fff; border-color:transparent }
.btn[disabled]{ opacity:.6; cursor:not-allowed }
.chip{ height:var(--chip-h); opacity:.9; }
.icon{ font-style:normal; font-weight:700; width:1.1em; text-align:center }

.search{
  display:flex; align-items:center; gap:8px; padding:0 10px;
  border:1px solid var(--stroke); border-radius:12px; height:var(--btn-h);
  background:rgba(255,255,255,.03); min-width:220px; flex:1 1 320px;
}
.search input{
  background:transparent; border:0; outline:0; color:var(--ink);
  width:100%; font-size:14px;
}
.select{ position:relative; }
.select select{
  appearance:none; background:transparent; color:var(--ink);
  border:1px solid var(--stroke); border-radius:12px; height:var(--btn-h); padding:0 36px 0 12px;
}
.select:after{ content:"‚ñæ"; position:absolute; right:10px; top:0; height:var(--btn-h); display:grid; place-items:center; color:var(--ink-dim) }

.seg{ display:flex; gap:6px }
.seg input{ position:absolute; opacity:0; pointer-events:none }
.seg input+label{
  height:var(--chip-h); font-size:13px; background:var(--chip);
}
.seg input:checked+label{ background:var(--blue); border-color:transparent; color:#fff }

/* ===== Grid ===== */
.grid{
  display:grid; gap:10px; margin-top:12px;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
}
.card{
  position:relative; border:1px solid var(--stroke); border-radius:14px; overflow:hidden; background:var(--panel);
}
.thumb{ position:relative; width:100%; padding-top:70%; overflow:hidden; background:rgba(255,255,255,.03) }
.thumb img, .thumb video, .thumb iframe{
  position:absolute; inset:0; width:100%; height:100%; object-fit:cover; background:#000;
}
.badge{
  position:absolute; top:8px; left:8px; height:26px; padding:0 8px; border-radius:999px;
  display:inline-flex; align-items:center; gap:6px; font-size:12px;
  color:#fff; background:rgba(0,0,0,.5); backdrop-filter:blur(8px);
}
.type{ text-transform:uppercase; font-weight:700; letter-spacing:.3px; font-size:11px; opacity:.9 }
.dim{ font-size:11px; opacity:.9 }
.actions{
  position:absolute; right:6px; bottom:6px; display:flex; gap:6px;
}
.icon-btn{
  border:none; background:rgba(0,0,0,.6); color:#fff; width:36px; height:36px; border-radius:10px;
  display:inline-grid; place-items:center; cursor:pointer;
}
.icon-btn:hover{ background:rgba(0,0,0,.75) }
.meta{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px }
.meta .name{ font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:70% }
.meta .dim{ color:var(--ink-dim) }

/* ===== Footer bar ===== */
.footer{
  position:sticky; bottom:0; z-index:10; margin-top:14px;
  background:linear-gradient(0deg, rgba(0,0,0,.72), rgba(0,0,0,.35) 60%, transparent);
  border-top:1px solid var(--stroke);
}
.footer-inner{
  display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 4px;
}
.count{ color:var(--ink-dim); font-size:14px }

/* ===== Modal (quick preview) ===== */
.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50 }
.modal.open{ display:flex }
.backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.6) }
.sheet{
  position:relative; width:min(980px,96vw); max-height:92vh; background:var(--panel); border:1px solid var(--stroke);
  border-radius:18px; overflow:hidden; box-shadow:var(--shadow); display:grid; grid-template-rows:auto 1fr auto;
}
.bar{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-bottom:1px solid var(--stroke) }
.view{ position:relative; background:#000; display:grid; place-items:center; overflow:auto }
.view img, .view video{ max-width:100%; max-height:100% }
.controls{ display:flex; gap:8px; align-items:center; padding:10px 12px; border-top:1px solid var(--stroke) }
.hidden{ display:none !important }
.kbd{ font:12px ui-monospace,SFMono-Regular,Consolas,monospace; background:rgba(127,127,127,.2); padding:0 6px; border-radius:6px }
</style>
</head>
<body>
  <div class="nav">
    <div class="wrap nav-inner">
      <div class="title">Media Picker</div>

      <div class="seg" role="tablist" aria-label="Media type filter">
        <input type="radio" name="kind" id="k-all" value="all" checked>
        <label for="k-all">All</label>
        <input type="radio" name="kind" id="k-img" value="image">
        <label for="k-img">Images</label>
        <input type="radio" name="kind" id="k-vid" value="video">
        <label for="k-vid">Videos</label>
        <input type="radio" name="kind" id="k-aud" value="audio">
        <label for="k-aud">Audio</label>
        <input type="radio" name="kind" id="k-doc" value="doc">
        <label for="k-doc">Docs</label>
      </div>

      <div class="search" role="search">
        <i class="icon">üîé</i>
        <input id="q" type="search" placeholder="Search name/type‚Ä¶" autocomplete="off" />
      </div>

      <div class="select" title="Sort">
        <select id="sort">
          <option value="name-asc">Name (A ‚Üí Z)</option>
          <option value="name-desc">Name (Z ‚Üí A)</option>
          <option value="date-desc" selected>Newest</option>
          <option value="date-asc">Oldest</option>
          <option value="size-desc">Largest</option>
          <option value="size-asc">Smallest</option>
        </select>
      </div>

      <button id="clearSel" class="btn" disabled><i class="icon">‚úï</i>Clear</button>
      <button id="useBtn" class="btn primary" disabled><i class="icon">‚úÖ</i>Use Selected</button>
    </div>

    <div class="wrap filters">
      <span class="chip" id="hint">Feed items via manifest param, window.__MEDIA__, or postMessage init.</span>
    </div>
  </div>

  <div class="wrap">
    <div id="grid" class="grid" aria-live="polite"></div>
  </div>

  <div class="footer">
    <div class="wrap footer-inner">
      <div class="count" id="count">0 items ‚Ä¢ 0 selected</div>
      <div style="display:flex; gap:8px">
        <button id="cancelBtn" class="btn"><i class="icon">‚¨ÖÔ∏é</i>Cancel</button>
        <button id="confirmBtn" class="btn primary" disabled><i class="icon">‚úÖ</i>Use Selected</button>
      </div>
    </div>
  </div>

  <!-- Quick preview -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-label="Preview">
    <div class="backdrop" data-close></div>
    <div class="sheet">
      <div class="bar">
        <div id="pvName" style="font-weight:700">Preview</div>
        <div style="display:flex; gap:8px">
          <button class="btn" id="openNew"><i class="icon">‚ÜóÔ∏é</i>Open</button>
          <button class="btn" data-close><i class="icon">‚úï</i>Close</button>
        </div>
      </div>
      <div class="view" id="pvView"></div>
      <div class="controls">
        <span class="kbd">Space</span><span>to play/pause videos ‚Ä¢</span>
        <span class="kbd">Esc</span><span>to close</span>
      </div>
    </div>
  </div>

<script>
(function(){
  /** @typedef {{url:string,name:string,type:string,size?:number,mtime?:number,poster?:string}} MediaItem */
  const els = {
    grid: document.getElementById('grid'),
    count: document.getElementById('count'),
    q: document.getElementById('q'),
    sort: document.getElementById('sort'),
    useBtn: document.getElementById('useBtn'),
    confirmBtn: document.getElementById('confirmBtn'),
    clearSel: document.getElementById('clearSel'),
    cancelBtn: document.getElementById('cancelBtn'),
    hint: document.getElementById('hint'),
    modal: document.getElementById('modal'),
    pvName: document.getElementById('pvName'),
    pvView: document.getElementById('pvView'),
    openNew: document.getElementById('openNew'),
  };
  const filters = [...document.querySelectorAll('input[name="kind"]')];

  /** @type {MediaItem[]} */
  let items = [];
  let view = [];       // filtered + sorted view
  const selected = new Set(); // urls
  let openerOrigin = '*'; // origin to postMessage back to (parent sets this optionally)

  // ========= Helpers =========
  const fmtBytes = n=>{
    if(!n && n!==0) return '';
    if(n<1024) return n+' B';
    if(n<1024*1024) return (n/1024).toFixed(1)+' KB';
    return (n/1024/1024).toFixed(1)+' MB';
  };
  function kindOf(type){
    if(!type) return 'doc';
    if(type.startsWith('image/')) return 'image';
    if(type.startsWith('video/')) return 'video';
    if(type.startsWith('audio/')) return 'audio';
    // treat pdf/zip/others as docs
    return 'doc';
  }
  function bySort(a,b,mode){
    switch(mode){
      case 'name-asc':  return a.name.localeCompare(b.name);
      case 'name-desc': return b.name.localeCompare(a.name);
      case 'size-asc':  return (a.size||0)-(b.size||0);
      case 'size-desc': return (b.size||0)-(a.size||0);
      case 'date-asc':  return (a.mtime||0)-(b.mtime||0);
      case 'date-desc': default: return (b.mtime||0)-(a.mtime||0);
    }
  }

  // ========= Rendering =========
  function render(){
    const q = els.q.value.trim().toLowerCase();
    const k = (filters.find(f=>f.checked)?.value)||'all';
    const s = els.sort.value;

    view = items
      .filter(it=>{
        const okKind = (k==='all') || kindOf(it.type)===k;
        const text = (it.name+' '+it.type).toLowerCase();
        const okText = !q || text.includes(q);
        return okKind && okText;
      })
      .sort((a,b)=>bySort(a,b,s));

    els.grid.innerHTML = '';
    const frag = document.createDocumentFragment();
    for(const it of view){
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.url = it.url;

      const t = document.createElement('div');
      t.className = 'thumb';

      const k = kindOf(it.type);
      if(k==='image'){
        const img = document.createElement('img');
        img.loading = 'lazy';
        img.src = it.url;
        img.alt = it.name;
        t.appendChild(img);
      }else if(k==='video'){
        const v = document.createElement('video');
        v.muted = true; v.preload = 'metadata'; v.playsInline = true;
        if(it.poster) v.poster = it.poster;
        const s = document.createElement('source');
        s.src = it.url; s.type = it.type || 'video/mp4';
        v.appendChild(s);
        t.appendChild(v);
      }else if(k==='audio'){
        // simple icon plate for audio
        const plate = document.createElement('div');
        plate.style = 'position:absolute;inset:0;display:grid;place-items:center;background:linear-gradient(180deg,#111,#000)';
        plate.innerHTML = '<div style="font-size:42px">üéµ</div>';
        t.appendChild(plate);
      }else{
        const plate = document.createElement('div');
        plate.style = 'position:absolute;inset:0;display:grid;place-items:center;background:linear-gradient(180deg,#111,#000)';
        plate.innerHTML = '<div style="font-size:38px">üìÑ</div>';
        t.appendChild(plate);
      }

      const badge = document.createElement('div');
      badge.className = 'badge';
      badge.innerHTML = `
        <span class="type">${kindOf(it.type)}</span>
        <span class="dim">${fmtBytes(it.size)}</span>
      `;
      t.appendChild(badge);

      const acts = document.createElement('div');
      acts.className = 'actions';
      acts.innerHTML = `
        <button class="icon-btn" data-act="preview" title="Preview">üîç</button>
        <button class="icon-btn" data-act="toggle" title="Select / Deselect">${selected.has(it.url)?'‚úÖ':'Ôºã'}</button>
      `;
      t.appendChild(acts);

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `
        <div class="name" title="${it.name}">${it.name}</div>
        <div class="dim">${it.type?.split('/')[1]||'file'}</div>
      `;

      card.appendChild(t);
      card.appendChild(meta);
      frag.appendChild(card);
    }
    els.grid.appendChild(frag);

    const selCount = selected.size;
    els.useBtn.disabled = selCount===0;
    els.confirmBtn.disabled = selCount===0;
    els.clearSel.disabled = selCount===0;
    els.count.textContent = `${view.length} item${view.length!==1?'s':''} ‚Ä¢ ${selCount} selected`;
  }

  // ========= Events =========
  els.q.addEventListener('input', render);
  els.sort.addEventListener('change', render);
  filters.forEach(f=>f.addEventListener('change', render));

  els.grid.addEventListener('click', e=>{
    const btn = e.target.closest('button');
    const card = e.target.closest('.card');
    if(!card) return;
    const url = card.dataset.url;
    const it = items.find(x=>x.url===url);
    if(!it) return;

    if(btn){
      const act = btn.dataset.act;
      if(act==='preview'){ openPreview(it); return; }
      if(act==='toggle'){
        if(selected.has(url)) selected.delete(url); else selected.add(url);
        btn.textContent = selected.has(url) ? '‚úÖ' : 'Ôºã';
        render();
        return;
      }
    }else{
      // click card toggles selection
      if(selected.has(url)) selected.delete(url); else selected.add(url);
      render();
    }
  });

  els.clearSel.addEventListener('click', ()=>{
    selected.clear(); render();
  });

  function submitSelection(){
    const chosen = items.filter(i=>selected.has(i.url));
    const payload = {
      type:'media-picker:submit',
      items: chosen
    };
    // send to parent (iframe) and also to opener if popped
    try{ window.parent !== window && window.parent.postMessage(payload, openerOrigin); }catch(_){}
    try{ window.opener && window.opener.postMessage(payload, openerOrigin); }catch(_){}
  }

  els.useBtn.addEventListener('click', submitSelection);
  els.confirmBtn.addEventListener('click', submitSelection);
  els.cancelBtn.addEventListener('click', ()=>{
    const payload = { type:'media-picker:cancel' };
    try{ window.parent !== window && window.parent.postMessage(payload, openerOrigin); }catch(_){}
    try{ window.opener && window.opener.postMessage(payload, openerOrigin); }catch(_){}
    // optional: window.close();
  });

  // ========= Preview =========
  const modal = els.modal;
  const pv = els.pvView;
  function openPreview(it){
    pv.innerHTML = '';
    els.pvName.textContent = it.name;
    const k = kindOf(it.type);
    if(k==='image'){
      const img = document.createElement('img');
      img.src = it.url; img.alt = it.name; pv.appendChild(img);
    }else if(k==='video'){
      const v = document.createElement('video');
      v.controls = true; v.playsInline = true;
      if(it.poster) v.poster = it.poster;
      const s = document.createElement('source');
      s.src = it.url; s.type = it.type || 'video/mp4';
      v.appendChild(s);
      pv.appendChild(v);
    }else if(k==='audio'){
      const a = document.createElement('audio');
      a.controls = true;
      const s = document.createElement('source');
      s.src = it.url; s.type = it.type || 'audio/mpeg';
      a.appendChild(s);
      pv.appendChild(a);
    }else{
      const div = document.createElement('div');
      div.style='padding:20px';
      div.innerHTML = `<div style="opacity:.8">No inline preview for this file type.</div>
      <div style="margin-top:8px"><a href="${it.url}" target="_blank" rel="noreferrer noopener">Open in new tab</a></div>`;
      pv.appendChild(div);
    }
    els.openNew.onclick = ()=>{ window.open(it.url, '_blank', 'noopener'); };
    modal.classList.add('open');
  }
  function closePreview(){ modal.classList.remove('open'); }
  modal.addEventListener('click', e=>{ if(e.target.hasAttribute('data-close')) closePreview(); });
  document.addEventListener('keydown', e=>{
    if(!modal.classList.contains('open')) return;
    if(e.key==='Escape') closePreview();
    const vid = pv.querySelector('video');
    if(vid && e.code==='Space'){ e.preventDefault(); vid.paused ? vid.play() : vid.pause(); }
  });

  // ========= Data loading =========
  async function tryLoad(){
    // 1) manifest param
    const params = new URL(location.href).searchParams;
    const manifest = params.get('manifest');
    const originParam = params.get('origin');
    if(originParam) openerOrigin = originParam;

    if(manifest){
      try{
        const res = await fetch(manifest, {cache:'no-store'});
        const data = await res.json();
        if(Array.isArray(data)) setItems(data);
        else if(Array.isArray(data.items)) setItems(data.items);
        else showHint('Manifest did not contain an array. Expected: [{"url","name","type",...}]');
        return;
      }catch(err){
        showHint('Failed to fetch manifest: '+err);
      }
    }

    // 2) window.__MEDIA__
    if(Array.isArray(window.__MEDIA__)){ setItems(window.__MEDIA__); return; }

    // 3) wait for postMessage init (parent can send later)
    showHint('Waiting for parent to post init items‚Ä¶');
  }

  function setItems(arr){
    items = sanitize(arr);
    if(items.length===0) showHint('No media found. Check your manifest/init payload.');
    else hideHint();
    selected.clear();
    render();
  }

  function sanitize(arr){
    return arr.map(it=>{
      const o = {...it};
      if(!o.name) o.name = o.url.split('/').pop() || 'file';
      if(!o.type){
        const ext = (o.name.split('.').pop()||'').toLowerCase();
        const map = {
          jpg:'image/jpeg', jpeg:'image/jpeg', png:'image/png', webp:'image/webp', gif:'image/gif',
          mp4:'video/mp4', webm:'video/webm', mov:'video/quicktime', m4v:'video/mp4',
          mp3:'audio/mpeg', wav:'audio/wav', m4a:'audio/mp4',
          pdf:'application/pdf'
        };
        o.type = map[ext] || 'application/octet-stream';
      }
      if(typeof o.mtime!=='number') o.mtime = Date.now();
      return o;
    });
  }

  function showHint(msg){ els.hint.textContent = msg; els.hint.classList.remove('hidden'); }
  function hideHint(){ els.hint.classList.add('hidden'); }

  // ========= Messaging protocol =========
  window.addEventListener('message', (e)=>{
    const d = e.data;
    if(!d || typeof d!=='object') return;
    if(d.type==='media-picker:init'){
      if(Array.isArray(d.items)) setItems(d.items);
      if(d.origin) openerOrigin = d.origin;
    }
    if(d.type==='media-picker:set-selection'){
      // parent can preselect
      selected.clear();
      (d.urls||[]).forEach(u=>selected.add(u));
      render();
    }
  });

  // Expose basic API for direct scripts (optional)
  window.MediaPicker = {
    setItems, getSelection:()=>items.filter(i=>selected.has(i.url)),
    clearSelection:()=>{ selected.clear(); render(); }
  };

  tryLoad();
})();
</script>
</body>
</html>
