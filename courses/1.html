<!DOCTYPE html>
<html lang="en-AU">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="color-scheme" content="dark" />
<title>30 Birds in 30 Days — FAOA</title>
<style>
/* ===== Design tokens (aligned with Home) ===== */
:root{
  --ink:#eef3ff; --ink-dim:#cfd3e1; --muted:rgba(238,243,255,.78);
  --bg:#000; --stroke:rgba(255,255,255,.18);
  --blue:#0A84FF; --green:#32d74b; --red:#ff3b30; --chip:#1b1f2a;
  --gold:#ffd700; --silver:#c0c7d1; --bronze:#b87333;
  --nav-h:68px; --maxw:1240px;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
  font:16px -apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,sans-serif;
  overflow-x:hidden;}
a{color:inherit;text-decoration:none}
button{cursor:pointer;}

/* ===== Background ===== */
.bg{position:fixed;inset:0;z-index:-2;background:#000;}

/* ===== Top bar ===== */
.nav{
  position:fixed; top:0; left:0; right:0; height:var(--nav-h);
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  padding:8px 12px; z-index:50;
  background:linear-gradient(180deg,rgba(0,0,0,.9),rgba(0,0,0,.55) 60%,rgba(0,0,0,.3));
  -webkit-backdrop-filter:blur(12px); backdrop-filter:blur(12px);
}
.title{font-weight:900; opacity:.92; display:flex; align-items:center; gap:10px}
.small{opacity:.8; font-weight:700; font-size:12px}

/* Avatar pill (reused look) */
.avatarTab{
  display:flex;flex-direction:column;align-items:flex-start;justify-content:center;
  padding:6px 12px;border-radius:12px;min-width:132px;height:44px;
  font-weight:900;line-height:1.1;text-align:left;border:1px solid var(--stroke);
  background:#222;color:#eef3ff;
}
.avatarTab .name{font-size:15px;font-weight:900}
.avatarTab .lvl{font-size:12px;opacity:.95;text-transform:capitalize}

/* ===== Wrap & layout ===== */
.wrap{max-width:var(--maxw); margin:0 auto; padding:calc(var(--nav-h) + env(safe-area-inset-top) + 10px) 14px 120px}

/* ===== Day rail ===== */
.rail{
  display:flex; gap:6px; overflow:auto; padding:10px 2px 6px; margin:2px 0 12px;
}
.daychip{
  min-width:40px; height:36px; border-radius:999px; border:1px solid var(--stroke);
  background:#0f1116; color:var(--ink); font-weight:900;
  display:flex;align-items:center;justify-content:center;
}
.daychip.lock{opacity:.45; pointer-events:none}
.daychip.done{background:#0b2010; border-color:#1d6; box-shadow:inset 0 0 0 1px rgba(50,215,75,.5)}
.daychip.current{outline:2px solid var(--blue);}

/* ===== Config bar (Developer tools) ===== */
.cfgbar{position:sticky; top:var(--nav-h); z-index:49; display:none;
  align-items:center; gap:8px; padding:10px 12px; background:#0d0f14; border-bottom:1px solid var(--stroke)}
.config-on .cfgbar{display:flex}
.cfgbtn{height:34px;padding:0 12px;border-radius:10px;border:1px solid var(--stroke);background:#161922;color:#fff;font-weight:800}
.cfgbtn.blue{background:var(--blue); color:#000; border-color:transparent}

/* ===== Card/content ===== */
.card{
  position:relative; border:1px solid var(--stroke); border-radius:16px; overflow:hidden;
  background:rgba(0,0,0,.35);
}
.card-head{display:flex; flex-wrap:wrap; gap:8px 12px; align-items:center; justify-content:space-between; padding:12px 14px}
.card-title{font-weight:900; font-size:18px}
.badge{height:28px; padding:0 12px; border-radius:999px; border:1px solid var(--stroke); background:var(--chip); color:#fff; font-weight:800; font-size:12px}
.badge.live{background:#0a0}
.badge.off{background:#b00020}
.badge.gold{box-shadow: inset 0 0 0 2px var(--gold)}
.badge.silver{box-shadow: inset 0 0 0 2px var(--silver)}
.badge.bronze{box-shadow: inset 0 0 0 2px var(--bronze)}

.area{display:grid; gap:12px; padding:12px 14px}
@media (min-width:900px){
  .area{grid-template-columns: 1.15fr 1fr;}
}

/* Video area */
.player{position:relative; border:1px solid var(--stroke); border-radius:14px; overflow:hidden; background:#0b0d12; min-height:220px}
.player video{width:100%; height:100%; display:block; background:#000}

/* Summary editable */
.editor{border:1px solid var(--stroke); border-radius:14px; background:#0b0d12; padding:12px}
.editor[contenteditable="true"]{outline:none}
.hint{opacity:.75; font-size:12px}

/* Background preview & controls */
.bgbox{position:relative; border:1px dashed var(--stroke); border-radius:14px; overflow:hidden; background:#0a0c10; min-height:180px}
.bgstage{position:absolute; inset:0; overflow:hidden; touch-action:none; cursor:grab}
.bgimg{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1); will-change:transform; user-select:none; pointer-events:none}
.bgtools{display:flex; gap:8px; align-items:center; padding:8px 10px}

/* Footer nav */
.footnav{display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:12px}
.btn{display:inline-flex;align-items:center;justify-content:center; min-width:120px; height:40px; padding:0 14px; border-radius:12px; border:1px solid var(--stroke); font-weight:900; background:#0f1116; color:var(--ink)}
.btn.blue{background:var(--blue); border-color:transparent; color:#000}
.btn[disabled]{opacity:.45; cursor:not-allowed}

/* ===== Modal (Hero Image Picker) ===== */
.modal{position:fixed; inset:0; z-index:70; display:none; background:rgba(0,0,0,.55); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px)}
.modal.open{display:block}
.modal .panel{position:absolute; inset:auto 12px 12px 12px; top:calc(var(--nav-h) + 8px);
  background:#0f1116; border:1px solid var(--stroke); border-radius:14px; padding:12px; max-height:75vh; display:flex; flex-direction:column; gap:10px}
.hero-frame{position:relative; border:1px dashed var(--stroke); border-radius:14px; overflow:hidden; aspect-ratio: 16/9; background:#080a0f}
.hero-stage{position:absolute; inset:0; overflow:hidden; touch-action:none; cursor:grab}
.hero-img{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1); will-change:transform; user-select:none; pointer-events:none}
.controls{display:flex; gap:8px; align-items:center; justify-content:space-between}

/* ===== Certificate ===== */
.cert{display:grid; gap:12px; padding:12px 14px}
.cert .stamp{font-size:20px; font-weight:900; color:var(--green)}

/* ===== Avatar drawer (simple) ===== */
#avatarMenu{position:absolute; top:calc(var(--nav-h) + 6px); right:12px; width:300px; display:none;
  background:#0f1116; border:1px solid var(--stroke); border-radius:14px; padding:8px; z-index:60}
#avatarMenu.open{display:block}
.menu-list a{display:flex; align-items:center; justify-content:space-between; padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08)}
.menu-list a:last-child{border-bottom:none}

/* Utility */
.hide{display:none !important}
.center{display:grid; place-items:center}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:12px; opacity:.8}
</style>
</head>
<body>

<div class="bg" aria-hidden="true"></div>

<header class="nav" role="navigation" aria-label="Primary">
  <div class="title">
    <span>30 Birds in 30 Days</span>
    <span class="small" id="roleHint"></span>
  </div>
  <div>
    <button id="avatarTab" class="avatarTab" aria-haspopup="dialog" aria-expanded="false">
      <span class="name" id="avatarName">User</span>
      <span class="lvl" id="avatarLvl">Admin</span>
    </button>
  </div>
</header>

<!-- Avatar menu -->
<nav id="avatarMenu" class="menu-list" role="menu">
  <a href="#" id="toggleDev">Developer Mode <span id="devState">Off</span></a>
  <a href="#" id="toggleDir">Director Mode <span id="dirState">Off</span></a>
</nav>

<!-- Config bar -->
<div id="cfgbar" class="cfgbar" aria-hidden="true">
  <button class="cfgbtn" id="jumpDay">Jump to Day…</button>
  <button class="cfgbtn" id="markDone">Mark Day Done</button>
  <button class="cfgbtn" id="resetDay">Reset Day</button>
  <button class="cfgbtn" id="resetCourse">Reset Course</button>
  <button class="cfgbtn blue" id="heroPick">Hero Image Picker</button>
</div>

<main class="wrap">

  <!-- Day rail -->
  <div class="rail" id="dayRail" aria-label="Day navigation"></div>

  <!-- Intro / Day / Certificate mount -->
  <section id="view"></section>

</main>

<!-- Hero Image Picker Modal -->
<div class="modal" id="heroModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="panel">
    <div class="hero-frame" id="heroFrame">
      <div class="hero-stage" id="heroStage"><img id="heroImg" class="hero-img" alt=""></div>
    </div>
    <div class="controls">
      <div>
        <label class="small">Zoom</label>
        <input type="range" id="heroZoom" min="0.5" max="2.5" step="0.01" value="1" />
      </div>
      <div style="display:flex; gap:8px">
        <button class="cfgbtn" id="heroCancel">Cancel</button>
        <button class="cfgbtn blue" id="heroSave">Save to Hero</button>
      </div>
    </div>
    <div class="mono" id="heroMeta"></div>
  </div>
</div>

<script>
(()=>{'use strict';

/* ===== Constants / Keys ===== */
const HERO_ID = 'co-1'; // attach to Hero 1
const K = { profile:'ao_profile', settings:'ao_settings', director:'ao_director_mode', dev:'ao_dev_mode' };

/* ===== Utils / Storage ===== */
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const store = {
  get:(k,f)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):f } catch{ return f } },
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),
  del:k=>localStorage.removeItem(k)
};
const Q = new URLSearchParams(location.search);
if(Q.get('reset')==='1'){ // course-only reset
  const s=store.get(K.settings,{}); if(s?.heroProgress?.[HERO_ID]) delete s.heroProgress[HERO_ID];
  if(s?.heroAssets?.[HERO_ID]) delete s.heroAssets[HERO_ID];
  store.set(K.settings,s);
}

/* Roles */
function getProfile(){ return store.get(K.profile, {displayName:'User', skill:'admin'}) }
function role(){ return (getProfile().skill||'admin').toLowerCase() }
function isAdmin(){ return role()==='admin' }
function isDirector(){ return role()==='director' }
function isSupport(){ return role()==='support' }
function isLearner(){ return ['bronze','silver','gold'].includes(role()) }
function devOn(){ return !!store.get(K.dev,false) }
function setDev(v){ store.set(K.dev,!!v); document.body.classList.toggle('config-on',!!v); $('#cfgbar').setAttribute('aria-hidden', v?'false':'true'); $('#devState').textContent=v?'On':'Off'; }
function dirOn(){ return !!store.get(K.director,false) }
function setDir(v){ store.set(K.director,!!v); $('#dirState').textContent=v?'On':'Off' }

/* Settings shape extension */
function ensureSettings(){
  const s = store.get(K.settings, { heroFlags:{}, heroLabels:{}, pageOrder:[], _seeded:true });
  s.heroProgress = s.heroProgress || {};
  s.heroAssets   = s.heroAssets   || {};
  if(!s.heroProgress[HERO_ID]){
    const days={}; for(let i=1;i<=30;i++){ days[String(i)] = {done:false, completedAt:null, unlockAt: i===1? 0 : null}; }
    s.heroProgress[HERO_ID] = { startedAt:null, complete:false, completedAt:null, days, lastVisited:'intro' };
  }
  if(!s.heroAssets[HERO_ID]){
    const days={}; for(let i=1;i<=30;i++){ days[String(i)] = { videoUrl:null, summary:'', bg:null }; }
    s.heroAssets[HERO_ID] = { days, heroCard:null };
  }
  store.set(K.settings,s); return s;
}
function saveSettings(s){ store.set(K.settings,s) }

/* Midnight unlock calculator (Australia/Sydney intent; uses local time on device) */
function nextLocalMidnight(ts){
  const d = ts? new Date(ts) : new Date();
  const n = new Date(d);
  n.setDate(d.getDate()+1); n.setHours(0,0,0,0);
  return n.getTime();
}

/* ===== UI: Avatar ===== */
function paintAvatar(){
  const p=getProfile();
  $('#avatarName').textContent = p.displayName || 'User';
  const r=role(); $('#avatarLvl').textContent = r.charAt(0).toUpperCase()+r.slice(1);
  const map={bronze:'#b87333',silver:'#c0c7d1',gold:'#ffd700',support:'#6a4cff',director:'#333',admin:'#0A84FF'};
  const pill=$('#avatarTab'); pill.style.background = map[r] || '#222';
  pill.style.color = (r==='gold'||r==='silver'||r==='admin') ? '#0b0c10' : '#eef3ff';
  $('#roleHint').textContent = isLearner() ? 'Learner view (daily lock enforced)' : (isSupport()?'Support (unrestricted)':'Privileged (unrestricted)');
}
paintAvatar();

$('#avatarTab').addEventListener('click', (e)=>{
  e.preventDefault();
  const m=$('#avatarMenu');
  m.classList.toggle('open');
  $('#devState').textContent = devOn()?'On':'Off';
  $('#dirState').textContent = dirOn()?'On':'Off';
});
document.addEventListener('click', (e)=>{
  if(!e.target.closest('#avatarTab') && !e.target.closest('#avatarMenu')) $('#avatarMenu').classList.remove('open');
});
$('#toggleDev').addEventListener('click', e=>{ e.preventDefault(); setDev(!devOn()); paint(); });
$('#toggleDir').addEventListener('click', e=>{ e.preventDefault(); setDir(!dirOn()); paint(); });

/* Initialise modes on load */
setDev(devOn()); setDir(dirOn());

/* ===== Router ===== */
function route(){
  const hash = location.hash.replace(/^#\/?/,'').trim();
  if(!hash) { navTo('intro'); return; }
  render(hash);
}
function navTo(seg){ location.hash = '#/'+seg; }

window.addEventListener('hashchange', route);

/* ===== Day rail ===== */
function buildRail(current){
  const rail = $('#dayRail'); rail.innerHTML='';
  const s = ensureSettings(); const prog = s.heroProgress[HERO_ID];
  for(let i=1;i<=30;i++){
    const d = prog.days[String(i)];
    const chip = document.createElement('button');
    chip.className='daychip';
    chip.textContent=String(i);
    if(String(current)==='day/'+i) chip.classList.add('current');
    if(d.done) chip.classList.add('done');
    const unlocked = !isLearner() || d.unlockAt===0 || (d.unlockAt!=null && Date.now()>=d.unlockAt) || d.done;
    if(!unlocked && isLearner()) chip.classList.add('lock');
    chip.addEventListener('click', ()=>{
      if(unlocked || !isLearner()) navTo('day/'+i);
    });
    rail.appendChild(chip);
  }
}

/* ===== Views ===== */
function render(seg){
  const view=$('#view'); view.innerHTML='';
  const s=ensureSettings(); const assets=s.heroAssets[HERO_ID]; const prog=s.heroProgress[HERO_ID];

  // remember last visited
  prog.lastVisited = seg; saveSettings(s);

  // config bar visibility
  $('#cfgbar').classList.toggle('hide', !devOn());
  $('#cfgbar').setAttribute('aria-hidden', devOn()?'false':'true');

  // Build rail with current
  buildRail(seg);

  if(seg==='intro'){
    view.appendChild(introView());
  }else if(seg==='certificate'){
    view.appendChild(certView());
  }else if(/^day\/\d+$/.test(seg)){
    const day = Number(seg.split('/')[1]);
    view.appendChild(dayView(day, assets, prog));
  }else{
    view.appendChild(errorView());
  }
}

function introView(){
  const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`
    <div class="card-head">
      <div class="card-title">Introduction</div>
      <div>
        ${isLearner()?'<span class="badge">Daily progression</span>':''}
        <span class="badge">3-min video</span>
      </div>
    </div>
    <div class="area">
      <div class="player center"><span class="hint">Upload intro video in Developer Mode</span></div>
      <div class="editor" id="introText" contenteditable="${devOn()}">Welcome to <b>30 Birds in 30 Days</b>. Each day you’ll create one bird study. Learners unlock the next day at local midnight after completing today’s activity.</div>
    </div>
    <div class="footnav">
      <button class="btn" id="goFirst">Start Day 1</button>
      <button class="btn" id="goCert">Certificate</button>
    </div>
  `;
  wrap.querySelector('#goFirst').addEventListener('click',()=>navTo('day/1'));
  wrap.querySelector('#goCert').addEventListener('click',()=>navTo('certificate'));
  return wrap;
}

function dayView(day, assets, prog){
  const id=String(day);
  const state = prog.days[id];
  const unlocked = !isLearner() || state.unlockAt===0 || state.done || (state.unlockAt!=null && Date.now()>=state.unlockAt);
  const nextLockedReason = (!unlocked && isLearner());

  // Guard learners
  if(!unlocked){
    const lock=document.createElement('div'); lock.className='card center';
    const when = state.unlockAt ? new Date(state.unlockAt) : null;
    lock.innerHTML=`<div class="card-head"><div class="card-title">Day ${day}</div></div>
      <div class="area center">
        <div class="hint">Locked until next day${when?` — unlocks ${when.toLocaleString()}`:''}.</div>
        <button class="btn" onclick="location.hash='#/intro'">Back to Intro</button>
      </div>`;
    return lock;
  }

  const media = assets.days[id] || { videoUrl:null, summary:'', bg:null };

  const el=document.createElement('div'); el.className='card';
  el.innerHTML=`
    <div class="card-head">
      <div class="card-title">Day ${day} — Bird Study</div>
      <div>
        ${state.done?'<span class="badge live">Completed</span>':'<span class="badge off">In Progress</span>'}
      </div>
    </div>

    <div class="area">
      <div>
        <div class="player">
          ${media.videoUrl ? `<video id="vid" controls preload="metadata" src="${media.videoUrl}"></video>` : `<div class="center" style="height:220px"><span class="hint">No video yet — upload in Developer/Director Mode</span></div>`}
        </div>
        ${devOn()||dirOn()?`
        <div class="bgtools">
          <label class="small">Upload 3-min video</label>
          <input type="file" id="upVid" accept="video/*">
        </div>`:''}
      </div>

      <div>
        <div class="editor" id="sum" contenteditable="${devOn()||dirOn()}">${escapeHtml(media.summary||defaultSummary(day))}</div>
        ${devOn()||dirOn()?`
        <div class="bgtools">
          <label class="small">Background image</label>
          <input type="file" id="upBg" accept="image/*">
          <button class="btn" id="useHero">Use for Hero</button>
        </div>`:''}
        <div class="bgbox">
          <div class="bgstage" id="bgStage">
            ${media.bg? `<img id="bgImg" class="bgimg" src="${media.bg.src}" style="transform:translate(-50%,-50%) scale(${media.bg.scale||1}); --x:${media.bg.posX||0}; --y:${media.bg.posY||0}">`
            : `<div class="center" style="height:100%"><span class="hint">No background yet</span></div>`}
          </div>
        </div>
      </div>
    </div>

    <div class="footnav">
      <button class="btn" id="prevBtn">${day>1?'Prev':''}</button>
      <div></div>
      <button class="btn blue" id="doneBtn">${state.done?'Completed':'Mark Complete'}</button>
      <button class="btn" id="nextBtn">${day<30?'Next':'Certificate'}</button>
    </div>
  `;

  // Handlers: uploads/editors only in Dev or Director modes
  if(devOn()||dirOn()){
    el.querySelector('#sum')?.addEventListener('blur', ()=>{
      const s=ensureSettings();
      const text = $('#sum').innerText.trim();
      s.heroAssets[HERO_ID].days[id] = s.heroAssets[HERO_ID].days[id] || {};
      s.heroAssets[HERO_ID].days[id].summary = text;
      saveSettings(s);
    });

    el.querySelector('#upVid')?.addEventListener('change', (ev)=>{
      const file=ev.target.files?.[0]; if(!file) return;
      const url = URL.createObjectURL(file);
      const s=ensureSettings();
      s.heroAssets[HERO_ID].days[id] = s.heroAssets[HERO_ID].days[id] || {};
      s.heroAssets[HERO_ID].days[id].videoUrl = url;
      saveSettings(s); paint();
    });

    el.querySelector('#upBg')?.addEventListener('change', (ev)=>{
      const file=ev.target.files?.[0]; if(!file) return;
      const url = URL.createObjectURL(file);
      const s=ensureSettings();
      s.heroAssets[HERO_ID].days[id] = s.heroAssets[HERO_ID].days[id] || {};
      s.heroAssets[HERO_ID].days[id].bg = { src:url, posX:0, posY:0, scale:1 };
      saveSettings(s); paint();
    });

    el.querySelector('#useHero')?.addEventListener('click', ()=>{
      const s=ensureSettings(); const bg=s.heroAssets[HERO_ID].days[id]?.bg;
      if(!bg){ alert('No background image for this day. Upload one first.'); return; }
      openHeroPicker(bg.src);
    });
  }

  // BG drag/zoom (simple) — only when image exists
  const bgStage=el.querySelector('#bgStage'); const img=el.querySelector('#bgImg');
  if(img && (devOn()||dirOn())){
    let scale = (assets.days[id].bg?.scale)||1;
    let pos = {x:(assets.days[id].bg?.posX)||0, y:(assets.days[id].bg?.posY)||0};
    let dragging=false, start={x:0,y:0}, at={x:0,y:0};

    function apply(){ img.style.transform = `translate(calc(-50% + ${pos.x}px), calc(-50% + ${pos.y}px)) scale(${scale})`; }
    apply();

    bgStage.addEventListener('pointerdown', e=>{ dragging=true; at={...pos}; start={x:e.clientX,y:e.clientY}; img.style.cursor='grabbing'; bgStage.setPointerCapture(e.pointerId); });
    bgStage.addEventListener('pointermove', e=>{ if(!dragging) return; pos.x = at.x + (e.clientX - start.x); pos.y = at.y + (e.clientY - start.y); apply(); });
    bgStage.addEventListener('pointerup', e=>{ dragging=false; img.style.cursor='grab'; savePos(); });

    bgStage.addEventListener('wheel', e=>{
      e.preventDefault();
      const delta = (e.deltaY<0)? 0.05 : -0.05;
      scale = Math.min(3, Math.max(0.5, scale+delta));
      apply(); savePos();
    }, {passive:false});

    function savePos(){
      const s=ensureSettings();
      const slot=s.heroAssets[HERO_ID].days[id].bg || {src:img.src};
      slot.posX=pos.x; slot.posY=pos.y; slot.scale=scale;
      s.heroAssets[HERO_ID].days[id].bg = slot;
      saveSettings(s);
    }
  }

  // Prev / Next
  el.querySelector('#prevBtn').addEventListener('click', ()=>{
    if(day>1) navTo('day/'+(day-1));
  });
  el.querySelector('#nextBtn').addEventListener('click', ()=>{
    if(day<30) navTo('day/'+(day+1)); else navTo('certificate');
  });

  // Mark complete
  el.querySelector('#doneBtn').addEventListener('click', ()=>{
    const s=ensureSettings(); const p=s.heroProgress[HERO_ID]; const d=p.days[id];
    if(!d.done){
      d.done=true; d.completedAt=Date.now();
      // unlock next day at next midnight (learners only); privileged users still unrestricted
      const next = String(day+1);
      if(Number(next)<=30){
        const nd = p.days[next];
        nd.unlockAt = nextLocalMidnight(d.completedAt);
      }
      if(p.startedAt==null) p.startedAt = d.completedAt;
      // auto advance
      saveSettings(s); paint();
    }
  });

  return el;
}

function certView(){
  const s=ensureSettings(); const p=s.heroProgress[HERO_ID];
  const allDone = Object.values(p.days).every(d=>d.done);

  const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`
    <div class="card-head">
      <div class="card-title">Certificate of Completion</div>
      <div>${p.complete?'<span class="badge live">Complete</span>': allDone?'<span class="badge">Ready</span>':'<span class="badge off">Incomplete</span>'}</div>
    </div>
    <div class="cert">
      <div class="editor" contenteditable="${devOn()||dirOn()}">I, ${escapeHtml(getProfile().displayName||'Learner')}, confirm I have completed the 30 Birds in 30 Days challenge.</div>
      <div class="mono">Hero: ${HERO_ID} • Days complete: ${Object.values(p.days).filter(d=>d.done).length}/30</div>
      <div class="footnav">
        <button class="btn" onclick="location.hash='#/intro'">Back</button>
        <div></div>
        <button class="btn blue" id="endorseBtn" ${p.complete?'disabled':''}>Endorse Completion</button>
      </div>
      <div class="stamp" id="stampLine">${p.complete?`✔ Endorsed on ${new Date(p.completedAt).toLocaleString()}`:''}</div>
    </div>
  `;
  wrap.querySelector('#endorseBtn').addEventListener('click', ()=>{
    const s=ensureSettings(); const p=s.heroProgress[HERO_ID];
    if(!p.complete){
      p.complete=true; p.completedAt=Date.now();
      saveSettings(s);
      $('#stampLine').textContent = '✔ Endorsed on '+new Date(p.completedAt).toLocaleString();
      // (Optional) also store a hero-level marker the Home page can read
      // e.g., s.heroFlags[HERO_ID] = { ...s.heroFlags[HERO_ID], completed: true }
      // but we avoid mutating your heroFlags schema unless you want it.
      paint();
    }
  });
  return wrap;
}

function errorView(){
  const el=document.createElement('div'); el.className='card center'; el.style.minHeight='220px';
  el.innerHTML=`<div class="hint">Unknown route. <button class="btn" onclick="location.hash='#/intro'">Go to Intro</button></div>`;
  return el;
}

/* ===== Config bar actions ===== */
$('#jumpDay').addEventListener('click', ()=>{
  if(!(devOn()||dirOn())) return;
  const v = prompt('Jump to day (1–30) or "certificate"', '1');
  if(v==null) return;
  if(v.toLowerCase().startsWith('c')) navTo('certificate');
  const n = Number(v);
  if(n>=1 && n<=30) navTo('day/'+n);
});
$('#markDone').addEventListener('click', ()=>{
  if(!(devOn()||dirOn())) return;
  const s=ensureSettings(); const seg=location.hash.replace('#/',''); const m=seg.match(/^day\/(\d+)$/); if(!m){ alert('Open a day first'); return; }
  const day=m[1]; const p=s.heroProgress[HERO_ID].days[day]; if(!p.done){ p.done=true; p.completedAt=Date.now(); }
  const next=String(Number(day)+1); if(Number(next)<=30){ s.heroProgress[HERO_ID].days[next].unlockAt = 0; }
  saveSettings(s); paint();
});
$('#resetDay').addEventListener('click', ()=>{
  if(!(devOn()||dirOn())) return;
  const s=ensureSettings(); const seg=location.hash.replace('#/',''); const m=seg.match(/^day\/(\d+)$/); if(!m){ alert('Open a day first'); return; }
  const day=m[1]; s.heroProgress[HERO_ID].days[day] = {done:false,completedAt:null,unlockAt:(day==='1'?0:null)};
  saveSettings(s); paint();
});
$('#resetCourse').addEventListener('click', ()=>{
  if(!(devOn()||dirOn())) return;
  if(!confirm('Reset all 30 days for this hero?')) return;
  const s=ensureSettings(); delete s.heroProgress[HERO_ID]; saveSettings(s); ensureSettings(); paint();
});
$('#heroPick').addEventListener('click', ()=>{
  if(!(devOn()||dirOn())) return;
  // prefer current day bg if available, else first available
  const s=ensureSettings(); const seg=location.hash.replace('#/',''); let src=null;
  if(/^day\/\d+$/.test(seg)){ const day=seg.split('/')[1]; src = s.heroAssets[HERO_ID].days[day]?.bg?.src || null; }
  if(!src){
    for(let i=1;i<=30;i++){ const bg=s.heroAssets[HERO_ID].days[String(i)]?.bg; if(bg?.src){ src=bg.src; break; } }
  }
  if(!src){ alert('No background found. Upload one on any day.'); return; }
  openHeroPicker(src);
});

/* ===== Hero Image Picker (modal) ===== */
const heroModal = $('#heroModal'), heroStage=$('#heroStage'), heroImg=$('#heroImg'), heroZoom=$('#heroZoom'), heroMeta=$('#heroMeta');
let heroCrop = { scale:1, x:0, y:0 }, heroDragging=false, heroStart={x:0,y:0}, heroAt={x:0,y:0};

function openHeroPicker(src){
  heroImg.src = src; heroCrop={scale:1,x:0,y:0};
  heroZoom.value='1'; applyHeroCrop();
  heroModal.classList.add('open'); heroModal.setAttribute('aria-hidden','false');
  heroMeta.textContent='Drag image to center. Use zoom to fit the hero card.';
}
function closeHeroPicker(){
  heroModal.classList.remove('open'); heroModal.setAttribute('aria-hidden','true');
}
$('#heroCancel').addEventListener('click', closeHeroPicker);
heroModal.addEventListener('click', (e)=>{ if(e.target===heroModal) closeHeroPicker(); });

function applyHeroCrop(){
  heroImg.style.transform = `translate(calc(-50% + ${heroCrop.x}px), calc(-50% + ${heroCrop.y}px)) scale(${heroCrop.scale})`;
}

heroStage.addEventListener('pointerdown', e=>{
  heroDragging=true; heroAt={x:heroCrop.x,y:heroCrop.y}; heroStart={x:e.clientX,y:e.clientY};
  heroStage.setPointerCapture(e.pointerId);
});
heroStage.addEventListener('pointermove', e=>{
  if(!heroDragging) return; heroCrop.x = heroAt.x + (e.clientX-heroStart.x); heroCrop.y = heroAt.y + (e.clientY-heroStart.y); applyHeroCrop();
});
heroStage.addEventListener('pointerup', ()=>{ heroDragging=false; });

heroZoom.addEventListener('input', ()=>{
  heroCrop.scale = parseFloat(heroZoom.value)||1; applyHeroCrop();
});

$('#heroSave').addEventListener('click', ()=>{
  const s=ensureSettings();
  s.heroAssets[HERO_ID].heroCard = { src: heroImg.src, crop:{ cx:heroCrop.x, cy:heroCrop.y, scale:heroCrop.scale } };
  saveSettings(s);
  heroMeta.textContent='Saved. Home can now render this crop on the hero card.';
  setTimeout(closeHeroPicker, 400);
});

/* ===== Helpers ===== */
function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[s])) }
function defaultSummary(day){
  return `Day ${day} — Create a 3-minute bird study. Focus on silhouette, gesture, and rhythm lines. Optional: add a splash of ink or colour for contrast.`;
}

/* ===== Paint (entry) ===== */
function paint(){
  // reflect dev mode class
  document.body.classList.toggle('config-on', devOn());
  $('#cfgbar').classList.toggle('hide', !devOn());
  $('#cfgbar').setAttribute('aria-hidden', devOn()?'false':'true');
  // repaint current route
  route();
}

/* ===== Start: go to last visited, else intro ===== */
paint(); // initial
if(!location.hash) navTo(ensureSettings().heroProgress[HERO_ID].lastVisited || 'intro');

})();
</script>
</body>
</html>