Artist HUB V1.0
<!DOCTYPE html>
<html lang="en-AU">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="color-scheme" content="dark" />
<title>Home — FAOA (CF7 v3)</title>
<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Lobster&family=Oswald:wght@400;700&family=Pacifico&family=Raleway:wght@700;900&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#eef3ff; --ink-dim:#cfd3e1; --muted:rgba(238,243,255,.78);
  --bg:#000; --panel:#0a0c10; --panel-2:#0f1116; --stroke:rgba(255,255,255,.18);
  --blue:#0A84FF; --green:#32d74b; --red:#ff3b30; --chip:#1b1f2a;
  --gap:12px; --r:14px; --maxw:1240px; --nav-h:68px; --hero-pad:16px;
}

/* Base */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%; margin:0; background:var(--bg); color:var(--ink);
  font:16px -apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,sans-serif;
  overscroll-behavior-y:contain; overflow-x:hidden; user-select:none; -webkit-user-select:none;
}
a{ color:inherit; text-decoration:none }
button{ user-select:none; -webkit-user-select:none; cursor:pointer }
body.lock{ position:fixed; width:100% }

/* Background */
.bg{ position:fixed; inset:0; z-index:-1; background:#000 url("./assets/home-bg.jpg") center/cover no-repeat }

/* Top bar */
.nav{
  position:fixed; top:0; left:0; right:0; height:var(--nav-h);
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  padding:8px 12px; z-index:50;
  background:linear-gradient(180deg,rgba(0,0,0,.9),rgba(0,0,0,.55) 60%,rgba(0,0,0,.3));
  -webkit-backdrop-filter:blur(12px); backdrop-filter:blur(12px);
}
.nav-left{ display:flex; align-items:center; gap:10px }
.hamburger{ width:38px; height:38px; border-radius:10px; border:1px solid var(--stroke);
  background:#141821; color:var(--ink); font-size:20px; display:flex; align-items:center; justify-content:center; }

/* Avatar pill */
.avatarTab{
  display:flex; flex-direction:column; align-items:flex-start; justify-content:center;
  padding:6px 12px; border-radius:12px; min-width:132px; height:44px;
  font-weight:900; line-height:1.1; text-align:left; border:1px solid var(--stroke);
  background:#222; color:#eef3ff;
}
.avatarTab .name{ font-size:15px; font-weight:900 }
.avatarTab .lvl{ font-size:12px; opacity:.95; text-transform:capitalize }

/* Avatar drawer */
#avatarSheet{ position:fixed; inset:0; z-index:80; display:none; background:rgba(0,0,0,.55); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px) }
#avatarSheet.open{ display:flex }
#avatarCard{ margin:auto; width:min(420px,92vw); background:#0f1116; border:1px solid var(--stroke); border-radius:14px; padding:14px; }
#avatarCard h3{ margin:0 0 12px; font-weight:900 }
#avatarClose{ float:right; }

/* Layout */
.wrap{ max-width:var(--maxw); margin:0 auto; padding:calc(var(--nav-h) + env(safe-area-inset-top) + 10px) 14px 160px }
.section{ margin:32px 0; position:relative; z-index:0 }
.section .divider{ margin-bottom:10px }

/* Grid */
.section .grid{
  display:grid;
  grid-auto-flow:column;
  grid-auto-columns:max-content;
  align-items:start;
  gap:var(--gap);
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  padding-bottom:10px;
}
.section .grid::-webkit-scrollbar{ display:none }

/* Hero card */
.hero{
  position:relative; overflow:hidden; background:#060708; border:1px solid var(--stroke);
  border-radius:16px; padding:var(--hero-pad); height:220px;
  width:auto; scroll-snap-align:start; display:block; cursor:pointer;
}
.hero.state-live{ border:2px solid var(--green) }
.hero.state-dev{ border:2px solid var(--blue) }
.hero.state-off{ border:2px solid var(--red) }
.hero .label{ font-weight:900; font-size:18px; position:absolute; top:14px; left:16px; z-index:2 }
.hero .ctrls{ position:absolute; top:10px; right:10px; z-index:6; display:flex; align-items:center; gap:8px }
.kebab{ display:inline-flex; align-items:center; justify-content:center;
  width:28px; height:28px; border-radius:8px; border:1px solid var(--stroke);
  background:#12151c; color:#e7eaf0; cursor:pointer; font-weight:900; }

/* Reorder arrows */
.hero-arrows{ display:none; position:absolute; right:8px; top:50%; transform:translateY(-50%);
  z-index:20; flex-direction:column; gap:10px; pointer-events:auto; }
.config-on .hero .hero-arrows{ display:flex }
.cfg-arrow{ display:inline-flex; align-items:center; justify-content:center;
  width:26px; height:26px; border-radius:8px; border:1px solid var(--stroke);
  background:#12151c; color:#e7eaf0; cursor:pointer; }

/* Hero art */
.hero .art{ position:absolute; inset:0; z-index:0; opacity:.92; pointer-events:none; overflow:hidden; border-radius:inherit }
.hero .art img{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1);
  width:auto; height:110%; min-width:110%; user-select:none; pointer-events:none;
  filter:saturate(1.02) contrast(1.02) brightness(0.95); }
.hero::after{ content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
  background:linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.45) 65%, rgba(0,0,0,.6)); z-index:1; }

/* Divider */
.divider{ position:relative; border:none; border-radius:14px; background:transparent;
  padding:0 2px 6px; min-height:0; margin:28px 2px 8px;
  display:flex; align-items:flex-end; gap:10px; z-index:1; }
.divider .htext{ font-weight:900; opacity:.92 }

/* Footer Dock */
#archiveDock{ position:fixed; left:12px; right:12px; bottom:12px; z-index:75;
  background:var(--panel-2); color:#fff; border:1px solid var(--stroke);
  border-radius:22px; box-shadow:0 10px 24px rgba(0,0,0,.45); }
#archiveDock .bar{ display:flex; align-items:center; justify-content:flex-start; gap:8px;
  padding:10px 12px; font-weight:900; overflow-x:auto; white-space:nowrap; }
.footer-chip{ display:inline-flex; align-items:center; gap:6px;
  padding:7px 10px; border-radius:14px; border:1px solid var(--stroke);
  background:#141821; color:#e7eaf0; cursor:pointer; }

/* Hero schedule chip */
.hero .sched-chip{
  position:absolute; left:10px; bottom:10px; z-index:3;
  display:inline-flex; align-items:center; gap:6px;
  padding:4px 8px; border-radius:10px; border:1px solid var(--stroke);
  background:#10131a; font:700 12px/1 system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
  max-width:calc(100% - 20px);
}
.hero .sched-chip.green{ color:#79ffa0; border-color:#1e3a22; background:#0c1610 }
.hero .sched-chip.red{   color:#ff9aa0; border-color:#3a1e1f; background:#160c0d }
.hero .sched-chip.blue{  color:#8fb3ff; border-color:#1e2f3a; background:#0c1216 }

/* Artist Hub overlay */
#artistHub{
  position:fixed; inset:0; z-index:2000;
  display:grid; place-items:center;
  background:rgba(0,0,0,.55);
  -webkit-backdrop-filter:blur(6px);
  backdrop-filter:blur(6px);
}
</style>
</head>
<body>
<div class="bg" aria-hidden="true"></div>
<header class="nav" role="navigation">
  <div class="nav-left">
    <button class="hamburger" id="artistHubBtn" aria-label="Artist Hub">☰</button>
  </div>
  <div class="nav-right">
    <button id="avatarTab" class="avatarTab">
      <span class="name" id="avatarName">User</span>
      <span class="lvl" id="avatarLvl">Admin</span>
    </button>
  </div>
</header>

<main class="wrap">
  <div id="pageGrid"></div>
</main>
<!-- Artist Hub overlay -->
<div id="artistHub" hidden>
  <div style="margin:auto;background:#0f1116;border:1px solid var(--stroke);border-radius:14px;max-width:480px;width:90%;padding:16px;position:relative">
    <button class="footer-chip" id="closeArtistHubBtn" style="position:absolute;top:10px;right:10px">Close</button>
    <h3 style="margin:0 0 12px 0">Artist Hub</h3>
    <div id="artistList" style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px"></div>
    <button class="footer-chip" id="newArtistBtn">+ Create Artist</button>
  </div>
</div>

<!-- Avatar Drawer -->
<div id="avatarSheet" aria-hidden="true">
  <div id="avatarCard" role="dialog" aria-modal="true" aria-labelledby="avatarTitle">
    <button id="avatarClose" class="footer-chip" type="button">Close</button>
    <h3 id="avatarTitle">Profile</h3>
    <div style="display:flex;flex-direction:column;gap:8px">
      <div><strong>Name:</strong> <span id="drawerName">User</span></div>
      <div><strong>Role:</strong> <span id="drawerRole">Admin</span></div>
    </div>
  </div>
</div>

<!-- Footer Dock -->
<div id="archiveDock">
  <div class="bar">
    <button class="footer-chip" id="devToggle">Developer: Off</button>
    <button class="footer-chip" id="createCourseBtn" style="display:none">Create Course</button>
    <button class="footer-chip" id="addHeadingBtn" style="display:none">Add Heading</button>
    <button class="footer-chip" id="archiveToggle" style="display:none">Archived</button>
  </div>
  <!-- Archive content (collapsible) -->
  <div class="content" id="archiveContent" style="display:none">
    <div class="list" id="archiveList"></div>
  </div>
</div>

<!-- Modal root -->
<div id="modalRoot" hidden>
  <div id="modalBackdrop"></div>
  <div class="modalCard" role="dialog" aria-modal="true">
    <div class="modalHead">
      <span class="title" id="modalTitle"></span>
      <button class="modalX" id="modalX">×</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
    <div class="modalFoot" id="modalFoot"></div>
  </div>
</div>

<!-- Course Sheet -->
<div id="courseSheet" aria-hidden="true">
  <div id="coursePanel" role="dialog" aria-modal="true">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--stroke)">
      <div style="font-weight:900" id="courseTitle">Course</div>
      <button id="courseClose" class="footer-chip" type="button" aria-label="Close">Close</button>
    </div>
    <div style="display:flex; gap:0; flex-wrap:wrap">
      <div style="flex:1 1 520px; min-height:300px; max-height:70vh; overflow:hidden; border-right:1px solid var(--stroke)">
        <iframe id="courseFrame" title="Course" src="" style="width:100%; height:100%; border:0"></iframe>
      </div>
      <div style="flex:1 1 360px; padding:12px; max-height:70vh; overflow:auto">
        <div id="courseSummary" style="opacity:.92"></div>
        <div style="display:flex; gap:8px; margin-top:12px">
          <button class="footer-chip" id="courseStart" type="button">Start</button>
          <button class="footer-chip" id="courseMarkDone" type="button">Mark Complete</button>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
(()=>{'use strict';

/* ===== Utils / storage ===== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const store={ get:(k,f)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):f }catch{ return f } }, set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)) };
const K={ profile:'ao_profile', settings:'ao_settings', view:'ao_view', schemaVer:'ao_schema_version' };
const SCHEMA_VERSION=8; // bumped for v3

const esc=s=>String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
const fmtDate=d=>{ if(!d) return ''; const t=new Date(d); if(Number.isNaN(+t)) return ''; const dd=String(t.getDate()).padStart(2,'0'); const mm=String(t.getMonth()+1).padStart(2,'0'); const yy=t.getFullYear(); return `${dd}/${mm}/${yy}` };

/* Roles */
const ROLE_MAP = { beginner:'bronze', intermediate:'silver', advanced:'gold' };
const ROLE_LABEL = { bronze:'Beginner', silver:'Intermediate', gold:'Advanced', support:'Support', director:'Director', admin:'Admin' };
const normalizeRole=r=>{ r=String(r||'').toLowerCase(); return ROLE_MAP[r] || r; };
function baseRole(){ const p = store.get(K.profile, { skill:'admin', displayName:'User' }); return normalizeRole(p.skill || 'admin'); }
function getRole(){ return baseRole(); }
function isAdmin(){ return getRole()==='admin'; }
function devModeOn(){ return document.body.classList.contains('config-on'); }
function seesAll(){ const r=getRole(); return r==='admin' || r==='support' || r==='director'; }

/* Settings + defaults */
function numberFromId(id){ const m = String(id || '').match(/(\\d+)/); return m ? m[1] : ''; }
function defaults(){
  return {
    heroFlags:{}, heroLabels:{}, heroAssets:{}, heroProgress:{}, heroStyle:{},
    heroSchedule:{}, heroShortcuts:{}, pageOrder:[], flags:{schedule:true},
    courseMap:{} // heroId -> courseId
  };
}
function sanitize(cfg){
  let c = (!cfg || typeof cfg!=='object') ? defaults() : {...cfg};
  c.heroFlags=c.heroFlags||{}; c.heroLabels=c.heroLabels||{}; c.heroAssets=c.heroAssets||{};
  c.heroProgress=c.heroProgress||{}; c.heroStyle=c.heroStyle||{}; c.pageOrder=Array.isArray(c.pageOrder)?c.pageOrder:[];
  c.heroSchedule=c.heroSchedule||{}; c.heroShortcuts=c.heroShortcuts||{}; c.flags=c.flags||{schedule:true};
  c.courseMap=c.courseMap||{};
  c.pageOrder = c.pageOrder.filter(it=> it && (it.type==='hero'||it.type==='divider'));
  return c;
}
function loadSettings(){
  const ver = Number(store.get(K.schemaVer, 0))||0;
  const raw = store.get(K.settings, null);
  let s = sanitize(raw);
  if(ver!==SCHEMA_VERSION){ store.set(K.settings, s); store.set(K.schemaVer, SCHEMA_VERSION); }
  return s;
}
let S = loadSettings();
function getSettings(){ return S; }
function saveSettings(next){ S = sanitize(next||S); store.set(K.settings,S); }

/* Avatar */
function paintAvatar(){
  const p=store.get(K.profile,{displayName:'User',skill:'admin'});
  $('#avatarName').textContent = p.displayName || 'User';
  $('#avatarLvl').textContent = ROLE_LABEL[getRole()] || getRole();
  $('#drawerName').textContent = p.displayName || 'User';
  $('#drawerRole').textContent = ROLE_LABEL[getRole()] || getRole();
}
paintAvatar();

/* Drawer wiring */
(function(){
  const avatarBtn = $('#avatarTab');
  const sheet = $('#avatarSheet');
  const closeBtn = $('#avatarClose');
  function openDrawer(){ sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false'); avatarBtn.setAttribute('aria-expanded','true'); }
  function closeDrawer(){ sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); avatarBtn.setAttribute('aria-expanded','false'); }
  avatarBtn?.addEventListener('click', openDrawer, {passive:true});
  closeBtn?.addEventListener('click', closeDrawer, {passive:true});
  sheet?.addEventListener('click', e=>{ if(e.target===sheet) closeDrawer(); }, {passive:true});
})();
/* Labels / style */
function labelFor(id){
  const s = getSettings();
  const custom = s.heroLabels?.[id];
  if (custom && custom.trim()) return custom;
  const n = numberFromId(id);
  if (n) return `#${n}`;
  const heroes = s.pageOrder.filter(it => it.type === 'hero');
  const pos = heroes.findIndex(it => it.id === id);
  return pos >= 0 ? `#${pos + 1}` : '#?';
}
function styleFor(id){
  const st=(getSettings().heroStyle||{})[id]||{};
  return { color: st.labelColor || '', font: st.labelFont || "system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif", size: Number(st.labelSize||18) };
}

/* Scheduling helpers */
function toDateOnly(d){ const t=new Date(d); if(Number.isNaN(+t)) return null; return new Date(t.getFullYear(),t.getMonth(),t.getDate()); }
function parseYMD(s){ if(!s) return null; const t=new Date(s); if(Number.isNaN(+t)) return null; return new Date(t.getFullYear(),t.getMonth(),t.getDate()); }
function nextFromRecurrence(rec, now){
  if(!rec || !rec.r) return null;
  const R = rec.r || {}; const freq=String(R.freq||'').toUpperCase(); const interval=Math.max(1, Number(R.interval||1));
  let cur = parseYMD(R.start||new Date());
  if(!cur) return null;
  now = toDateOnly(now||new Date());
  function addStep(d){ if(freq==='DAILY') d.setDate(d.getDate()+interval); else if(freq==='WEEKLY') d.setDate(d.getDate()+7*interval); else if(freq==='MONTHLY') d.setMonth(d.getMonth()+interval); else if(freq==='YEARLY') d.setFullYear(d.getFullYear()+interval); else d.setDate(d.getDate()+interval); }
  let safety=0; while(cur < now && safety<512){ addStep(cur); safety++; }
  return cur>=now ? cur : null;
}
function nextOccurrence(val, now){
  if(!val) return null;
  if(typeof val==='string'){ const t=parseYMD(val); return (t && t>=toDateOnly(now||new Date())) ? t : null; }
  if(typeof val==='object' && val.r) return nextFromRecurrence(val, now);
  return null;
}
function computeHeroScheduleStateAndChip(id){
  const s=getSettings(); const flag=s.heroFlags[id]||{}; const sch=s.heroSchedule[id]||{};
  const now = new Date();
  const relDate = parseYMD(typeof sch.release==='string'?sch.release:sch.release?.r?.start);
  const expDate = parseYMD(typeof sch.expiry==='string'?sch.expiry:sch.expiry?.r?.start);
  const devDate = parseYMD(typeof sch.dev==='string'?sch.dev:sch.dev?.r?.start);
  const today = toDateOnly(now);

  let effState = flag.state || 'dev';
  if(today && expDate && expDate <= today){ effState='off'; }
  else if(today && relDate && relDate <= today){ effState='live'; }
  else if(today && devDate && devDate <= today){ effState='dev'; }

  const nexts = [
    ['live','green', nextOccurrence(sch.release, now)],
    ['off','red',   nextOccurrence(sch.expiry, now)],
    ['dev','blue',  nextOccurrence(sch.dev, now)],
  ].filter(([, , d])=>!!d);

  let chip=null;
  if(nexts.length){
    const nearest = nexts.sort((a,b)=>a[2]-b[2])[0];
    const [type, color, date] = nearest;
    const days = Math.ceil((toDateOnly(date)-toDateOnly(new Date()))/86400000);
    if(!Number.isNaN(days)) chip = { color, text: `${type==='live'?'Live':'Exp'===type?'Exp':'Dev'}: ${days} Days` };
  }
  return { effState, chip };
}

/* DOM builders */
function heroCard(id){
  const s=getSettings(); const f=s.heroFlags[id]; if(!f) return null;
  const art = s.heroAssets?.[id]?.heroCard || null;
  const devOn = devModeOn(); const canAdminDev = isAdmin() && devOn;
  const shape = f.shape || 'square';
  const st = styleFor(id);
  const {effState, chip} = computeHeroScheduleStateAndChip(id);
  const el=document.createElement('article'); el.className='hero'; el.dataset.heroId=id; el.dataset.place=f.place; el.classList.add(`shape-${shape}`);
  if (seesAll()) {
    if(effState==='live') el.classList.add('state-live');
    else if (effState==='dev') el.classList.add('state-dev');
    else el.classList.add('state-off');
  }
  const artLayer = (art && art.src) ? `<div class="art"><img alt="" src="${esc(art.src)}"></div>` : '';
  const labelInline = ` style="color:${esc(st.color)};font-family:${esc(st.font)};font-size:${st.size}px"`;
  el.innerHTML = `${artLayer}
    ${canAdminDev ? `<div class="hero-arrows"><button class="cfg-arrow" data-sort="up" data-key="hero:${esc(id)}" type="button">▲</button><button class="cfg-arrow" data-sort="down" data-key="hero:${esc(id)}" type="button">▼</button></div>` : ``}
    <span class="label"${labelInline}>${esc(labelFor(id))}</span>
    <div class="ctrls">${canAdminDev?`<button class="kebab" data-hero-kebab="${esc(id)}" aria-haspopup="dialog" aria-expanded="false">⋮</button>`:''}</div>`;
  if(chip){
    const chipEl = document.createElement('div'); chipEl.className = `sched-chip ${chip.color}`; chipEl.textContent = chip.text; el.appendChild(chipEl);
  }
  return el;
}

function dividerEl(obj){
  const editable   = isAdmin() && devModeOn();
  const color      = obj.color || '';
  const fontFamily = obj.fontFamily || "system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif";
  const fontSize   = Number(obj.fontSize || 22);
  const el = document.createElement('div');
  el.className = 'divider';
  el.dataset.type = 'divider';
  el.dataset.divId = obj.id;
  el.innerHTML = `
    ${editable ? `<div class="dctrls-left"><button class="footer-chip" data-div-act="up" data-div-id="${esc(obj.id)}" type="button">▲</button><button class="footer-chip" data-div-act="down" data-div-id="${esc(obj.id)}" type="button">▼</button></div>`:''}
    <span class="htext" style="color:${esc(color)};font-family:${esc(fontFamily)};font-size:${fontSize}px">${esc(obj.title || 'Heading')}</span>
    <div class="tools">
      ${editable ? `<div class="ctrls"><button class="kebab" data-div-kebab="${esc(obj.id)}" type="button">⋮</button></div>`:''}
      <div class="aud-indicators-head" aria-hidden="${seesAll()?'false':'true'}"></div>
    </div>`;
  return el;
}
/* Paint page/archive */
function addHeroIndicators(){
  if(!seesAll()) return;
  $$('.hero').forEach(h=>{
    h.querySelectorAll('.aud-indicators').forEach(n=>n.remove());
    const f=getSettings()?.heroFlags?.[h.dataset.heroId]; if(!f?.aud) return;
    const order=[['gold','Advanced'],['silver','Intermediate'],['bronze','Beginner']];
    const active = order.filter(([k])=>!!f.aud[k]); if(!active.length) return;
    const ind=document.createElement('div'); ind.className='aud-indicators'; ind.style.cssText='position:absolute;right:10px;bottom:10px;display:flex;gap:6px;z-index:2;';
    ind.innerHTML = active.map(([k,t])=>`<span class="aud-dot ${k} on" title="${t}"></span>`).join('');
    h.appendChild(ind);
  });
}
function addHeadingIndicators(){
  if(!seesAll()) return;
  $$('.divider').forEach(div=>{
    const slot = div.querySelector('.aud-indicators-head');
    if(!slot) return;
    slot.innerHTML = '';
    const heroes=[...(div.nextElementSibling?.querySelectorAll?.('.hero')||[])];
    const agg={bronze:false,silver:false,gold:false};
    heroes.forEach(h=>{
      const f=getSettings()?.heroFlags?.[h.dataset.heroId];
      if(f?.aud){ agg.bronze ||= !!f.aud.bronze; agg.silver ||= !!f.aud.silver; agg.gold ||= !!f.aud.gold; }
    });
    const order=[['gold','Advanced'],['silver','Intermediate'],['bronze','Beginner']];
    const active = order.filter(([k])=>agg[k]); if(!active.length) return;
    slot.innerHTML = active.map(([k,t])=>`<span class="aud-dot ${k} on" title="${t}"></span>`).join('');
  });
}
function paintPage(){
  const root = $('#pageGrid'); if(!root) return;
  root.innerHTML = '';
  const s = getSettings(); const role = getRole(); const staff = seesAll();
  function startSection(divObj){
    if(divObj && !staff){
      const aud = divObj.aud || {bronze:true,silver:true,gold:true};
      if(!aud[role]) return null;
      if(divObj.state==='off') return null;
    }
    const sec = document.createElement('section'); sec.className = 'section';
    if(divObj) sec.appendChild(dividerEl(divObj));
    const row = document.createElement('div'); row.className = 'grid size-m';
    sec.appendChild(row); root.appendChild(sec); return {sec,row};
  }
  let currentRow=null;
  for(const it of s.pageOrder){
    if(it.type==='divider'){ const started = startSection(it); currentRow = started ? started.row : null; continue; }
    if(it.type==='hero'){
      const id=it.id, f=s.heroFlags[id]; if(!f || f.place!=='page') continue;
      const {effState}=computeHeroScheduleStateAndChip(id);
      if(!seesAll()){
        if(effState!=='live') continue;
        if(!f.aud[role]) continue;
      }
      if(!currentRow){ const started = startSection(null); currentRow = started ? started.row : null; if(!currentRow) continue; }
      const card=heroCard(id); if(card) currentRow.appendChild(card);
    }
  }
  $$('#pageGrid .section').forEach(sec=>{
    const row = sec.querySelector('.grid');
    const hasHeroes = row && row.children.length>0;
    const hasDivider = !!sec.querySelector('.divider');
    if(!hasHeroes && !hasDivider){ sec.remove(); }
  });
  addHeroIndicators(); addHeadingIndicators();
}

/* Footer / archive */
const dock=$('#archiveDock'), archiveList=$('#archiveList');
function updateFooterModeControls(){
  const devOn=devModeOn();
  $('#devToggle').textContent=`Developer: ${devOn?'On':'Off'}`;
  $('#createCourseBtn').style.display = (isAdmin() && devOn) ? 'inline-flex' : 'none';
  $('#addHeadingBtn').style.display   = (isAdmin() && devOn) ? 'inline-flex' : 'none';
  $('#archiveToggle').style.display   = (isAdmin() && devOn) ? 'inline-flex' : 'none';
}
function applyArchiveVisibility(){ dock.setAttribute('aria-hidden','false'); }
function paintArchive(){
  const s=getSettings(); const flags=s.heroFlags;
  if(!archiveList) return;
  archiveList.innerHTML='';
  const items=Object.entries(flags).filter(([id,f])=>f.place==='archive')
    .sort((a,b)=>String(a[0]).localeCompare(String(b[0]),undefined,{numeric:true}));
  items.forEach(([id,f])=>{
    const statusLabel = (f.state==='live'?'Live':(f.state==='dev'?'Dev':'Offline'));
    const row=document.createElement('div'); row.className='row'; row.dataset.heroId=id; row.dataset.place='archive';
    row.innerHTML = `<span class="num">${esc(labelFor(id))}</span>
    ${(isAdmin() && devModeOn())?`<div style="display:flex;gap:8px;align-items:center">
      <button class="footer-chip" data-act="move" type="button">Move to Page</button>
      <button class="footer-chip" data-act="toggle" type="button">${esc(statusLabel)}</button>
    </div>`:`<div></div>`}`;
    archiveList.appendChild(row);
  });
}

/* Boot */
applyArchiveVisibility(); paintArchive(); paintPage(); updateFooterModeControls();

/* Footer handlers */
$('#archiveToggle')?.addEventListener('click',()=>{
  const cont = $('#archiveContent');
  if(!cont) return;
  const open = cont.style.display !== 'none';
  cont.style.display = open ? 'none' : 'block';
});
$('#devToggle').addEventListener('click', ()=>{
  if(!isAdmin()) return;
  document.body.classList.toggle('config-on');
  updateFooterModeControls(); paintPage(); paintArchive();
});
/* Create course */
$('#createCourseBtn')?.addEventListener('click', ()=>{
  const s=getSettings();
  const nextId = 'co-' + Date.now();
  s.heroFlags[nextId] = { place:'page', state:'dev', aud:{bronze:true,silver:true,gold:true} };
  s.heroLabels[nextId] = 'New Course';
  s.pageOrder.push({type:'hero', id:nextId});
  s.courseMap[nextId] = 'course-' + Date.now();
  saveSettings(s); paintPage();
});

/* Add heading */
$('#addHeadingBtn')?.addEventListener('click', ()=>{
  const s=getSettings();
  const nextId = 'hd-' + Date.now();
  s.pageOrder.push({type:'divider', id:nextId, title:'Heading'});
  saveSettings(s); paintPage();
});

/* Delegated click handling */
document.body.addEventListener('click', e=>{
  const t=e.target;
  if(t.closest('.hero')){
    const card=t.closest('.hero');
    const id=card.dataset.heroId;
    if(!id) return;
    const s=getSettings();
    const courseId=s.courseMap?.[id];
    if(courseId){ window.location.href=`studio.html?course=${encodeURIComponent(courseId)}`; }
    return;
  }
  if(t.matches('.cfg-arrow')){
    const key=t.dataset.key, dir=t.dataset.sort;
    const [type,id]=key.split(':'); if(type!=='hero') return;
    const s=getSettings(); const arr=s.pageOrder;
    const idx=arr.findIndex(it=>it.type==='hero' && it.id===id);
    if(idx<0) return;
    const [item]=arr.splice(idx,1);
    const newIdx=dir==='up'?Math.max(0,idx-1):Math.min(arr.length,idx+1);
    arr.splice(newIdx,0,item);
    saveSettings(s); paintPage();
    return;
  }
  if(t.dataset?.divAct){
    const act=t.dataset.divAct, id=t.dataset.divId;
    const s=getSettings(); const arr=s.pageOrder;
    const idx=arr.findIndex(it=>it.type==='divider' && it.id===id);
    if(idx<0) return;
    const [item]=arr.splice(idx,1);
    const newIdx=(act==='up')?Math.max(0,idx-1):Math.min(arr.length,idx+1);
    arr.splice(newIdx,0,item);
    saveSettings(s); paintPage();
    return;
  }
  if(t.closest('#archiveList .row')){
    const row=t.closest('.row'); const id=row.dataset.heroId;
    const act=t.dataset.act;
    const s=getSettings();
    if(act==='move'){ s.heroFlags[id].place='page'; s.pageOrder.push({type:'hero',id}); saveSettings(s); paintPage(); paintArchive(); }
    if(act==='toggle'){ const f=s.heroFlags[id]; f.state=(f.state==='live'?'off':'live'); saveSettings(s); paintArchive(); }
    return;
  }
});

/* ===== Artist Hub ===== */
const ARTISTS_KEY = 'ao_artists';
const CURRENT_ARTIST_KEY = 'ao_current_artist';

function loadArtists(){ return store.get(ARTISTS_KEY, []); }
function saveArtists(list){ store.set(ARTISTS_KEY, list); }
function currentArtist(){ return store.get(CURRENT_ARTIST_KEY, null); }
function setCurrentArtist(id){ store.set(CURRENT_ARTIST_KEY, id); }

function paintArtistHub(){
  const hub=$('#artistHub'); const listEl=$('#artistList');
  listEl.innerHTML='';
  const artists=loadArtists();
  const cur=currentArtist();
  artists.forEach(a=>{
    const row=document.createElement('div');
    row.className='footer-chip'; row.style.justifyContent='space-between';
    row.innerHTML=`<span>${esc(a.name)}</span>
      <div style="display:flex;gap:6px">
        <button class="footer-chip" data-artist-act="switch" data-id="${a.id}">${a.id===cur?'✓':'Switch'}</button>
        <button class="footer-chip" data-artist-act="rename" data-id="${a.id}">Rename</button>
        <button class="footer-chip" data-artist-act="toggle" data-id="${a.id}">${a.visible?'Hide':'Show'}</button>
        <button class="footer-chip" data-artist-act="delete" data-id="${a.id}">Delete</button>
      </div>`;
    listEl.appendChild(row);
  });
}

$('#artistHubBtn').addEventListener('click',()=>{
  const hub=$('#artistHub');
  hub.hidden=false;
  paintArtistHub();
});
$('#closeArtistHubBtn')?.addEventListener('click',()=>{ $('#artistHub').hidden=true; });

$('#newArtistBtn').addEventListener('click',()=>{
  const name=prompt('Artist name?','');
  if(!name) return;
  const id='artist-'+Date.now();
  const list=loadArtists();
  list.push({id,name,visible:true});
  saveArtists(list);
  setCurrentArtist(id);
  $('#artistHub').hidden=true;
  paintPage(); paintArchive();
});

$('#artistList').addEventListener('click',e=>{
  const t=e.target; if(!t.dataset.artistAct) return;
  const act=t.dataset.artistAct, id=t.dataset.id;
  let list=loadArtists();
  if(act==='switch'){ setCurrentArtist(id); $('#artistHub').hidden=true; paintPage(); paintArchive(); }
  if(act==='rename'){ const name=prompt('Rename to?', ''); if(name){ list=list.map(a=>a.id===id?{...a,name}:a); saveArtists(list); paintArtistHub(); } }
  if(act==='toggle'){ list=list.map(a=>a.id===id?{...a,visible:!a.visible}:a); saveArtists(list); paintArtistHub(); }
  if(act==='delete'){ if(confirm('Delete artist? This cannot be undone.')){ list=list.filter(a=>a.id!==id); saveArtists(list); if(currentArtist()===id) setCurrentArtist(list[0]?.id||null); paintArtistHub(); paintPage(); paintArchive(); } }
});

/* On load: ensure artist context */
(function(){
  let cur=currentArtist();
  const list=loadArtists();
  const param=new URLSearchParams(location.search).get('artist');
  if(param && list.some(a=>a.id===param)){ cur=param; setCurrentArtist(cur); }
  if(!cur && list.length){ cur=list[0].id; setCurrentArtist(cur); }
  if(!list.length){ $('#artistHub').hidden=false; }
})();

})(); // end IIFE
</script>
</body>
</html>

