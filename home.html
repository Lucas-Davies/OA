<!DOCTYPE html>
<html lang="en-AU">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="color-scheme" content="dark" />
<title>Home — FAOA</title>

<style>
:root{
  --ink:#eef3ff; --ink-dim:#cfd3e1; --muted:rgba(238,243,255,.78);
  --bg:#000; --panel:#0a0c10; --stroke:rgba(255,255,255,.18);
  --blue:#0A84FF; --green:#32d74b; --red:#ff3b30; --chip:#1b1f2a;
  --gap:12px; --r:14px; --maxw:1240px; --nav-h:68px; --hero-pad:16px;
}

/* Resets / base */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{
  height:100%; margin:0; background:var(--bg); color:var(--ink);
  font:16px -apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,sans-serif;
  overscroll-behavior-y:contain; overflow-x:hidden; user-select:none; -webkit-user-select:none;
}
a{ color:inherit; text-decoration:none }
button{ user-select:none; -webkit-user-select:none; cursor:pointer }
body.lock{ position:fixed; width:100% }

/* Background */
.bg{ position:fixed; inset:0; z-index:-1; background:#000 url("./assets/home-bg.jpg") center/cover no-repeat }

/* Top bar */
.nav{
  position:fixed; top:0; left:0; right:0; height:var(--nav-h);
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  padding:8px 12px; z-index:50;
  background:linear-gradient(180deg,rgba(0,0,0,.9),rgba(0,0,0,.55) 60%,rgba(0,0,0,.3));
  -webkit-backdrop-filter:blur(12px); backdrop-filter:blur(12px);
}
.title-tab{ font-weight:900; opacity:.92 }

/* Avatar pill */
.avatarTab{
  display:flex; flex-direction:column; align-items:flex-start; justify-content:center;
  padding:6px 12px; border-radius:12px; min-width:132px; height:44px;
  font-weight:900; line-height:1.1; text-align:left; border:1px solid var(--stroke);
  background:#222; color:#eef3ff;
}
.avatarTab .name{ font-size:15px; font-weight:900 }
.avatarTab .lvl{ font-size:12px; opacity:.95; text-transform:capitalize }

/* Layout */
.wrap{ max-width:var(--maxw); margin:0 auto; padding:calc(var(--nav-h) + env(safe-area-inset-top) + 10px) 14px 160px }

/* Grid now stacks headings + rows */
.grid{
  display:flex;
  flex-direction:column;
  gap:24px;
}

/* Each row: horizontal scroll of square heroes */
.row{
  display:grid;
  grid-auto-flow:column;
  grid-auto-columns:clamp(180px, 28vw, 280px);
  gap:var(--gap);
  overflow-x:auto;
  padding-bottom:8px;
  scroll-snap-type:x mandatory;
}
.row::-webkit-scrollbar{ display:none }
.row > *{ scroll-snap-align:start }

/* Hero squares */
.hero{
  position:relative;
  overflow:hidden;
  background:#060708;
  border:1px solid var(--stroke);
  border-radius:16px;
  padding:var(--hero-pad);
  aspect-ratio:1/1;          /* force square */
}
.hero .label{
  font-weight:900;
  font-size:18px;
  opacity:.95;
  position:absolute;
  top:14px;
  left:16px;
  z-index:2;
}

/* rename pencil */
.cfg-pin{
  position:absolute; top:10px; left:12px; z-index:5;
  width:28px; height:28px; border-radius:8px;
  border:1px solid var(--stroke); background:#121212; color:#fff; font-weight:900; line-height:1;
}
.hero.has-pencil .label{ left:46px } /* nudge label when pencil is present */

.ctrls{ position:absolute; top:10px; right:10px; display:flex; gap:8px; z-index:5 }
.chip{
  height:28px; padding:0 12px; border-radius:999px; border:1px solid var(--stroke);
  background:var(--chip); color:#fff; font-weight:800; font-size:12px; white-space:nowrap
}
.chip[disabled]{ opacity:.55; filter:grayscale(.15) }
.badge-live{ background:#0a0 }
.badge-off{ background:#b00020 }
.badge-dev{ background:var(--blue); color:#000; border-color:transparent }

.hero-arrows{ display:none; position:absolute; right:10px; top:50%; transform:translateY(-50%); z-index:4; flex-direction:column; gap:6px }
.config-on .hero .hero-arrows{ display:flex }
.hero-arrows .cfg-arrow{
  height:24px; padding:0 6px; border-radius:8px; border:1px solid var(--stroke);
  background:#161922; color:#fff; font-weight:900; font-size:12px
}

/* Buttons */
.btn{
  display:inline-flex; align-items:center; justify-content:center; min-width:120px; height:40px; padding:0 14px;
  border-radius:12px; border:1px solid var(--stroke); font-weight:900; background:#0f1116; color:var(--ink)
}
.btn.blue{ background:var(--blue); border-color:transparent; color:#000 }
.btn.grey{ background:#3a3a3a; color:#fff; border-color:var(--stroke) }

/* CTA + audience */
.cta-left{ position:absolute; left:16px; bottom:16px; display:flex; flex-direction:column; align-items:flex-start; gap:8px; z-index:2 }
.aud-line{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
.aud-chip{
  height:28px; padding:0 12px; border-radius:999px; border:1px solid var(--stroke);
  background:#141416; color:#fff; font-weight:800; font-size:12px; opacity:.9
}
.aud-chip.on{ opacity:1; filter:brightness(1.22) }
.aud-chip.on::after{ content:" ✓"; font-weight:900 }
.aud-chip.bronze{ box-shadow:inset 0 0 0 2px #b87333 }
.aud-chip.silver{ box-shadow:inset 0 0 0 2px #c0c7d1 }
.aud-chip.gold{   box-shadow:inset 0 0 0 2px #ffd700 }

/* Read-only status pill (normal mode only for staff) */
.status-pill{
  position:absolute; top:12px; right:12px; height:28px; padding:0 12px; border-radius:999px;
  display:inline-flex; align-items:center; font-weight:900; z-index:4; border:1px solid rgba(255,255,255,.18)
}
.status-live{ background:#1c6b1c; color:#fff }
.status-off{ background:#5a0d12; color:#fff }
.status-dev{ background:var(--blue); color:#000; border-color:transparent }

/* Divider (Heading) */
.divider{
  position:relative; border:1px dashed var(--stroke); border-radius:14px; background:#0b0d12;
  padding:14px 16px 56px; min-height:58px; grid-column:1 / -1;
}
.divider .htext{ font-weight:900; opacity:.92 }
.divider .dctrls{ position:absolute; top:10px; right:10px; display:none; gap:6px }
.config-on .divider .dctrls{ display:flex }
.divider .aud-line{ position:absolute; left:16px; bottom:14px }

/* Compact headings when NOT in config mode */
:not(.config-on) .divider{ border:none; background:transparent; min-height:0; padding:0 2px 6px; margin:28px 2px 8px; display:flex; align-items:flex-end }
:not(.config-on) .divider .aud-line{ display:none }
:not(.config-on) .divider .htext{ padding:0; margin:0 }

/* Avatar Drawer */
#avatarSheet{
  position:fixed; inset:0; z-index:70; display:none;
  background:rgba(0,0,0,.55); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px)
}
#avatarSheet.open{ display:block }
#avatarSheet .panel{
  position:absolute; inset:0; margin:auto; width:100%; height:100%;
  background:#0f1116; border:1px solid var(--stroke); border-radius:0; padding:12px; overflow:auto;
}
#avatarClose{
  position:absolute; right:12px; top:12px; width:32px; height:32px; border-radius:10px; border:1px solid var(--stroke);
  background:#121212; color:#fff; font-weight:900; line-height:1; z-index:2;
}
@media (min-width:820px){
  #avatarSheet .panel{ width:min(780px, 92vw); height:min(86vh, 920px); right:12px; left:auto; top:calc(var(--nav-h) + 8px); bottom:auto; border-radius:14px }
}
.menu-list a{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 10px; border-bottom:1px solid rgba(255,255,255,.08)
}
.menu-list a:last-child{ border-bottom:none }

/* Subsheet (courses) */
#subSheet{
  position:fixed; inset:0; z-index:80; display:none;
  background:rgba(0,0,0,.75); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px)
}
#subSheet.open{ display:block }
#subSheet .inner{
  position:absolute; inset:0; background:#0f1116; border:none; border-radius:0; padding:0;
  display:flex; flex-direction:column
}
.sheet-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-bottom:1px solid var(--stroke) }
.sheet-close{ width:36px; height:36px; border-radius:10px; border:1px solid var(--stroke); background:#121212; color:#fff; font-weight:900 }
#subFrame{ flex:1 1 auto; width:100%; height:100%; border:none; background:#0b0c10; overflow:hidden }

/* Footer Dock (Developer only, single Archived chip) */
#archiveDock{
  position:fixed; left:0; right:0; bottom:0; z-index:75; background:var(--red); color:#fff; border-top:1px solid rgba(255,255,255,.25);
  transition:max-height .22s ease; overflow:hidden; overscroll-behavior:contain
}
#archiveDock .bar{
  display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 14px; font-weight:900;
  overflow-x:auto; white-space:nowrap
}
#archiveDock .bar::-webkit-scrollbar{ display:none }
#archiveDock .title{ display:inline-flex; align-items:center; gap:8px }
#archiveDock .content{ background:#160b0b; max-height:calc(60vh - 48px); overflow:auto }
#archiveDock .list{ padding:8px 12px 16px; display:flex; flex-direction:column; gap:8px }
#archiveDock .row{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:10px 12px; border:1px solid rgba(255,255,255,.28); background:#0d0d10; border-radius:10px
}
#archiveDock .row .num{ font-weight:900 }
#archiveDock .row .chip{ height:26px }
#archiveDock.collapsed{ max-height:48px }
#archiveDock.open{ max-height:80vh }

/* Footer controls */
.footer-chip{
  display:inline-flex; align-items:center; gap:8px; height:34px; padding:0 12px; border-radius:999px;
  border:1px solid var(--stroke); background:#1b1f2a; color:#fff; font-weight:800
}
.footer-select{
  appearance:none; background:#10131b; border:1px solid var(--stroke); color:#fff; height:34px;
  border-radius:999px; padding:0 38px 0 12px; font-weight:800
}
.footer-label{ opacity:.9; margin-left:10px; font-size:12px }

/* Completed / In-Progress / DEV priority order */
.hero.completed{ border:2px solid #888 }            /* completed = grey */
.hero.inprogress{ border:2px solid var(--green) }   /* in-progress = green */
.hero.devstate{ border:2px solid var(--blue) }      /* DEV = blue (highest) */

/* Hero art layer */
.hero .art{ position:absolute; inset:0; z-index:0; opacity:.92; pointer-events:none; overflow:hidden; border-radius:16px }
.hero .art img{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1);
  width:auto; height:110%; min-width:110%; user-select:none; pointer-events:none;
  filter:saturate(1.02) contrast(1.02) brightness(0.95);
}
.hero::after{
  content:""; position:absolute; inset:0; border-radius:16px; pointer-events:none;
  background:linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.45) 65%, rgba(0,0,0,.6));
  z-index:1;
}

/* Hide editor-only bits when not in dev */
.hide-when-normal{ display:none }
.config-on .hide-when-normal{ display:flex }

/* In normal view hide audience line entirely unless director-on-dev (unchanged) */
.normal-hide{ display:none }
.config-on .normal-hide{ display:flex }
</style>
</head>

<body ontouchstart="">
<div class="bg" aria-hidden="true"></div>

<header class="nav" role="navigation" aria-label="Primary">
  <div class="nav-left"><span class="title-tab">Courses</span></div>
  <div class="nav-right">
    <button id="avatarTab" class="avatarTab" aria-haspopup="dialog" aria-expanded="false">
      <span class="name" id="avatarName">User</span>
      <span class="lvl" id="avatarLvl">Admin</span>
    </button>
  </div>
</header>

<main class="wrap">
  <section class="grid" id="pageGrid"></section>
</main>

<!-- Avatar Drawer -->
<div id="avatarSheet" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="panel" role="document">
    <button id="avatarClose" aria-label="Close">×</button>
    <nav class="menu-list" id="avatarMenu">
      <a href="avatar/profile.html" data-pop="Profile">Profile<span>›</span></a>
      <a href="avatar/settings.html" data-pop="Settings">Settings<span>›</span></a>
      <a href="avatar/mydata.html" data-pop="My Data">My Data<span>›</span></a>
      <a href="avatar/statistics.html" data-pop="Statistics">Statistics<span>›</span></a>
      <a href="avatar/usersearch.html" data-pop="User Search">User Search<span>›</span></a>
    </nav>
  </div>
</div>

<!-- Subsheet (courses) -->
<div id="subSheet" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="inner" role="document">
    <div class="sheet-head">
      <h2 id="sheetTitle">—</h2>
      <button class="sheet-close" id="sheetClose" aria-label="Close" type="button">×</button>
    </div>
    <iframe id="subFrame" title="Panel"></iframe>
  </div>
</div>

<!-- Footer Dock (Developer only) -->
<div id="archiveDock" class="collapsed" aria-hidden="true">
  <div class="bar">
    <div class="title">
      <span id="archiveTitle">Developer Mode</span>
      <button class="footer-chip" id="devToggle" type="button">Developer: Off</button>

      <span class="footer-label">Cols</span>
      <select id="footerCols" class="footer-select">
        <option value="1">1</option><option value="2">2</option>
        <option value="3" selected>3</option><option value="4">4</option>
      </select>
    </div>

<div class="title" style="gap:12px">
  <!-- Only one control: Archived/Close -->
  <button class="footer-chip" id="archiveToggle" type="button">Archived</button>
  <button class="footer-chip" id="addHeadingBtn" type="button">+ Heading</button>
</div>
  </div>

  <div class="content">
    <div class="list" id="archiveList"></div>
  </div>
</div>

<script>
(()=>{'use strict';

/* =========================
   Small, safe utilities
========================= */
const $ = (s,root=document)=>root.querySelector(s);
const $$= (s,root=document)=>Array.from(root.querySelectorAll(s));

// Escape any user-entered text before injecting into HTML
const esc = s => String(s ?? '')
  .replace(/&/g,'&amp;')
  .replace(/</g,'&lt;')
  .replace(/>/g,'&gt;')
  .replace(/"/g,'&quot;')
  .replace(/'/g,'&#39;');

// Safe JSON read/write
function safeParse(str, fallback){
  try{ return JSON.parse(str) }catch{ return fallback }
}
function safeSetLS(k,v){
  try{ localStorage.setItem(k, JSON.stringify(v)); return true }catch{ return false }
}
function safeGetLS(k,f){ return safeParse(localStorage.getItem(k), f) }

/* =========================
   Keys / schema versioning
========================= */
const K = {
  profile:'ao_profile',
  settings:'ao_settings',
  view:'ao_view',
  schemaVer:'ao_schema_version'
};
const SCHEMA_VERSION = 2; // bump if we change shape

// If URL has ?reset=1, clear persisted UI state
try{
  const Q=new URLSearchParams(location.search);
  if(Q.get('reset')==='1'){
    localStorage.removeItem(K.settings);
    localStorage.removeItem(K.view);
    localStorage.removeItem(K.schemaVer);
  }
}catch{}

/* =========================
   View / role helpers
========================= */
function defaultView(){ return { cols:3 }; }
function getView(){
  const raw = safeGetLS(K.view, defaultView()) || {};
  const cols = Math.min(4, Math.max(1, Number(raw.cols)||3));
  return { cols };
}
function saveView(v){
  const cols = Math.min(4, Math.max(1, Number((v && v.cols)||3)));
  safeSetLS(K.view, { cols });
  applyView();
}
function applyView(){
  const v = getView();
  const grid = document.querySelector('#pageGrid, .grid');
  if(!grid) return;
  grid.style.gridTemplateColumns = `repeat(${v.cols}, 1fr)`;
  grid.style.gap = (v.cols >= 3 ? 36 : 18) + 'px';
  document.documentElement.style.setProperty('--hero-pad', '18px');
}

const ROLE_MAP = { beginner:'bronze', intermediate:'silver', advanced:'gold' };
const ROLE_LABEL = {
  bronze:'Beginner', silver:'Intermediate', gold:'Advanced',
  support:'Support', director:'Director', admin:'Admin'
};
function normalizeRole(r){ r=String(r||'').toLowerCase(); return ROLE_MAP[r] || r; }
function baseRole(){
  const p = safeGetLS(K.profile, { skill:'admin', displayName:'User' });
  return normalizeRole(p.skill || 'admin');
}
function getRole(){ return baseRole(); }
function isAdmin(){ return getRole()==='admin'; }
function isDirector(){ return getRole()==='director'; }
function isSupport(){ return getRole()==='support'; }
function devModeOn(){ return document.body.classList.contains('config-on'); }
function canDirectorDevEdit(flag){ return isDirector() && flag?.state==='dev'; }
function seesAll(){ const r=getRole(); return r==='admin' || r==='support' || r==='director'; }
function canSeeStatusPill(){ return isAdmin() || isSupport() || isDirector(); }

/* =========================
   Avatar + drawers
========================= */
function paintAvatar(){
  const p=safeGetLS(K.profile,{displayName:'User',skill:'admin'});
  const nameEl=$('#avatarName');
  const lvlEl=$('#avatarLvl');
  const pill=$('#avatarTab');
  if(nameEl) nameEl.textContent = p.displayName || 'User';
  const role=getRole();
  const friendly = ROLE_LABEL[role] || (role.charAt(0).toUpperCase()+role.slice(1));
  if(lvlEl) lvlEl.textContent = friendly || role;
  const map={bronze:'#b87333',silver:'#c0c7d1',gold:'#ffd700',support:'#6a4cff',director:'#6a4cff',admin:'#0A84FF'};
  if(pill){
    pill.style.background = map[role] || '#222';
    pill.style.color = (role==='gold'||role==='silver'||role==='admin') ? '#0b0c10' : '#eef3ff';
  }
}

const avatarBtn=$('#avatarTab'), avatarSheet=$('#avatarSheet');
function lockBody(){
  try{
    lockBody._y = window.scrollY || document.documentElement.scrollTop || 0;
    document.body.classList.add('lock');
    document.body.style.top = `-${lockBody._y}px`;
  }catch{}
}
function unlockBody(){
  try{
    document.body.classList.remove('lock');
    document.body.style.top = '';
    window.scrollTo(0, lockBody._y||0);
  }catch{}
}
function openDrawer(){ if(!avatarSheet||!avatarBtn) return; avatarSheet.classList.add('open'); avatarSheet.setAttribute('aria-hidden','false'); avatarBtn.setAttribute('aria-expanded','true'); lockBody(); }
function closeDrawer(){ if(!avatarSheet||!avatarBtn) return; avatarSheet.classList.remove('open'); avatarSheet.setAttribute('aria-hidden','true'); avatarBtn.setAttribute('aria-expanded','false'); unlockBody(); }
if(avatarBtn) avatarBtn.addEventListener('click', openDrawer, {passive:true});
if(avatarSheet) avatarSheet.addEventListener('click', e=>{ if(e.target===avatarSheet) closeDrawer(); }, {passive:true});
document.addEventListener('click', e=>{ if(e.target && e.target.id==='avatarClose') closeDrawer(); }, {passive:true});

const subSheet=$('#subSheet'), subFrame=$('#subFrame'), sheetTitle=$('#sheetTitle');
function openSubSheet(title,url,heroId){
  if(sheetTitle) sheetTitle.textContent = title || '—';
  if(!url){ alert('401 — Not linked yet'); return; }
  const origin = encodeURIComponent(location.origin);
  const hid = encodeURIComponent(heroId||'');
  if(subFrame) subFrame.src = url + (url.includes('?')?'&':'?') + 'v=' + Date.now() + `&heroId=${hid}&parent=${origin}`;
  if(subSheet){ subSheet.classList.add('open'); subSheet.setAttribute('aria-hidden','false'); lockBody(); }
}
function closeSubSheet(){ if(subSheet && subFrame){ subSheet.classList.remove('open'); subSheet.setAttribute('aria-hidden','true'); subFrame.src='about:blank'; unlockBody(); } }
const sheetClose=$('#sheetClose');
if(sheetClose) sheetClose.addEventListener('click', closeSubSheet, {passive:true});
if(subSheet) subSheet.addEventListener('click', e=>{ if(e.target===subSheet) closeSubSheet(); }, {passive:true});
$$('#avatarSheet [data-pop]').forEach(a=>a.addEventListener('click',e=>{
  e.preventDefault(); closeDrawer(); openSubSheet(a.dataset.pop, a.getAttribute('href'));
}, {passive:false}));

/* =========================
   Settings + migration
========================= */
function numberFromId(id){ const m=String(id||'').match(/\d+/); return m?m[0]:'?'; }
function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

function defaults(){
  const heroFlags={}, pageOrder=[];
  heroFlags['co-1']={state:'live',place:'page',aud:{bronze:true,silver:false,gold:false}}; pageOrder.push({type:'hero',id:'co-1'});
  heroFlags['co-2']={state:'live',place:'page',aud:{bronze:false,silver:true,gold:false}}; pageOrder.push({type:'hero',id:'co-2'});
  heroFlags['co-3']={state:'live',place:'page',aud:{bronze:false,silver:false,gold:true}}; pageOrder.push({type:'hero',id:'co-3'});
  heroFlags['co-4']={state:'dev', place:'page',aud:{bronze:false,silver:false,gold:false}}; pageOrder.push({type:'hero',id:'co-4'});
  heroFlags['co-5']={state:'off', place:'page',aud:{bronze:true,silver:true,gold:true}};  pageOrder.push({type:'hero',id:'co-5'});
  heroFlags['co-6']={state:'off', place:'page',aud:{bronze:true,silver:true,gold:true}};  pageOrder.push({type:'hero',id:'co-6'});
  for(let i=7;i<=50;i++){ const id=`co-${i}`; heroFlags[id]={state:'off',place:'archive',aud:{bronze:true,silver:true,gold:true}}; }
  return { heroFlags, heroLabels:{}, heroAssets:{}, heroProgress:{}, heroStyle:{}, pageOrder, _seeded:true };
}

// sanitize + migrate
function sanitize(cfg){
  let c = (!cfg || typeof cfg!=='object') ? defaults() : {...cfg};
  c.heroFlags=c.heroFlags||{}; c.heroLabels=c.heroLabels||{}; c.heroAssets=c.heroAssets||{};
  c.heroProgress=c.heroProgress||{}; c.heroStyle=c.heroStyle||{}; c.pageOrder=Array.isArray(c.pageOrder)?c.pageOrder:[];
  for(let i=1;i<=50;i++){
    const id=`co-${i}`;
    if(!c.heroFlags[id]) c.heroFlags[id]={state:'off',place:'archive',aud:{bronze:true,silver:true,gold:true}};
    const onPage = c.heroFlags[id].place==='page';
    if(onPage && !c.pageOrder.some(it=>it.type==='hero' && it.id===id)) c.pageOrder.push({type:'hero',id});
  }
  if(!c.pageOrder.some(it=>it.type==='hero' && c.heroFlags[it.id]?.place==='page')){
    ['co-1','co-2','co-3','co-4','co-5','co-6'].forEach(id=>{
      if(!c.pageOrder.some(it=>it.type==='hero' && it.id===id)) c.pageOrder.push({type:'hero',id});
    });
  }
  c.pageOrder=c.pageOrder.map(it=> it.type==='divider' ? ({aud:{bronze:true,silver:true,gold:true}, ...it}) : it);
  return c;
}

// In-memory settings cache to avoid repeated LS hits
let S=null;
function loadSettings(){
  // migrate schema if needed
  const currentVer = Number(safeGetLS(K.schemaVer, 0)) || 0;
  const raw = safeGetLS(K.settings, null);
  if(currentVer !== SCHEMA_VERSION){
    S = sanitize(raw);             // migration point if needed later
    safeSetLS(K.settings, S);
    safeSetLS(K.schemaVer, SCHEMA_VERSION);
  }else{
    S = sanitize(raw);
  }
  return S;
}
function getSettings(){ return S || loadSettings(); }
function saveSettings(next){
  S = sanitize(next || S || defaults());
  safeSetLS(K.settings, S);
}

// convenience
function labelFor(id){ const s=getSettings(); const lbl = s.heroLabels[id]; return lbl ? String(lbl) : `#${numberFromId(id)}`; }

/* =========================
   Rendering (debounced)
========================= */
let rafId=null;
function queueRender(cb){
  if(cb) try{ cb() }catch{}
  if(rafId) return;
  rafId = requestAnimationFrame(()=>{ rafId=null; try{
    applyView(); paintAvatar(); paintArchive(); paintPage(); updateFooterModeControls();
  }catch(e){ console.error(e); }});
}

/* =========================
   DOM builders (escape!)
========================= */
function heroCard(id){
  const s=getSettings(); const f=s.heroFlags[id]; if(!f) return null;

  const completed = !!(s.heroProgress && s.heroProgress[id] && s.heroProgress[id].complete);
  const inprogress = !completed && !!(s.heroProgress && s.heroProgress[id] && s.heroProgress[id].inprogress);
  const art = (s.heroAssets && s.heroAssets[id] && s.heroAssets[id].heroCard) ? s.heroAssets[id].heroCard : null;

  const devOn = devModeOn();

  // NEW: show "Dev" chip (disabled) + "Photo" chip for Director on DEV (normal mode)
  const showDirectorDevChip = (isDirector() && f.state==='dev' && !devOn);

  // Status pill is hidden when we’re showing the director chip pair
  const showStatusPill = (!devOn) && canSeeStatusPill() && !showDirectorDevChip;
  const statusPill = showStatusPill ? 
    `<span class="status-pill ${
      f.state==='live'?'status-live' : (f.state==='dev'?'status-dev':'status-off')
    }">${f.state==='live'?'Live':(f.state==='dev'?'Dev':'Offline')}</span>` : '';

  // Controls visibility
  const showArchiveChip = isAdmin() && devOn;
  const showStatusChipInDev = devOn && (isAdmin() || isSupport() || isDirector()); // visible to staff in dev; admin toggles
  const statusChipDisabled = !isAdmin();
  const showPhotoChip = (isAdmin() && devOn) || (isDirector() && f.state==='dev'); // director sees Photo when hero is DEV

  // Pencil: Admin in Dev, OR Director when hero is DEV (normal mode ok)
  const showRenamePencil = (isAdmin() && devOn) || (isDirector() && f.state==='dev');

  // Audience chips: Admin+Dev OR Director-on-DEV
  const showAudienceLine = (isAdmin() && devOn) || (isDirector() && f.state==='dev');

  // Build controls (keep order so Dev chip is left of Photo)
  let ctrlsHTML = '';
  if (showDirectorDevChip || showArchiveChip || showStatusChipInDev || showPhotoChip){
    ctrlsHTML += `<div class="ctrls">`;

    // Director on DEV in normal mode: show disabled Dev chip, then Photo
    if (showDirectorDevChip){
      ctrlsHTML += `<button class="chip badge-dev" type="button" disabled>Dev</button>`;
      if (showPhotoChip){
        ctrlsHTML += `<button class="chip" data-act="pickart" type="button">Photo</button>`;
      }
    } else {
      // Dev mode controls for staff
      if(showArchiveChip){
        ctrlsHTML += `<button class="chip" data-act="move" type="button">${f.place==='page'?'Archive':'Move to Page'}</button>`;
      }
      if(showStatusChipInDev){
        const editClass = f.state==='live'?'badge-live':(f.state==='dev'?'badge-dev':'badge-off');
        const editLabel = f.state==='live'?'Live':(f.state==='dev'?'Dev':'Offline');
        ctrlsHTML += `<button class="chip ${editClass}" data-act="toggle" type="button" ${statusChipDisabled?'disabled':''}>${editLabel}</button>`;
      }
      if(showPhotoChip){
        ctrlsHTML += `<button class="chip" data-act="pickart" type="button">Photo</button>`;
      }
    }
    ctrlsHTML += `</div>`;
  }

  let btnLabel = 'Start', btnClass='blue';
  if(completed){ btnLabel='Complete'; btnClass='grey'; }
  else if(inprogress){ btnLabel='In Progress'; }

  const el=document.createElement('article'); el.className='hero'; el.dataset.heroId=id; el.dataset.place=f.place;
  const artLayer = (art && art.src) ? `<div class="art"><img alt="" src="${esc(art.src)}"></div>` : '';

  const labelColor = (s.heroStyle && s.heroStyle[id] && s.heroStyle[id].labelColor) ? `style="color:${esc(s.heroStyle[id].labelColor)}"` : '';

  el.innerHTML =
    `${artLayer}
     ${statusPill}
     ${showRenamePencil ? `<button class="cfg-pin" title="Rename" data-cfg-rename="${esc(id)}" type="button">✎</button>` : ``}
     ${(isAdmin() && devOn) ? `
       <div class="hero-arrows">
         <button class="cfg-arrow" data-sort="up" data-key="hero:${esc(id)}" type="button">▲</button>
         <button class="cfg-arrow" data-sort="down" data-key="hero:${esc(id)}" type="button">▼</button>
       </div>` : ``}
     <span class="label" ${labelColor}>${esc(labelFor(id))}</span>
     ${ctrlsHTML}
     <div class="cta-left">
       <button class="btn ${btnClass}" data-act="enter" type="button">${btnLabel}</button>
       ${(showAudienceLine) ? `
         <div class="aud-line">
           <button class="aud-chip bronze ${f.aud.bronze?'on':''}" data-aud="bronze" type="button">Beginner</button>
           <button class="aud-chip silver ${f.aud.silver?'on':''}" data-aud="silver" type="button">Intermediate</button>
           <button class="aud-chip gold   ${f.aud.gold  ?'on':''}" data-aud="gold"   type="button">Advanced</button>
         </div>` : ``}
     </div>`;

  if(showRenamePencil) el.classList.add('has-pencil');
  if(completed) el.classList.add('completed');
  else if(inprogress) el.classList.add('inprogress');
  if(f.state === 'dev') el.classList.add('devstate');

  if(art && art.crop){
    const img = el.querySelector('.art img');
    if(img){
      const cx = Number(art.crop.cx||0), cy = Number(art.crop.cy||0), sc = Number(art.crop.scale||1);
      img.style.transform = `translate(calc(-50% + ${cx}px), calc(-50% + ${cy}px)) scale(${sc})`;
    }
  }
  return el;
}

function dividerEl(obj){
  const editable = isAdmin() && devModeOn();
  const tools = editable ? 
    `<div class="dctrls">
      <button class="chip" data-div-act="rename" data-div-id="${esc(obj.id)}" type="button">Rename</button>
      <button class="chip" data-div-act="color"  data-div-id="${esc(obj.id)}" type="button">Color</button>
      <button class="chip" data-div-act="up"     data-div-id="${esc(obj.id)}" type="button">▲</button>
      <button class="chip" data-div-act="down"   data-div-id="${esc(obj.id)}" type="button">▼</button>
      <button class="chip" data-div-act="remove" data-div-id="${esc(obj.id)}" type="button">Remove</button>
    </div>` : '';

  const audLine = editable ? 
    `<div class="aud-line">
      <button class="aud-chip bronze ${obj.aud?.bronze?'on':''}" data-div-aud="bronze" data-div-id="${esc(obj.id)}" type="button">Beginner</button>
      <button class="aud-chip silver ${obj.aud?.silver?'on':''}" data-div-aud="silver" data-div-id="${esc(obj.id)}" type="button">Intermediate</button>
      <button class="aud-chip gold   ${obj.aud?.gold  ?'on':''}" data-div-aud="gold"   data-div-id="${esc(obj.id)}" type="button">Advanced</button>
    </div>` : '';

  const el=document.createElement('div'); el.className='divider'; el.dataset.type='divider'; el.dataset.divId=obj.id;
  el.innerHTML=`<span class="htext" style="${obj.color?`color:${esc(obj.color)}`:''}">${esc(obj.title||'Heading')}</span>${tools}${audLine}`;
  return el;
}

/* =========================
   Paint page + archive
========================= */
function paintPage(){
  const grid = $('#pageGrid'); 
  if(!grid) return;
  grid.innerHTML = '';
  const s = getSettings(); 
  const role = getRole();

  let currentRow = null;

  s.pageOrder.forEach(it=>{
    if(it.type==='divider'){
      // close any open row before starting a new section
      currentRow = null;

      const aud = it.aud || {bronze:true,silver:true,gold:true};
      if(!seesAll()){ if(!aud[role]) return; }

      // add the divider
      grid.appendChild(dividerEl(it));

      // new row for this heading
      currentRow = document.createElement('div');
      currentRow.className = 'row';
      grid.appendChild(currentRow);

    } else if(it.type==='hero'){
      const id = it.id; 
      const f = s.heroFlags[id]; 
      if(!f || f.place!=='page') return;

      if(!seesAll()){
        if(f.state!=='live') return;
        if(!f.aud[role]) return;
      }

      const card = heroCard(id);
      if(card){
        if(!currentRow){
          // no heading yet → put hero directly into grid
          currentRow = document.createElement('div');
          currentRow.className = 'row';
          grid.appendChild(currentRow);
        }
        currentRow.appendChild(card);
      }
    }
  });

  // Dev-only: add "Add Heading" chip at the bottom
  if(isAdmin() && devModeOn()){
    const addBtn = document.createElement('button');
    addBtn.className = 'chip';
    addBtn.textContent = '+ Add Heading';
    addBtn.dataset.divAct = 'add';
    grid.appendChild(addBtn);
  }
}

const dock=$('#archiveDock'), archiveList=$('#archiveList');
function applyArchiveVisibility(){
  if(!dock) return;
  if(isAdmin()){ dock.style.display='block'; dock.setAttribute('aria-hidden','false'); }
  else{ dock.style.display='none'; dock.setAttribute('aria-hidden','true'); }
}
function applyArchiveSkin(){
  const t=$('#archiveTitle');
  if(t) t.textContent = 'Developer Mode';
  if(dock){
    dock.style.background = 'var(--red)';
    dock.style.color = '#fff';
  }
  updateFooterModeControls();
}
function updateFooterModeControls(){
  const devOn = devModeOn();
  const btn=$('#devToggle');
  if(btn) btn.textContent = `Developer: ${devOn?'On':'Off'}`;
}
function syncFooterViewControls(){
  const v=getView();
  const sel=$('#footerCols');
  if(sel) sel.value=String(v.cols||3);
}
function paintArchive(){
  if(!archiveList) return;
  const s=getSettings(); const flags=s.heroFlags;
  archiveList.innerHTML='';
  const items=Object.entries(flags).filter(([id,f])=>f.place==='archive')
    .sort((a,b)=>Number(numberFromId(a[0]))-Number(numberFromId(b[0])));
  items.forEach(([id,f])=>{
    const row=document.createElement('div'); row.className='row'; row.dataset.heroId=id; row.dataset.place='archive';
    const statusLabel = (f.state==='live'?'Live':(f.state==='dev'?'Dev':'Offline'));
    const statusClass = (f.state==='live'?'badge-live':(f.state==='dev'?'badge-dev':'badge-off'));
    const controls = (isAdmin() && devModeOn()) ? `<div style="display:flex;gap:8px;align-items:center">
      <button class="chip" data-act="move" type="button">Move to Page</button>
      <button class="chip ${statusClass}" data-act="toggle" type="button">${statusLabel}</button>
    </div>` : `<div></div>`;
    row.innerHTML = `<span class="num">${esc(labelFor(id))}</span>${controls}`;
    archiveList.appendChild(row);
  });
}

/* =========================
   Progress wiring
========================= */
window.addEventListener('message', (evt)=>{
  try{
    const data = evt?.data || {};
    if(data && data.type==='ao-progress'){
      const s=getSettings();
      const heroId = data.heroId || (subFrame ? (new URL(subFrame.src||'about:blank')).searchParams.get('heroId') : '');
      if(!heroId || !s.heroFlags[heroId]) return;
      s.heroProgress = s.heroProgress || {};
      if(data.status==='inprogress'){
        s.heroProgress[heroId] = { inprogress:true, complete:false };
      }else if(data.status==='complete'){
        s.heroProgress[heroId] = { inprogress:false, complete:true };
      }else if(data.status==='reset'){
        delete s.heroProgress[heroId];
      }
      saveSettings(s); queueRender();
    }
  }catch(e){ console.warn('progress message ignored', e); }
}, false);

/* =========================
   Boot (guarded)
========================= */
try{
  loadSettings();
  applyView();
  paintAvatar();
  applyArchiveVisibility(); 
  applyArchiveSkin();
  paintArchive();
  paintPage();
  syncFooterViewControls();
  updateFooterModeControls();
}catch(e){
  console.error('Boot error', e);
}

/* =========================
   Footer listeners (null-safe)
========================= */
const colsEl = $('#footerCols');
if (colsEl) {
  colsEl.addEventListener('change', e=>{
    const v=getView(); v.cols=Number(e.target.value)||3; saveView(v);
  }, {passive:true});
}

const archBtn = $('#archiveToggle');
if (archBtn && dock) {
  archBtn.addEventListener('click',()=>{
    const isOpen=dock.classList.contains('open');
    dock.classList.toggle('open', !isOpen);
    dock.classList.toggle('collapsed', isOpen);
    archBtn.textContent = !isOpen ? 'Close' : 'Archived';
    if(!isOpen) lockBody(); else unlockBody();
  }, {passive:true});
}

const devBtn = $('#devToggle');
if (devBtn) {
  devBtn.addEventListener('click', ()=>{
    if(!isAdmin()) return;
    document.body.classList.toggle('config-on');
    queueRender();
  }, {passive:true});
}

/* =========================
   Main click delegation
========================= */
document.addEventListener('click',(e)=>{
  /* Enter hero */
  const actEnter = e.target.closest('[data-act="enter"]');
  if(actEnter){
    const host=e.target.closest('[data-hero-id]'); const id=host?.dataset?.heroId||'';
    const n = Number(((id||'').match(/\d+/)||[])[0]||0);
    const url = (n>=1 && n<=50) ? `courses/${n}.html` : null;
    openSubSheet(labelFor(id), url, id); return;
  }

  /* Toggle status — Admin in Dev only */
  const actToggle = e.target.closest('[data-act="toggle"]');
  if(actToggle){
    if(!(isAdmin() && devModeOn())) return;
    const host=e.target.closest('[data-hero-id], .row'); const id=host?.dataset?.heroId; if(!id) return;
    const s=getSettings(); const cur=s.heroFlags[id]; if(!cur) return;
    const order=['live','off','dev'];
    const ni=(order.indexOf(cur.state)+1)%order.length;
    s.heroFlags[id]={...cur, state:order[ni]};
    saveSettings(s); queueRender(); return;
  }

  /* Move to/from archive — Admin in Dev only */
  const actMove = e.target.closest('[data-act="move"]');
  if(actMove){
    if(!(isAdmin() && devModeOn())) return;
    const host=e.target.closest('[data-hero-id], .row'); const id=host?.dataset?.heroId; if(!id) return;
    const s=getSettings(); const cur=s.heroFlags[id]; if(!cur) return;
    const dest = (cur.place==='page') ? 'archive' : 'page';
    if(!confirm(`Move ${labelFor(id)} to ${dest==='page'?'Page':'Archive'}?`)) return;
    s.heroFlags[id]={...cur, place:dest};
    if(dest==='page'){ const exists=s.pageOrder.some(it=>it.type==='hero' && it.id===id); if(!exists) s.pageOrder.push({type:'hero',id}); }
    else{ s.pageOrder = s.pageOrder.filter(it=>!(it.type==='hero' && it.id===id)); }
    saveSettings(s); queueRender(); return;
  }

  /* Audience chips — Admin+Dev OR Director on DEV */
  const audBtn=e.target.closest('[data-aud]');
  if(audBtn){
    const hero=e.target.closest('[data-hero-id]'); const id=hero?.dataset?.heroId; if(!id) return;
    const s=getSettings(); const f=s.heroFlags[id]; if(!f) return;
    if(!((isAdmin() && devModeOn()) || canDirectorDevEdit(f))) return;
    const key=audBtn.getAttribute('data-aud');
    const nextVal=!f.aud[key];
    if(!confirm(`${nextVal?'Allow':'Disallow'} ${cap(key)} audience for ${labelFor(id)}?`)) return;
    s.heroFlags[id]={...f, aud:{...f.aud, [key]:nextVal}}; saveSettings(s);
    queueRender(); return;
  }
/* Pencil rename — Admin in Dev mode OR Director when hero is DEV */
const pin = e.target.closest('[data-cfg-rename]');
if(pin){
  const id=pin.getAttribute('data-cfg-rename'); if(!id) return;
  const s=getSettings(); const f=s.heroFlags[id]; if(!f) return;
  const allow = (isAdmin() && devModeOn()) || (isDirector() && f.state==='dev');
  if(!allow) return;

  const curLabel=s.heroLabels[id] || `#${numberFromId(id)}`;
  const next=prompt('Hero label', curLabel);
  if(next!=null){
    const v=next.trim();
    if(v) s.heroLabels[id]=v; else delete s.heroLabels[id];

    const curColor=(s.heroStyle&&s.heroStyle[id]&&s.heroStyle[id].labelColor)||'#eef3ff';
    const color=prompt('Hero title colour (CSS value, e.g. #0A84FF or #ffd700)', curColor);
    if(color!=null){
      s.heroStyle = s.heroStyle || {};
      s.heroStyle[id] = {...(s.heroStyle[id]||{}), labelColor: color.trim()};
    }
    saveSettings(s); queueRender();
  }
  return;
  }

  /* Sort arrows — Admin+Dev only */
  const sortBtn=e.target.closest('.cfg-arrow');
  if(sortBtn){
    if(!(isAdmin() && devModeOn())) return;
    const key=sortBtn.dataset.key; const s=getSettings();
    const keys = s.pageOrder.map(it=> it.type==='hero' ? `hero:${it.id}` : `div:${it.id}`);
    const from = keys.indexOf(key); if(from<0) return;
    const dir = sortBtn.dataset.sort==='up' ? -1 : 1;
    const to = Math.min(Math.max(0, from+dir), keys.length-1);
    if(to!==from){
      const objFrom = s.pageOrder.splice(from,1)[0];
      s.pageOrder.splice(to,0,objFrom);
      saveSettings(s); queueRender();
    }
    return;
  }

  /* Photo — Admin+Dev OR Director-on-DEV */
  const photoBtn=e.target.closest('[data-act="pickart"]');
  if(photoBtn){
    const host=e.target.closest('[data-hero-id]'); const id=host?.dataset?.heroId; if(!id) return;
    const s=getSettings(); const f=s.heroFlags[id]; if(!f) return;
    if(!((isAdmin() && devModeOn()) || canDirectorDevEdit(f))) return;
    const url = prompt('Image path (under /images ...)', 'images/your-folder/your-image.jpg');
    if(!url) return;
    s.heroAssets[id]={...(s.heroAssets[id]||{}), heroCard:{src:url, crop:{cx:0,cy:0,scale:1}}};
    saveSettings(s); queueRender(); return;
  }

  /* Divider tools — Admin+Dev (robust) */
  const divBtn = e.target.closest('[data-div-act]');
  if (divBtn) {
    if (!(isAdmin() && devModeOn())) return;
    const divAct = divBtn.dataset.divAct;
    const id     = divBtn.dataset.divId;
    const s      = getSettings();
    const idx = s.pageOrder.findIndex(it => it.type === 'divider' && it.id === id);
    if (idx < 0) return;

    if (divAct === 'rename') {
      const cur  = s.pageOrder[idx].title || 'Heading';
      const next = prompt('Heading title', cur);
      if (next != null) {
        s.pageOrder[idx].title = (next.trim() || 'Heading');
        const curC = s.pageOrder[idx].color || '#eef3ff';
        const color = prompt('Heading colour (CSS value, e.g. #ffd700)', curC);
        if(color!=null){ s.pageOrder[idx].color = color.trim(); }
        saveSettings(s); queueRender();
      }
      return;
    }
    if (divAct === 'color') {
      const cur = s.pageOrder[idx].color || '#eef3ff';
      const next = prompt('Heading colour (CSS value, e.g. #ffd700)', cur);
      if(next!=null){ s.pageOrder[idx].color = next.trim(); saveSettings(s); queueRender(); }
      return;
    }
    if (divAct === 'up' || divAct === 'down') {
      const dir = (divAct === 'up') ? -1 : 1;
      const to  = Math.min(Math.max(0, idx + dir), s.pageOrder.length - 1);
      if (to !== idx) {
        const obj = s.pageOrder.splice(idx, 1)[0];
        s.pageOrder.splice(to, 0, obj);
        saveSettings(s); queueRender();
      }
      return;
    }
    if (divAct === 'remove') {
      if (confirm('Remove this heading?')) {
        s.pageOrder.splice(idx, 1);
        saveSettings(s); queueRender();
      }
      return;
    }
  }

  /* Divider audience chips — Admin+Dev (robust) */
  const audDivBtn = e.target.closest('[data-div-aud]');
  if (audDivBtn) {
    if (!(isAdmin() && devModeOn())) return;
    const key = audDivBtn.dataset.divAud;
    const id  = audDivBtn.dataset.divId;
    const s   = getSettings();
    const idx = s.pageOrder.findIndex(it => it.type === 'divider' && it.id === id);
    if (idx < 0) return;

    const cur = s.pageOrder[idx].aud || { bronze:true, silver:true, gold:true };
    const nextVal = !cur[key];
    if (!confirm(`${nextVal ? 'Allow' : 'Disallow'} ${cap(key)} audience for heading "${s.pageOrder[idx].title || 'Heading'}"?`)) return;

    s.pageOrder[idx].aud = { ...cur, [key]: nextVal };
    saveSettings(s); queueRender();
    return;
  }

}, {passive:false});

/* Final state sync once more */
queueRender();

})();</script>
</body>
</html>