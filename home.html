<!DOCTYPE html>
<html lang="en-AU">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="color-scheme" content="dark" />
<title>Home — FAOA</title>
<style>
:root{
  --ink:#eef3ff; --ink-dim:#cfd3e1; --muted:rgba(238,243,255,.78);
  --bg:#000; --panel:#0a0c10; --stroke:rgba(255,255,255,.18);
  --blue:#0A84FF; --green:#32d74b; --red:#ff3b30; --chip:#1b1f2a;
  --gap:12px; --r:14px; --maxw:1240px; --nav-h:68px;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{
  height:100%;margin:0;background:var(--bg);color:var(--ink);
  font:16px -apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,sans-serif;
  overscroll-behavior-y:contain;overflow-x:hidden;user-select:none;-webkit-user-select:none;
}
a{color:inherit;text-decoration:none}
button{user-select:none;-webkit-user-select:none}
.bg{position:fixed;inset:0;z-index:-1;background:#000 url("./assets/home-bg.jpg") center/cover no-repeat}

/* Top bar */
.nav{position:fixed;top:0;left:0;right:0;height:var(--nav-h);display:flex;align-items:center;justify-content:space-between;gap:8px;
  padding:8px 12px;z-index:50;background:linear-gradient(180deg,rgba(0,0,0,.9),rgba(0,0,0,.55) 60%,rgba(0,0,0,.3));
  -webkit-backdrop-filter:blur(12px);backdrop-filter:blur(12px)}
.title-tab{font-weight:900;opacity:.92}

/* Avatar pill */
.avatarTab{display:flex;flex-direction:column;align-items:flex-start;justify-content:center;padding:6px 12px;border-radius:12px;min-width:132px;height:44px;
  font-weight:900;line-height:1.1;text-align:left;cursor:pointer;border:1px solid var(--stroke);background:#222;color:#eef3ff}
.avatarTab .name{font-size:15px;font-weight:900}
.avatarTab .lvl{font-size:12px;opacity:.95;text-transform:capitalize}

/* Layout */
.wrap{max-width:var(--maxw);margin:0 auto;padding:calc(var(--nav-h) + env(safe-area-inset-top) + 10px) 14px 160px}

/* Grid (unchanged) */
.grid{display:grid;gap:12px}
@media (max-width:600px){.grid{grid-template-columns:1fr}}
@media (min-width:601px) and (max-width:900px){.grid{grid-template-columns:1fr 1fr}}
@media (min-width:901px) and (max-width:1180px){.grid{grid-template-columns:1fr 1fr 1fr}}
@media (min-width:1181px){.grid{grid-template-columns:1fr 1fr 1fr 1fr}}

/* Config toolbar */
.cfgbar{position:sticky;top:var(--nav-h);z-index:49;background:#0d0f14;border-bottom:1px solid var(--stroke);
  display:none;align-items:center;gap:8px;padding:10px 14px}
.config-on .cfgbar{display:flex}
.cfgbtn{height:34px;padding:0 12px;border-radius:10px;border:1px solid var(--stroke);background:#161922;color:#fff;font-weight:800;cursor:pointer}
.cfgbtn.blue{background:var(--blue);border-color:transparent;color:#000}

/* Hero */
.hero{position:relative;overflow:hidden;background:#060708;border:1px solid var(--stroke);border-radius:16px;padding:16px;min-height:240px}
.hero .label{font-weight:900;font-size:18px;opacity:.95}
.ctrls{position:absolute;top:10px;right:10px;display:flex;gap:8px;z-index:5}
.chip{height:28px;padding:0 12px;border-radius:999px;border:1px solid var(--stroke);background:var(--chip);color:#fff;font-weight:800;font-size:12px;cursor:pointer}
.chip[disabled]{opacity:.55;cursor:default;filter:grayscale(.15)}
.badge-live{background:#0a0}
.badge-off{background:#b00020}
.cta-left{position:absolute;left:16px;bottom:16px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;justify-content:center;min-width:120px;height:40px;padding:0 14px;border-radius:12px;border:1px solid var(--stroke);
  font-weight:900;background:#0f1116;color:var(--ink);cursor:pointer}
.btn.blue{background:var(--blue);border-color:transparent;color:#000}

/* Audience chips */
.aud-line{display:flex;gap:8px;align-items:center}
.aud-chip{height:28px;padding:0 12px;border-radius:999px;border:1px solid var(--stroke);background:#141416;color:#fff;font-weight:800;font-size:12px;cursor:pointer;opacity:.9}
.aud-chip.on{opacity:1;filter:brightness(1.22)}
.aud-chip.on::after{content:" ✓";font-weight:900}
.aud-chip.bronze{box-shadow:inset 0 0 0 2px #b87333}
.aud-chip.silver{box-shadow:inset 0 0 0 2px #c0c7d1}
.aud-chip.gold  {box-shadow:inset 0 0 0 2px #ffd700}

/* Divider (Heading) — full grid width */
.divider{position:relative;border:1px dashed var(--stroke);border-radius:14px;background:#0b0d12;padding:14px 16px 56px;min-height:58px;
  grid-column:1 / -1;}
.divider .htext{font-weight:900;opacity:.92}
.divider .dctrls{position:absolute;top:10px;right:10px;display:none;gap:6px}
.config-on .divider .dctrls{display:flex}
.divider .aud-line{position:absolute;left:16px;bottom:14px}

/* Compact headings when NOT in config mode (tight, bottom-snapped) */
:not(.config-on) .divider{
  border:none;background:transparent;min-height:0;
  padding:0 2px 6px;margin:28px 2px 8px; /* more above, less below */
  display:flex;align-items:flex-end;
}
:not(.config-on) .divider .aud-line{display:none}
:not(.config-on) .divider .htext{padding:0;margin:0}

/* Config affordances */
.cfg-pin{display:none;position:absolute;top:10px;left:10px;width:24px;height:24px;border-radius:8px;background:#111;border:1px solid var(--stroke);
  font-size:14px;font-weight:900;color:#fff;align-items:center;justify-content:center;z-index:6}
.config-on .cfg-pin{display:flex}

/* Old arrow bar (kept for headings). New hero arrows below. */
.cfg-arrows{display:none;position:absolute;top:10px;left:42px;gap:6px;z-index:6}
.config-on .cfg-arrows{display:flex}

/* NEW: vertical hero arrows (right center) — config mode only */
.hero-arrows{display:none;position:absolute;right:10px;top:50%;transform:translateY(-50%);z-index:4;flex-direction:column;gap:6px}
.config-on .hero .hero-arrows{display:flex}
.hero-arrows .cfg-arrow{height:26px;padding:0 8px;border-radius:8px;border:1px solid var(--stroke);background:#161922;color:#fff;font-weight:900;cursor:pointer}
@media (max-width:380px){ .hero-arrows .cfg-arrow{height:24px;padding:0 6px;font-size:12px} }

/* Avatar Drawer */
#avatarSheet{position:fixed;inset:0;z-index:60;display:none;background:rgba(0,0,0,.45);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}
#avatarSheet.open{display:block}
#avatarSheet .panel{position:absolute;top:calc(var(--nav-h) + 6px);right:12px;width:320px;max-height:70vh;overflow:auto;background:#0f1116;border:1px solid var(--stroke);border-radius:14px;padding:12px}
.menu-list a{display:flex;align-items:center;justify-content:space-between;padding:12px 10px;border-bottom:1px solid rgba(255,255,255,.08)}
.menu-list a:last-child{border-bottom:none}

/* Subsheet */
#subSheet{position:fixed;inset:0;z-index:70;display:none;background:rgba(0,0,0,.55);-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px)}
#subSheet.open{display:block}
#subSheet .inner{position:absolute;top:calc(var(--nav-h) + 6px);right:12px;width:min(820px,calc(100% - 24px));height:min(78vh,calc(100% - (var(--nav-h) + 24px)));
  background:#0f1116;border:1px solid var(--stroke);border-radius:14px;padding:12px;display:flex;flex-direction:column}
.sheet-head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:4px 4px 10px}
.sheet-close{width:36px;height:36px;border-radius:10px;border:1px solid var(--stroke);background:#121212;color:#fff;font-weight:900;cursor:pointer}
#subFrame{flex:1 1 auto;width:100%;height:100%;border:none;border-radius:12px;background:#0b0c10;overflow:hidden}

/* Archive Footer */
#archiveDock{position:fixed;left:0;right:0;bottom:0;z-index:55;background:var(--red);color:#fff;border-top:1px solid rgba(255,255,255,.25);
  transition:max-height .22s ease;overflow:hidden;overscroll-behavior:contain}
#archiveDock .bar{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 14px;font-weight:900}
#archiveDock .bar .count{opacity:.95}
#archiveDock .content{background:#160b0b;max-height:calc(60vh - 48px);overflow:auto}
#archiveDock .list{padding:8px 12px 16px;display:flex;flex-direction:column;gap:8px}
#archiveDock .row{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid rgba(255,255,255,.28);background:#0d0d10;border-radius:10px}
#archiveDock .row .num{font-weight:900}
#archiveDock .row .chip{height:26px}
#archiveDock.collapsed{max-height:48px}
#archiveDock.open{max-height:60vh}

/* Lock body when drawer open */
body.lock{position:fixed;inset:0;overflow:hidden}

/* ====== ADDED: Completed visual + hero art ====== */
.hero.completed{ box-shadow: inset 0 0 0 3px var(--green), 0 0 0 1px var(--green); }
.hero .complete-tick{
  position:absolute; top:10px; left:10px; z-index:6;
  width:28px; height:28px; border-radius:999px;
  background:var(--green); color:#000; font-weight:900; display:grid; place-items:center;
  border:1px solid rgba(0,0,0,.35);
}
.hero .art{
  position:absolute; inset:0; z-index:0; opacity:.9; pointer-events:none; overflow:hidden;
  border-radius:16px;
}
.hero .art img{
  position:absolute; top:50%; left:50%;
  transform:translate(-50%,-50%) scale(1);
  width:auto; height:110%; min-width:110%;
  user-select:none; pointer-events:none;
  filter:saturate(1.02) contrast(1.02) brightness(0.95);
}
/* PATCH: stacking context for hero content (don’t disturb .cta-left) */
.hero > *:not(.art){ z-index:1; } /* no position change */
.hero .label,
.hero .ctrls,
.hero .cfg-pin,
.hero .hero-arrows{
  position:relative; /* stacking without layout shift */
  z-index:1;
}
.hero .cta-left{ /* keep anchored exactly as before */
  position:absolute;
  left:16px;
  bottom:16px;
  z-index:1;
}
.hero::after{
  content:""; position:absolute; inset:0; z-index:0;
  background:linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.45) 65%, rgba(0,0,0,.6));
  pointer-events:none; border-radius:16px;
}

/* --- Dev Mode chip/CTA placement fix --- */
.config-on .hero{ position:relative; }
.config-on .hero .cta-left{ position:absolute; left:16px; bottom:16px; z-index:3; }
.config-on .hero .ctrls{ position:absolute; top:10px; right:10px; z-index:4; }
.config-on .hero .hero-arrows{ z-index:2; }
.config-on .hero .cfg-arrows{ z-index:2; }
</style>
</head>
<body ontouchstart="">
<div class="bg" aria-hidden="true"></div>

<header class="nav" role="navigation" aria-label="Primary">
  <div class="nav-left"><span class="title-tab">Courses</span></div>
  <div class="nav-right">
    <button id="avatarTab" class="avatarTab" aria-haspopup="dialog" aria-expanded="false">
      <span class="name" id="avatarName">User</span>
      <span class="lvl" id="avatarLvl">Admin</span>
    </button>
  </div>
</header>

<!-- Config toolbar -->
<div id="cfgbar" class="cfgbar" aria-hidden="true">
  <button class="cfgbtn blue" id="addHeadingBtn" type="button">Add Heading</button>
  <button class="cfgbtn" id="exitCfgBtn" type="button">Exit Developer</button>
</div>

<main class="wrap">
  <section class="grid" id="pageGrid"></section>
</main>

<!-- Avatar Drawer -->
<div id="avatarSheet" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="panel" role="document">
    <nav class="menu-list" id="avatarMenu">
      <a href="avatar/profile.html" data-pop="Profile">Profile<span>›</span></a>
      <a href="avatar/settings.html" data-pop="Settings">Settings<span>›</span></a>
      <a href="avatar/mydata.html" data-pop="My Data">My Data<span>›</span></a>
      <a href="avatar/statistics.html" data-pop="Statistics">Statistics<span>›</span></a>
      <a href="avatar/usersearch.html" data-pop="User Search">User Search<span>›</span></a>
      <a href="#" id="cfgToggle">Developer Mode<span>⌁</span></a>
      <!-- Director Mode toggle is injected here only for Directors -->
    </nav>
  </div>
</div>

<!-- Subsheet -->
<div id="subSheet" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="inner" role="document">
    <div class="sheet-head">
      <h2 id="sheetTitle">—</h2>
      <button class="sheet-close" id="sheetClose" aria-label="Close" type="button">×</button>
    </div>
    <iframe id="subFrame" title="Panel"></iframe>
  </div>
</div>

<!-- Archive Footer (Admin/Director only) -->
<div id="archiveDock" class="collapsed" aria-hidden="true">
  <div class="bar">
    <span>Archived</span>
    <span class="count" id="countArchive">0</span>
    <button class="chip" id="archiveToggle" type="button">Open</button>
  </div>
  <div class="content">
    <div class="list" id="archiveList"></div>
  </div>
</div>

<script>
(()=>{'use strict';
/* ===== utils & storage ===== */
var $=function(s){return document.querySelector(s)};
var $$=function(s){return Array.prototype.slice.call(document.querySelectorAll(s))};
var store={
  get:function(k,f){try{var v=localStorage.getItem(k);return v?JSON.parse(v):f}catch(e){return f}},
  set:function(k,v){localStorage.setItem(k,JSON.stringify(v))}
};
var K={ profile:'ao_profile', settings:'ao_settings', directorMode:'ao_director_mode' };

/* URL reset hook */
var Q=new URLSearchParams(location.search);
if(Q.get('reset')==='1'){ localStorage.removeItem(K.settings); localStorage.removeItem(K.directorMode); }

/* Roles + Director Mode */
function getRole(){ var p=store.get(K.profile,{skill:'admin',displayName:'User'}); return (p.skill||'admin').toLowerCase(); }
function isAdmin(){ return getRole()==='admin'; }
function isDirector(){ return getRole()==='director'; }
function directorMode(){ return !!store.get(K.directorMode,false); }
function seesAll(){ var r=getRole(); return r==='admin' || r==='director' || r==='support'; }

/* Avatar paint */
function paintAvatar(){
  var p=store.get(K.profile,{displayName:'User',skill:'admin'});
  $('#avatarName').textContent = p.displayName || 'User';
  var role=(p.skill||'admin').toLowerCase();
  $('#avatarLvl').textContent = role.charAt(0).toUpperCase()+role.slice(1);
  var map={bronze:'#b87333',silver:'#c0c7d1',gold:'#ffd700',support:'#6a4cff',director:'#333',admin:'#0A84FF'};
  var pill=$('#avatarTab'); pill.style.background= map[role] || '#222';
  pill.style.color = (role==='gold'||role==='silver'||role==='admin') ? '#0b0c10' : '#eef3ff';
}
paintAvatar();

/* Build avatar menu: hide Config for non-admin; add Director Mode toggle for directors */
(function buildAvatarMenu(){
  var menu = $('#avatarMenu');
  if(!isAdmin()){
    var cfg = $('#cfgToggle'); if(cfg) cfg.style.display='none';
  }
  if(isDirector()){
    var li=document.createElement('a');
    li.href='#'; li.id='dirToggle';
    li.innerHTML='Director Mode <span>'+ (directorMode()?'On':'Off') +'</span>';
    menu.appendChild(li);
    li.addEventListener('click',function(e){
      e.preventDefault();
      var next=!directorMode();
      store.set(K.directorMode,next);
      closeDrawer();
      paintPage(); paintArchive();
    });
  }
})();

/* Mark body with admin class & hide config for non-admin */
if(isAdmin()){ document.body.classList.add('admin'); }
else{
  document.body.classList.remove('admin','config-on');
  $('#cfgbar').setAttribute('aria-hidden','true');
}

/* Avatar drawer + subsheet */
var avatarBtn=$('#avatarTab'), avatarSheet=$('#avatarSheet');
function openDrawer(){ avatarSheet.classList.add('open'); avatarSheet.setAttribute('aria-hidden','false'); avatarBtn.setAttribute('aria-expanded','true'); }
function closeDrawer(){ avatarSheet.classList.remove('open'); avatarSheet.setAttribute('aria-hidden','true'); avatarBtn.setAttribute('aria-expanded','false'); }
avatarBtn.addEventListener('click', openDrawer, {passive:true});
avatarSheet.addEventListener('click', function(e){ if(e.target===avatarSheet) closeDrawer(); }, {passive:true});

var subSheet=$('#subSheet'), subFrame=$('#subFrame'), sheetTitle=$('#sheetTitle']);
function openSubSheet(title,url){
  sheetTitle.textContent=title;
  if(!url){ alert('401 — Not linked yet'); return; }
  subFrame.src=url+(url.indexOf('?')>-1?'&':'?')+'v='+Date.now();
  subSheet.classList.add('open'); subSheet.setAttribute('aria-hidden','false');
}
function closeSubSheet(){ subSheet.classList.remove('open'); subSheet.setAttribute('aria-hidden','true'); subFrame.src='about:blank'; }
$('#sheetClose').addEventListener('click', closeSubSheet, {passive:true});
subSheet.addEventListener('click', function(e){ if(e.target===subSheet) closeSubSheet(); }, {passive:true});
$$('#avatarSheet [data-pop]').forEach(function(a){
  a.addEventListener('click',function(e){
    e.preventDefault(); closeDrawer(); openSubSheet(a.getAttribute('data-pop'), a.getAttribute('href'));
  }, {passive:false});
});

/* Config toggle — admin only */
var cfgToggleEl = $('#cfgToggle');
if(cfgToggleEl){
  cfgToggleEl.addEventListener('click', function(e){
    e.preventDefault();
    if(!isAdmin()) return;
    document.body.classList.toggle('config-on');
    var on=document.body.classList.contains('config-on');
    $('#cfgbar').setAttribute('aria-hidden', on?'false':'true');
  }, {passive:false});
}

/* ===== settings & flags ===== */
function defaults(){
  var heroFlags={}, pageOrder=[];
  for(var i=1;i<=10;i++){
    var id='co-'+i;
    heroFlags[id]={state:'live',place:'page',aud:{bronze:true,silver:true,gold:true}};
    pageOrder.push({type:'hero',id:id});
  }
  for(var j=11;j<=50;j++){
    var id2='co-'+j;
    heroFlags[id2]={state:'off',place:'archive',aud:{bronze:true,silver:true,gold:true}};
  }
  return { heroFlags:heroFlags, heroLabels:{}, pageOrder:pageOrder, _seeded:true };
}
function sanitize(cfg){
  if(!cfg || typeof cfg!=='object') return defaults();
  cfg.heroFlags=cfg.heroFlags||{};
  cfg.heroLabels=cfg.heroLabels||{};
  cfg.pageOrder=Array.isArray(cfg.pageOrder)?cfg.pageOrder:[];
  for(var i=1;i<=50;i++){
    var id='co-'+i;
    if(!cfg.heroFlags[id]) cfg.heroFlags[id]={state:'off',place:i<=10?'page':'archive',aud:{bronze:true,silver:true,gold:true}};
    var onPage = cfg.heroFlags[id] && cfg.heroFlags[id].place==='page';
    if(onPage && !cfg.pageOrder.some(function(it){return it.type==='hero' && it.id===id;})) cfg.pageOrder.push({type:'hero',id:id});
  }
  cfg.pageOrder=cfg.pageOrder.map(function(it){
    if(it.type==='divider'){
      var a=it.aud||{bronze:true,silver:true,gold:true};
      return {aud:a, id:it.id, title:it.title, type:'divider'};
    }
    return it;
  });
  return cfg;
}
function getSettings(){ return sanitize(store.get(K.settings,null) || (store.set(K.settings,defaults()), store.get(K.settings))); }
function saveSettings(s){ store.set(K.settings,sanitize(s)); }

/* SELF-HEAL if empty */
(function repairIfEmpty(){
  var s = store.get(K.settings,null);
  if(!s){ store.set(K.settings, defaults()); return; }
  var cfg = sanitize(s);
  var hasPage = cfg.pageOrder.some(function(it){ return it.type==='hero' && cfg.heroFlags[it.id] && cfg.heroFlags[it.id].place==='page'; });
  var hasArchive = Object.keys(cfg.heroFlags).some(function(key){ return cfg.heroFlags[key] && cfg.heroFlags[key].place==='archive'; });
  if(!hasPage && !hasArchive){ store.set(K.settings, defaults()); }
  else{ store.set(K.settings, cfg); }
})();

function numberFromId(id){ var m=id.match(/\d+/); return m?m[0]:'?'; }
function labelFor(id){ var s=getSettings(); return (s.heroLabels && s.heroLabels[id]) || ('#'+numberFromId(id)); }
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}

/* DOM builders */
function heroCard(id){
  var s=getSettings(); var f=s.heroFlags[id]; if(!f) return null;

  // completion + art
  var completed = !!(s.heroProgress && s.heroProgress[id] && s.heroProgress[id].complete);
  var art = (s.heroAssets && s.heroAssets[id] && s.heroAssets[id].heroCard) ? s.heroAssets[id].heroCard : null;

  // Permission booleans
  var showMove = isAdmin();
  var showLiveAdmin = isAdmin();
  var showLiveDirector = isDirector() && directorMode();
  var showAnyLive = showLiveAdmin || showLiveDirector;
  var showAudience = isAdmin() || (isDirector() && directorMode());

  // Controls HTML
  var ctrlsHTML = '';
  if(showAnyLive || showMove){
    ctrlsHTML += '<div class="ctrls">';
    if(showAnyLive){
      var label = f.state==='live'?'Live':'Offline';
      var cls   = f.state==='live'?'badge-live':'badge-off';
      var ro    = (showLiveDirector && !showLiveAdmin) ? ' disabled aria-disabled="true" ' : '';
      ctrlsHTML += '<button class="chip '+cls+'" data-act="toggle" '+ro+' type="button">'+label+'</button>';
    }
    if(showMove){
      ctrlsHTML += '<button class="chip" data-act="move" type="button">Move</button>';
    }
    ctrlsHTML += '</div>';
  }

  var el=document.createElement('article'); el.className='hero'; el.dataset.heroId=id; el.dataset.place=f.place;

  var artLayer = (art && art.src) ? '<div class="art"><img alt="" src="'+art.src+'"></div>' : '';
  var tick = completed ? '<div class="complete-tick">✓</div>' : '';

  el.innerHTML=
    artLayer+
    tick+
    '<button class="cfg-pin" title="Rename" data-cfg-rename="'+id+'" type="button">✎</button>'+
    '<div class="hero-arrows">'+
      '<button class="cfg-arrow" data-sort="up" data-key="hero:'+id+'" type="button">▲</button>'+
      '<button class="cfg-arrow" data-sort="down" data-key="hero:'+id+'" type="button">▼</button>'+
    '</div>'+
    '<span class="label">'+labelFor(id)+'</span>'+
    ctrlsHTML+
    '<div class="cta-left">'+
      '<button class="btn blue" data-act="enter" type="button">Start</button>'+
      (showAudience?(
        '<div class="aud-line">'+
          '<button class="aud-chip bronze '+(f.aud.bronze?'on':'')+'" data-aud="bronze" type="button">Bronze</button>'+
          '<button class="aud-chip silver '+(f.aud.silver?'on':'')+'" data-aud="silver" type="button">Silver</button>'+
          '<button class="aud-chip gold   '+(f.aud.gold?'on':'')+'" data-aud="gold"   type="button">Gold</button>'+
        '</div>'
      ):'')+
    '</div>';

  if(completed) el.classList.add('completed');

  // crop offsets if present
  if(art && art.crop){
    var img = el.querySelector('.art img');
    if(img){
      var cx = Number(art.crop.cx||0), cy = Number(art.crop.cy||0), sc = Number(art.crop.scale||1);
      img.style.transform = 'translate(calc(-50% + '+cx+'px), calc(-50% + '+cy+'px)) scale('+sc+')';
    }
  }

  return el;
}

function dividerEl(obj){
  var tools = isAdmin() ? (
    '<div class="dctrls">'+
      '<button class="cfgbtn" data-div-act="rename" data-div-id="'+obj.id+'" type="button">Rename</button>'+
      '<button class="cfgbtn" data-div-act="up" data-div-id="'+obj.id+'" type="button">▲</button>'+
      '<button class="cfgbtn" data-div-act="down" data-div-id="'+obj.id+'" type="button">▼</button>'+
      '<button class="cfgbtn" data-div-act="remove" data-div-id="'+obj.id+'" type="button">Remove</button>'+
    '</div>'
  ) : '';

  var aud = obj.aud || {bronze:true,silver:true,gold:true};
  var audLine = isAdmin() ? (
    '<div class="aud-line">'+
      '<button class="aud-chip bronze '+(aud.bronze?'on':'')+'" data-div-aud="bronze" data-div-id="'+obj.id+'" type="button">Bronze</button>'+
      '<button class="aud-chip silver '+(aud.silver?'on':'')+'" data-div-aud="silver" data-div-id="'+obj.id+'" type="button">Silver</button>'+
      '<button class="aud-chip gold   '+(aud.gold?'on':'')+'" data-div-aud="gold" data-div-id="'+obj.id+'" type="button">Gold</button>'+
    '</div>'
  ) : '';

  var el=document.createElement('div'); el.className='divider'; el.dataset.type='divider'; el.dataset.divId=obj.id;
  el.innerHTML='<span class="htext">'+(obj.title||'Heading')+'</span>'+tools+audLine;
  return el;
}

/* Paint page respecting visibility */
function paintPage(){
  var grid=$('#pageGrid'); grid.innerHTML='';
  var s=getSettings(); var role=getRole();
  s.pageOrder.forEach(function(it){
    if(it.type==='hero'){
      var id=it.id; var f=s.heroFlags[id]; if(!f || f.place!=='page') return;
      if(!seesAll()){
        if(f.state!=='live') return;
        if(!f.aud[role]) return;
      }
      grid.appendChild(heroCard(id));
    }else if(it.type==='divider'){
      var aud=it.aud || {bronze:true,silver:true,gold:true};
      if(!seesAll()){ if(!aud[role]) return; }
      grid.appendChild(dividerEl(it));
    }
  });
  var dirItem = $('#dirToggle'); if(dirItem){ dirItem.querySelector('span').textContent = directorMode()?'On':'Off'; }
}

/* Archive footer visibility (Admin OR Director) */
var dock=$('#archiveDock'), archiveList=$('#archiveList'), countArchive=$('#countArchive']);
function applyArchiveVisibility(){
  if(isAdmin() || isDirector()){ dock.style.display='block'; dock.setAttribute('aria-hidden','false'); }
  else{ dock.style.display='none'; dock.setAttribute('aria-hidden','true'); }
}
applyArchiveVisibility();

/* Archive list */
function paintArchive(){
  var s=getSettings(); var flags=s.heroFlags;
  archiveList.innerHTML='';
  var items=Object.keys(flags).map(function(key){return [key,flags[key]];})
    .filter(function(pair){return pair[1].place==='archive'})
    .sort(function(a,b){return Number(numberFromId(a[0]))-Number(numberFromId(b[0]));});
  countArchive.textContent=items.length;
  items.forEach(function(pair){
    var id=pair[0], f=pair[1];
    var controls =
      '<div style="display:flex;gap:8px;align-items:center">'+
        ((isAdmin() || (isDirector()&&directorMode()))
          ? '<button class="chip '+(f.state==='live'?'badge-live':'badge-off')+'" '+(isAdmin()?'':'disabled aria-disabled="true"')+' data-act="toggle" type="button">'+(f.state==='live'?'Live':'Offline')+'</button>'
          : '')+
        (isAdmin()?'<button class="chip" data-act="move" type="button">Move to Page</button>':'')+
      '</div>';
    var row=document.createElement('div'); row.className='row'; row.dataset.heroId=id; row.dataset.place='archive';
    row.innerHTML='<span class="num">'+labelFor(id)+'</span>'+controls;
    archiveList.appendChild(row);
  });
}
paintArchive();

/* Archive open/close + body lock */
var savedScrollY=0;
function lockBody(){ savedScrollY=window.scrollY; document.body.classList.add('lock'); document.body.style.top='-'+savedScrollY+'px'; }
function unlockBody(){ document.body.classList.remove('lock'); document.body.style.top=''; window.scrollTo(0,savedScrollY); }
$('#archiveToggle').addEventListener('click',function(){
  var isOpen=dock.classList.contains('open');
  dock.classList.toggle('open', !isOpen);
  dock.classList.toggle('collapsed', isOpen);
  $('#archiveToggle').textContent = !isOpen ? 'Close' : 'Open';
  if(!isOpen) lockBody(); else unlockBody();
}, {passive:true});

/* Config toolbar */
function uuidId(){return 'div_'+Math.random().toString(36).slice(2,9);}
$('#addHeadingBtn').addEventListener('click',function(){
  if(!isAdmin()) return;
  var title=prompt('Heading title','Section'); if(title==null) return;
  var s=getSettings(); s.pageOrder.push({type:'divider', id:uuidId(), title:title.trim()||'Section', aud:{bronze:true,silver:true,gold:true}});
  saveSettings(s); paintPage();
}, {passive:false});
$('#exitCfgBtn').addEventListener('click',function(){ document.body.classList.remove('config-on'); $('#cfgbar').setAttribute('aria-hidden','true'); }, {passive:true});

/* Click handlers with confirmations */
document.addEventListener('click',function(e){
  // Start (open course)
  var enterBtn = e.target.closest ? e.target.closest('[data-act="enter"]') : null;
  if(enterBtn){
    var host = e.target.closest('[data-hero-id]');
    var id = host && host.dataset ? host.dataset.heroId : '';
    var num = Number(((id||'').match(/\d+/)||[])[0]||0);
    var path = (num>=1 && num<=50) ? 'courses/'+num+'.html' : null;
    if(path){ openSubSheet(labelFor(id), path); return; }
    openSubSheet('Course '+labelFor(id), null); return;
  }
  // Live toggle (Admin only)
  var tog = e.target.closest ? e.target.closest('[data-act="toggle"]') : null;
  if(tog){
    if(!isAdmin()) return;
    var host2 = e.target.closest('[data-hero-id], .row'); var id2 = host2 && host2.dataset ? host2.dataset.heroId : null;
    var s=getSettings(); var cur=s.heroFlags[id2];
    var next = cur.state==='live' ? 'off' : 'live';
    if(!confirm('Are you sure you want to set this to '+(next==='live'?'LIVE':'OFFLINE')+'?')) return;
    s.heroFlags[id2]={state:next, place:cur.place, aud:cur.aud};
    saveSettings(s); paintPage(); paintArchive(); return;
  }
  // Move (page<->archive) — Admin only
  var mv = e.target.closest ? e.target.closest('[data-act="move"]') : null;
  if(mv){
    if(!isAdmin()) return;
    var host3=e.target.closest('[data-hero-id], .row'); var id3=host3 && host3.dataset ? host3.dataset.heroId : null;
    var s2=getSettings(); var cur2=s2.heroFlags[id3];
    var dest = (cur2.place==='page') ? 'archive' : 'page';
    if(!confirm('Move '+labelFor(id3)+' to '+(dest==='page'?'Page':'Archive')+'?')) return;
    s2.heroFlags[id3]={state:cur2.state, place:dest, aud:cur2.aud};
    if(dest==='page'){
      var exists=s2.pageOrder.some(function(it){return it.type==='hero' && it.id===id3;});
      if(!exists) s2.pageOrder.push({type:'hero',id:id3});
    } else {
      s2.pageOrder = s2.pageOrder.filter(function(it){return !(it.type==='hero' && it.id===id3);});
    }
    saveSettings(s2); paintPage(); paintArchive(); return;
  }
  // Audience chips on heroes — Admin OR Director (Director Mode)
  var audBtn=e.target.closest ? e.target.closest('[data-aud]') : null;
  if(audBtn){
    if(!(isAdmin() || (isDirector() && directorMode()))) return;
    var key=audBtn.getAttribute('data-aud');
    var hero=e.target.closest('[data-hero-id]'); var idh=hero && hero.dataset ? hero.dataset.heroId : null;
    var s3=getSettings(); var cur3=s3.heroFlags[idh]; var nextVal=!cur3.aud[key];
    if(!confirm((nextVal?'Allow':'Disallow')+' '+cap(key)+' audience for '+labelFor(idh)+'?')) return;
    var newAud={bronze:cur3.aud.bronze, silver:cur3.aud.silver, gold:cur3.aud.gold}; newAud[key]=nextVal;
    s3.heroFlags[idh]={state:cur3.state, place:cur3.place, aud:newAud}; saveSettings(s3);
    paintPage(); paintArchive(); return;
  }
  // Audience chips on headings — Admin only
  if(e.target.getAttribute && e.target.getAttribute('data-div-aud')){
    if(!isAdmin()) return;
    var key2=e.target.getAttribute('data-div-aud'); var idd=e.target.getAttribute('data-div-id');
    var s4=getSettings(); var idx=s4.pageOrder.findIndex(function(it){return it.type==='divider' && it.id===idd;}); if(idx<0) return;
    var curAud=s4.pageOrder[idx].aud || {bronze:true,silver:true,gold:true}; var nextVal2=!curAud[key2];
    if(!confirm((nextVal2?'Allow':'Disallow')+' '+cap(key2)+' audience for heading "'+(s4.pageOrder[idx].title||'Heading')+'"?')) return;
    var newAud2={bronze:!!curAud.bronze, silver:!!curAud.silver, gold:!!curAud.gold}; newAud2[key2]=nextVal2;
    s4.pageOrder[idx]={type:'divider', id:s4.pageOrder[idx].id, title:s4.pageOrder[idx].title, aud:newAud2};
    saveSettings(s4); paintPage(); return;
  }
  // Rename hero label — Admin only
  if(e.target.matches && e.target.matches('[data-cfg-rename]')){
    if(!isAdmin()) return;
    var idr=e.target.getAttribute('data-cfg-rename');
    var s5=getSettings(); var curLabel=(s5.heroLabels && s5.heroLabels[idr]) || ('#'+numberFromId(idr));
    var nextLabel=prompt('Hero label', curLabel);
    if(nextLabel!=null){
      var v=nextLabel.trim();
      if(!s5.heroLabels) s5.heroLabels={};
      if(v) s5.heroLabels[idr]=v; else delete s5.heroLabels[idr];
      saveSettings(s5); paintPage(); paintArchive();
    }
    return;
  }
  // Divider actions — Admin only
  if(e.target.getAttribute && e.target.getAttribute('data-div-act')){
    if(!isAdmin()) return;
    var idd2=e.target.getAttribute('data-div-id'); var s6=getSettings();
    var idx2=s6.pageOrder.findIndex(function(it){return it.type==='divider' && it.id===idd2;}); if(idx2<0) return;
    var act=e.target.getAttribute('data-div-act');
    if(act==='rename'){
      var nextTitle=prompt('Heading title', s6.pageOrder[idx2].title||'Heading');
      if(nextTitle!=null){ s6.pageOrder[idx2].title=(nextTitle.trim()||'Heading'); saveSettings(s6); paintPage(); }
    }else if(act==='remove'){
      if(confirm('Remove this heading?')){ s6.pageOrder.splice(idx2,1); saveSettings(s6); paintPage(); }
    }else if(act==='up' || act==='down'){
      var to = act==='up' ? Math.max(0, idx2-1) : Math.min(s6.pageOrder.length-1, idx2+1);
      if(to!==idx2){ var it=s6.pageOrder.splice(idx2,1)[0]; s6.pageOrder.splice(to,0,it); saveSettings(s6); paintPage(); }
    }
    return;
  }
  // Hero sort arrows — Admin only
  if(e.target.matches && e.target.matches('.cfg-arrow')){
    if(!isAdmin()) return;
    var keySort=e.target.getAttribute('data-key'); var s7=getSettings();
    var keys = s7.pageOrder.map(function(it){return it.type==='hero' ? ('hero:'+it.id) : ('div:'+it.id);});
    var from = keys.indexOf(keySort); if(from<0) return;
    var dir = e.target.getAttribute('data-sort')==='up' ? -1 : 1;
    var to2 = Math.min(Math.max(0, from+dir), keys.length-1);
    if(to2!==from){
      var objFrom = s7.pageOrder[from];
      s7.pageOrder.splice(from,1);
      s7.pageOrder.splice(to2,0,objFrom);
      saveSettings(s7); paintPage();
    }
    return;
  }
}, {passive:false});

/* Initial render */
paintPage(); paintArchive();
})();
</script>
</body>
</html>