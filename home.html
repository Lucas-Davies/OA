<script>
(()=>{'use strict';
/* ===== utils & storage ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const store = {
  get:(k,f)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):f}catch{return f}},
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))
};
const K = { profile:'ao_profile', settings:'ao_settings', directorMode:'ao_director_mode', view:'ao_view', viewAs:'ao_view_as' };

/* URL reset hook */
const Q = new URLSearchParams(location.search);
if(Q.get('reset')==='1'){
  localStorage.removeItem(K.settings);
  localStorage.removeItem(K.directorMode);
  localStorage.removeItem(K.view);
  localStorage.removeItem(K.viewAs);
}

/* ===== View settings ===== */
function defaultView(){ return { cols:3 }; }
function getView(){
  const raw = store.get(K.view, defaultView()) || {};
  const cols = Math.min(4, Math.max(1, Number(raw.cols) || 3));
  return { cols };
}
function saveView(v){
  const cols = Math.min(4, Math.max(1, Number((v && v.cols) || 3)));
  store.set(K.view, { cols });
  applyView();
}
function applyView(){
  const v = getView();
  const grid = document.querySelector('#pageGrid, .grid');
  if(!grid) return;
  grid.style.gridTemplateColumns = `repeat(${v.cols}, 1fr)`;
  grid.style.gap = (v.cols >= 3 ? 36 : 18) + 'px';
  document.documentElement.style.setProperty('--hero-pad', '18px');
}

/* ===== Roles, labels & colors ===== */
const ROLE_LABEL = {
  bronze:'Beginner', silver:'Intermediate', gold:'Advanced',
  support:'Support', director:'Director', admin:'Admin'
};
const ROLE_COLORS = {
  bronze:{chip:'#b87333', text:'#0b0c10'},
  silver:{chip:'#c0c7d1', text:'#0b0c10'},
  gold:{chip:'#ffd700', text:'#0b0c10'},
  support:{chip:'#6a4cff', text:'#eef3ff'},
  director:{chip:'#ffd60a', text:'#0b0c10'},
  admin:{chip:'#0A84FF', text:'#0b0c10'}
};

/* Base role from profile + View-as override */
function baseRole(){
  const p = store.get(K.profile, { skill:'admin', displayName:'User' });
  const skill = (p.skill || 'admin').toLowerCase();
  return ['bronze','silver','gold','support','director','admin'].includes(skill) ? skill : 'admin';
}
function viewOverride(){
  const v = (store.get(K.viewAs, '') || '').toLowerCase();
  return ['bronze','silver','gold','support','director','admin'].includes(v) ? v : '';
}
function getRole(){ return viewOverride() || baseRole(); }
function isAdmin(){ return getRole()==='admin'; }
function isDirector(){ return getRole()==='director'; }
function isSupport(){ return getRole()==='support'; }
function directorMode(){ return !!store.get(K.directorMode,false); }
function seesAll(){ const r=getRole(); return r==='admin'||r==='director'||r==='support'; }

/* Avatar paint */
function paintAvatar(){
  const p = store.get(K.profile, { displayName:'User', skill:'admin' });
  const role = getRole();
  const friendly = ROLE_LABEL[role] || role;
  $('#avatarName').textContent = p.displayName || 'User';
  $('#avatarLvl').textContent  = friendly;
  const colors = ROLE_COLORS[role] || {chip:'#222', text:'#eef3ff'};
  const pill = $('#avatarTab');
  pill.style.background = colors.chip;
  pill.style.color      = colors.text;
}

/* ===== Settings (courses) ===== */
function defaults(){
  const heroFlags = {}, pageOrder = [];
  for(let i=1;i<=10;i++){
    const id = `co-${i}`;
    heroFlags[id] = { state:'live', place:'page', aud:{bronze:true,silver:true,gold:true} };
    pageOrder.push({ type:'hero', id });
  }
  for(let i=11;i<=50;i++){
    const id = `co-${i}`;
    heroFlags[id] = { state:'off', place:'archive', aud:{bronze:true,silver:true,gold:true} };
  }
  return { heroFlags, heroLabels:{}, heroAssets:{}, heroProgress:{}, pageOrder, _seeded:true };
}
function sanitize(cfg){
  let c = (!cfg || typeof cfg!=='object') ? defaults() : {...cfg};
  c.heroFlags=c.heroFlags||{}; c.heroLabels=c.heroLabels||{}; c.heroAssets=c.heroAssets||{};
  c.heroProgress=c.heroProgress||{}; c.pageOrder=Array.isArray(c.pageOrder)?c.pageOrder:[];
  for(let i=1;i<=50;i++){
    const id=`co-${i}`;
    if(!c.heroFlags[id]) c.heroFlags[id]={state:'off',place:i<=10?'page':'archive',aud:{bronze:true,silver:true,gold:true}};
    const onPage = c.heroFlags[id].place==='page';
    if(onPage && !c.pageOrder.some(it=>it.type==='hero' && it.id===id)) c.pageOrder.push({type:'hero',id});
  }
  const hasPage = c.pageOrder.some(it=>it.type==='hero' && c.heroFlags[it.id]?.place==='page');
  if(!hasPage){
    for(let i=1;i<=10;i++){
      const id=`co-${i}`;
      c.heroFlags[id]={state:'live',place:'page',aud:{bronze:true,silver:true,gold:true}};
      if(!c.pageOrder.some(it=>it.type==='hero' && it.id===id)) c.pageOrder.push({type:'hero',id});
    }
  }
  c.pageOrder=c.pageOrder.map(it=> it.type==='divider' ? ({aud:{bronze:true,silver:true,gold:true}, ...it}) : it);
  return c;
}
function getSettings(){ return sanitize(store.get(K.settings,null) || (store.set(K.settings,defaults()), store.get(K.settings))); }
function saveSettings(s){ store.set(K.settings, sanitize(s)); }

/* Helpers */
function numberFromId(id){ const m = id.match(/\d+/); return m?m[0]:'?'; }
function labelFor(id){ const s=getSettings(); return s.heroLabels[id] || `#${numberFromId(id)}`; }
function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

/* ===== Footer Dock (visibility + skin) ===== */
const dock = $('#archiveDock'), archiveList = $('#archiveList'), countArchive = $('#countArchive');

function applyArchiveVisibility(){
  const r = getRole();
  if(r==='admin' || r==='director'){ dock.style.display='block'; dock.setAttribute('aria-hidden','false'); }
  else{ dock.style.display='none'; dock.setAttribute('aria-hidden','true'); }
}

function applyArchiveSkin(){
  const role = getRole();
  $('#archiveTitle').textContent = role==='director' ? 'Director Mode' : 'Developer Mode';
  if(role==='director'){
    dock.style.background = '#ffd60a';
    dock.style.color      = '#000';
    $('#dirModeToggle').style.display = 'inline-flex';
    $('#devToggle').style.display     = 'none';
    document.body.classList.remove('config-on');
  }else{
    dock.style.background = 'var(--red)';
    dock.style.color      = '#fff';
    $('#dirModeToggle').style.display = 'none';
    $('#devToggle').style.display     = 'inline-flex';
    document.body.classList.remove('dir-on');
  }
  updateFooterModeControls();
}

function updateFooterModeControls(){
  const devOn = document.body.classList.contains('config-on');
  if($('#devToggle').style.display!=='none'){
    $('#devToggle').textContent = `Developer: ${devOn ? 'On' : 'Off'}`;
  }
  if($('#dirModeToggle').style.display!=='none'){
    const dirOn = document.body.classList.contains('dir-on') && directorMode();
    $('#dirModeToggle').textContent = `Director: ${dirOn ? 'On' : 'Off'}`;
  }
  $('#addHeadingBtn').style.display = (isAdmin() && devOn) ? 'inline-flex' : 'none';
}

/* ===== Cards / DOM builders ===== */
function heroCard(id){
  const s=getSettings(); const f=s.heroFlags[id]; if(!f) return null;

  const completed  = !!(s.heroProgress && s.heroProgress[id] && s.heroProgress[id].complete);
  const inprogress = !completed && !!(s.heroProgress && s.heroProgress[id] && s.heroProgress[id].inprogress);
  const art = (s.heroAssets && s.heroAssets[id] && s.heroAssets[id].heroCard) ? s.heroAssets[id].heroCard : null;

  const devOn = document.body.classList.contains('config-on');
  const dirOn = document.body.classList.contains('dir-on') && directorMode();
  const canEdit = (isAdmin() && devOn) || (isDirector() && dirOn);

  const role = getRole();
  const showPill = (role==='admin' || role==='director' || role==='support') ||
                   (f.state==='dev' && (role==='admin' || role==='director'));

  const statusPill = showPill ? 
    `<span class="status-pill ${f.state==='live'?'status-live':(f.state==='dev'?'status-dev':'status-off')}">
       ${f.state==='live'?'Live':(f.state==='dev'?'Dev':'Offline')}
     </span>` : '';

  let ctrlsHTML = '';
  if(canEdit){
    const editClass = f.state==='live'?'badge-live':(f.state==='dev'?'badge-dev':'badge-off');
    const editLabel = f.state==='live'?'Live':(f.state==='dev'?'Dev':'Offline');
    ctrlsHTML += `<div class="ctrls hide-when-normal">`;
    ctrlsHTML += `<button class="chip ${editClass}" data-act="toggle" type="button">${editLabel}</button>`;
    if(isAdmin()) ctrlsHTML += `<button class="chip" data-act="move" type="button">Archive</button>`;
    ctrlsHTML += `<button class="chip" data-act="pickart" type="button">Photo</button>`;
    ctrlsHTML += `</div>`;
  }

  let btnLabel='Start', btnClass='blue';
  if(completed){ btnLabel='Complete'; btnClass='grey'; }
  else if(inprogress){ btnLabel='In Progress'; }

  const el = document.createElement('article'); el.className='hero'; el.dataset.heroId=id; el.dataset.place=f.place;
  const artLayer = (art && art.src) ? `<div class="art"><img alt="" src="${art.src}"></div>` : '';

  el.innerHTML = `
    ${artLayer}
    ${statusPill}
    <button class="cfg-pin hide-when-normal" title="Rename" data-cfg-rename="${id}" type="button">✎</button>
    <div class="hero-arrows hide-when-normal">
      <button class="cfg-arrow" data-sort="up" data-key="hero:${id}" type="button">▲</button>
      <button class="cfg-arrow" data-sort="down" data-key="hero:${id}" type="button">▼</button>
    </div>
    <span class="label">${labelFor(id)}</span>
    ${ctrlsHTML}
    <div class="cta-left">
      <button class="btn ${btnClass}" data-act="enter" type="button">${btnLabel}</button>
      ${canEdit ? `
        <div class="aud-line">
          <button class="aud-chip bronze ${f.aud.bronze?'on':''}" data-aud="bronze" type="button">Beginner</button>
          <button class="aud-chip silver ${f.aud.silver?'on':''}" data-aud="silver" type="button">Intermediate</button>
          <button class="aud-chip gold   ${f.aud.gold  ?'on':''}" data-aud="gold"   type="button">Advanced</button>
        </div>` : ``}
    </div>`;

  if(completed) el.classList.add('completed');
  else if(inprogress) el.classList.add('inprogress');

  if(art && art.crop){
    const img = el.querySelector('.art img');
    if(img){
      const cx = Number(art.crop.cx||0), cy = Number(art.crop.cy||0), sc = Number(art.crop.scale||1);
      img.style.transform = `translate(calc(-50% + ${cx}px), calc(-50% + ${cy}px)) scale(${sc})`;
    }
  }
  return el;
}

function dividerEl(obj){
  const devOn = document.body.classList.contains('config-on');
  const dirOn = document.body.classList.contains('dir-on') && directorMode();
  const canEdit = (isAdmin() && devOn) || (isDirector() && dirOn);

  const tools = (canEdit && isAdmin()) ? `
    <div class="dctrls">
      <button class="chip" data-div-act="rename" data-div-id="${obj.id}" type="button">Rename</button>
      <button class="chip" data-div-act="up" data-div-id="${obj.id}" type="button">▲</button>
      <button class="chip" data-div-act="down" data-div-id="${obj.id}" type="button">▼</button>
      <button class="chip" data-div-act="remove" data-div-id="${obj.id}" type="button">Remove</button>
    </div>` : '';

  const audLine = canEdit ? `
    <div class="aud-line">
      <button class="aud-chip bronze ${obj.aud?.bronze?'on':''}" data-div-aud="bronze" data-div-id="${obj.id}" type="button">Beginner</button>
      <button class="aud-chip silver ${obj.aud?.silver?'on':''}" data-div-aud="silver" data-div-id="${obj.id}" type="button">Intermediate</button>
      <button class="aud-chip gold   ${obj.aud?.gold  ?'on':''}" data-div-aud="gold"   data-div-id="${obj.id}" type="button">Advanced</button>
    </div>` : '';

  const el = document.createElement('div'); el.className='divider'; el.dataset.type='divider'; el.dataset.divId=obj.id;
  el.innerHTML = `<span class="htext">${obj.title||'Heading'}</span>${tools}${audLine}`;
  return el;
}

/* Paint page */
function paintPage(){
  const grid = $('#pageGrid'); grid.innerHTML='';
  applyView(); paintAvatar();
  const s=getSettings(); const role=getRole();
  s.pageOrder.forEach(it=>{
    if(it.type==='hero'){
      const id=it.id; const f=s.heroFlags[id]; if(!f || f.place!=='page') return;
      if(!seesAll()){
        if(f.state!=='live') return;
        if(!f.aud[role]) return;
      }
      grid.appendChild(heroCard(id));
    }else if(it.type==='divider'){
      const aud=it.aud || {bronze:true,silver:true,gold:true};
      if(!seesAll() && !aud[role]) return;
      grid.appendChild(dividerEl(it));
    }
  });
}

/* Footer view controls */
function syncFooterViewControls(){
  const v=getView();
  const el=$('#footerCols'); if(el) el.value=String(v.cols||3);
}
syncFooterViewControls();
$('#footerCols')?.addEventListener('change', e=>{ const v=getView(); v.cols=Number(e.target.value)||3; saveView(v); }, {passive:true});

/* View-as override */
$('#viewAs')?.addEventListener('change', e=>{
  store.set(K.viewAs, e.target.value||'');
  paintAvatar(); paintPage(); applyArchiveSkin();
},{passive:true});

/* Archive list */
function paintArchive(){
  const s=getSettings(); const flags=s.heroFlags;
  archiveList.innerHTML='';
  const items = Object.entries(flags).filter(([id,f])=>f.place==='archive')
    .sort((a,b)=>Number(numberFromId(a[0]))-Number(numberFromId(b[0])));
  countArchive.textContent = items.length;
  items.forEach(([id,f])=>{
    const row=document.createElement('div'); row.className='row'; row.dataset.heroId=id; row.dataset.place='archive';
    const controls = `
      <div style="display:flex;gap:8px;align-items:center">
        ${isAdmin()?`<button class="chip" data-act="move" type="button">Move to Page</button>`:''}
      </div>`;
    row.innerHTML = `<span class="num">${labelFor(id)}</span>${controls}`;
    archiveList.appendChild(row);
  });
}
paintArchive();

/* Archive open/close + body lock */
let savedScrollY=0;
function lockBody(){ savedScrollY=window.scrollY; document.body.classList.add('lock'); document.body.style.top=`-${savedScrollY}px`; }
function unlockBody(){ document.body.classList.remove('lock'); document.body.style.top=''; window.scrollTo(0,savedScrollY); }
$('#archiveToggle')?.addEventListener('click',()=>{
  const isOpen=dock.classList.contains('open');
  dock.classList.toggle('open', !isOpen);
  dock.classList.toggle('collapsed', isOpen);
  $('#archiveToggle').textContent = !isOpen ? 'Close' : 'Open';
  if(!isOpen) lockBody(); else unlockBody();
},{passive:true});

/* Footer mode toggle handlers */
$('#devToggle')?.addEventListener('click', ()=>{
  if(!['admin','director'].includes(baseRole())) return;
  document.body.classList.toggle('config-on');
  if(document.body.classList.contains('config-on')) document.body.classList.remove('dir-on');
  updateFooterModeControls(); paintPage();
},{passive:true});

$('#dirModeToggle')?.addEventListener('click', ()=>{
  if(baseRole()!=='director') return;
  const next=!directorMode();
  store.set(K.directorMode,next);
  document.body.classList.toggle('dir-on', next);
  if(next) document.body.classList.remove('config-on');
  updateFooterModeControls(); paintPage(); paintArchive(); applyArchiveSkin();
},{passive:true});

/* Add Heading (footer) */
function uuidId(){return 'div_'+Math.random().toString(36).slice(2,9);}
$('#addHeadingBtn')?.addEventListener('click',()=>{
  if(!isAdmin() || !document.body.classList.contains('config-on')) return;
  const title=prompt('Heading title','Section'); if(title==null) return;
  const s=getSettings(); s.pageOrder.push({type:'divider', id:uuidId(), title:(title.trim()||'Section'), aud:{bronze:true,silver:true,gold:true}});
  saveSettings(s); paintPage();
},{passive:false});

/* Page click handlers */
document.addEventListener('click',(e)=>{
  // Enter (open course)
  if(e.target.closest('[data-act="enter"]')){
    const host=e.target.closest('[data-hero-id]'); const id=host?.dataset?.heroId||'';
    const n = Number(((id||'').match(/\d+/)||[])[0]||0);
    const url = (n>=1 && n<=50) ? `courses/${n}.html` : null;
    if(url) openSubSheet(labelFor(id), url);
    return;
  }
  // Cycle status (admin/director while tools on): live → off → dev → live
  if(e.target.closest('[data-act="toggle"]')){
    const devOn = document.body.classList.contains('config-on');
    const dirOn = document.body.classList.contains('dir-on') && directorMode();
    if(!((isAdmin() && devOn) || (isDirector() && dirOn))) return;
    const host=e.target.closest('[data-hero-id], .row'); const id=host.dataset.heroId;
    const s=getSettings(); const cur=s.heroFlags[id];
    const order=['live','off','dev'];
    const ni=(order.indexOf(cur.state)+1)%order.length;
    s.heroFlags[id]={...cur, state:order[ni]};
    saveSettings(s); paintPage(); paintArchive();
    return;
  }
  // Move to/from archive (admin + dev only)
  if(e.target.closest('[data-act="move"]')){
    if(!(isAdmin() && document.body.classList.contains('config-on'))) return;
    const host=e.target.closest('[data-hero-id], .row');
    const id=host.dataset.heroId; const s=getSettings(); const cur=s.heroFlags[id];
    const dest = (cur.place==='page') ? 'archive' : 'page';
    if(!confirm(`Move ${labelFor(id)} to ${dest==='page'?'Page':'Archive'}?`)) return;
    s.heroFlags[id]={...cur, place:dest};
    if(dest==='page'){
      const exists=s.pageOrder.some(it=>it.type==='hero' && it.id===id);
      if(!exists) s.pageOrder.push({type:'hero',id});
    }else{
      s.pageOrder = s.pageOrder.filter(it=>!(it.type==='hero' && it.id===id));
    }
    saveSettings(s); paintPage(); paintArchive();
    return;
  }
  // Audience chips — only while editor tools are on
  const audBtn=e.target.closest('[data-aud]');
  if(audBtn){
    const devOn = document.body.classList.contains('config-on');
    const dirOn = document.body.classList.contains('dir-on') && directorMode();
    if(!((isAdmin() && devOn) || (isDirector() && dirOn))) return;
    const key=audBtn.getAttribute('data-aud');
    const hero=e.target.closest('[data-hero-id]'); const id=hero.dataset.heroId;
    const s=getSettings(); const cur=s.heroFlags[id]; const nextVal=!cur.aud[key];
    if(!confirm(`${nextVal?'Allow':'Disallow'} ${cap(key)} audience for ${labelFor(id)}?`)) return;
    s.heroFlags[id]={...cur, aud:{...cur.aud, [key]:nextVal}}; saveSettings(s);
    paintPage(); paintArchive();
    return;
  }
  // Divider audience
  if(e.target.dataset.divAud){
    const devOn = document.body.classList.contains('config-on');
    const dirOn = document.body.classList.contains('dir-on') && directorMode();
    if(!((isAdmin() && devOn) || (isDirector() && dirOn))) return;
    const key=e.target.dataset.divAud; const id=e.target.dataset.divId;
    const s=getSettings(); const idx=s.pageOrder.findIndex(it=>it.type==='divider' && it.id===id); if(idx<0) return;
    const cur=s.pageOrder[idx].aud || {bronze:true,silver:true,gold:true}; const nextVal=!cur[key];
    if(!confirm(`${nextVal?'Allow':'Disallow'} ${cap(key)} audience for heading "${s.pageOrder[idx].title||'Heading'}"?`)) return;
    s.pageOrder[idx].aud={...cur,[key]:nextVal}; saveSettings(s); paintPage();
    return;
  }
  // Rename hero (admin + dev)
  if(e.target.matches('[data-cfg-rename]')){
    if(!(isAdmin() && document.body.classList.contains('config-on'))) return;
    const id=e.target.getAttribute('data-cfg-rename');
    const s=getSettings(); const cur=s.heroLabels[id] || `#${numberFromId(id)}`;
    const next=prompt('Hero label', cur);
    if(next!=null){
      const v=next.trim();
      if(v) s.heroLabels[id]=v; else delete s.heroLabels[id];
      saveSettings(s); paintPage(); paintArchive();
    }
    return;
  }
  // Sort arrows (admin + dev)
  if(e.target.matches('.cfg-arrow')){
    if(!(isAdmin() && document.body.classList.contains('config-on'))) return;
    const key=e.target.dataset.key; const s=getSettings();
    const keys = s.pageOrder.map(it=> it.type==='hero' ? `hero:${it.id}` : `div:${it.id}`);
    const from = keys.indexOf(key); if(from<0) return;
    const dir = e.target.dataset.sort==='up' ? -1 : 1;
    const to = Math.min(Math.max(0, from+dir), keys.length-1);
    if(to!==from){
      const objFrom = s.pageOrder[from];
      s.pageOrder.splice(from,1);
      s.pageOrder.splice(to,0,objFrom);
      saveSettings(s); paintPage();
    }
    return;
  }
  // Pick hero art (admin + dev)
  if(e.target.closest('[data-act="pickart"]')){
    if(!(isAdmin() && document.body.classList.contains('config-on'))) return;
    const host=e.target.closest('[data-hero-id]'); const id=host.dataset.heroId;
    const url = prompt('Image path (under /images ...)', 'images/your-folder/your-image.jpg'); if(!url) return;
    const s=getSettings(); s.heroAssets[id]={...(s.heroAssets[id]||{}), heroCard:{src:url, crop:{cx:0,cy:0,scale:1}}};
    saveSettings(s); paintPage(); return;
  }
},{passive:false});

/* Avatar drawer & subsheet */
const avatarBtn=$('#avatarTab'), avatarSheet=$('#avatarSheet');
function openDrawer(){ avatarSheet.classList.add('open'); avatarSheet.setAttribute('aria-hidden','false'); avatarBtn.setAttribute('aria-expanded','true'); document.body.classList.add('lock'); }
function closeDrawer(){ avatarSheet.classList.remove('open'); avatarSheet.setAttribute('aria-hidden','true'); avatarBtn.setAttribute('aria-expanded','false'); document.body.classList.remove('lock'); }
avatarBtn?.addEventListener('click', openDrawer, {passive:true});
avatarSheet?.addEventListener('click', e=>{ if(e.target===avatarSheet) closeDrawer(); }, {passive:true});
document.addEventListener('click', e=>{ if(e.target && e.target.id==='avatarClose') closeDrawer(); }, {passive:true});

const subSheet=$('#subSheet'), subFrame=$('#subFrame'), sheetTitle=$('#sheetTitle');
function openSubSheet(title,url){
  sheetTitle.textContent=title;
  if(!url){ alert('401 — Not linked yet'); return; }
  subFrame.src=url+(url.includes('?')?'&':'?')+'v='+Date.now();
  subSheet.classList.add('open'); subSheet.setAttribute('aria-hidden','false');
  document.body.classList.add('lock');
}
function closeSubSheet(){ subSheet.classList.remove('open'); subSheet.setAttribute('aria-hidden','true'); subFrame.src='about:blank'; document.body.classList.remove('lock'); }
$('#sheetClose')?.addEventListener('click', closeSubSheet, {passive:true});
subSheet?.addEventListener('click', e=>{ if(e.target===subSheet) closeSubSheet(); }, {passive:true});
$$('#avatarSheet [data-pop]').forEach(a=>a.addEventListener('click',e=>{
  e.preventDefault(); closeDrawer(); openSubSheet(a.dataset.pop, a.getAttribute('href'));
},{passive:false}));

/* Initial render */
applyView();
paintAvatar();
paintPage();
paintArchive();
applyArchiveVisibility();
applyArchiveSkin();
updateFooterModeControls();
syncFooterViewControls();
})();
</script>