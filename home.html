<!DOCTYPE html>
<html lang="en-AU">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="color-scheme" content="dark" />
<title>Home — FAOA</title>

<!-- Optional Google Fonts (safe fallbacks included if blocked) -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;800&family=Playfair+Display:wght@700&family=Oswald:wght@500&family=Anton&family=Lobster&family=Pacifico&family=Bangers&family=Baloo+2:wght@700&display=swap" rel="stylesheet">

<style>
:root{
  --ink:#eef3ff; --ink-dim:#cfd3e1; --muted:rgba(238,243,255,.78);
  --bg:#000; --panel:#0a0c10; --stroke:rgba(255,255,255,.18);
  --blue:#0A84FF; --green:#32d74b; --red:#ff3b30; --chip:#1b1f2a;
  --gap:12px; --r:14px; --maxw:1240px; --nav-h:68px; --hero-pad:16px;
}

/* Resets / base */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{
  height:100%; margin:0; background:var(--bg); color:var(--ink);
  font:16px -apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,sans-serif;
  overscroll-behavior-y:contain; overflow-x:hidden; user-select:none; -webkit-user-select:none;
}
a{ color:inherit; text-decoration:none }
button{ user-select:none; -webkit-user-select:none; cursor:pointer }
body.lock{ position:fixed; width:100% }

/* Background */
.bg{ position:fixed; inset:0; z-index:-1; background:#000 url("./assets/home-bg.jpg") center/cover no-repeat }

/* Top bar */
.nav{
  position:fixed; top:0; left:0; right:0; height:var(--nav-h);
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  padding:8px 12px; z-index:50;
  background:linear-gradient(180deg,rgba(0,0,0,.9),rgba(0,0,0,.55) 60%,rgba(0,0,0,.3));
  -webkit-backdrop-filter:blur(12px); backdrop-filter:blur(12px);
}
.title-tab{ font-weight:900; opacity:.92 }

/* Avatar pill */
.avatarTab{
  display:flex; flex-direction:column; align-items:flex-start; justify-content:center;
  padding:6px 12px; border-radius:12px; min-width:132px; height:44px;
  font-weight:900; line-height:1.1; text-align:left; border:1px solid var(--stroke);
  background:#222; color:#eef3ff;
}
.avatarTab .name{ font-size:15px; font-weight:900 }
.avatarTab .lvl{ font-size:12px; opacity:.95; text-transform:capitalize }

/* Avatar drawer */
#avatarSheet{
  position:fixed; inset:0; z-index:80; display:none;
  background:rgba(0,0,0,.55); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px)
}
#avatarSheet.open{ display:flex }
#avatarCard{
  margin:auto; width:min(420px,92vw); background:#0f1116; border:1px solid var(--stroke); border-radius:14px; padding:14px;
}
#avatarCard h3{ margin:0 0 12px; font-weight:900 }
#avatarClose{ float:right; }

/* Layout */
.wrap{ max-width:var(--maxw); margin:0 auto; padding:calc(var(--nav-h) + env(safe-area-inset-top) + 10px) 14px 160px }

/* Sections */
.section{ margin:32px 0 }
.section .divider{ margin-bottom:10px }

/* Row carousels */
.section .grid{
  display:grid;
  grid-auto-flow:column;
  grid-auto-columns:clamp(180px, 28vw, 280px);
  gap:var(--gap);
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  padding-bottom:10px;
}
.section .grid::-webkit-scrollbar{ display:none }

/* Hero cards */
.hero{
  position:relative; overflow:hidden; background:#060708; border:1px solid var(--stroke);
  border-radius:16px; padding:var(--hero-pad); aspect-ratio:1/1; scroll-snap-align:start;
}
.hero.devstate{ border:2px solid var(--blue) }

/* Labels */
.hero .label{
  font-weight:900; font-size:18px; opacity:.95; position:absolute; top:14px; left:16px; z-index:2
}

/* Pencil (used only inside divider controls now) */
.cfg-pin{
  width:28px; height:28px; border-radius:8px;
  border:1px solid var(--stroke); background:#121212; color:#fff; font-weight:900; line-height:1;
}

/* Kebab on heroes (admin+dev) */
.ctrls{ position:absolute; top:10px; right:10px; z-index:6; display:flex; align-items:center; gap:8px }
.kebab{ background:#121212; border:1px solid var(--stroke); border-radius:8px; width:28px; height:28px; font-weight:900; color:#fff }
.kebab-menu{
  position:absolute; top:40px; right:0; background:#1b1f2a; border:1px solid var(--stroke); border-radius:10px;
  display:none; flex-direction:column; min-width:150px; z-index:20; padding:6px;
}
.kebab-menu button{
  background:none; border:none; color:#fff; padding:8px 10px; text-align:left; font-weight:700; cursor:pointer; border-radius:8px;
}
.kebab-menu button:hover{ background:#2a2f3a }

/* Hero reorder arrows (Admin + Dev only) */
.hero-arrows{
  display:none;
  position:absolute; right:8px; top:50%; transform:translateY(-50%);
  z-index:6; flex-direction:column; align-items:center; justify-content:center; gap:10px;
}
.config-on .hero .hero-arrows{ display:flex }
.hero-arrows .cfg-arrow{
  width:32px; height:32px; border-radius:8px; border:1px solid var(--stroke);
  background:#161922; color:#fff; font-weight:900; font-size:14px; line-height:1;
}

/* Status pill (normal mode) */
.status-pill{
  position:absolute; top:12px; right:12px; height:28px; padding:0 12px; border-radius:999px;
  display:inline-flex; align-items:center; font-weight:900; z-index:4; border:1px solid rgba(255,255,255,.18)
}
.status-live{ background:#1c6b1c; color:#fff }
.status-off{ background:#5a0d12; color:#fff }
.status-dev{ background:var(--blue); color:#000; border-color:transparent }

/* Buttons */
.btn{
  display:inline-flex; align-items:center; justify-content:center; min-width:120px; height:40px; padding:0 14px;
  border-radius:12px; border:1px solid var(--stroke); font-weight:900; background:#0f1116; color:var(--ink)
}
.btn.blue{ background:var(--blue); border-color:transparent; color:#000 }
.btn.grey{ background:#3a3a3a; color:#fff; border-color:var(--stroke) }

/* CTA + audience */
.cta-left{ position:absolute; left:16px; bottom:16px; display:flex; flex-direction:column; align-items:flex-start; gap:8px; z-index:2 }
.aud-line{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
.aud-chip{
  height:28px; padding:0 12px; border-radius:999px; border:1px solid var(--stroke);
  background:#141416; color:#fff; font-weight:800; font-size:12px; opacity:.9
}
.aud-chip.on{ opacity:1; filter:brightness(1.22) }
.aud-chip.on::after{ content:" ✓"; font-weight:900 }
.aud-chip.bronze{ box-shadow:inset 0 0 0 2px #b87333 }
.aud-chip.silver{ box-shadow:inset 0 0 0 2px #c0c7d1 }
.aud-chip.gold{   box-shadow:inset 0 0 0 2px #ffd700 }

/* Divider (Heading) */
.divider{
  position:relative; border:1px dashed var(--stroke); border-radius:14px; background:#0b0d12;
  padding:14px 16px 56px; min-height:58px; margin:18px 0;
}
.divider .htext{ font-weight:900; opacity:.92 }
.divider .dctrls{
  position:absolute; top:10px; right:10px; display:none; gap:6px; align-items:center;
}
.config-on .divider .dctrls{ display:flex }
/* only style the old left pencil if it exists as a direct child (we've removed it) */
.divider > .cfg-pin{ position:absolute; top:10px; left:12px }

/* Divider audience row */
.divider .aud-line{ position:absolute; left:16px; bottom:14px }

/* Compact headings in normal mode */
:not(.config-on) .divider{ border:none; background:transparent; min-height:0; padding:0 2px 6px; margin:28px 2px 8px; display:flex; align-items:flex-end }
:not(.config-on) .divider .aud-line{ display:none }
:not(.config-on) .divider .htext{ padding:0; margin:0 }

/* Footer Dock (Developer only) */
#archiveDock{
  position:fixed; left:0; right:0; bottom:0; z-index:75; background:var(--red); color:#fff; border-top:1px solid rgba(255,255,255,.25);
  transition:max-height .22s ease; overflow:hidden; overscroll-behavior:contain
}
#archiveDock .bar{
  display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 14px; font-weight:900;
  overflow-x:auto; white-space:nowrap
}
#archiveDock .bar::-webkit-scrollbar{ display:none }
#archiveDock .title{ display:inline-flex; align-items:center; gap:8px }
#archiveDock .content{ background:#160b0b; max-height:calc(60vh - 48px); overflow:auto }
#archiveDock .list{ padding:8px 12px 16px; display:flex; flex-direction:column; gap:8px }
#archiveDock .row{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:10px 12px; border:1px solid rgba(255,255,255,.28); background:#0d0d10; border-radius:10px
}
#archiveDock .row .num{ font-weight:900 }
#archiveDock.collapsed{ max-height:48px }
#archiveDock.open{ max-height:80vh }

.footer-chip{
  display:inline-flex; align-items:center; gap:8px; height:34px; padding:0 12px; border-radius:999px;
  border:1px solid var(--stroke); background:#1b1f2a; color:#fff; font-weight:800
}
.footer-label{ opacity:.9; margin-left:10px; font-size:12px }

/* Completed/In-Progress flags */
.hero.completed{ border:2px solid #888 }
.hero.inprogress{ border:2px solid var(--green) }

/* Hero art layer */
.hero .art{ position:absolute; inset:0; z-index:0; opacity:.92; pointer-events:none; overflow:hidden; border-radius:16px }
.hero .art img{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1);
  width:auto; height:110%; min-width:110%; user-select:none; pointer-events:none;
  filter:saturate(1.02) contrast(1.02) brightness(0.95);
}
.hero::after{
  content:""; position:absolute; inset:0; border-radius:16px; pointer-events:none;
  background:linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.45) 65%, rgba(0,0,0,.6));
  z-index:1;
}

/* Visibility helpers */
.hide-when-normal{ display:none }
.config-on .hide-when-normal{ display:flex }
.normal-hide{ display:none }
.config-on .normal-hide{ display:flex }

/* Edit dialog */
#editDialog{
  position:fixed; inset:0; z-index:90; display:none; align-items:center; justify-content:center;
  background:rgba(0,0,0,.55); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px)
}
#editDialog.open{ display:flex }
#editPanel{
  width:min(560px, 92vw); background:#0f1116; border:1px solid var(--stroke); border-radius:14px; padding:14px;
}
#editPanel h3{ margin:0 0 10px; font-weight:900 }
#editPanel .row{ display:flex; gap:10px; align-items:center; margin:10px 0; flex-wrap:wrap }
#editPanel input[type="text"]{
  flex:1; min-width:200px; background:#12141a; border:1px solid var(--stroke); color:#fff; height:36px; border-radius:10px; padding:0 10px; font-weight:700
}
.palette{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px }
.swatch{
  width:28px; height:28px; border-radius:8px; border:1px solid rgba(255,255,255,.2); cursor:pointer;
}
.actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:12px }
#fontControls{ display:flex; align-items:center; gap:8px }
.fontBtn{
  width:36px; height:36px; border-radius:10px; border:1px solid var(--stroke);
  background:#12141a; color:#fff; font-weight:900; font-size:16px;
}
#fontFamily{
  background:#12141a; color:#fff; border:1px solid var(--stroke); height:36px; border-radius:10px; padding:0 10px; font-weight:700;
  max-width:280px;
}
.preview{
  width:100%; border:1px dashed var(--stroke); border-radius:10px; padding:10px; margin-top:4px; background:#0b0d12; font-weight:900
}
</style>
</head>

<body ontouchstart="">
<div class="bg" aria-hidden="true"></div>

<header class="nav" role="navigation" aria-label="Primary">
  <div class="nav-left"><span class="title-tab">Courses</span></div>
  <div class="nav-right">
    <button id="avatarTab" class="avatarTab" aria-haspopup="dialog" aria-expanded="false">
      <span class="name" id="avatarName">User</span>
      <span class="lvl" id="avatarLvl">Admin</span>
    </button>
  </div>
</header>

<main class="wrap">
  <div id="pageGrid"></div>
</main>

<!-- Avatar Drawer -->
<div id="avatarSheet" aria-hidden="true">
  <div id="avatarCard" role="dialog" aria-modal="true" aria-labelledby="avatarTitle">
    <button id="avatarClose" class="footer-chip" type="button">Close</button>
    <h3 id="avatarTitle">Profile</h3>
    <div style="display:flex;flex-direction:column;gap:8px">
      <div><strong>Name:</strong> <span id="drawerName">User</span></div>
      <div><strong>Role:</strong> <span id="drawerRole">Admin</span></div>
      <div class="hide-when-normal" style="gap:8px;display:flex">
        <button id="drawerToggleDev" class="footer-chip" type="button">Toggle Developer</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Dialog -->
<div id="editDialog" aria-modal="true" role="dialog">
  <div id="editPanel" role="document">
    <h3 id="editTitle">Edit</h3>

    <div class="row">
      <input id="editText" type="text" placeholder="Title">
    </div>

    <div class="row">
      <div style="font-weight:800">Colour:</div>
      <div class="palette" id="editPalette"></div>
    </div>

    <div class="row" id="fontControls">
      <div style="font-weight:800">Font:</div>
      <select id="fontFamily">
        <!-- sensible defaults + fun display faces -->
        <option value="system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif">System Sans</option>
        <option value="Inter,system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif">Inter</option>
        <option value="ui-serif,Georgia,'Times New Roman',serif">Serif</option>
        <option value="Playfair Display,Georgia,'Times New Roman',serif">Playfair Display</option>
        <option value="Oswald,Arial Narrow,Arial,sans-serif">Oswald</option>
        <option value="Anton,Impact,Haettenschweiler,Arial Narrow Bold,sans-serif">Anton</option>
        <option value="Lobster,'Brush Script MT',cursive">Lobster</option>
        <option value="Pacifico,'Brush Script MT',cursive">Pacifico</option>
        <option value="Bangers,Impact,Haettenschweiler,'Arial Narrow Bold',sans-serif">Bangers</option>
        <option value="Baloo 2,Arial Rounded MT Bold,Arial,sans-serif">Baloo 2</option>
        <option value="ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace">Monospace</option>
      </select>
      <button class="fontBtn" id="fontDown" type="button" aria-label="Decrease font size">A–</button>
      <button class="fontBtn" id="fontUp"   type="button" aria-label="Increase font size">A+</button>
      <span id="fontSizeLabel" style="opacity:.9;min-width:48px;text-align:right"></span>
    </div>

    <div class="row">
      <div class="preview" id="editPreview">Preview</div>
    </div>

    <div class="actions">
      <button class="footer-chip" id="editCancel">Cancel</button>
      <button class="footer-chip" id="editSave">Save</button>
    </div>
  </div>
</div>

<!-- Footer Dock (Developer only) -->
<div id="archiveDock" class="collapsed" aria-hidden="true">
  <div class="bar">
    <div class="title">
      <span id="archiveTitle">Developer Mode</span>
      <button class="footer-chip" id="devToggle" type="button">Developer: Off</button>
      <button class="footer-chip hide-when-normal" id="addHeadingBtn" type="button">Add Heading</button>
    </div>
    <div class="title" style="gap:12px">
      <button class="footer-chip" id="archiveToggle" type="button">Archived</button>
    </div>
  </div>
  <div class="content">
    <div class="list" id="archiveList"></div>
  </div>
</div>

<script>
(()=>{'use strict';

/* =========================
   Utils / storage
========================= */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const store={
  get:(k,f)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):f }catch{ return f } },
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))
};
const K={ profile:'ao_profile', settings:'ao_settings', view:'ao_view', schemaVer:'ao_schema_version' };
const SCHEMA_VERSION=5;

/* Escape */
const esc=s=>String(s??'')
  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
  .replace(/"/g,'&quot;').replace(/'/g,'&#39;');

/* =========================
   Roles
========================= */
const ROLE_MAP = { beginner:'bronze', intermediate:'silver', advanced:'gold' };
const ROLE_LABEL = {
  bronze:'Beginner', silver:'Intermediate', gold:'Advanced',
  support:'Support', director:'Director', admin:'Admin'
};
function normalizeRole(r){ r=String(r||'').toLowerCase(); return ROLE_MAP[r] || r; }
function baseRole(){
  const p = store.get(K.profile, { skill:'admin', displayName:'User' });
  return normalizeRole(p.skill || 'admin');
}
function getRole(){ return baseRole(); }
function isAdmin(){ return getRole()==='admin'; }
function isDirector(){ return getRole()==='director'; }
function isSupport(){ return getRole()==='support'; }
function devModeOn(){ return document.body.classList.contains('config-on'); }
function canDirectorDevEdit(flag){ return isDirector() && flag?.state==='dev'; }
function seesAll(){ const r=getRole(); return r==='admin' || r==='support' || r==='director'; }
function canSeeStatusPill(){ return isAdmin() || isSupport() || isDirector(); }

/* =========================
   Settings + seed
========================= */
function numberFromId(id){ const m=String(id||'').match(/\d+/); return m?m[0]:'?'; }
function defaults(){
  const heroFlags={}, pageOrder=[];
  heroFlags['co-1']={state:'live', place:'page', aud:{bronze:true,silver:false,gold:false}};
  heroFlags['co-2']={state:'live', place:'page', aud:{bronze:false,silver:true,gold:false}};
  heroFlags['co-3']={state:'live', place:'page', aud:{bronze:false,silver:false,gold:true}};
  heroFlags['co-4']={state:'dev',  place:'page', aud:{bronze:false,silver:false,gold:false}};
  for(let i=5;i<=12;i++) heroFlags[`co-${i}`]={state:'off', place:'archive', aud:{bronze:true,silver:true,gold:true}};
  pageOrder.push({type:'hero',id:'co-1'},{type:'hero',id:'co-2'},{type:'hero',id:'co-3'},{type:'hero',id:'co-4'});
  return { heroFlags, heroLabels:{}, heroAssets:{}, heroProgress:{}, heroStyle:{}, pageOrder, _seeded:true };
}
function sanitize(cfg){
  let c = (!cfg || typeof cfg!=='object') ? defaults() : {...cfg};
  c.heroFlags=c.heroFlags||{}; c.heroLabels=c.heroLabels||{}; c.heroAssets=c.heroAssets||{};
  c.heroProgress=c.heroProgress||{}; c.heroStyle=c.heroStyle||{}; c.pageOrder=Array.isArray(c.pageOrder)?c.pageOrder:[];
  for(let i=1;i<=50;i++){
    const id=`co-${i}`;
    if(!c.heroFlags[id]) c.heroFlags[id]={state:'off',place:'archive',aud:{bronze:true,silver:true,gold:true}};
  }
  c.pageOrder = c.pageOrder.filter(it=> it && (it.type==='hero'||it.type==='divider'));
  Object.keys(c.heroFlags).forEach(id=>{
    if(c.heroFlags[id].place==='page' && !c.pageOrder.some(it=>it.type==='hero' && it.id===id)){
      c.pageOrder.push({type:'hero', id});
    }
  });
  return c;
}
function loadSettings(){
  const ver = Number(store.get(K.schemaVer, 0))||0;
  const raw = store.get(K.settings, null);
  const s = sanitize(raw);
  if(ver!==SCHEMA_VERSION){ store.set(K.settings, s); store.set(K.schemaVer, SCHEMA_VERSION); }
  return s;
}
let S = loadSettings();
function getSettings(){ return S; }
function saveSettings(next){ S = sanitize(next||S); store.set(K.settings,S); }

/* =========================
   Avatar
========================= */
function paintAvatar(){
  const p=store.get(K.profile,{displayName:'User',skill:'admin'});
  $('#avatarName').textContent = p.displayName || 'User';
  const role=getRole();
  $('#avatarLvl').textContent = ROLE_LABEL[role] || role;
  $('#drawerName').textContent = p.displayName || 'User';
  $('#drawerRole').textContent = ROLE_LABEL[role] || role;
}
paintAvatar();

/* Drawer wiring */
(function wireAvatarDrawer(){
  const avatarBtn = $('#avatarTab');
  const sheet = $('#avatarSheet');
  const closeBtn = $('#avatarClose');
  const toggleDev = $('#drawerToggleDev');

  function openDrawer(){
    sheet.classList.add('open');
    sheet.setAttribute('aria-hidden','false');
    avatarBtn.setAttribute('aria-expanded','true');
    lockBody();
  }
  function closeDrawer(){
    sheet.classList.remove('open');
    sheet.setAttribute('aria-hidden','true');
    avatarBtn.setAttribute('aria-expanded','false');
    unlockBody();
  }
  avatarBtn?.addEventListener('click', openDrawer, {passive:true});
  closeBtn?.addEventListener('click', closeDrawer, {passive:true});
  sheet?.addEventListener('click', e=>{ if(e.target===sheet) closeDrawer(); }, {passive:true});
  toggleDev?.addEventListener('click', ()=>{
    if(!isAdmin()) return;
    document.body.classList.toggle('config-on');
    updateFooterModeControls(); paintPage(); paintArchive();
  }, {passive:true});
})();

/* =========================
   Label helpers
========================= */
function labelFor(id){ const s=getSettings(); return s.heroLabels[id] || `#${numberFromId(id)}`; }
function styleFor(id){
  const st=(getSettings().heroStyle||{})[id]||{};
  return {
    color: st.labelColor || '',
    font:  st.labelFont  || "system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif",
    size:  Number(st.labelSize||18)
  };
}

/* =========================
   Edit dialog (text+color+font)
========================= */
const paletteColors = [
  '#eef3ff','#cfd3e1','#ffffff','#000000','#808080',
  '#0A84FF','#32d74b','#ff3b30','#ffd700','#b87333',
  '#c0c7d1','#6a4cff','#ff9f0a','#64d2ff','#ff2d55'
];

let editCtx=null;
let liveFont=18, liveColor='', liveFamily="system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif";

function applyPreview(){
  const pv = $('#editPreview');
  pv.style.color = liveColor||'';
  pv.style.fontFamily = liveFamily;
  pv.style.fontSize = liveFont+'px';
  pv.textContent = $('#editText').value || 'Preview';
  $('#fontSizeLabel').textContent = liveFont+'px';
}

function openEditDialog(ctx, currentText, currentColor, currentSize=18, currentFamily="system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif"){
  editCtx = ctx;
  $('#editTitle').textContent = (ctx.type==='hero'?'Edit Hero':'Edit Heading');
  $('#editText').value = currentText||'';

  // palette
  const pal = $('#editPalette'); pal.innerHTML='';
  paletteColors.forEach(col=>{
    const b=document.createElement('button');
    b.type='button'; b.className='swatch'; b.style.background=col; b.dataset.col=col;
    b.addEventListener('click',()=>{ liveColor=col; applyPreview(); }, {passive:true});
    pal.appendChild(b);
  });

  // font controls
  liveFont = Math.max(10, Math.min(64, Number(currentSize||18)));
  liveColor = currentColor || '';
  liveFamily = currentFamily || "system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif";
  $('#fontFamily').value = liveFamily;

  $('#fontFamily').onchange = ()=>{ liveFamily = $('#fontFamily').value; applyPreview(); };
  $('#fontUp').onclick   = ()=>{ liveFont = Math.min(64, liveFont+1); applyPreview(); };
  $('#fontDown').onclick = ()=>{ liveFont = Math.max(10, liveFont-1); applyPreview(); };

  applyPreview();
  $('#editDialog').classList.add('open');
}
function closeEditDialog(){ $('#editDialog').classList.remove('open'); editCtx=null; }
$('#editCancel').addEventListener('click', closeEditDialog);
$('#editDialog').addEventListener('click', e=>{ if(e.target===e.currentTarget) closeEditDialog(); }, {passive:true});
$('#editSave').addEventListener('click', ()=>{
  if(!editCtx) return;
  const s=getSettings();
  const text = $('#editText').value.trim();

  if(editCtx.type==='hero'){
    if(text){ s.heroLabels[editCtx.id]=text } else { delete s.heroLabels[editCtx.id] }
    s.heroStyle = s.heroStyle || {};
    s.heroStyle[editCtx.id] = {
      ...(s.heroStyle[editCtx.id]||{}),
      labelColor: liveColor,
      labelSize:  liveFont,
      labelFont:  liveFamily
    };
  }else{ // divider
    const idx = s.pageOrder.findIndex(it=>it.type==='divider' && it.id===editCtx.id);
    if(idx>=0){
      s.pageOrder[idx].title = text || 'Heading';
      s.pageOrder[idx].color = liveColor || '';
      s.pageOrder[idx].fontSize = liveFont;
      s.pageOrder[idx].fontFamily = liveFamily;
    }
  }
  saveSettings(s);
  paintPage(); paintArchive();
  closeEditDialog();
});

/* =========================
   DOM builders
========================= */
function heroCard(id){
  const s=getSettings(); const f=s.heroFlags[id]; if(!f) return null;

  const completed = !!(s.heroProgress && s.heroProgress[id] && s.heroProgress[id].complete);
  const inprogress = !completed && !!(s.heroProgress && s.heroProgress[id] && s.heroProgress[id].inprogress);
  const art = (s.heroAssets && s.heroAssets[id] && s.heroAssets[id].heroCard) ? s.heroAssets[id].heroCard : null;
  const devOn = devModeOn();

  const showStatusPill = (!devOn) && canSeeStatusPill();
  const statusPill = showStatusPill ? 
    `<span class="status-pill ${f.state==='live'?'status-live':(f.state==='dev'?'status-dev':'status-off')}">
      ${f.state==='live'?'Live':(f.state==='dev'?'Dev':'Offline')}
     </span>` : '';

  const canAdminDev = isAdmin() && devOn;
  const canDirOnDev = canDirectorDevEdit(f);

  /* HERO PENCIL REMOVED (rename via kebab only) */
  const st = styleFor(id);
  const labelInline = ` style="color:${esc(st.color)};font-family:${esc(st.font)};font-size:${st.size}px"`;

  const el=document.createElement('article'); 
  el.className='hero'; 
  el.dataset.heroId=id; 
  el.dataset.place=f.place;
  if(f.state==='dev') el.classList.add('devstate');

  const artLayer = (art && art.src) ? `<div class="art"><img alt="" src="${esc(art.src)}"></div>` : '';

  const kebabHTML = canAdminDev ? `
    <button class="kebab" aria-haspopup="true" aria-expanded="false">⋮</button>
    <div class="kebab-menu">
      <button data-menu="rename">Rename</button>
      <button data-menu="move">${f.place==='page'?'Archive':'Move to Page'}</button>
      <button data-menu="toggle">${f.state==='live'?'Set Offline':(f.state==='off'?'Set Dev':'Set Live')}</button>
      <button data-menu="photo">Photo</button>
    </div>` : '';

  el.innerHTML = `
    ${artLayer}
    ${statusPill}
    ${canAdminDev ? `
      <div class="hero-arrows">
        <button class="cfg-arrow" data-sort="up" data-key="hero:${esc(id)}" type="button">▲</button>
        <button class="cfg-arrow" data-sort="down" data-key="hero:${esc(id)}" type="button">▼</button>
      </div>` : ``}

    <span class="label"${labelInline}>${esc(labelFor(id))}</span>

    <div class="ctrls">
      ${kebabHTML}
      ${(!canAdminDev && canDirOnDev) ? `
        <button class="footer-chip" disabled style="height:28px">Dev</button>
        <button class="footer-chip" data-act="pickart" style="height:28px">Photo</button>` : ``}
    </div>

    <div class="cta-left">
      <button class="btn ${completed?'grey':'blue'}" data-act="enter" type="button">
        ${completed?'Complete':(inprogress?'In Progress':'Start')}
      </button>
      ${(canAdminDev || canDirOnDev) ? `
        <div class="aud-line">
          <button class="aud-chip bronze ${f.aud.bronze?'on':''}" data-aud="bronze" type="button">Beginner</button>
          <button class="aud-chip silver ${f.aud.silver?'on':''}" data-aud="silver" type="button">Intermediate</button>
          <button class="aud-chip gold   ${f.aud.gold  ?'on':''}" data-aud="gold"   type="button">Advanced</button>
        </div>` : ``}
    </div>
  `;

  if(completed) el.classList.add('completed');
  else if(inprogress) el.classList.add('inprogress');

  if(art && art.crop){
    const img = el.querySelector('.art img');
    if(img){
      const cx = Number(art.crop.cx||0), cy = Number(art.crop.cy||0), sc = Number(art.crop.scale||1);
      img.style.transform = `translate(calc(-50% + ${cx}px), calc(-50% + ${cy}px)) scale(${sc})`;
    }
  }
  return el;
}

function dividerEl(obj){
  const editable = isAdmin() && devModeOn();
  const color = obj.color || '';
  const fontFamily = obj.fontFamily || "system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif";
  const fontSize = Number(obj.fontSize || 22);
  const inline = `style="color:${esc(color)};font-family:${esc(fontFamily)};font-size:${fontSize}px"`;

  const el=document.createElement('div'); el.className='divider'; el.dataset.type='divider'; el.dataset.divId=obj.id;
  el.innerHTML=`
    <span class="htext" ${inline}>${esc(obj.title||'Heading')}</span>
    ${editable?`
      <div class="dctrls">
        <button class="footer-chip" data-div-act="up"     data-div-id="${esc(obj.id)}" type="button">▲</button>
        <button class="footer-chip" data-div-act="down"   data-div-id="${esc(obj.id)}" type="button">▼</button>
        <button class="footer-chip" data-div-act="remove" data-div-id="${esc(obj.id)}" type="button">Remove</button>
        <button class="cfg-pin" title="Rename / Colour" data-div-pencil="${esc(obj.id)}" type="button">✎</button>
      </div>`:''}
    ${editable?`
      <div class="aud-line">
        <button class="aud-chip bronze ${obj.aud?.bronze?'on':''}" data-div-aud="bronze" data-div-id="${esc(obj.id)}" type="button">Beginner</button>
        <button class="aud-chip silver ${obj.aud?.silver?'on':''}" data-div-aud="silver" data-div-id="${esc(obj.id)}" type="button">Intermediate</button>
        <button class="aud-chip gold   ${obj.aud?.gold  ?'on':''}" data-div-aud="gold"   data-div-id="${esc(obj.id)}" type="button">Advanced</button>
      </div>`:''}
  `;
  return el;
}

/* =========================
   Paint page + archive
========================= */
function paintPage(){
  const root = $('#pageGrid');
  if(!root) return;
  root.innerHTML = '';

  const s = getSettings();
  const role = getRole();
  const staff = seesAll();

  function startSection(divObj){
    if(divObj && !staff){
      const aud = divObj.aud || {bronze:true,silver:true,gold:true};
      if(!aud[role]) return null;
    }
    const sec = document.createElement('section');
    sec.className = 'section';
    if(divObj) sec.appendChild(dividerEl(divObj));
    const row = document.createElement('div');
    row.className = 'grid';
    sec.appendChild(row);
    root.appendChild(sec);
    return {sec, row};
  }

  let currentRow = null;

  for(const it of s.pageOrder){
    if(it.type === 'divider'){
      const started = startSection(it);
      currentRow = started ? started.row : null;
      continue;
    }
    if(it.type === 'hero'){
      const id = it.id;
      const f = s.heroFlags[id];
      if(!f || f.place!=='page') continue;

      if(!staff){
        if(f.state!=='live') continue;
        if(!f.aud[role]) continue;
      }

      if(!currentRow){
        const started = startSection(null);
        currentRow = started ? started.row : null;
        if(!currentRow) continue;
      }

      const card = heroCard(id);
      if(card) currentRow.appendChild(card);
    }
  }

  // Clean any empty nameless section
  $$('#pageGrid .section').forEach(sec=>{
    const row = sec.querySelector('.grid');
    const hasHeroes = row && row.children.length>0;
    const hasDivider = !!sec.querySelector('.divider');
    if(!hasHeroes && !hasDivider) sec.remove();
  });
}

const dock=$('#archiveDock'), archiveList=$('#archiveList');
function applyArchiveVisibility(){
  if(isAdmin()){ dock.style.display='block'; dock.setAttribute('aria-hidden','false'); }
  else{ dock.style.display='none'; dock.setAttribute('aria-hidden','true'); }
}
function applyArchiveSkin(){ $('#archiveTitle').textContent='Developer Mode'; updateFooterModeControls(); }
function updateFooterModeControls(){ const devOn=devModeOn(); $('#devToggle').textContent=`Developer: ${devOn?'On':'Off'}`; $('#addHeadingBtn').style.display=(isAdmin() && devOn) ? 'inline-flex' : 'none'; }

function paintArchive(){
  const s=getSettings(); const flags=s.heroFlags;
  archiveList.innerHTML='';
  const items=Object.entries(flags).filter(([id,f])=>f.place==='archive')
    .sort((a,b)=>Number(numberFromId(a[0]))-Number(numberFromId(b[0])));
  items.forEach(([id,f])=>{
    const statusLabel = (f.state==='live'?'Live':(f.state==='dev'?'Dev':'Offline'));
    const row=document.createElement('div'); row.className='row'; row.dataset.heroId=id; row.dataset.place='archive';
    row.innerHTML = `<span class="num">${esc(labelFor(id))}</span>
    ${(isAdmin() && devModeOn())?`<div style="display:flex;gap:8px;align-items:center">
      <button class="footer-chip" data-act="move" type="button">Move to Page</button>
      <button class="footer-chip" data-act="toggle" type="button">${esc(statusLabel)}</button>
    </div>`:`<div></div>`}`;
    archiveList.appendChild(row);
  });
}

/* =========================
   Lock helpers
========================= */
let savedScrollY=0;
function lockBody(){ savedScrollY = window.scrollY||document.documentElement.scrollTop||0; document.body.classList.add('lock'); document.body.style.top=`-${savedScrollY}px`; }
function unlockBody(){ document.body.classList.remove('lock'); document.body.style.top=''; window.scrollTo(0,savedScrollY||0); }

/* =========================
   Subsheet
========================= */
const subSheet=$('#subSheet'), subFrame=$('#subFrame'), sheetTitle=$('#sheetTitle');
function openSubSheet(title,url){
  if(!url){ alert('401 — Not linked yet'); return; }
  if(sheetTitle) sheetTitle.textContent=title;
  if(subFrame) subFrame.src = url + (url.includes('?')?'&':'?') + 'v=' + Date.now();
  if(subSheet){ subSheet.classList.add('open'); subSheet.setAttribute('aria-hidden','false'); }
  lockBody();
}

/* =========================
   Boot
========================= */
applyArchiveVisibility(); 
applyArchiveSkin();
paintArchive();
paintPage();
updateFooterModeControls();

/* =========================
   Footer & global handlers
========================= */
$('#archiveToggle').addEventListener('click',()=>{
  const isOpen=dock.classList.contains('open');
  dock.classList.toggle('open', !isOpen);
  dock.classList.toggle('collapsed', isOpen);
  $('#archiveToggle').textContent = !isOpen ? 'Close' : 'Archived';
  if(!isOpen) lockBody(); else unlockBody();
});

$('#devToggle').addEventListener('click', ()=>{
  if(!isAdmin()) return;
  document.body.classList.toggle('config-on');
  updateFooterModeControls(); paintPage(); paintArchive();
});

function uuidId(){return 'div_'+Math.random().toString(36).slice(2,9);}
$('#addHeadingBtn').addEventListener('click',()=>{
  if(!(isAdmin() && devModeOn())) return;
  const title=prompt('Heading title','Section'); if(title==null) return;
  const s=getSettings(); s.pageOrder.push({type:'divider', id:uuidId(), title:title.trim()||'Section', aud:{bronze:true,silver:true,gold:true}, fontSize:22});
  saveSettings(s); paintPage();
});

/* =========================
   Delegated clicks
========================= */
document.addEventListener('click',(e)=>{
  /* Enter */
  const enter = e.target.closest('[data-act="enter"]');
  if(enter){
    const host=e.target.closest('[data-hero-id]'); const id=host?.dataset?.heroId||'';
    const n=Number(((id||'').match(/\d+/)||[])[0]||0);
    const url = (n>=1 && n<=50) ? `courses/${n}.html` : null;
    openSubSheet(labelFor(id), url); return;
  }

  /* Divider pencil (Admin + Dev) */
  const pinDiv = e.target.closest('[data-div-pencil]');
  if(pinDiv){
    if(!(isAdmin() && devModeOn())) return;
    const id=pinDiv.getAttribute('data-div-pencil');
    const s=getSettings(); const idx=s.pageOrder.findIndex(it=>it.type==='divider' && it.id===id);
    const obj = s.pageOrder[idx]||{};
    openEditDialog({type:'divider', id}, obj.title || 'Heading', obj.color||'', Number(obj.fontSize||22), obj.fontFamily||"system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif");
    return;
  }

  /* Kebab open/close */
  const keb = e.target.closest('.kebab');
  if(keb){
    const menu=keb.nextElementSibling;
    const open = menu.style.display==='flex';
    $$('.kebab-menu').forEach(m=>m.style.display='none');
    menu.style.display = open ? 'none' : 'flex';
    return;
  }
  if(!e.target.closest('.kebab-menu')) $$('.kebab-menu').forEach(m=>m.style.display='none');

  /* Kebab actions (Admin + Dev) */
  const menuBtn = e.target.closest('.kebab-menu button');
  if(menuBtn){
    const host = e.target.closest('.hero'); const id=host?.dataset?.heroId;
    const s=getSettings(); const f=s.heroFlags[id];
    if(!(isAdmin() && devModeOn())) return;

    const act = menuBtn.dataset.menu;
    if(act==='rename'){
      const st = styleFor(id);
      openEditDialog({type:'hero', id}, s.heroLabels[id] || `#${numberFromId(id)}`, st.color, st.size, st.font);
    }else if(act==='move'){
      const dest = (f.place==='page') ? 'archive' : 'page';
      if(!confirm(`Move ${labelFor(id)} to ${dest==='page'?'Page':'Archive'}?`)) return;
      s.heroFlags[id]={...f, place:dest};
      if(dest==='page'){
        if(!s.pageOrder.some(it=>it.type==='hero' && it.id===id)) s.pageOrder.push({type:'hero',id});
      }else{
        s.pageOrder = s.pageOrder.filter(it=>!(it.type==='hero' && it.id===id));
      }
      saveSettings(s); paintPage(); paintArchive();
    }else if(act==='toggle'){
      const order=['live','off','dev'];
      const ni=(order.indexOf(f.state)+1)%order.length;
      s.heroFlags[id]={...f, state:order[ni]};
      saveSettings(s); paintPage(); paintArchive();
    }else if(act==='photo'){
      const url = prompt('Image path (under /images ...)', 'images/your-folder/your-image.jpg'); if(!url) return;
      s.heroAssets[id]={...(s.heroAssets[id]||{}), heroCard:{src:url, crop:{cx:0,cy:0,scale:1}}};
      saveSettings(s); paintPage();
    }
    return;
  }

  /* Audience hero chips */
  const audBtn=e.target.closest('[data-aud]');
  if(audBtn){
    const hero=e.target.closest('[data-hero-id]'); const id=hero?.dataset?.heroId;
    const s=getSettings(); const f=s.heroFlags[id];
    if(!((isAdmin() && devModeOn()) || canDirectorDevEdit(f))) return;
    const key=audBtn.getAttribute('data-aud'); const nextVal=!f.aud[key];
    if(!confirm(`${nextVal?'Allow':'Disallow'} ${key} for ${labelFor(id)}?`)) return;
    s.heroFlags[id]={...f, aud:{...f.aud, [key]:nextVal}}; saveSettings(s); paintPage(); return;
  }

  /* Reorder heroes/dividers */
  const sortBtn = e.target.closest('.cfg-arrow');
  if(sortBtn){
    if(!(isAdmin() && devModeOn())) return;
    const key = sortBtn.dataset.key; // hero:co-1 or div:div_xxx
    const s=getSettings();
    const keys = s.pageOrder.map(it=> it.type==='hero' ? `hero:${it.id}` : `div:${it.id}`);
    const from = keys.indexOf(key); if(from<0) return;
    const dir = sortBtn.dataset.sort==='up' ? -1 : 1;
    const to  = Math.min(Math.max(0, from+dir), s.pageOrder.length-1);
    if(to!==from){
      const objFrom = s.pageOrder.splice(from,1)[0];
      s.pageOrder.splice(to,0,objFrom);
      saveSettings(s); paintPage();
    }
    return;
  }

  /* Divider tools */
  const divAct = e.target.dataset.divAct;
  if(divAct){
    if(!(isAdmin() && devModeOn())) return;
    const id = e.target.dataset.divId;
    const s = getSettings();
    const idx = s.pageOrder.findIndex(it=>it.type==='divider' && it.id===id);
    if(idx<0) return;
    if(divAct==='up' || divAct==='down'){
      const dir = (divAct==='up') ? -1 : 1;
      const to  = Math.min(Math.max(0, idx + dir), s.pageOrder.length - 1);
      if (to !== idx) {
        const obj = s.pageOrder.splice(idx,1)[0];
        s.pageOrder.splice(to,0,obj);
        saveSettings(s); paintPage();
      }
      return;
    }
    if(divAct==='remove'){
      if(confirm('Remove this heading?')){
        s.pageOrder.splice(idx,1); saveSettings(s); paintPage();
      }
      return;
    }
  }

  /* Archive list actions */
  const actToggle = e.target.closest('#archiveList [data-act="toggle"]');
  const actMove = e.target.closest('#archiveList [data-act="move"]');
  if(actToggle || actMove){
    if(!(isAdmin() && devModeOn())) return;
    const row = e.target.closest('.row'); const id=row.dataset.heroId;
    const s=getSettings(); const f=s.heroFlags[id];
    if(actToggle){
      const order=['live','off','dev'];
      const ni=(order.indexOf(f.state)+1)%order.length;
      s.heroFlags[id]={...f, state:order[ni]};
    }else if(actMove){
      s.heroFlags[id]={...f, place:'page'};
      if(!s.pageOrder.some(it=>it.type==='hero' && it.id===id)) s.pageOrder.push({type:'hero',id});
    }
    saveSettings(s); paintPage(); paintArchive();
  }
}, {passive:false});

})();
</script>
</body>
</html>