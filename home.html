<!DOCTYPE html>
<html lang="en-AU">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="color-scheme" content="dark" />
<title>Home — FAOA</title>

<style>
:root{
  --ink:#eef3ff; --ink-dim:#cfd3e1; --muted:rgba(238,243,255,.78);
  --bg:#000; --panel:#0a0c10; --stroke:rgba(255,255,255,.18);
  --blue:#0A84FF; --green:#32d74b; --red:#ff3b30; --chip:#1b1f2a;
  --gap:12px; --r:14px; --maxw:1240px; --nav-h:68px; --btn-h:44px;
}
/* ----- GLOBAL RESET / iOS anti-highlight ----- */
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
html,body{
  height:100%; margin:0; background:var(--bg); color:var(--ink);
  font:16px -apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,sans-serif;
  overscroll-behavior-y:contain; overflow-x:hidden;
  user-select:none; -webkit-user-select:none; /* <- stop text selection */
}
a{color:inherit; text-decoration:none}
button{user-select:none; -webkit-user-select:none}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
.bg{position:fixed;inset:0;z-index:-1;background:#000 url("./assets/home-bg.jpg") center/cover no-repeat}

/* Top bar */
.nav{position:fixed;top:0;left:0;right:0;height:var(--nav-h);display:flex;align-items:center;justify-content:space-between;gap:8px;
  padding:8px 12px;z-index:50;background:linear-gradient(180deg,rgba(0,0,0,.9),rgba(0,0,0,.55) 60%,rgba(0,0,0,.3));
  -webkit-backdrop-filter:blur(12px);backdrop-filter:blur(12px)}
.title-tab{font-weight:900;opacity:.92}

/* Config toolbar */
.cfgbar{position:sticky;top:var(--nav-h);z-index:49;background:#0d0f14;border-bottom:1px solid var(--stroke);
  display:none;align-items:center;gap:8px;padding:10px 14px}
.config-on .cfgbar{display:flex}
.cfgbtn{height:34px;padding:0 12px;border-radius:10px;border:1px solid var(--stroke);background:#161922;color:#fff;font-weight:800;cursor:pointer}
.cfgbtn.blue{background:var(--blue);border-color:transparent;color:#000}

/* Avatar pill */
.avatarTab{display:flex;flex-direction:column;align-items:flex-start;justify-content:center;padding:6px 12px;border-radius:12px;min-width:132px;height:44px;
  font-weight:900;line-height:1.1;text-align:left;cursor:pointer;border:1px solid var(--stroke);background:#222;color:#eef3ff}
.avatarTab .name{font-size:15px;font-weight:900}
.avatarTab .lvl{font-size:12px;opacity:.95;text-transform:capitalize}

/* Layout */
.wrap{max-width:var(--maxw);margin:0 auto;padding:calc(var(--nav-h) + env(safe-area-inset-top) + 10px) 14px 160px}

/* Grid */
.grid{display:grid;gap:12px}
@media (max-width:600px){.grid{grid-template-columns:1fr}}
@media (min-width:601px) and (max-width:900px){.grid{grid-template-columns:1fr 1fr}}
@media (min-width:901px) and (max-width:1180px){.grid{grid-template-columns:1fr 1fr 1fr}}
@media (min-width:1181px){.grid{grid-template-columns:1fr 1fr 1fr 1fr}}

/* Draggable chrome (config) */
.item[draggable="true"]{touch-action:none}
.drag-ghost{opacity:.5}
.drag-over{outline:2px dashed var(--blue); outline-offset:3px; border-radius:14px}

/* Hero – 2x height */
.hero{position:relative;overflow:hidden;background:#060708;border:1px solid var(--stroke);border-radius:16px;padding:16px;min-height:240px}
.hero .label{font-weight:900;font-size:18px;opacity:.95}
.hero .cta-left{position:absolute;left:16px;bottom:16px;display:flex;gap:8px;align-items:center}
.btn{display:inline-flex;align-items:center;justify-content:center;min-width:120px;height:40px;padding:0 14px;border-radius:12px;border:1px solid var(--stroke);
  font-weight:900;background:#0f1116;color:var(--ink);cursor:pointer}
.btn.blue{background:var(--blue);border-color:transparent;color:#000}

/* Admin chips (top-right) */
.ctrls{position:absolute;top:10px;right:10px;display:flex;gap:8px;z-index:5;pointer-events:auto}
.chip{height:28px;padding:0 10px;border-radius:999px;border:1px solid var(--stroke);background:var(--chip);color:#fff;font-weight:800;font-size:12px;cursor:pointer}
.badge-live{background:#0a0}
.badge-off{background:#b00020}

/* Menus (very high z-index to beat iOS select callout) */
.move{position:relative}
.menu{position:absolute;top:32px;right:0;background:#0f0f12;border:1px solid var(--stroke);border-radius:10px;padding:6px;display:none;z-index:3000;min-width:220px}
.menu.open{display:block}
.menu button{display:block;width:100%;text-align:left;padding:8px 10px;border-radius:8px;border:1px solid var(--stroke);background:#141416;color:#fff;
  font-weight:800;font-size:12px;margin:4px 0;cursor:pointer}

/* Audience */
.aud{position:relative}
.aud-menu{position:absolute;bottom:46px;left:0;background:#0f0f12;border:1px solid var(--stroke);border-radius:10px;padding:10px;display:none;z-index:3000;min-width:220px}
.aud-menu.open{display:block}
/* allow selection & taps inside checkboxes */
.aud-menu, .aud-menu *{user-select:auto; -webkit-user-select:auto}
.aud-menu label{display:flex;align-items:center;gap:8px;margin:4px 0;font-size:13px}
.aud-menu .row{display:flex;gap:8px;margin-top:8px}

/* Heading divider */
.divider{border:1px dashed var(--stroke);border-radius:14px;background:#0b0d12;padding:14px 16px;min-height:58px;display:flex;align-items:center;justify-content:space-between}
.divider .htext{font-weight:900;opacity:.92}
.divider .dctrls{display:none;gap:8px}
.config-on .divider .dctrls{display:flex}

/* Config pin (rename hero) */
.cfg-pin{display:none;position:absolute;top:10px;left:10px;width:24px;height:24px;border-radius:8px;background:#111;border:1px solid var(--stroke);
  font-size:14px;font-weight:900;color:#fff;align-items:center;justify-content:center;z-index:6}
.config-on .cfg-pin{display:flex}

/* Subsheet */
#subSheet{position:fixed;inset:0;z-index:70;display:none;background:rgba(0,0,0,.55);-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px)}
#subSheet.open{display:block}
#subSheet .inner{position:absolute;top:calc(var(--nav-h) + 6px);right:12px;width:min(820px,calc(100% - 24px));height:min(78vh,calc(100% - (var(--nav-h) + 24px)));
  background:#0f1116;border:1px solid var(--stroke);border-radius:14px;padding:12px;display:flex;flex-direction:column}
.sheet-head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:4px 4px 10px}
.sheet-close{width:36px;height:36px;border-radius:10px;border:1px solid var(--stroke);background:#121212;color:#fff;font-weight:900;cursor:pointer}
#subFrame{flex:1 1 auto;width:100%;height:100%;border:none;border-radius:12px;background:#0b0c10;overflow:hidden}

/* Avatar Drawer */
#avatarSheet{position:fixed;inset:0;z-index:60;display:none;background:rgba(0,0,0,.45);-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}
#avatarSheet.open{display:block}
#avatarSheet .panel{position:absolute;top:calc(var(--nav-h) + 6px);right:12px;width:320px;max-height:70vh;overflow:auto;background:#0f1116;border:1px solid var(--stroke);border-radius:14px;padding:12px}
.menu-list a{display:flex;align-items:center;justify-content:space-between;padding:12px 10px;border-bottom:1px solid rgba(255,255,255,.08)}
.menu-list a:last-child{border-bottom:none}

/* Archive Footer */
#archiveDock{position:fixed;left:0;right:0;bottom:0;z-index:55;background:var(--red);color:#fff;border-top:1px solid rgba(255,255,255,.25);
  transition:max-height .22s ease;overflow:hidden;overscroll-behavior:contain}
#archiveDock .bar{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 14px;font-weight:900}
#archiveDock .bar .count{opacity:.95}
#archiveDock .content{background:#160b0b;max-height:calc(60vh - 48px);overflow:auto}
#archiveDock .list{padding:8px 12px 16px;display:flex;flex-direction:column;gap:8px}
#archiveDock .row{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid rgba(255,255,255,.28);background:#0d0d10;border-radius:10px}
#archiveDock .row .num{font-weight:900}
#archiveDock .row .chip{height:26px}
#archiveDock.collapsed{max-height:48px}
#archiveDock.open{max-height:60vh}

/* Body lock when drawer open */
body.lock{position:fixed;inset:0;overflow:hidden}
</style>
</head>
<body ontouchstart="">
<div class="bg" aria-hidden="true"></div>

<header class="nav" role="navigation" aria-label="Primary">
  <div class="nav-left"><span class="title-tab">Courses</span></div>
  <div class="nav-right">
    <button id="avatarTab" class="avatarTab" aria-haspopup="dialog" aria-expanded="false">
      <span class="name" id="avatarName">User</span>
      <span class="lvl" id="avatarLvl">Admin</span>
    </button>
  </div>
</header>

<!-- Config toolbar -->
<div id="cfgbar" class="cfgbar" aria-hidden="true">
  <button class="cfgbtn blue" id="addHeadingBtn" type="button">Add Heading</button>
  <button class="cfgbtn" id="exitCfgBtn" type="button">Exit Config</button>
</div>

<main class="wrap">
  <section class="grid" id="pageGrid"></section>
</main>

<!-- Avatar Drawer -->
<div id="avatarSheet" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="panel" role="document">
    <nav class="menu-list">
      <a href="avatar/profile.html" data-pop="Profile">Profile<span>›</span></a>
      <a href="avatar/settings.html" data-pop="Settings">Settings<span>›</span></a>
      <a href="avatar/mydata.html" data-pop="My Data">My Data<span>›</span></a>
      <a href="avatar/statistics.html" data-pop="Statistics">Statistics<span>›</span></a>
      <a href="avatar/usersearch.html" data-pop="User Search">User Search<span>›</span></a>
      <a href="#" id="cfgToggle">Config Mode<span>⌁</span></a>
    </nav>
  </div>
</div>

<!-- Subsheet -->
<div id="subSheet" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="inner" role="document">
    <div class="sheet-head">
      <h2 id="sheetTitle">—</h2>
      <button class="sheet-close" id="sheetClose" aria-label="Close" type="button">×</button>
    </div>
    <iframe id="subFrame" title="Panel"></iframe>
  </div>
</div>

<!-- Archive Footer (Admin only) -->
<div id="archiveDock" class="collapsed" aria-hidden="true">
  <div class="bar">
    <span>Archived</span>
    <span class="count" id="countArchive">0</span>
    <button class="chip" id="archiveToggle" type="button">Open</button>
  </div>
  <div class="content">
    <div class="list" id="archiveList"></div>
  </div>
</div>

<script>
(()=>{'use strict';
/* ===== utils & storage ===== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const store={get:(k,f)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):f}catch{return f}},
             set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};
const K={ profile:'ao_profile', settings:'ao_settings' };

/* Roles */
function getRole(){ const p=store.get(K.profile,{skill:'admin',displayName:'User'}); return (p.skill||'admin').toLowerCase(); }
function isAdminLike(){ const r=getRole(); return r==='admin' || r==='director'; }
function seesAll(){ const r=getRole(); return r==='admin' || r==='director' || r==='support'; }

/* Avatar paint */
(function applyAvatar(){
  const p=store.get(K.profile,{displayName:'User',skill:'admin'});
  $('#avatarName').textContent = p.displayName || 'User';
  const role=(p.skill||'admin').toLowerCase();
  $('#avatarLvl').textContent = role.charAt(0).toUpperCase()+role.slice(1);
  const map={bronze:'#b87333',silver:'#c0c7d1',gold:'#ffd700',support:'#6a4cff',director:'#333',admin:'#0A84FF'};
  const pill=$('#avatarTab'); pill.style.background= map[role] || '#222';
  pill.style.color = (role==='gold'||role==='silver'||role==='admin') ? '#0b0c10' : '#eef3ff';
})();

/* Avatar drawer + subsheet */
const avatarBtn=$('#avatarTab'), avatarSheet=$('#avatarSheet');
function openDrawer(){ avatarSheet.classList.add('open'); avatarSheet.setAttribute('aria-hidden','false'); avatarBtn.setAttribute('aria-expanded','true'); }
function closeDrawer(){ avatarSheet.classList.remove('open'); avatarSheet.setAttribute('aria-hidden','true'); avatarBtn.setAttribute('aria-expanded','false'); }
avatarBtn.addEventListener('click', openDrawer, {passive:true});
avatarSheet.addEventListener('click', e=>{ if(e.target===avatarSheet) closeDrawer(); }, {passive:true});

const subSheet=$('#subSheet'), subFrame=$('#subFrame'), sheetTitle=$('#sheetTitle');
function openSubSheet(title,url){
  sheetTitle.textContent=title;
  if(!url){ alert('401 — Not linked yet'); return; }
  subFrame.src=url+(url.includes('?')?'&':'?')+'v='+Date.now();
  subSheet.classList.add('open'); subSheet.setAttribute('aria-hidden','false');
}
function closeSubSheet(){ subSheet.classList.remove('open'); subSheet.setAttribute('aria-hidden','true'); subFrame.src='about:blank'; }
$('#sheetClose').addEventListener('click', closeSubSheet, {passive:true});
subSheet.addEventListener('click', e=>{ if(e.target===subSheet) closeSubSheet(); }, {passive:true});
$$('#avatarSheet [data-pop]').forEach(a=>a.addEventListener('click',e=>{
  e.preventDefault(); closeDrawer(); openSubSheet(a.dataset.pop, a.getAttribute('href'));
}, {passive:false}));
$('#cfgToggle').addEventListener('click', e=>{
  e.preventDefault();
  document.body.classList.toggle('config-on');
  const on=document.body.classList.contains('config-on');
  $('#cfgbar').setAttribute('aria-hidden', on?'false':'true');
  setDraggable(on);
}, {passive:false});

/* ===== settings & flags ===== */
function uuid(){ return 'div_'+Math.random().toString(36).slice(2,9); }
function defaults(){
  const heroFlags={}, pageOrder=[];
  for(let i=1;i<=10;i++){
    const id=`co-${i}`;
    heroFlags[id]={state:'live',place:'page',aud:{bronze:true,silver:true,gold:true}};
    pageOrder.push({type:'hero',id});
  }
  for(let i=11;i<=50;i++){
    const id=`co-${i}`;
    heroFlags[id]={state:'off',place:'archive',aud:{bronze:true,silver:true,gold:true}};
  }
  return { heroFlags, heroLabels:{}, pageOrder, _seeded:true };
}
function migrate(cfg){
  const po=cfg.pageOrder||[];
  const fixed=po.map(it=>{
    if(typeof it==='string') return {type:'hero', id:it};
    if(it && it.type==='divider' && !it.id) return {...it, id:uuid()};
    return it;
  });
  cfg.pageOrder=fixed; return cfg;
}
function sanitize(cfg){
  if(!cfg || typeof cfg!=='object') return defaults();
  cfg=migrate(cfg);
  cfg.heroFlags=cfg.heroFlags||{};
  cfg.heroLabels=cfg.heroLabels||{};
  cfg.pageOrder=Array.isArray(cfg.pageOrder)?cfg.pageOrder:[];
  for(let i=1;i<=50;i++){
    const id=`co-${i}`;
    if(!cfg.heroFlags[id]) cfg.heroFlags[id]={state:'off',place:i<=10?'page':'archive',aud:{bronze:true,silver:true,gold:true}};
    if(!cfg.pageOrder.some(it=>it.type==='hero' && it.id===id) && cfg.heroFlags[id].place==='page') cfg.pageOrder.push({type:'hero',id});
  }
  return cfg;
}
function getSettings(){ return sanitize(store.get(K.settings,null) || (store.set(K.settings,defaults()), store.get(K.settings))); }
function saveSettings(s){ store.set(K.settings,sanitize(s)); }

function numberFromId(id){ const m=id.match(/\d+/); return m?m[0]:'?'; }
function labelFor(id){ const s=getSettings(); return s.heroLabels[id] || `#${numberFromId(id)}`; }
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}

/* DOM builders */
function heroCard(id){
  const s=getSettings(); const f=s.heroFlags[id]; if(!f) return null;
  const wrap=document.createElement('div'); wrap.className='item'; wrap.dataset.key=`hero:${id}`;
  const el=document.createElement('article'); el.className='hero'; el.dataset.heroId=id; el.dataset.place=f.place;
  el.innerHTML=`
    <button class="cfg-pin" title="Rename" data-cfg-rename="${id}" type="button">✎</button>
    <span class="label">${labelFor(id)}</span>
    <div class="ctrls" ${isAdminLike()?'':'style="display:none"'}>
      <button class="chip ${f.state==='live'?'badge-live':'badge-off'}" data-act="toggle" type="button">${f.state==='live'?'Live':'Offline'}</button>
      <div class="move"><button class="chip" data-act="move" type="button">Move</button>
        <div class="menu">
          ${f.place==='page'
            ? '<button data-to="archive" type="button">Move to Archive</button>'
            : '<button data-to="page" type="button">Move to Page</button>'}
        </div>
      </div>
    </div>
    <div class="cta-left">
      <button class="btn blue" data-act="enter" type="button">Start</button>
      ${isAdminLike()?`
        <div class="aud">
          <button class="chip" data-act="aud" type="button">Audience</button>
          <div class="aud-menu">
            <label><input type="checkbox" data-aud="bronze" ${f.aud.bronze?'checked':''}> Bronze</label>
            <label><input type="checkbox" data-aud="silver" ${f.aud.silver?'checked':''}> Silver</label>
            <label><input type="checkbox" data-aud="gold"   ${f.aud.gold  ?'checked':''}> Gold</label>
            <div class="row" style="justify-content:flex-end">
              <button class="chip" data-act="aud-cancel" type="button">Cancel</button>
              <button class="chip" data-act="aud-save" type="button">Save</button>
            </div>
          </div>
        </div>`:''}
    </div>`;
  wrap.appendChild(el);
  return wrap;
}
function dividerEl(obj){
  const wrap=document.createElement('div'); wrap.className='item'; wrap.dataset.key=`div:${obj.id}`;
  const el=document.createElement('div'); el.className='divider'; el.dataset.type='divider'; el.dataset.divId=obj.id;
  el.innerHTML=`<span class="htext">${obj.title||'Heading'}</span>
    <div class="dctrls">
      <button class="cfgbtn" data-div-act="rename" data-div-id="${obj.id}" type="button">Rename</button>
      <button class="cfgbtn" data-div-act="remove" data-div-id="${obj.id}" type="button">Remove</button>
    </div>`;
  wrap.appendChild(el);
  return wrap;
}

/* Paint page respecting visibility */
function paintPage(){
  const grid=$('#pageGrid'); grid.innerHTML='';
  const s=getSettings(); const role=getRole();
  s.pageOrder.forEach(it=>{
    if(it.type==='hero'){
      const id=it.id; const f=s.heroFlags[id]; if(!f || f.place!=='page') return;
      if(!seesAll()){
        if(f.state!=='live') return;
        if(!f.aud[role]) return;
      }
      const card=heroCard(id); if(card) grid.appendChild(card);
    }else if(it.type==='divider'){ grid.appendChild(dividerEl(it)); }
  });
  setDraggable(document.body.classList.contains('config-on'));
}

/* Archive footer */
const dock=$('#archiveDock'), archiveList=$('#archiveList'), countArchive=$('#countArchive');
let savedScrollY=0;
function applyArchiveVisibility(){
  if(isAdminLike()){ dock.style.display='block'; dock.setAttribute('aria-hidden','false'); }
  else{ dock.style.display='none'; dock.setAttribute('aria-hidden','true'); }
}
applyArchiveVisibility();

function paintArchive(){
  const s=getSettings(); const flags=s.heroFlags;
  archiveList.innerHTML='';
  const items=Object.entries(flags).filter(([id,f])=>f.place==='archive')
    .sort((a,b)=>Number(numberFromId(a[0]))-Number(numberFromId(b[0])));
  countArchive.textContent=items.length;
  items.forEach(([id,f])=>{
    const row=document.createElement('div'); row.className='row'; row.dataset.heroId=id; row.dataset.place='archive';
    row.innerHTML=`<span class="num">${labelFor(id)}</span>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="chip ${f.state==='live'?'badge-live':'badge-off'}" data-act="toggle" type="button">`+(f.state==='live'?'Live':'Offline')+`</button>
        <div class="move">
          <button class="chip" data-act="move" type="button">Move</button>
          <div class="menu"><button data-to="page" type="button">Move to Page</button></div>
        </div>
      </div>`;
    archiveList.appendChild(row);
  });
}
paintArchive();

function lockBody(){ savedScrollY=window.scrollY; document.body.classList.add('lock'); document.body.style.top=`-${savedScrollY}px`; }
function unlockBody(){ document.body.classList.remove('lock'); document.body.style.top=''; window.scrollTo(0,savedScrollY); }

$('#archiveToggle').addEventListener('click',()=>{
  const isOpen=dock.classList.contains('open');
  dock.classList.toggle('open', !isOpen);
  dock.classList.toggle('collapsed', isOpen);
  $('#archiveToggle').textContent = !isOpen ? 'Close' : 'Open';
  if(!isOpen) lockBody(); else unlockBody();
}, {passive:true});

/* Config toolbar */
$('#addHeadingBtn').addEventListener('click',()=>{
  const title=prompt('Heading title','Section'); if(title==null) return;
  const s=getSettings(); s.pageOrder.push({type:'divider', id:uuid(), title:title.trim()||'Section'});
  saveSettings(s); paintPage();
}, {passive:false});
$('#exitCfgBtn').addEventListener('click',()=>{ document.body.classList.remove('config-on'); $('#cfgbar').setAttribute('aria-hidden','true'); setDraggable(false); }, {passive:true});

/* ===== Robust tap handler (click + pointerup + touchend) ===== */
['click','pointerup','touchend'].forEach(evt=>{
  document.addEventListener(evt,(e)=>{
    // Start (placeholder)
    const start = e.target.closest('[data-act="enter"]');
    if(start){
      const host=e.target.closest('[data-hero-id]'); const id=host?.dataset?.heroId||'';
      openSubSheet(`Course ${labelFor(id)}`, null); return;
    }

    // Toggle live/off
    const tgl = e.target.closest('[data-act="toggle"]');
    if(tgl){
      if(!isAdminLike()) return;
      const host=e.target.closest('[data-hero-id], .row');
      const id=host.dataset.heroId; const s=getSettings(); const cur=s.heroFlags[id];
      s.heroFlags[id]={...cur, state:(cur.state==='live'?'off':'live')};
      saveSettings(s); paintPage(); paintArchive(); return;
    }

    // Open/close move menu
    const mv = e.target.closest('[data-act="move"]');
    if(mv){
      const menu = mv.parentElement.querySelector('.menu');
      const open=!menu.classList.contains('open');
      $$('.menu.open').forEach(m=>m.classList.remove('open'));
      if(open) menu.classList.add('open');
      e.stopPropagation(); return;
    }

    // Move destination
    const toBtn = e.target.closest('button[data-to]');
    if(toBtn){
      const to = toBtn.getAttribute('data-to');
      const host = toBtn.closest('[data-hero-id], .row');
      const id = host.dataset.heroId;
      moveHero(id,to);
      $$('.menu.open').forEach(m=>m.classList.remove('open'));
      e.stopPropagation(); return;
    }

    // Audience popup
    const audBtn = e.target.closest('[data-act="aud"]');
    if(audBtn){
      const menu=audBtn.parentElement.querySelector('.aud-menu');
      const open=!menu.classList.contains('open');
      $$('.aud-menu.open').forEach(m=>m.classList.remove('open'));
      if(open) menu.classList.add('open');
      e.stopPropagation(); return;
    }
    if(e.target.matches('[data-act="aud-cancel"]')){
      const menu=e.target.closest('.aud-menu'); if(menu) menu.classList.remove('open'); return;
    }
    if(e.target.matches('[data-act="aud-save"]')){
      const menu=e.target.closest('.aud-menu'); const host=e.target.closest('.hero');
      const id=host.dataset.heroId; const s=getSettings(); const cur=s.heroFlags[id];
      const aud={
        bronze: menu.querySelector('[data-aud="bronze"]').checked,
        silver: menu.querySelector('[data-aud="silver"]').checked,
        gold:   menu.querySelector('[data-aud="gold"]').checked
      };
      s.heroFlags[id]={...cur, aud}; saveSettings(s); menu.classList.remove('open'); paintPage(); return;
    }

    // Rename hero label (config)
    if(e.target.matches('[data-cfg-rename]')){
      const id=e.target.getAttribute('data-cfg-rename');
      const s=getSettings(); const cur=s.heroLabels[id] || `#${numberFromId(id)}`;
      const next=prompt('Hero label', cur);
      if(next!=null){ const v=next.trim(); if(v) s.heroLabels[id]=v; else delete s.heroLabels[id]; saveSettings(s); paintPage(); paintArchive(); }
      return;
    }

    // Divider rename/remove
    if(e.target.dataset.divAct){
      const id=e.target.getAttribute('data-div-id'); const s=getSettings();
      const idx=s.pageOrder.findIndex(it=>it.type==='divider' && it.id===id); if(idx<0) return;
      if(e.target.dataset.divAct==='rename'){
        const next=prompt('Heading title', s.pageOrder[idx].title||'Heading');
        if(next!=null){ s.pageOrder[idx].title=next.trim()||'Heading'; saveSettings(s); paintPage(); }
      }else{
        s.pageOrder.splice(idx,1); saveSettings(s); paintPage();
      }
      return;
    }
  }, {passive:false});
});

// close popovers on outside click / ESC
document.addEventListener('click',()=>{ $$('.menu.open').forEach(m=>m.classList.remove('open')); $$('.aud-menu.open').forEach(m=>m.classList.remove('open')); }, {passive:true});
window.addEventListener('keydown',e=>{ if(e.key==='Escape'){ $$('.menu.open,.aud-menu.open').forEach(m=>m.classList.remove('open')); closeSubSheet(); closeDrawer(); }});

/* Movement (page <-> archive) + keep pageOrder sane */
function ensureInOrder(id){
  const s=getSettings(); if(!s.pageOrder.some(it=>it.type==='hero'&&it.id===id)){ s.pageOrder.push({type:'hero',id}); saveSettings(s); }
}
function moveHero(id, dest){
  const s=getSettings(); const cur=s.heroFlags[id]; if(!cur) return;
  if(dest!=='page' && dest!=='archive') return;
  s.heroFlags[id]={...cur, place:dest};
  if(dest==='page') ensureInOrder(id);
  saveSettings(s); paintPage(); paintArchive();
}

/* Sortable (config) */
let draggingKey=null;
function setDraggable(on){ $$('#pageGrid .item').forEach(el=>{ el.setAttribute('draggable', on?'true':'false'); }); }
$('#pageGrid').addEventListener('dragstart',e=>{ const item=e.target.closest('.item'); if(!item) return; draggingKey=item.dataset.key; item.classList.add('drag-ghost'); });
$('#pageGrid').addEventListener('dragend',e=>{ const item=e.target.closest('.item'); if(item) item.classList.remove('drag-ghost'); draggingKey=null; $$('#pageGrid .item').forEach(i=>i.classList.remove('drag-over')); });
$('#pageGrid').addEventListener('dragover',e=>{ if(!draggingKey) return; e.preventDefault(); const over=e.target.closest('.item'); if(!over || over.dataset.key===draggingKey) return; over.classList.add('drag-over'); });
$('#pageGrid').addEventListener('dragleave',e=>{ const over=e.target.closest('.item'); if(over) over.classList.remove('drag-over'); });
$('#pageGrid').addEventListener('drop',e=>{
  if(!draggingKey) return; e.preventDefault();
  const over=e.target.closest('.item'); if(!over || over.dataset.key===draggingKey) return;
  const s=getSettings();
  const keyToObj = key=>{ const [type,id]=key.split(':'); return type==='hero' ? {type, id} : {type:'divider', id}; };
  const orderDom=[...$('#pageGrid').children].map(n=>n.dataset.key);
  const from = orderDom.indexOf(draggingKey);
  const to   = orderDom.indexOf(over.dataset.key);
  if(from<0||to<0||from===to) return;
  const keys = s.pageOrder.map(it=> it.type==='hero' ? `hero:${it.id}` : `div:${it.id}`);
  const [moved]=keys.splice(from,1); keys.splice(to,0,moved);
  s.pageOrder = keys.map(keyToObj); saveSettings(s); paintPage();
});

/* Initial paint */
paintPage(); paintArchive();
})();
</script>
</body>
</html>