<!DOCTYPE html>
<html lang="en-AU">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="color-scheme" content="dark" />
<title>Home â€” FAOA (CF7)</title>

<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Lobster&family=Oswald:wght@400;700&family=Pacifico&family=Raleway:wght@700;900&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">

<style>
:root{
  --ink:#eef3ff; --ink-dim:#cfd3e1; --muted:rgba(238,243,255,.78);
  --bg:#000; --panel:#0a0c10; --stroke:rgba(255,255,255,.18);
  --blue:#0A84FF; --green:#32d74b; --red:#ff3b30; --chip:#1b1f2a;
  --gap:12px; --r:14px; --maxw:1240px; --nav-h:68px; --hero-pad:16px;
}

/* Base */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%; margin:0; background:var(--bg); color:var(--ink);
  font:16px -apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,sans-serif;
  overscroll-behavior-y:contain; overflow-x:hidden; user-select:none; -webkit-user-select:none;
}
a{ color:inherit; text-decoration:none }
button{ user-select:none; -webkit-user-select:none; cursor:pointer }
body.lock{ position:fixed; width:100% }

/* Background */
.bg{ position:fixed; inset:0; z-index:-1; background:#000 url("./assets/home-bg.jpg") center/cover no-repeat }

/* Top bar */
.nav{
  position:fixed; top:0; left:0; right:0; height:var(--nav-h);
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  padding:8px 12px; z-index:50;
  background:linear-gradient(180deg,rgba(0,0,0,.9),rgba(0,0,0,.55) 60%,rgba(0,0,0,.3));
  -webkit-backdrop-filter:blur(12px); backdrop-filter:blur(12px);
}
.title-tab{ font-weight:900; opacity:.92 }

/* Avatar pill */
.avatarTab{
  display:flex; flex-direction:column; align-items:flex-start; justify-content:center;
  padding:6px 12px; border-radius:12px; min-width:132px; height:44px;
  font-weight:900; line-height:1.1; text-align:left; border:1px solid var(--stroke);
  background:#222; color:#eef3ff;
}
.avatarTab .name{ font-size:15px; font-weight:900 }
.avatarTab .lvl{ font-size:12px; opacity:.95; text-transform:capitalize }

/* Avatar drawer */
#avatarSheet{ position:fixed; inset:0; z-index:80; display:none; background:rgba(0,0,0,.55); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px) }
#avatarSheet.open{ display:flex }
#avatarCard{ margin:auto; width:min(420px,92vw); background:#0f1116; border:1px solid var(--stroke); border-radius:14px; padding:14px; }
#avatarCard h3{ margin:0 0 12px; font-weight:900 }
#avatarClose{ float:right; }

/* Layout */
.wrap{ max-width:var(--maxw); margin:0 auto; padding:calc(var(--nav-h) + env(safe-area-inset-top) + 10px) 14px 160px }
.section{ margin:32px 0; position:relative; z-index:0 }
.section .divider{ margin-bottom:10px }

/* Horizontal rows (GRID FIX: use max-content auto-columns so cards never overlap) */
.section .grid{
  display:grid;
  grid-auto-flow:column;
  grid-auto-columns:max-content;  /* <-- key fix (01c) */
  align-items:start;
  gap:var(--gap);
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  padding-bottom:10px;
}
.section .grid::-webkit-scrollbar{ display:none }
.grid.size-xs{ --card-h:160px } .grid.size-s{ --card-h:190px } .grid.size-m{ --card-h:220px } .grid.size-l{ --card-h:250px } .grid.size-xl{ --card-h:280px }

/* Cards */
.hero{
  position:relative; overflow:hidden; background:#060708; border:1px solid var(--stroke);
  border-radius:16px; padding:var(--hero-pad); height:var(--card-h);
  width:auto; scroll-snap-align:start; display:block; cursor:pointer;
}
.hero.shape-square{ aspect-ratio:1/1 }
.hero.shape-hr{ aspect-ratio:16/9 }
.hero.shape-vr{ aspect-ratio:3/4 }
.hero.shape-circle{ aspect-ratio:1/1; border-radius:50% }

/* Staff border state */
.hero.state-live{ border:2px solid var(--green) }
.hero.state-dev{ border:2px solid var(--blue) }
.hero.state-off{ border:2px solid var(--red) }

/* Labels / ctrls */
.hero .label{
  font-weight:900; font-size:18px; opacity:.95; position:absolute; top:14px; left:16px; z-index:2
}
.hero .ctrls{ position:absolute; top:10px; right:10px; z-index:6; display:flex; align-items:center; gap:8px }
.kebab{
  display:inline-flex; align-items:center; justify-content:center;
  width:28px; height:28px; border-radius:8px; border:1px solid var(--stroke);
  background:#12151c; color:#e7eaf0; cursor:pointer; font-weight:900;
}

/* Reorder arrows (Admin+Dev only) */
.hero-arrows{
  display:none; position:absolute; right:8px; top:50%; transform:translateY(-50%);
  z-index:20; flex-direction:column; gap:10px; pointer-events:auto;
}
.config-on .hero .hero-arrows{ display:flex }
.cfg-arrow{
  display:inline-flex; align-items:center; justify-content:center;
  width:26px; height:26px; border-radius:8px; border:1px solid var(--stroke);
  background:#12151c; color:#e7eaf0; cursor:pointer;
}

/* Hero art layer */
.hero .art{ position:absolute; inset:0; z-index:0; opacity:.92; pointer-events:none; overflow:hidden; border-radius:inherit }
.hero .art img{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1);
  width:auto; height:110%; min-width:110%; user-select:none; pointer-events:none;
  filter:saturate(1.02) contrast(1.02) brightness(0.95);
}
.hero::after{
  content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
  background:linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.45) 65%, rgba(0,0,0,.6));
  z-index:1;
}

/* Divider (Heading) */
.divider{
  position:relative;
  border:none;
  border-radius:14px;
  background:transparent;
  padding:0 2px 6px;
  min-height:0;
  margin:28px 2px 8px;
  display:flex; align-items:flex-end;
  z-index:1;
}
.divider .htext{ font-weight:900; opacity:.92 }

/* Divider tools row */
.divider .tools{
  position:absolute; top:0; left:0;
  display:flex; align-items:center; gap:8px; z-index:9000;
}
.divider .dctrls{ display:none; gap:6px; align-items:center }
.config-on .divider .dctrls{ display:flex }
.divider .ctrls{ display:flex; align-items:center }
.divider .aud-indicators-head{ display:flex; gap:6px; align-items:center }


/* Countdown chip (CF7) */
.hero .sched-chip{
  position:absolute; left:10px; bottom:10px; z-index:3;
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 8px; border-radius:10px; border:1px solid var(--stroke);
  background:#10131a; font:700 12px/1 system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
}
.hero .sched-chip.green{ border-color:#1e3a22; background:#0c1610; color:#79ffa0 }
.hero .sched-chip.red{ border-color:#3a1e1f; background:#160c0d; color:#ff9aa0 }
.hero .sched-chip.blue{ border-color:#1e2f3a; background:#0c1216; color:#8fb3ff }

/* Audience dots */
.aud-dot{ width:8px; height:8px; border-radius:50%; opacity:.6; outline:1px solid rgba(255,255,255,.25) }
.aud-dot.on{ opacity:1 }
.aud-dot.bronze{ background:#b87333 }
.aud-dot.silver{ background:#c0c7d1 }
.aud-dot.gold{ background:#ffd700 }

/* Footer Dock (Developer only) */
#archiveDock{
  position:fixed; left:0; right:0; bottom:0; z-index:75; background:var(--red); color:#fff; border-top:1px solid rgba(255,255,255,.25);
  transition:max-height .22s ease; overflow:hidden; overscroll-behavior:contain
}
#archiveDock .bar{
  display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 14px; font-weight:900;
  overflow-x:auto; white-space:nowrap
}
#archiveDock .bar::-webkit-scrollbar{ display:none }
#archiveDock .title{ display:inline-flex; align-items:center; gap:8px }
#archiveDock .content{ background:#160b0b; max-height:calc(60vh - 48px); overflow:auto }
#archiveDock .list{ padding:8px 12px 16px; display:flex; flex-direction:column; gap:8px }
#archiveDock .row{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:10px 12px; border:1px solid rgba(255,255,255,.28); background:#0d0d10; border-radius:10px
}
#archiveDock .row .num{ font-weight:900 }
#archiveDock.collapsed{ max-height:48px }
#archiveDock.open{ max-height:80vh }

.footer-chip{
  display:inline-flex; align-items:center; gap:6px;
  padding:7px 10px; border-radius:10px; border:1px solid var(--stroke);
  background:#141821; color:#e7eaf0; cursor:pointer; user-select:none; font:600 13px/1.2 system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
}
.footer-chip:hover{ background:#182032; }

/* Universal Modal (iOS style) */
#modalRoot{position:fixed; inset:0; z-index:15000; display:flex; align-items:center; justify-content:center}
#modalRoot[hidden]{display:none}
#modalBackdrop{position:absolute; inset:0; background:rgba(0,0,0,.5); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px)}
.modalCard{ position:relative; z-index:1; width:min(620px,94vw); max-height:84vh; overflow:auto; background:#0f1116; border:1px solid var(--stroke); border-radius:14px; padding:12px; box-shadow:0 20px 48px rgba(0,0,0,.6) }
.modalHead{display:flex; align-items:center; justify-content:space-between; gap:10px; font-weight:900; margin-bottom:8px}
.modalHead .title{font-weight:900}
.modalX{border:1px solid var(--stroke); background:#121212; color:#fff; border-radius:10px; width:32px; height:32px; cursor:pointer}
.modalFoot{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
.modalBtn{padding:8px 12px; border-radius:10px; border:1px solid var(--stroke); background:#141821; color:#e7eaf0; font-weight:800; cursor:pointer}
.modalBtn.danger{border-color:#5a1f23; background:#2a1012; color:#ffb4b8}

.modalGroup{ background:#0b0d12; border:1px solid rgba(255,255,255,.12); border-radius:12px; margin:10px 0; overflow:hidden }
.modalGroup .groupHead{ font-weight:900; opacity:.92; padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.08) }
.modalGroup .groupBody{ display:flex; flex-direction:column }
.modalSub{ opacity:.66; font-weight:800; padding:8px 12px }
.modalOpt{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border-top:1px solid rgba(255,255,255,.06); background:#0c1016; cursor:pointer }
.modalOpt:first-child{ border-top:none }
.modalOpt:hover{ background:#0e121a }
.optRight{ opacity:.92; font-weight:800 }

.badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:10px; border:1px solid var(--stroke); background:#10131a; font:700 12px/1 system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;}
.badge.green{ border-color:#1e3a22; background:#0c1610; color:#79ffa0 }
.badge.red{ border-color:#3a1e1f; background:#160c0d; color:#ff9aa0 }
.badge.blue{ border-color:#1e2f3a; background:#0c1216; color:#8fb3ff }

/* Edit dialog centred */
#editDialog{ position:fixed; inset:0; display:none; z-index:14000; align-items:center; justify-content:center; background:rgba(0,0,0,.5); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px); }
#editDialog.open{ display:flex }
#editPanel{ background:#0f1116; border:1px solid var(--stroke); border-radius:12px; padding:12px; min-width:min(420px,96vw); max-width:96vw }
#editPanel .row{ margin:10px 0; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
#editPanel .swatch{ width:22px; height:22px; border-radius:50%; border:1px solid rgba(255,255,255,.2) }
#editPanel .preview{ padding:8px 10px; border:1px dashed var(--stroke); border-radius:8px }
#editPanel .actions{ display:flex; gap:8px; justify-content:flex-start; }

/* Full-bleed rows on wider screens */
@media (min-width: 1024px){
  .wrap{ max-width:100vw; padding-left:16px; padding-right:16px }
  .section .grid{ margin-left:calc(50% - 50vw); margin-right:calc(50% - 50vw); padding-left:16px; padding-right:16px; }
}

/* Course Sheet â€” centered */
#courseSheet{ position:fixed; inset:0; display:none; z-index:11000; background:rgba(0,0,0,.55); backdrop-filter:blur(6px); align-items:center; justify-content:center }
#courseSheet.open{ display:flex }
#coursePanel{
  position:relative; width:min(1100px, 96vw); max-height:86vh;
  background:#0f1116; border:1px solid var(--stroke); border-radius:16px; overflow:hidden; display:flex; flex-direction:column;
}
</style>
</head>

<body ontouchstart="">
<div class="bg" aria-hidden="true"></div>

<header class="nav" role="navigation" aria-label="Primary">
  <div class="nav-left"><span class="title-tab">Courses</span></div>
  <div class="nav-right">
    <button id="avatarTab" class="avatarTab" aria-haspopup="dialog" aria-expanded="false">
      <span class="name" id="avatarName">User</span>
      <span class="lvl" id="avatarLvl">Admin</span>
    </button>
  </div>
</header>

<main class="wrap">
  <div id="pageGrid"></div>
</main>

<!-- Avatar Drawer -->
<div id="avatarSheet" aria-hidden="true">
  <div id="avatarCard" role="dialog" aria-modal="true" aria-labelledby="avatarTitle">
    <button id="avatarClose" class="footer-chip" type="button">Close</button>
    <h3 id="avatarTitle">Profile</h3>
    <div style="display:flex;flex-direction:column;gap:8px">
      <div><strong>Name:</strong> <span id="drawerName">User</span></div>
      <div><strong>Role:</strong> <span id="drawerRole">Admin</span></div>
      <div class="hide-when-normal" style="gap:8px;display:flex">
        <button id="drawerToggleDev" class="footer-chip" type="button">Toggle Developer</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Dialog -->
<div id="editDialog" aria-modal="true" role="dialog">
  <div id="editPanel" role="document">
    <button id="editCloseX" aria-label="Close edit dialog">Ã—</button>
    <h3 id="editTitle">Edit</h3>
    <div class="row"><input id="editText" type="text" placeholder="Title"></div>
    <div class="row">
      <div style="font-weight:800">Colour:</div>
      <div class="palette" id="editPalette"></div>
    </div>
    <div class="row" id="fontControls">
      <div style="font-weight:800">Font:</div>
      <select id="fontFamily">
        <option value="system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif">System Sans</option>
        <option value="ui-serif,Georgia,'Times New Roman',serif">Serif</option>
        <option value="ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace">Monospace</option>
        <option value="'Comic Neue','Comic Sans MS',cursive">Comic Neue</option>
        <option value="'Pacifico',cursive">Pacifico</option>
        <option value="'Bangers',cursive">Bangers</option>
        <option value="'Lobster',cursive">Lobster</option>
        <option value="'Oswald',Arial,sans-serif">Oswald</option>
        <option value="'Raleway',Arial,sans-serif">Raleway</option>
      </select>
      <button class="fontBtn" id="fontDown" type="button" aria-label="Decrease font size">Aâ€“</button>
      <button class="fontBtn" id="fontUp"   type="button" aria-label="Increase font size">A+</button>
      <span id="fontSizeLabel" style="opacity:.9;min-width:48px;text-align:right"></span>
    </div>
    <div class="row"><div class="preview" id="editPreview">Preview</div></div>
    <div class="actions">
      <button class="footer-chip" id="editCancel">Cancel</button>
      <button class="footer-chip" id="editSave">Save</button>
    </div>
  </div>
</div>

<!-- Footer Dock (Developer only) -->
<div id="archiveDock" class="collapsed" aria-hidden="true">
  <div class="bar">
    <div class="title">
      <span id="archiveTitle">Developer Mode</span>
      <button class="footer-chip" id="devToggle" type="button">Developer: Off</button>
      <button class="footer-chip hide-when-normal" id="addHeadingBtn" type="button">Add Heading</button>
    </div>
    <div class="title" style="gap:12px">
      <button class="footer-chip" id="archiveToggle" type="button">Archived</button>
    </div>
  </div>
  <div class="content">
    <div class="list" id="archiveList"></div>
  </div>
</div>

<!-- Universal Modal Root -->
<div id="modalRoot" hidden>
  <div id="modalBackdrop"></div>
  <div class="modalCard" role="dialog" aria-modal="true">
    <div class="modalHead"><span class="title" id="modalTitle"></span><button class="modalX" id="modalX">Ã—</button></div>
    <div class="modalBody" id="modalBody"></div>
    <div class="modalFoot" id="modalFoot"></div>
  </div>
</div>

<!-- Course Sheet (centered) -->
<div id="courseSheet" aria-hidden="true">
  <div id="coursePanel" role="dialog" aria-modal="true">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--stroke)">
      <div style="font-weight:900" id="courseTitle">Course</div>
      <button id="courseClose" class="footer-chip" type="button" aria-label="Close">Close</button>
    </div>
    <div style="display:flex; gap:0; flex-wrap:wrap">
      <div style="flex:1 1 520px; min-height:300px; max-height:70vh; overflow:hidden; border-right:1px solid var(--stroke)">
        <iframe id="courseFrame" title="Course" src="" style="width:100%; height:100%; border:0"></iframe>
      </div>
      <div style="flex:1 1 360px; padding:12px; max-height:70vh; overflow:auto">
        <div id="courseSummary" style="opacity:.92"></div>
        <div style="display:flex; gap:8px; margin-top:12px">
          <button class="footer-chip" id="courseStart" type="button">Start</button>
          <button class="footer-chip" id="courseMarkDone" type="button">Mark Complete</button>
        </div>
      </div>
    </div>
  </div>
</div>
</body>

<script>
(()=>{'use strict';

/* =========================
   Utils / storage
========================= */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const store={ get:(k,f)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):f }catch{ return f } }, set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)) };
const K={ profile:'ao_profile', settings:'ao_settings', view:'ao_view', schemaVer:'ao_schema_version' };
const SCHEMA_VERSION=7;
const esc=s=>String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
const fmtDate=d=>{ if(!d) return ''; const t=new Date(d); if(Number.isNaN(+t)) return ''; const dd=String(t.getDate()).padStart(2,'0'); const mm=String(t.getMonth()+1).padStart(2,'0'); const yy=t.getFullYear(); return `${dd}/${mm}/${yy}` };

/* =========================
   Roles
========================= */
const ROLE_MAP = { beginner:'bronze', intermediate:'silver', advanced:'gold' };
const ROLE_LABEL = { bronze:'Beginner', silver:'Intermediate', gold:'Advanced', support:'Support', director:'Director', admin:'Admin' };
function normalizeRole(r){ r=String(r||'').toLowerCase(); return ROLE_MAP[r] || r; }
function baseRole(){ const p = store.get(K.profile, { skill:'admin', displayName:'User' }); return normalizeRole(p.skill || 'admin'); }
function getRole(){ return baseRole(); }
function isAdmin(){ return getRole()==='admin'; }
function isDirector(){ return getRole()==='director'; }
function isSupport(){ return getRole()==='support'; }
function devModeOn(){ return document.body.classList.contains('config-on'); }
function seesAll(){ const r=getRole(); return r==='admin' || r==='support' || r==='director'; }

/* =========================
   Settings + seed
========================= */
function numberFromId(id){ const m=String(id||'').match(/\\d+/); return m?m[0]:'?'; }
function defaults(){
  const heroFlags={}, pageOrder=[], heroSchedule={}, heroShortcuts={};
  heroFlags['co-1']={state:'live', place:'page', aud:{bronze:true,silver:false,gold:false}, shape:'square'};
  heroFlags['co-2']={state:'live', place:'page', aud:{bronze:false,silver:true,gold:false}, shape:'square'};
  heroFlags['co-3']={state:'live', place:'page', aud:{bronze:false,silver:false,gold:true}, shape:'square'};
  heroFlags['co-4']={state:'dev',  place:'page', aud:{bronze:false,silver:false,gold:false}, shape:'square'};
  for(let i=5;i<=12;i++) heroFlags['co-'+i]={state:'off', place:'archive', aud:{bronze:true,silver:true,gold:true}, shape:'square'};
  pageOrder.push({type:'hero',id:'co-1'},{type:'hero',id:'co-2'},{type:'hero',id:'co-3'},{type:'hero',id:'co-4'});
  return { heroFlags, heroLabels:{}, heroAssets:{}, heroProgress:{}, heroStyle:{}, heroSchedule, heroShortcuts, pageOrder, _seeded:true };
}
function sanitize(cfg){
  let c = (!cfg || typeof cfg!=='object') ? defaults() : {...cfg};
  c.heroFlags=c.heroFlags||{}; c.heroLabels=c.heroLabels||{}; c.heroAssets=c.heroAssets||{};
  c.heroProgress=c.heroProgress||{}; c.heroStyle=c.heroStyle||{}; c.pageOrder=Array.isArray(c.pageOrder)?c.pageOrder:[];
  c.heroSchedule=c.heroSchedule||{}; c.heroShortcuts=c.heroShortcuts||{};
  for(let i=1;i<=50;i++){ const id='co-'+i; if(!c.heroFlags[id]) c.heroFlags[id]={state:'off',place:'archive',aud:{bronze:true,silver:true,gold:true}, shape:'square'}; else if(!c.heroFlags[id].shape) c.heroFlags[id].shape='square'; }
  c.pageOrder = c.pageOrder.filter(it=> it && (it.type==='hero'||it.type==='divider'));
  Object.keys(c.heroFlags).forEach(id=>{ if(c.heroFlags[id].place==='page' && !c.pageOrder.some(it=>it.type==='hero' && it.id===id)){ c.pageOrder.push({type:'hero', id}); } });
  return c;
}
function loadSettings(){
  const ver = Number(store.get(K.schemaVer, 0))||0;
  const raw = store.get(K.settings, null);
  const s = sanitize(raw);
  if(ver!==SCHEMA_VERSION){ store.set(K.settings, s); store.set(K.schemaVer, SCHEMA_VERSION); }
  return s;
}
let S = loadSettings();
function getSettings(){ return S; }
function saveSettings(next){ S = sanitize(next||S); store.set(K.settings,S); }

/* =========================
   Avatar
========================= */
function paintAvatar(){
  const p=store.get(K.profile,{displayName:'User',skill:'admin'});
  $('#avatarName').textContent = p.displayName || 'User';
  const role=getRole();
  $('#avatarLvl').textContent = ROLE_LABEL[role] || role;
  $('#drawerName').textContent = p.displayName || 'User';
  $('#drawerRole').textContent = ROLE_LABEL[role] || role;
}
paintAvatar();

(function wireAvatarDrawer(){
  const avatarBtn = $('#avatarTab');
  const sheet = $('#avatarSheet');
  const closeBtn = $('#avatarClose');
  const toggleDev = $('#drawerToggleDev');

  function openDrawer(){ sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false'); avatarBtn.setAttribute('aria-expanded','true'); }
  function closeDrawer(){ sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); avatarBtn.setAttribute('aria-expanded','false'); }
  avatarBtn?.addEventListener('click', openDrawer, {passive:true});
  closeBtn?.addEventListener('click', closeDrawer, {passive:true});
  sheet?.addEventListener('click', e=>{ if(e.target===sheet) closeDrawer(); }, {passive:true});
  toggleDev?.addEventListener('click', ()=>{
    if(!isAdmin()) return;
    document.body.classList.toggle('config-on');
    updateFooterModeControls(); paintPage(); paintArchive();
  }, {passive:true});
})();

/* =========================
   Label helpers (patched)
========================= */
function numberFromId(id){
  const m = String(id || '').match(/(\d+)/);
  return m ? m[1] : '';
}

function labelFor(id){
  const s = getSettings();
  const custom = s.heroLabels?.[id];
  if (custom && custom.trim()) return custom;

  // Try digits from id
  const n = numberFromId(id);
  if (n) return `#${n}`;

  // Fallback: position in pageOrder
  const heroes = s.pageOrder.filter(it => it.type === 'hero');
  const pos = heroes.findIndex(it => it.id === id);
  return pos >= 0 ? `#${pos + 1}` : '#?';
}

function styleFor(id){
  const st=(getSettings().heroStyle||{})[id]||{};
  return {
    color: st.labelColor || '',
    font:  st.labelFont  || "system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif",
    size:  Number(st.labelSize||18)
  };
}

/* =========================
   Edit dialog (text+color+font)
========================= */
const paletteColors = ['#eef3ff','#cfd3e1','#ffffff','#000000','#808080','#0A84FF','#32d74b','#ff3b30','#ffd700','#b87333','#c0c7d1','#6a4cff','#ff9f0a','#64d2ff','#ff2d55'];

let editCtx=null;
let liveFont=18, liveColor='', liveFamily="system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif";

function applyPreview(){
  const pv = $('#editPreview');
  pv.style.color = liveColor||'';
  pv.style.fontFamily = liveFamily;
  pv.style.fontSize = liveFont+'px';
  pv.textContent = $('#editText').value || 'Preview';
  $('#fontSizeLabel').textContent = liveFont+'px';
}

function openEditDialog(ctx, currentText, currentColor, currentSize=18, currentFamily="system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif"){
  editCtx = ctx;
  $('#editTitle').textContent = (ctx.type==='hero'?'Rename Course':'Edit Heading');
  $('#editText').value = currentText||'';

  const pal = $('#editPalette'); pal.innerHTML='';
  paletteColors.forEach(col=>{
    const b=document.createElement('button');
    b.type='button'; b.className='swatch'; b.style.background=col; b.dataset.col=col;
    b.addEventListener('click',()=>{ liveColor=col; applyPreview(); }, {passive:true});
    pal.appendChild(b);
  });

  liveFont = Math.max(10, Math.min(64, Number(currentSize||18)));
  liveColor = currentColor || '';
  liveFamily = currentFamily || "system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif";
  $('#fontFamily').value = liveFamily;

  $('#fontFamily').onchange = ()=>{ liveFamily = $('#fontFamily').value; applyPreview(); };
  $('#fontUp').onclick   = ()=>{ liveFont = Math.min(64, liveFont+1); applyPreview(); };
  $('#fontDown').onclick = ()=>{ liveFont = Math.max(10, liveFont-1); applyPreview(); };

  applyPreview();
  $('#editDialog').classList.add('open');
}
function closeEditDialog(){ $('#editDialog').classList.remove('open'); editCtx=null; }
$('#editCancel').addEventListener('click', closeEditDialog);
$('#editDialog').addEventListener('click', e=>{ if(e.target===e.currentTarget) closeEditDialog(); }, {passive:true});
$('#editSave').addEventListener('click', ()=>{
  if(!editCtx) return;
  const s=getSettings();
  const text = $('#editText').value.trim();

  if(editCtx.type==='hero'){
    if(text){ s.heroLabels[editCtx.id]=text } else { delete s.heroLabels[editCtx.id] }
    s.heroStyle = s.heroStyle || {};
    s.heroStyle[editCtx.id] = { ...(s.heroStyle[editCtx.id]||{}), labelColor: liveColor, labelSize:  liveFont, labelFont:  liveFamily };
  }else{
    const idx = s.pageOrder.findIndex(it=>it.type==='divider' && it.id===editCtx.id);
    if(idx>=0){
      s.pageOrder[idx].title = text || 'Heading';
      s.pageOrder[idx].color = liveColor || '';
      s.pageOrder[idx].fontSize = liveFont;
      s.pageOrder[idx].fontFamily = liveFamily;
    }
  }
  saveSettings(s);
  paintPage(); paintArchive();
  closeEditDialog();
});

/* =========================
   Universal Modal (no native prompts/confirms)
========================= */
const modalRoot = $('#modalRoot');
const mTitle = $('#modalTitle');
const mBody  = $('#modalBody');
const mFoot  = $('#modalFoot');

$('#modalX').onclick = ()=> modalClose();
$('#modalBackdrop').onclick = ()=> modalClose();

function modalClose(){ modalRoot.hidden = true; mTitle.textContent=''; mBody.innerHTML=''; mFoot.innerHTML=''; }
function modalConfirm({title='Confirm', body='Are you sure?', okText='Confirm', cancelText='Cancel', danger=false}={}, onOK){
  mTitle.textContent = title;
  mBody.innerHTML = typeof body==='string' ? `<div>${body}</div>` : '';
  mFoot.innerHTML = '';
  const cancel = document.createElement('button'); cancel.className='modalBtn'; cancel.textContent=cancelText; cancel.onclick=modalClose;
  const ok = document.createElement('button'); ok.className='modalBtn'+(danger?' danger':''); ok.textContent=okText; ok.onclick=()=>{ modalClose(); onOK?.(); };
  mFoot.append(cancel, ok); modalRoot.hidden = false;
}
function modalPrompt({title='Enter value', label='Value', value=''}={}, onOK){
  mTitle.textContent = title;
  mBody.innerHTML = `<label style="display:block;opacity:.9;margin-bottom:6px">${label}</label>
    <input id="modalInput" type="text" value="${value}" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--stroke);background:#0b0c10;color:${'var(--ink)'}">`;
  mFoot.innerHTML = '';
  const cancel = document.createElement('button'); cancel.className='modalBtn'; cancel.textContent='Cancel'; cancel.onclick=modalClose;
  const ok = document.createElement('button'); ok.className='modalBtn'; ok.textContent='Save'; ok.onclick=()=>{ const v=$('#modalInput').value; modalClose(); onOK?.(v); };
  mFoot.append(cancel, ok); modalRoot.hidden = false; setTimeout(()=>$('#modalInput')?.focus(),0);
}
function modalDate({title='Select date', label='Date', value=''}={}, onOK){
  mTitle.textContent = title;
  mBody.innerHTML = `<label style="display:block;opacity:.9;margin-bottom:6px">${label}</label>
    <input id="modalDate" type="date" value="${value||''}" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--stroke);background:#0b0c10;color:${'var(--ink)'}">`;
  mFoot.innerHTML = '';
  const cancel = document.createElement('button'); cancel.className='modalBtn'; cancel.textContent='Cancel'; cancel.onclick=modalClose;
  const ok = document.createElement('button'); ok.className='modalBtn'; ok.textContent='Save'; ok.onclick=()=>{ const v=$('#modalDate').value; modalClose(); onOK?.(v); };
  mFoot.append(cancel, ok); modalRoot.hidden = false;
}

/* =========================
   DOM builders
========================= */

function chipFor(id){
  const s=getSettings(); const sch=s.heroSchedule[id]||{};
  if(!sch) return '';
  // Dummy: just show if release date exists
  if(sch.release){
    return `<span class="sched-chip green">Live soon</span>`;
  }
  return '';
}

function heroCard(id){
  const s=getSettings(); const f=s.heroFlags[id]; if(!f) return null;
  const art = s.heroAssets?.[id]?.heroCard || null;
  const devOn = devModeOn(); const canAdminDev = isAdmin() && devOn;
  const shape = f.shape || 'square';
  const st = styleFor(id);
  const el=document.createElement('article'); el.className='hero'; el.dataset.heroId=id; el.dataset.place=f.place; el.classList.add(`shape-${shape}`);
  if (seesAll()) { if(f.state==='live') el.classList.add('state-live'); else if (f.state==='dev') el.classList.add('state-dev'); else el.classList.add('state-off'); }
  const artLayer = (art && art.src) ? `<div class="art"><img alt="" src="${esc(art.src)}"></div>` : '';
  const labelInline = ` style="color:${esc(st.color)};font-family:${esc(st.font)};font-size:${st.size}px"`;
  el.innerHTML = `${artLayer}
    ${canAdminDev ? `<div class="hero-arrows"><button class="cfg-arrow" data-sort="up" data-key="hero:${esc(id)}" type="button">â–²</button><button class="cfg-arrow" data-sort="down" data-key="hero:${esc(id)}" type="button">â–¼</button></div>` : ``}
    <span class="label"${labelInline}>${esc(labelFor(id))}</span>
    <div class="ctrls">${canAdminDev?`<button class="kebab" data-hero-kebab="${esc(id)}" aria-haspopup="dialog" aria-expanded="false">â‹®</button>`:''}</div>`;
  return el;
}

function dividerEl(obj){
  const editable   = isAdmin() && devModeOn();
  const color      = obj.color || '';
  const fontFamily = obj.fontFamily || "system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif";
  const fontSize   = Number(obj.fontSize || 22);
  const el = document.createElement('div');
  el.className = 'divider';
  el.dataset.type = 'divider';
  el.dataset.divId = obj.id;
  el.innerHTML = `
    <span class="htext" style="color:${esc(color)};font-family:${esc(fontFamily)};font-size:${fontSize}px">${esc(obj.title || 'Heading')}</span>
    <div class="tools">
      ${editable ? `<div class="dctrls"><button class="footer-chip" data-div-act="up"   data-div-id="${esc(obj.id)}" type="button">â–²</button>
      <button class="footer-chip" data-div-act="down" data-div-id="${esc(obj.id)}" type="button">â–¼</button></div>`:''}
      ${editable ? `<div class="ctrls"><button class="kebab" data-div-kebab="${esc(obj.id)}" type="button">â‹®</button></div>`:''}
      <div class="aud-indicators-head" aria-hidden="${seesAll()?'false':'true'}"></div>
    </div>`;
  return el;
}

/* =========================
   Paint page + archive
========================= */
function addHeroIndicators(){
  if(!seesAll()) return;
  $$('.hero').forEach(h=>{
    h.querySelectorAll('.aud-indicators').forEach(n=>n.remove());
    const f=getSettings()?.heroFlags?.[h.dataset.heroId]; if(!f?.aud) return;
    const order=[['gold','Advanced'],['silver','Intermediate'],['bronze','Beginner']];
    const active = order.filter(([k])=>!!f.aud[k]); if(!active.length) return;
    const ind=document.createElement('div'); ind.className='aud-indicators'; ind.style.cssText='position:absolute;right:10px;bottom:10px;display:flex;gap:6px;z-index:2;';
    ind.innerHTML = active.map(([k,t])=>`<span class="aud-dot ${k} on" title="${t}"></span>`).join('');
    h.appendChild(ind);
  });
}

function addHeadingIndicators(){
  if(!seesAll()) return;
  $$('.divider').forEach(div=>{
    const slot = div.querySelector('.aud-indicators-head');
    if(!slot) return;
    slot.innerHTML = '';
    const heroes=[...(div.nextElementSibling?.querySelectorAll?.('.hero')||[])];
    const agg={bronze:false,silver:false,gold:false};
    heroes.forEach(h=>{ const f=getSettings()?.heroFlags?.[h.dataset.heroId]; if(f?.aud){ agg.bronze ||= !!f.aud.bronze; agg.silver ||= !!f.aud.silver; agg.gold   ||= !!f.aud.gold; } });
    const order=[['gold','Advanced'],['silver','Intermediate'],['bronze','Beginner']];
    const active = order.filter(([k])=>agg[k]); if(!active.length) return;
    slot.innerHTML = active.map(([k,t])=>`<span class="aud-dot ${k} on" title="${t}"></span>`).join('');
  });
}

function paintPage(){
  const root = $('#pageGrid');
  if(!root) return;
  root.innerHTML = '';
  const s = getSettings();
  const role = getRole();
  const staff = seesAll();

  function startSection(divObj){
    if(divObj && !staff){
      const aud = divObj.aud || {bronze:true,silver:true,gold:true};
      if(!aud[role]) return null;
      if(divObj.state==='off') return null;
    }
    const sec = document.createElement('section');
    sec.className = 'section';
    if(divObj) sec.appendChild(dividerEl(divObj));
    const row = document.createElement('div');
    row.className = 'grid';
    const size = (divObj && divObj.rowSize) ? String(divObj.rowSize) : 'm';
    row.classList.add(`size-${['xs','s','m','l','xl'].includes(size)?size:'m'}`);

    sec.appendChild(row);
    root.appendChild(sec);
    return {sec, row};
  }

  let currentRow = null;

  for(const it of s.pageOrder){
    if(it.type === 'divider'){
      const started = startSection(it);
      currentRow = started ? started.row : null;
      continue;
    }
    if(it.type === 'hero'){
      const id = it.id;
      const f = s.heroFlags[id];
      if(!f || f.place!=='page') continue;

      if(!seesAll()){
        if(f.state!=='live') continue;
        if(!f.aud[role]) continue;
      }

      if(!currentRow){
        const started = startSection(null);
        currentRow = started ? started.row : null;
        if(!currentRow) continue;
      }

      const card = heroCard(id);
      if(card) currentRow.appendChild(card);
    }
  }

  // Clean empty nameless sections
  $$('#pageGrid .section').forEach(sec=>{
    const row = sec.querySelector('.grid');
    const hasHeroes = row && row.children.length>0;
    const hasDivider = !!sec.querySelector('.divider');
    if(!hasHeroes && !hasDivider){ sec.remove(); }
  });

  addHeroIndicators(); addHeadingIndicators();
}

const dock=$('#archiveDock'), archiveList=$('#archiveList');
function applyArchiveVisibility(){
  if(isAdmin()){ dock.style.display='block'; dock.setAttribute('aria-hidden','false'); }
  else{ dock.style.display='none'; dock.setAttribute('aria-hidden','true'); }
}
function applyArchiveSkin(){ $('#archiveTitle').textContent='Developer Mode'; updateFooterModeControls(); }
function updateFooterModeControls(){ const devOn=devModeOn(); $('#devToggle').textContent=`Developer: ${devOn?'On':'Off'}`; $('#addHeadingBtn').style.display=(isAdmin() && devOn) ? 'inline-flex' : 'none'; }

function paintArchive(){
  const s=getSettings(); const flags=s.heroFlags;
  archiveList.innerHTML='';
  const items=Object.entries(flags).filter(([id,f])=>f.place==='archive')
    .sort((a,b)=>Number(numberFromId(a[0]))-Number(numberFromId(b[0])));
  items.forEach(([id,f])=>{
    const statusLabel = (f.state==='live'?'Live':(f.state==='dev'?'Dev':'Offline'));
    const row=document.createElement('div'); row.className='row'; row.dataset.heroId=id; row.dataset.place='archive';
    row.innerHTML = `<span class="num">${esc(labelFor(id))}</span>
    ${(isAdmin() && devModeOn())?`<div style="display:flex;gap:8px;align-items:center">
      <button class="footer-chip" data-act="move" type="button">Move to Page</button>
      <button class="footer-chip" data-act="toggle" type="button">${esc(statusLabel)}</button>
    </div>`:`<div></div>`}`;
    archiveList.appendChild(row);
  });
}

/* =========================
   Boot
========================= */
applyArchiveVisibility();
applyArchiveSkin();
paintArchive();
paintPage();
updateFooterModeControls();

/* =========================
   Footer & global handlers
========================= */
$('#archiveToggle').addEventListener('click',()=>{
  const isOpen=dock.classList.contains('open');
  dock.classList.toggle('open', !isOpen);
  dock.classList.toggle('collapsed', isOpen);
  $('#archiveToggle').textContent = !isOpen ? 'Close' : 'Archived';
});

$('#devToggle').addEventListener('click', ()=>{
  if(!isAdmin()) return;
  document.body.classList.toggle('config-on');
  updateFooterModeControls(); paintPage(); paintArchive();
});

function uuidId(){return 'div_'+Math.random().toString(36).slice(2,9);}
$('#addHeadingBtn').addEventListener('click',()=>{
  if(!(isAdmin() && devModeOn())) return;
  modalPrompt({title:'Add Heading', label:'Heading title', value:'Section'}, (title)=>{
    const s=getSettings(); s.pageOrder.push({type:'divider', id:uuidId(), title:(title||'Section').trim(), aud:{bronze:true,silver:true,gold:true}, fontSize:22, rowSize:'m', state:'live', schedule:{} });
    saveSettings(s); paintPage();
  });
});

/* =========================
   Delegated clicks (page)
========================= */
document.addEventListener('click',(e)=>{
  /* Arrow reorder (heroes) */
  const sortBtn = e.target.closest('.cfg-arrow');
  if(sortBtn && sortBtn.dataset.key?.startsWith('hero:')){
    e.stopPropagation();
    if(!(isAdmin() && devModeOn())) return;
    const key = sortBtn.dataset.key;
    const s=getSettings();
    const keys = s.pageOrder.map(it=> it.type==='hero' ? `hero:${it.id}` : `div:${it.id}`);
    const from = keys.indexOf(key); if(from<0) return;
    const dir = sortBtn.dataset.sort==='up' ? -1 : 1;
    const to  = Math.min(Math.max(0, from+dir), s.pageOrder.length-1);
    if(to!==from){
      const obj = s.pageOrder.splice(from,1)[0];
      s.pageOrder.splice(to,0,obj);
      saveSettings(s); paintPage();
    }
    return;
  }

  /* Arrow reorder (dividers) via .dctrls buttons */
  const divSort = e.target.closest('[data-div-act]');
  if(divSort){
    if(!(isAdmin() && devModeOn())) return;
    const act = divSort.dataset.divAct;
    const id  = divSort.dataset.divId;
    const s = getSettings();
    const keys = s.pageOrder.map(it=> it.type==='hero' ? `hero:${it.id}` : `div:${it.id}`);
    const from = keys.indexOf('div:'+id); if(from<0) return;
    const dir = act==='up' ? -1 : 1;
    const to  = Math.min(Math.max(0, from+dir), s.pageOrder.length-1);
    if(to!==from){
      const obj = s.pageOrder.splice(from,1)[0];
      s.pageOrder.splice(to,0,obj);
      saveSettings(s); paintPage();
    }
    return;
  }

  /* Archive list actions */
  const actToggle = e.target.closest('#archiveList [data-act="toggle"]');
  const actMove = e.target.closest('#archiveList [data-act="move"]');
  if(actToggle || actMove){
    if(!(isAdmin() && devModeOn())) return;
    const row = e.target.closest('.row'); const id=row.dataset.heroId;
    const s=getSettings(); const f=s.heroFlags[id];
    if(actToggle){
      const order=['live','off','dev'];
      const ni=(order.indexOf(f.state)+1)%order.length;
      s.heroFlags[id]={...f, state:order[ni]};
    }else if(actMove){
      s.heroFlags[id]={...f, place:'page'};
      if(!s.pageOrder.some(it=>it.type==='hero' && it.id===id)) s.pageOrder.push({type:'hero',id});
    }
    saveSettings(s); paintPage(); paintArchive();
    return;
  }

  /* Kebab open: HERO */
  const kebHero = e.target.closest('[data-hero-kebab]');
  if(kebHero){
    if(!(isAdmin() && devModeOn())) return;
    const id = kebHero.getAttribute('data-hero-kebab');
    openHeroKebab(id);
    return;
  }

  /* Kebab open: DIVIDER */
  const kebDiv = e.target.closest('[data-div-kebab]');
  if(kebDiv){
    if(!(isAdmin() && devModeOn())) return;
    const id = kebDiv.getAttribute('data-div-kebab');
    openDividerKebab(id);
    return;
  }
}, {passive:false});

/* =========================
   HERO KEBAB (iOS modal)
========================= */
function openHeroKebab(id){
  const s=getSettings(); const f=s.heroFlags[id]; const sch=s.heroSchedule[id]||{};
  const art = s.heroAssets?.[id]?.heroCard?.src || '';
  mTitle.textContent = labelFor(id);
  const badge=(kind,val)=> val?`<span class="badge ${kind}">${fmtDate(val)}</span>`:'';

  mBody.innerHTML = `
  <div class="modalGroup">
    <div class="groupHead">Course Hero</div>
    <div class="modalSub">Cover Dimensions</div>
    <div class="groupBody">
      ${['square','hr','vr','circle'].map(shape=>`
      <div class="modalOpt" data-hact="shape" data-shape="${shape}">
        <div>${shape==='hr'?'Horizontal Rectangle':shape==='vr'?'Vertical Rectangle':shape==='circle'?'Circle':'Square'}</div>
        <div class="optRight">${f.shape===shape?'âœ“':''}</div>
      </div>`).join('')}
    </div>
  </div>
  <div class="modalGroup">
    <div class="groupHead">Audience</div>
    <div class="groupBody">
      ${[['bronze','Beginner'],['silver','Intermediate'],['gold','Advanced']].map(([k,lab])=>`
      <div class="modalOpt" data-hact="aud" data-aud="${k}">
        <div>${lab}</div><div class="optRight">${f.aud[k]?'âœ“':''}</div>
      </div>`).join('')}
    </div>
  </div>
  <div class="modalGroup">
    <div class="groupHead">Course Activity State</div>
    <div class="groupBody">
      ${[['live','Online'],['off','Offline'],['dev','Under Development']].map(([k,lab])=>`
      <div class="modalOpt" data-hact="state" data-state="${k}">
        <div>${lab}</div><div class="optRight">${f.state===k?'âœ“':''}</div>
      </div>`).join('')}
    </div>
  </div>
  <div class="modalGroup">
    <div class="groupHead">Schedule Activity State</div>
    <div class="groupBody">
      <div class="modalOpt" data-hact="date" data-kind="release"><div>Set Release Date</div><div class="optRight">${badge('green',sch.release)}</div></div>
      <div class="modalOpt" data-hact="date" data-kind="expiry"><div>Set Expiry Date</div><div class="optRight">${badge('red',sch.expiry)}</div></div>
      <div class="modalOpt" data-hact="date" data-kind="dev"><div>Schedule for Development</div><div class="optRight">${badge('blue',sch.dev)}</div></div>
    </div>
  </div>
  <div class="modalGroup">
    <div class="groupHead">Customisation</div>
    <div class="groupBody">
      <div class="modalOpt" data-hact="rename"><div>Rename Course</div></div>
      <div class="modalOpt" data-hact="cover"><div>Add Cover Art</div><div class="optRight" style="opacity:.8">${art? 'Set' : 'None'}</div></div>
      <div class="modalOpt" data-hact="archive"><div>Archive Course</div></div>
      <div class="modalOpt"><div>Create Customisable Shortcut</div><div class="optRight" style="opacity:.6">Coming soon</div></div>
      <div class="modalOpt"><div>Remove Shortcut</div><div class="optRight" style="opacity:.6">Coming soon</div></div>
      <div class="modalOpt"><div>Create Request</div><div class="optRight" style="opacity:.6">Coming soon</div></div>
      <div class="modalOpt"><div>Audit Course</div><div class="optRight" style="opacity:.6">Coming soon</div></div>
    </div>
  </div>`;

  mFoot.innerHTML='';
  modalRoot.hidden=false;

  mBody.onclick = (e)=>{
    const opt = e.target.closest('[data-hact]'); if(!opt) return;
    const act = opt.getAttribute('data-hact');
    if(act==='shape'){
      const shape = opt.getAttribute('data-shape');
      s.heroFlags[id]={...f, shape}; saveSettings(s); paintPage(); openHeroKebab(id);
    }else if(act==='aud'){
      const key = opt.getAttribute('data-aud'); const next=!f.aud[key];
      modalConfirm({title:'Change audience', body:`${next?'Enable':'Disable'} <b>${key}</b> for <b>${labelFor(id)}</b>?`}, ()=>{
        s.heroFlags[id]={...f, aud:{...f.aud, [key]:next}}; saveSettings(s); paintPage(); openHeroKebab(id);
      });
    }else if(act==='state'){
      const state = opt.getAttribute('data-state');
      modalConfirm({title:'Change state', body:`Set <b>${labelFor(id)}</b> to <b>${state}</b>?`}, ()=>{
        s.heroFlags[id]={...f, state}; saveSettings(s); paintPage(); openHeroKebab(id);
      });
    }else if(act==='date'){
      const kind = opt.getAttribute('data-kind');
      modalDate({title:'Select date', label:`${kind[0].toUpperCase()+kind.slice(1)} date`, value:(s.heroSchedule[id]?.[kind]||'')}, (val)=>{
        s.heroSchedule[id]={...(s.heroSchedule[id]||{}), [kind]:val||null}; saveSettings(s); paintPage(); openHeroKebab(id);
      });
    }else if(act==='rename'){
      modalClose();
      const st=styleFor(id);
      openEditDialog({type:'hero', id}, s.heroLabels[id] || `#${numberFromId(id)}`, st.color, st.size, st.font);
    }else if(act==='cover'){
      modalPrompt({title:'Add Cover Art', label:'Image path (e.g. images/folder/img.jpg)', value: art || ''}, (url)=>{
        const cur = s.heroAssets[id] || {};
        s.heroAssets[id] = {...cur, heroCard:{src:url||'', crop:{cx:0,cy:0,scale:1}}};
        saveSettings(s); paintPage(); openHeroKebab(id);
      });
    }else if(act==='archive'){
      modalConfirm({title:'Archive Course', body:`Move <b>${labelFor(id)}</b> to Archive?`}, ()=>{
        s.heroFlags[id]={...f, place:'archive'}; s.pageOrder=s.pageOrder.filter(it=>!(it.type==='hero' && it.id===id)); saveSettings(s); paintPage(); paintArchive(); modalClose();
      });
    }
  };
}

/* =========================
   DIVIDER KEBAB (iOS modal)
========================= */
function openDividerKebab(divId){
  const s=getSettings(); const idx=s.pageOrder.findIndex(it=>it.type==='divider' && it.id===divId); if(idx<0) return;
  const d=s.pageOrder[idx]; const sch=d.schedule||{};
  mTitle.textContent = d.title || 'Heading';
  const badge=(kind,val)=> val?`<span class="badge ${kind}">${fmtDate(val)}</span>`:'';

  mBody.innerHTML = `
  <div class="modalGroup">
    <div class="groupHead">Heading</div>
    <div class="groupBody">
      <div class="modalOpt" data-dact="rename"><div>Rename Heading</div></div>
    </div>
  </div>
  <div class="modalGroup">
    <div class="groupHead">Layout</div>
    <div class="groupBody">
      ${['xs','s','m','l','xl'].map(sz=>`
      <div class="modalOpt" data-dact="size" data-size="${sz}">
        <div>Row Size â€” ${sz.toUpperCase()}</div><div class="optRight">${(d.rowSize||'m')===sz?'âœ“':''}</div>
      </div>`).join('')}
    </div>
  </div>
  <div class="modalGroup">
    <div class="groupHead">Audience Filter</div>
    <div class="groupBody">
      ${[['bronze','Beginner'],['silver','Intermediate'],['gold','Advanced']].map(([k,lab])=>`
      <div class="modalOpt" data-dact="aud" data-aud="${k}"><div>${lab}</div><div class="optRight">${d.aud?.[k]?'âœ“':''}</div></div>`).join('')}
    </div>
  </div>
  <div class="modalGroup">
    <div class="groupHead">Section Activity State</div>
    <div class="groupBody">
      ${[['live','Online'],['off','Offline'],['dev','Under Development']].map(([k,lab])=>`
      <div class="modalOpt" data-dact="state" data-state="${k}"><div>${lab}</div><div class="optRight">${(d.state||'live')===k?'âœ“':''}</div></div>`).join('')}
    </div>
  </div>
  <div class="modalGroup">
    <div class="groupHead">Section Schedule</div>
    <div class="groupBody">
      <div class="modalOpt" data-dact="date" data-kind="release"><div>Set Release Date</div><div class="optRight">${badge('green',sch.release)}</div></div>
      <div class="modalOpt" data-dact="date" data-kind="expiry"><div>Set Expiry Date</div><div class="optRight">${badge('red',sch.expiry)}</div></div>
      <div class="modalOpt" data-dact="date" data-kind="dev"><div>Schedule for Development</div><div class="optRight">${badge('blue',sch.dev)}</div></div>
    </div>
  </div>
  <div class="modalGroup">
    <div class="groupHead">Danger</div>
    <div class="groupBody">
      <div class="modalOpt" data-dact="remove"><div>Remove Heading</div></div>
    </div>
  </div>`;

  mFoot.innerHTML='';
  modalRoot.hidden=false;

  mBody.onclick = (e)=>{
    const opt = e.target.closest('[data-dact]'); if(!opt) return;
    const act = opt.getAttribute('data-dact');
    if(act==='rename'){
      modalClose();
      openEditDialog({type:'divider', id:divId}, d.title||'Heading', d.color||'', Number(d.fontSize||22), d.fontFamily||"system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif");
    }else if(act==='size'){
      const size=opt.getAttribute('data-size')||'m';
      modalConfirm({title:'Change row size', body:`Apply <b>${size.toUpperCase()}</b> size to "${d.title||'Heading'}"?`}, ()=>{
        s.pageOrder[idx].rowSize=size; saveSettings(s); paintPage(); openDividerKebab(divId);
      });
    }else if(act==='aud'){
      const key=opt.getAttribute('data-aud'); const next=!(d.aud?.[key]);
      modalConfirm({title:'Change audience filter', body:`${next?'Allow':'Disallow'} <b>${key}</b> for "${d.title||'Heading'}"?`}, ()=>{
        const cur = d.aud || {bronze:true,silver:true,gold:true};
        s.pageOrder[idx].aud = {...cur, [key]:next}; saveSettings(s); paintPage(); openDividerKebab(divId);
      });
    }else if(act==='state'){
      const state=opt.getAttribute('data-state');
      modalConfirm({title:'Change section state', body:`Set "${d.title||'Heading'}" to <b>${state}</b>?`}, ()=>{
        s.pageOrder[idx].state = state; saveSettings(s); paintPage(); openDividerKebab(divId);
      });
    }else if(act==='date'){
      const kind=opt.getAttribute('data-kind');
      modalDate({title:'Select date', label:`${kind[0].toUpperCase()+kind.slice(1)} date`, value:(sch?.[kind]||'')}, (val)=>{
        s.pageOrder[idx].schedule = {...(s.pageOrder[idx].schedule||{}), [kind]:val||null};
        saveSettings(s); paintPage(); openDividerKebab(divId);
      });
    }else if(act==='remove'){
      modalConfirm({title:'Remove heading', body:`Remove "${d.title||'Heading'}"? This won't delete contained heroes.`, danger:true}, ()=>{
        s.pageOrder = s.pageOrder.filter((it)=>!(it.type==='divider' && it.id===divId)); saveSettings(s); paintPage(); modalClose();
      });
    }
  };
}

/* =========================
   Course Sheet (tap hero area)
========================= */
document.addEventListener('click',(e)=>{
  const hero = e.target.closest?.('.hero');
  if(!hero || e.target.closest('.kebab, .cfg-arrow')) return;
  const id = hero.dataset.heroId;
  const n = Number(((id||'').match(/\\d+/)||[])[0]||0);
  const url = (n>=1 && n<=50) ? `courses/${n}.html` : '';
  document.getElementById('courseTitle').textContent = labelFor(id);
  document.getElementById('courseFrame').src = url ? url + '?v=' + Date.now() : '';
  document.getElementById('courseSummary').textContent = `Quick summary for ${labelFor(id)} â€” (placeholder).`;
  const sheet = document.getElementById('courseSheet');
  sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false');
});

document.getElementById('courseClose').addEventListener('click',()=>{
  const sheet=document.getElementById('courseSheet');
  sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true');
});

})();</script>
</html>
