<!DOCTYPE html>
<html lang="en-AU">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="color-scheme" content="dark" />
<title>Home â€” FAOA</title>

<!-- Google fonts for the rename dialog -->
<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Lobster&family=Oswald:wght@400;700&family=Pacifico&family=Raleway:wght@700;900&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
<style>
:root{
  --ink:#eef3ff; --ink-dim:#cfd3e1; --muted:rgba(238,243,255,.78);
  --bg:#000; --panel:#0a0c10; --stroke:rgba(255,255,255,.18);
  --blue:#0A84FF; --green:#32d74b; --red:#ff3b30; --chip:#1b1f2a;
  --gap:12px; --r:14px; --maxw:1240px; --nav-h:68px; --hero-pad:16px;
}

/* Resets / base */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{
  height:100%; margin:0; background:var(--bg); color:var(--ink);
  font:16px -apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,sans-serif;
  overscroll-behavior-y:contain; overflow-x:hidden; user-select:none; -webkit-user-select:none;
}
a{ color:inherit; text-decoration:none }
button{ user-select:none; -webkit-user-select:none; cursor:pointer }
body.lock{ position:fixed; width:100% }

/* Background */
.bg{ position:fixed; inset:0; z-index:-1; background:#000 url("./assets/home-bg.jpg") center/cover no-repeat }

/* Top bar */
.nav{
  position:fixed; top:0; left:0; right:0; height:var(--nav-h);
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  padding:8px 12px; z-index:50;
  background:linear-gradient(180deg,rgba(0,0,0,.9),rgba(0,0,0,.55) 60%,rgba(0,0,0,.3));
  -webkit-backdrop-filter:blur(12px); backdrop-filter:blur(12px);
}
.title-tab{ font-weight:900; opacity:.92 }

/* Avatar pill */
.avatarTab{
  display:flex; flex-direction:column; align-items:flex-start; justify-content:center;
  padding:6px 12px; border-radius:12px; min-width:132px; height:44px;
  font-weight:900; line-height:1.1; text-align:left; border:1px solid var(--stroke);
  background:#222; color:#eef3ff;
}
.avatarTab .name{ font-size:15px; font-weight:900 }
.avatarTab .lvl{ font-size:12px; opacity:.95; text-transform:capitalize }

/* Avatar drawer */
#avatarSheet{
  position:fixed; inset:0; z-index:80; display:none;
  background:rgba(0,0,0,.55); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px)
}
#avatarSheet.open{ display:flex }
#avatarCard{
  margin:auto; width:min(420px,92vw); background:#0f1116; border:1px solid var(--stroke); border-radius:14px; padding:14px;
}
#avatarCard h3{ margin:0 0 12px; font-weight:900 }
#avatarClose{ float:right; }

/* Layout */
.wrap{ max-width:var(--maxw); margin:0 auto; padding:calc(var(--nav-h) + env(safe-area-inset-top) + 10px) 14px 160px }

/* Sections (each divider gets its own row) */
.section{ margin:32px 0; position:relative; z-index:0 }
.section .divider{ margin-bottom:10px }

/* Horizontal hero rows */
.section .grid{
  display:grid;
  grid-auto-flow:column;
  grid-auto-columns:max-content;
  gap:var(--gap);
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  padding-bottom:10px;
}
.section .grid::-webkit-scrollbar{ display:none }

/* Row sizing -> fixed card height per row */
.grid.size-xs{ --card-h:160px }
.grid.size-s { --card-h:190px }
.grid.size-m { --card-h:220px }
.grid.size-l { --card-h:250px }
.grid.size-xl{ --card-h:280px }

/* Hero cards (base) */
.hero{
  position:relative; overflow:hidden; background:#060708; border:1px solid var(--stroke);
  border-radius:16px; padding:var(--hero-pad); height:var(--card-h);
  width:auto; scroll-snap-align:start; display:block; cursor:pointer;
}

/* Shapes via aspect-ratio so widths align cleanly */
.hero.shape-square{ aspect-ratio:1/1; }
.hero.shape-hr    { aspect-ratio:16/9; }
.hero.shape-vr    { aspect-ratio:3/4;  }
.hero.shape-circle{ aspect-ratio:1/1; border-radius:50%; }

/* Staff-only coloured borders */
.hero.state-live { border:2px solid var(--green); }
.hero.state-dev  { border:2px solid var(--blue); }
.hero.state-off  { border:2px solid var(--red); }

/* Label */
.hero .label{
  font-weight:900; font-size:18px; opacity:.95; position:absolute; top:14px; left:16px; z-index:2
}

/* Hero controls anchored inside hero */
.hero .ctrls{ position:absolute; top:10px; right:10px; z-index:6; display:flex; align-items:center; gap:8px }
.kebab{
  display:inline-flex; align-items:center; justify-content:center;
  width:28px; height:28px; border-radius:8px; border:1px solid var(--stroke);
  background:#12151c; color:#e7eaf0; cursor:pointer; font-weight:900;
}

/* Hero reorder arrows (Admin + Dev only) */
.hero-arrows{
  display:none; position:absolute; right:8px; top:50%; transform:translateY(-50%);
  z-index:6; flex-direction:column; align-items:center; justify-content:center; gap:10px;
}
.config-on .hero .hero-arrows{ display:flex }
.cfg-arrow{
  display:inline-flex; align-items:center; justify-content:center;
  width:26px; height:26px; border-radius:8px; border:1px solid var(--stroke);
  background:#12151c; color:#e7eaf0; cursor:pointer;
}

/* Kebab menu (floating, overlayed) */
.kebab-menu{
  position:fixed !important; display:none; flex-direction:column;
  min-width:260px; max-width:92vw; max-height:80vh; overflow:auto;
  background:#1b1f2a; border:1px solid var(--stroke); border-radius:10px; padding:12px;
  box-shadow:0 20px 40px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.06) inset;
  z-index:10000 !important; pointer-events:auto;
}
.kebab-menu .group{ padding:4px 6px 8px 6px }
.kebab-menu .title{ color:#fff; font-weight:900; padding:6px 8px 2px }
.kebab-menu .opt{
  display:flex; align-items:center; gap:8px; width:100%; text-align:left;
  padding:8px 10px; border-radius:8px; border:1px solid transparent;
  background:#0f1219; color:#e7eaf0; cursor:pointer; font-weight:800;
}
.kebab-menu .opt:hover{ border-color:#2a3344; background:#141a25 }
.kebab-menu .dot{ width:8px; height:8px; border-radius:999px; background:#8fb3ff; display:inline-block }
.kebab-close{
  position:absolute; top:6px; right:6px; width:28px; height:28px; border-radius:8px;
  border:1px solid var(--stroke); background:#121212; color:#fff; font-weight:900; cursor:pointer;
}

/* Divider (Heading) */
.divider{
  position:relative; border:1px dashed var(--stroke); border-radius:14px; background:#0b0d12;
  padding:14px 16px 56px; min-height:58px; margin:18px 0; z-index:1;
}
.divider .htext{ font-weight:900; opacity:.92 }
.divider .aud-line{ position:absolute; left:16px; bottom:14px }

/* Compact headings in normal mode */
:not(.config-on) .divider{ border:none; background:transparent; min-height:0; padding:0 2px 6px; margin:28px 2px 8px; display:flex; align-items:flex-end }
:not(.config-on) .divider .aud-line{ display:none }
:not(.config-on) .divider .htext{ padding:0; margin:0 }

/* Divider controls pinned inside divider top-right */
.divider .dctrls{ position:absolute; top:10px; right:54px; display:none; gap:6px; align-items:center; z-index:6 }
.config-on .divider .dctrls{ display:flex }
.divider .ctrls{ position:absolute; top:10px; right:10px; z-index:9000 }

/* Audience indicator dots */
.aud-indicators{
  position:absolute; right:10px; bottom:10px; display:flex; gap:6px; z-index:2;
}
.aud-dot{ width:8px; height:8px; border-radius:50%; opacity:.6; outline:1px solid rgba(255,255,255,.25) }
.aud-dot.on{ opacity:1 }
.aud-dot.bronze{ background:#b87333 }
.aud-dot.silver{ background:#c0c7d1 }
.aud-dot.gold{   background:#ffd700 }
.divider .aud-indicators-head{
  position:absolute; right:10px; top:10px; transform:translateX(calc(100% + 10px));
  display:flex; gap:6px;
}

/* Footer Dock (Developer only) */
#archiveDock{
  position:fixed; left:0; right:0; bottom:0; z-index:75; background:var(--red); color:#fff; border-top:1px solid rgba(255,255,255,.25);
  transition:max-height .22s ease; overflow:hidden; overscroll-behavior:contain
}
#archiveDock .bar{
  display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 14px; font-weight:900;
  overflow-x:auto; white-space:nowrap
}
#archiveDock .bar::-webkit-scrollbar{ display:none }
#archiveDock .title{ display:inline-flex; align-items:center; gap:8px }
#archiveDock .content{ background:#160b0b; max-height:calc(60vh - 48px); overflow:auto }
#archiveDock .list{ padding:8px 12px 16px; display:flex; flex-direction:column; gap:8px }
#archiveDock .row{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:10px 12px; border:1px solid rgba(255,255,255,.28); background:#0d0d10; border-radius:10px
}
#archiveDock .row .num{ font-weight:900 }
#archiveDock.collapsed{ max-height:48px }
#archiveDock.open{ max-height:80vh }

.footer-chip{
  display:inline-flex; align-items:center; gap:6px;
  padding:7px 10px; border-radius:10px; border:1px solid var(--stroke);
  background:#141821; color:#e7eaf0; cursor:pointer; user-select:none; font:600 13px/1.2 system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
}
.footer-chip:hover{ background:#182032; }
.footer-chip.danger{ border-color:#5a1f23; background:#2a1012; color:#ffb4b8 }

/* Hide legacy CTA surface & buttons */
.aud-line{ display:none !important; }
.cta-left{ display:none !important; }
.btn{ display:none !important; }

/* Hero art layer */
.hero .art{ position:absolute; inset:0; z-index:0; opacity:.92; pointer-events:none; overflow:hidden; border-radius:inherit }
.hero .art img{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1);
  width:auto; height:110%; min-width:110%; user-select:none; pointer-events:none;
  filter:saturate(1.02) contrast(1.02) brightness(0.95);
}
.hero::after{
  content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
  background:linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.45) 65%, rgba(0,0,0,.6));
  z-index:1;
}

/* Overlay root for kebabs */
#kebabOverlay{ position:fixed; inset:0; z-index:12000; pointer-events:none; }
#kebabOverlay[hidden]{ display:none }
#kebabBackdrop{ position:absolute; inset:0; background:transparent; pointer-events:auto }

/* Course Sheet */
#courseSheet{ position:fixed; inset:0; display:none; z-index:85; background:rgba(0,0,0,.55); backdrop-filter:blur(6px) }
#coursePanel{
  position:absolute; left:50%; bottom:0; transform:translateX(-50%);
  width:min(1100px, 96vw); max-height:86vh; background:#0f1116; border:1px solid var(--stroke);
  border-radius:16px 16px 0 0; overflow:hidden; display:flex; flex-direction:column;
}
</style>
</head>

<body ontouchstart="">
<div class="bg" aria-hidden="true"></div>

<header class="nav" role="navigation" aria-label="Primary">
  <div class="nav-left"><span class="title-tab">Courses</span></div>
  <div class="nav-right">
    <button id="avatarTab" class="avatarTab" aria-haspopup="dialog" aria-expanded="false">
      <span class="name" id="avatarName">User</span>
      <span class="lvl" id="avatarLvl">Admin</span>
    </button>
  </div>
</header>

<main class="wrap">
  <div id="pageGrid"></div>
</main>

<!-- Avatar Drawer -->
<div id="avatarSheet" aria-hidden="true">
  <div id="avatarCard" role="dialog" aria-modal="true" aria-labelledby="avatarTitle">
    <button id="avatarClose" class="footer-chip" type="button">Close</button>
    <h3 id="avatarTitle">Profile</h3>
    <div style="display:flex;flex-direction:column;gap:8px">
      <div><strong>Name:</strong> <span id="drawerName">User</span></div>
      <div><strong>Role:</strong> <span id="drawerRole">Admin</span></div>
      <div class="hide-when-normal" style="gap:8px;display:flex">
        <button id="drawerToggleDev" class="footer-chip" type="button">Toggle Developer</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Dialog -->
<div id="editDialog" aria-modal="true" role="dialog">
  <div id="editPanel" role="document">
    <h3 id="editTitle">Edit</h3>
    <div class="row"><input id="editText" type="text" placeholder="Title"></div>
    <div class="row">
      <div style="font-weight:800">Colour:</div>
      <div class="palette" id="editPalette"></div>
    </div>
    <div class="row" id="fontControls">
      <div style="font-weight:800">Font:</div>
      <select id="fontFamily">
        <option value="system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif">System Sans</option>
        <option value="ui-serif,Georgia,'Times New Roman',serif">Serif</option>
        <option value="ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace">Monospace</option>
        <option value="'Comic Neue','Comic Sans MS',cursive">Comic Neue</option>
        <option value="'Pacifico',cursive">Pacifico</option>
        <option value="'Bangers',cursive">Bangers</option>
        <option value="'Lobster',cursive">Lobster</option>
        <option value="'Oswald',Arial,sans-serif">Oswald</option>
        <option value="'Raleway',Arial,sans-serif">Raleway</option>
      </select>
      <button class="fontBtn" id="fontDown" type="button" aria-label="Decrease font size">Aâ€“</button>
      <button class="fontBtn" id="fontUp"   type="button" aria-label="Increase font size">A+</button>
      <span id="fontSizeLabel" style="opacity:.9;min-width:48px;text-align:right"></span>
    </div>
    <div class="row"><div class="preview" id="editPreview">Preview</div></div>
    <div class="actions">
      <button class="footer-chip" id="editCancel">Cancel</button>
      <button class="footer-chip" id="editSave">Save</button>
    </div>
  </div>
</div>

<!-- Footer Dock (Developer only) -->
<div id="archiveDock" class="collapsed" aria-hidden="true">
  <div class="bar">
    <div class="title">
      <span id="archiveTitle">Developer Mode</span>
      <button class="footer-chip" id="devToggle" type="button">Developer: Off</button>
      <button class="footer-chip hide-when-normal" id="addHeadingBtn" type="button">Add Heading</button>
    </div>
    <div class="title" style="gap:12px">
      <button class="footer-chip" id="archiveToggle" type="button">Archived</button>
    </div>
  </div>
  <div class="content">
    <div class="list" id="archiveList"></div>
  </div>
</div>

<!-- Kebab overlay root -->
<div id="kebabOverlay" hidden aria-hidden="true">
  <div class="backdrop" id="kebabBackdrop"></div>
</div>

<!-- Course Sheet -->
<div id="courseSheet" aria-hidden="true">
  <div id="coursePanel" role="dialog" aria-modal="true">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--stroke)">
      <div style="font-weight:900" id="courseTitle">Course</div>
      <button id="courseClose" class="footer-chip" type="button" aria-label="Close">Close</button>
    </div>
    <div style="display:flex; gap:0; flex-wrap:wrap">
      <div style="flex:1 1 520px; min-height:300px; max-height:70vh; overflow:hidden; border-right:1px solid var(--stroke)">
        <iframe id="courseFrame" title="Course" src="" style="width:100%; height:100%; border:0"></iframe>
      </div>
      <div style="flex:1 1 360px; padding:12px; max-height:70vh; overflow:auto">
        <div id="courseSummary" style="opacity:.92"></div>
        <div style="display:flex; gap:8px; margin-top:12px">
          <button class="footer-chip" id="courseStart" type="button">Start</button>
          <button class="footer-chip" id="courseMarkDone" type="button">Mark Complete</button>
        </div>
      </div>
    </div>
  </div>
</div>
</body>

<script>
(()=>{'use strict';

/* =========================
   Utils / storage
========================= */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const store={
  get:(k,f)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):f }catch{ return f } },
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))
};
const K={ profile:'ao_profile', settings:'ao_settings', view:'ao_view', schemaVer:'ao_schema_version' };
const SCHEMA_VERSION=5;
const esc=s=>String(s??'')
  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
  .replace(/"/g,'&quot;').replace(/'/g,'&#39;');

/* =========================
   Roles
========================= */
const ROLE_MAP = { beginner:'bronze', intermediate:'silver', advanced:'gold' };
const ROLE_LABEL = {
  bronze:'Beginner', silver:'Intermediate', gold:'Advanced',
  support:'Support', director:'Director', admin:'Admin'
};
function normalizeRole(r){ r=String(r||'').toLowerCase(); return ROLE_MAP[r] || r; }
function baseRole(){
  const p = store.get(K.profile, { skill:'admin', displayName:'User' });
  return normalizeRole(p.skill || 'admin');
}
function getRole(){ return baseRole(); }
function isAdmin(){ return getRole()==='admin'; }
function isDirector(){ return getRole()==='director'; }
function isSupport(){ return getRole()==='support'; }
function devModeOn(){ return document.body.classList.contains('config-on'); }
function seesAll(){ const r=getRole(); return r==='admin' || r==='support' || r==='director'; }

/* =========================
   Settings + seed
========================= */
function numberFromId(id){ const m=String(id||'').match(/\d+/); return m?m[0]:'?'; }
function defaults(){
  const heroFlags={}, pageOrder=[];
  heroFlags['co-1']={state:'live', place:'page', aud:{bronze:true,silver:false,gold:false}, shape:'square'};
  heroFlags['co-2']={state:'live', place:'page', aud:{bronze:false,silver:true,gold:false}, shape:'square'};
  heroFlags['co-3']={state:'live', place:'page', aud:{bronze:false,silver:false,gold:true}, shape:'square'};
  heroFlags['co-4']={state:'dev',  place:'page', aud:{bronze:false,silver:false,gold:false}, shape:'square'};
  for(let i=5;i<=12;i++) heroFlags[`co-${i}`]={state:'off', place:'archive', aud:{bronze:true,silver:true,gold:true}, shape:'square'};
  pageOrder.push({type:'hero',id:'co-1'},{type:'hero',id:'co-2'},{type:'hero',id:'co-3'},{type:'hero',id:'co-4'});
  return { heroFlags, heroLabels:{}, heroAssets:{}, heroProgress:{}, heroStyle:{}, pageOrder, _seeded:true };
}
function sanitize(cfg){
  let c = (!cfg || typeof cfg!=='object') ? defaults() : {...cfg};
  c.heroFlags=c.heroFlags||{}; c.heroLabels=c.heroLabels||{}; c.heroAssets=c.heroAssets||{};
  c.heroProgress=c.heroProgress||{}; c.heroStyle=c.heroStyle||{}; c.pageOrder=Array.isArray(c.pageOrder)?c.pageOrder:[];
  for(let i=1;i<=50;i++){
    const id=`co-${i}`;
    if(!c.heroFlags[id]) c.heroFlags[id]={state:'off',place:'archive',aud:{bronze:true,silver:true,gold:true}, shape:'square'};
    else if(!c.heroFlags[id].shape) c.heroFlags[id].shape='square';
  }
  c.pageOrder = c.pageOrder.filter(it=> it && (it.type==='hero'||it.type==='divider'));
  Object.keys(c.heroFlags).forEach(id=>{
    if(c.heroFlags[id].place==='page' && !c.pageOrder.some(it=>it.type==='hero' && it.id===id)){
      c.pageOrder.push({type:'hero', id});
    }
  });
  return c;
}
function loadSettings(){
  const ver = Number(store.get(K.schemaVer, 0))||0;
  const raw = store.get(K.settings, null);
  const s = sanitize(raw);
  if(ver!==SCHEMA_VERSION){ store.set(K.settings, s); store.set(K.schemaVer, SCHEMA_VERSION); }
  return s;
}
let S = loadSettings();
function getSettings(){ return S; }
function saveSettings(next){ S = sanitize(next||S); store.set(K.settings,S); }

/* =========================
   Avatar
========================= */
function paintAvatar(){
  const p=store.get(K.profile,{displayName:'User',skill:'admin'});
  $('#avatarName').textContent = p.displayName || 'User';
  const role=getRole();
  $('#avatarLvl').textContent = ROLE_LABEL[role] || role;
  $('#drawerName').textContent = p.displayName || 'User';
  $('#drawerRole').textContent = ROLE_LABEL[role] || role;
}
paintAvatar();

/* Drawer wiring */
(function wireAvatarDrawer(){
  const avatarBtn = $('#avatarTab');
  const sheet = $('#avatarSheet');
  const closeBtn = $('#avatarClose');
  const toggleDev = $('#drawerToggleDev');

  function openDrawer(){
    sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false');
    avatarBtn.setAttribute('aria-expanded','true'); lockBody();
  }
  function closeDrawer(){
    sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true');
    avatarBtn.setAttribute('aria-expanded','false'); unlockBody();
  }
  avatarBtn?.addEventListener('click', openDrawer, {passive:true});
  closeBtn?.addEventListener('click', closeDrawer, {passive:true});
  sheet?.addEventListener('click', e=>{ if(e.target===sheet) closeDrawer(); }, {passive:true});
  toggleDev?.addEventListener('click', ()=>{
    if(!isAdmin()) return;
    document.body.classList.toggle('config-on');
    updateFooterModeControls(); paintPage(); paintArchive();
  }, {passive:true});
})();

/* =========================
   Label helpers
========================= */
function labelFor(id){ const s=getSettings(); return s.heroLabels[id] || `#${numberFromId(id)}`; }
function styleFor(id){
  const st=(getSettings().heroStyle||{})[id]||{};
  return {
    color: st.labelColor || '',
    font:  st.labelFont  || "system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif",
    size:  Number(st.labelSize||18)
  };
}

/* =========================
   Edit dialog (text+color+font)
========================= */
const paletteColors = ['#eef3ff','#cfd3e1','#ffffff','#000000','#808080','#0A84FF','#32d74b','#ff3b30','#ffd700','#b87333','#c0c7d1','#6a4cff','#ff9f0a','#64d2ff','#ff2d55'];

let editCtx=null;
let liveFont=18, liveColor='', liveFamily="system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif";

function applyPreview(){
  const pv = $('#editPreview');
  pv.style.color = liveColor||'';
  pv.style.fontFamily = liveFamily;
  pv.style.fontSize = liveFont+'px';
  pv.textContent = $('#editText').value || 'Preview';
  $('#fontSizeLabel').textContent = liveFont+'px';
}

function openEditDialog(ctx, currentText, currentColor, currentSize=18, currentFamily="system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif"){
  editCtx = ctx;
  $('#editTitle').textContent = (ctx.type==='hero'?'Edit Hero':'Edit Heading');
  $('#editText').value = currentText||'';

  const pal = $('#editPalette'); pal.innerHTML='';
  paletteColors.forEach(col=>{
    const b=document.createElement('button');
    b.type='button'; b.className='swatch'; b.style.background=col; b.dataset.col=col;
    b.addEventListener('click',()=>{ liveColor=col; applyPreview(); }, {passive:true});
    pal.appendChild(b);
  });

  liveFont = Math.max(10, Math.min(64, Number(currentSize||18)));
  liveColor = currentColor || '';
  liveFamily = currentFamily || "system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif";
  $('#fontFamily').value = liveFamily;

  $('#fontFamily').onchange = ()=>{ liveFamily = $('#fontFamily').value; applyPreview(); };
  $('#fontUp').onclick   = ()=>{ liveFont = Math.min(64, liveFont+1); applyPreview(); };
  $('#fontDown').onclick = ()=>{ liveFont = Math.max(10, liveFont-1); applyPreview(); };

  applyPreview();
  $('#editDialog').classList.add('open');
}
function closeEditDialog(){ $('#editDialog').classList.remove('open'); editCtx=null; }
$('#editCancel').addEventListener('click', closeEditDialog);
$('#editDialog').addEventListener('click', e=>{ if(e.target===e.currentTarget) closeEditDialog(); }, {passive:true});
$('#editSave').addEventListener('click', ()=>{
  if(!editCtx) return;
  const s=getSettings();
  const text = $('#editText').value.trim();

  if(editCtx.type==='hero'){
    if(text){ s.heroLabels[editCtx.id]=text } else { delete s.heroLabels[editCtx.id] }
    s.heroStyle = s.heroStyle || {};
    s.heroStyle[editCtx.id] = {
      ...(s.heroStyle[editCtx.id]||{}),
      labelColor: liveColor,
      labelSize:  liveFont,
      labelFont:  liveFamily
    };
  }else{
    const idx = s.pageOrder.findIndex(it=>it.type==='divider' && it.id===editCtx.id);
    if(idx>=0){
      s.pageOrder[idx].title = text || 'Heading';
      s.pageOrder[idx].color = liveColor || '';
      s.pageOrder[idx].fontSize = liveFont;
      s.pageOrder[idx].fontFamily = liveFamily;
    }
  }
  saveSettings(s);
  paintPage(); paintArchive();
  closeEditDialog();
});

/* =========================
   DOM builders
========================= */
function heroCard(id){
  const s=getSettings(); const f=s.heroFlags[id]; if(!f) return null;

  const completed = !!(s.heroProgress && s.heroProgress[id] && s.heroProgress[id].complete);
  const inprogress = !completed && !!(s.heroProgress && s.heroProgress[id] && s.heroProgress[id].inprogress);
  const art = (s.heroAssets && s.heroAssets[id] && s.heroAssets[id].heroCard) ? s.heroAssets[id].heroCard : null;

  const devOn = devModeOn();
  const canAdminDev = isAdmin() && devOn;

  const shape = f.shape || 'square';
  const st = styleFor(id);
  const labelInline = ` style="color:${esc(st.color)};font-family:${esc(st.font)};font-size:${st.size}px"`;

  const el=document.createElement('article'); 
  el.className='hero'; 
  el.dataset.heroId=id; 
  el.dataset.place=f.place;
  el.classList.add(`shape-${shape}`);

  if (seesAll()) {
    if      (f.state==='live') el.classList.add('state-live');
    else if (f.state==='dev')  el.classList.add('state-dev');
    else                       el.classList.add('state-off');
  }

  const artLayer = (art && art.src) ? `<div class="art"><img alt="" src="${esc(art.src)}"></div>` : '';

  const dot = '<span class="dot" aria-hidden="true"></span>';
  const kebabHTML = canAdminDev ? `
    <button class="kebab" aria-haspopup="true" aria-expanded="false">â‹®</button>
    <div class="kebab-menu" data-for="${esc(id)}">
      <div class="group">
        <div class="title">Orientation</div>
        <button class="opt" data-menu="shape" data-shape="square" type="button">${shape==='square'?dot:''}Square</button>
        <button class="opt" data-menu="shape" data-shape="hr"     type="button">${shape==='hr'?dot:''}Horizontal rectangle</button>
        <button class="opt" data-menu="shape" data-shape="vr"     type="button">${shape==='vr'?dot:''}Vertical rectangle</button>
        <button class="opt" data-menu="shape" data-shape="circle" type="button">${shape==='circle'?dot:''}Circle</button>
      </div>
      <div class="group">
        <div class="title">Item</div>
        <button class="opt" data-menu="rename" type="button">Rename</button>
        <button class="opt" data-menu="move"   type="button">${f.place==='page'?'Archive':'Move to Page'}</button>
        <button class="opt" data-menu="toggle" type="button">${f.state==='live'?'Set Offline':(f.state==='off'?'Set Dev':'Set Live')}</button>
        <button class="opt" data-menu="photo"  type="button">Photo</button>
      </div>
    </div>` : '';

  el.innerHTML = `
    ${artLayer}
    ${canAdminDev ? `
      <div class="hero-arrows">
        <button class="cfg-arrow" data-sort="up" data-key="hero:${esc(id)}" type="button">â–²</button>
        <button class="cfg-arrow" data-sort="down" data-key="hero:${esc(id)}" type="button">â–¼</button>
      </div>` : ``}
    <span class="label"${labelInline}>${esc(labelFor(id))}</span>
    <div class="ctrls">${kebabHTML}</div>
  `;

  if(completed) el.classList.add('completed');
  else if(inprogress) el.classList.add('inprogress');

  if(art && art.crop){
    const img = el.querySelector('.art img');
    if(img){
      const cx = Number(art.crop.cx||0), cy = Number(art.crop.cy||0), sc = Number(art.crop.scale||1);
      img.style.transform = `translate(calc(-50% + ${cx}px), calc(-50% + ${cy}px)) scale(${sc})`;
    }
  }
  return el;
}

function dividerEl(obj){
  const editable   = isAdmin() && devModeOn();
  const color      = obj.color || '';
  const fontFamily = obj.fontFamily || "system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif";
  const fontSize   = Number(obj.fontSize || 22);
  const inline     = `style="color:${esc(color)};font-family:${esc(fontFamily)};font-size:${fontSize}px"`;

  const size = (obj.rowSize || 'm'); // xs, s, m, l, xl
  const dot  = '<span class="dot" aria-hidden="true"></span>';

  const el = document.createElement('div');
  el.className = 'divider';
  el.dataset.type = 'divider';
  el.dataset.divId = obj.id;

  el.innerHTML = `
    <span class="htext" ${inline}>${esc(obj.title || 'Heading')}</span>
    ${editable ? `
      <div class="dctrls">
        <button class="footer-chip" data-div-act="up"   data-div-id="${esc(obj.id)}" type="button">â–²</button>
        <button class="footer-chip" data-div-act="down" data-div-id="${esc(obj.id)}" type="button">â–¼</button>
      </div>
      <div class="ctrls">
        <button class="kebab div-kebab" aria-haspopup="true" aria-expanded="false" type="button">â‹®</button>
        <div class="kebab-menu div-menu" role="menu" data-for="${esc(obj.id)}">
          <div class="group">
            <div class="title">Customise</div>
            <button class="opt" data-divm="rename" data-div-id="${esc(obj.id)}" type="button">Rename</button>
          </div>
          <div class="group">
            <div class="title">Size</div>
            <button class="opt" data-divm="size" data-size="xs" data-div-id="${esc(obj.id)}" type="button">${size==='xs'?dot:''}Extra Small</button>
            <button class="opt" data-divm="size" data-size="s"  data-div-id="${esc(obj.id)}" type="button">${size==='s'?dot:''}Small</button>
            <button class="opt" data-divm="size" data-size="m"  data-div-id="${esc(obj.id)}" type="button">${size==='m'?dot:''}Medium</button>
            <button class="opt" data-divm="size" data-size="l"  data-div-id="${esc(obj.id)}" type="button">${size==='l'?dot:''}Large</button>
            <button class="opt" data-divm="size" data-size="xl" data-div-id="${esc(obj.id)}" type="button">${size==='xl'?dot:''}Extra Large</button>
          </div>
          <div class="group">
            <div class="title">Audience</div>
            <button class="opt" data-divm="aud" data-aud="bronze" data-div-id="${esc(obj.id)}" type="button">${obj.aud?.bronze?dot:''}Beginner</button>
            <button class="opt" data-divm="aud" data-aud="silver" data-div-id="${esc(obj.id)}" type="button">${obj.aud?.silver?dot:''}Intermediate</button>
            <button class="opt" data-divm="aud" data-aud="gold"   data-div-id="${esc(obj.id)}" type="button">${obj.aud?.gold?dot:''}Advanced</button>
          </div>
          <div class="group"><button class="opt danger" data-divm="remove" data-div-id="${esc(obj.id)}" type="button">Remove</button></div>
        </div>
      </div>
    ` : ''}`;
  return el;
}

/* =========================
   Paint page + archive
========================= */
function paintPage(){
  const root = $('#pageGrid');
  if(!root) return;
  root.innerHTML = '';

  const s = getSettings();
  const role = getRole();
  const staff = seesAll();

  function startSection(divObj){
    if(divObj && !staff){
      const aud = divObj.aud || {bronze:true,silver:true,gold:true};
      if(!aud[role]) return null;
    }
    const sec = document.createElement('section');
    sec.className = 'section';
    if(divObj) sec.appendChild(dividerEl(divObj));
    const row = document.createElement('div');
    row.className = 'grid';
    const size = (divObj && divObj.rowSize) ? String(divObj.rowSize) : 'm';
    row.classList.add(`size-${['xs','s','m','l','xl'].includes(size)?size:'m'}`);
    sec.appendChild(row);
    root.appendChild(sec);
    return {sec, row};
  }

  let currentRow = null;

  for(const it of s.pageOrder){
    if(it.type === 'divider'){
      const started = startSection(it);
      currentRow = started ? started.row : null;
      continue;
    }
    if(it.type === 'hero'){
      const id = it.id;
      const f = s.heroFlags[id];
      if(!f || f.place!=='page') continue;

      if(!seesAll()){
        if(f.state!=='live') continue;
        if(!f.aud[role]) continue;
      }

      if(!currentRow){
        const started = startSection(null);
        currentRow = started ? started.row : null;
        if(!currentRow) continue;
      }

      const card = heroCard(id);
      if(card) currentRow.appendChild(card);
    }
  }

  // Remove empty nameless sections
  $$('#pageGrid .section').forEach(sec=>{
    const row = sec.querySelector('.grid');
    const hasHeroes = row && row.children.length>0;
    const hasDivider = !!sec.querySelector('.divider');
    if(!hasHeroes && !hasDivider){ sec.remove(); }
  });

  // After painting, add indicators for staff
  addHeroIndicators();
  addHeadingIndicators();
}

const dock=$('#archiveDock'), archiveList=$('#archiveList');
function applyArchiveVisibility(){
  if(isAdmin()){ dock.style.display='block'; dock.setAttribute('aria-hidden','false'); }
  else{ dock.style.display='none'; dock.setAttribute('aria-hidden','true'); }
}
function applyArchiveSkin(){ $('#archiveTitle').textContent='Developer Mode'; updateFooterModeControls(); }
function updateFooterModeControls(){ const devOn=devModeOn(); $('#devToggle').textContent=`Developer: ${devOn?'On':'Off'}`; $('#addHeadingBtn').style.display=(isAdmin() && devOn) ? 'inline-flex' : 'none'; }

function paintArchive(){
  const s=getSettings(); const flags=s.heroFlags;
  archiveList.innerHTML='';
  const items=Object.entries(flags).filter(([id,f])=>f.place==='archive')
    .sort((a,b)=>Number(numberFromId(a[0]))-Number(numberFromId(b[0])));
  items.forEach(([id,f])=>{
    const statusLabel = (f.state==='live'?'Live':(f.state==='dev'?'Dev':'Offline'));
    const row=document.createElement('div'); row.className='row'; row.dataset.heroId=id; row.dataset.place='archive';
    row.innerHTML = `<span class="num">${esc(labelFor(id))}</span>
    ${(isAdmin() && devModeOn())?`<div style="display:flex;gap:8px;align-items:center">
      <button class="footer-chip" data-act="move" type="button">Move to Page</button>
      <button class="footer-chip" data-act="toggle" type="button">${esc(statusLabel)}</button>
    </div>`:`<div></div>`}`;
    archiveList.appendChild(row);
  });
}

/* =========================
   Lock helpers
========================= */
let savedScrollY=0;
function lockBody(){ savedScrollY = window.scrollY||document.documentElement.scrollTop||0; document.body.classList.add('lock'); document.body.style.top=`-${savedScrollY}px`; }
function unlockBody(){ document.body.classList.remove('lock'); document.body.style.top=''; window.scrollTo(0,savedScrollY||0); }

/* =========================
   Subsheet open
========================= */
function openSubSheet(title,url){
  if(!url){ alert('401 â€” Not linked yet'); return; }
  $('#courseTitle').textContent = title;
  $('#courseFrame').src = url + (url.includes('?')?'&':'?') + 'v=' + Date.now();
  $('#courseSummary').textContent = `Quick summary for ${title} â€” (replace later).`;
  const sheet = $('#courseSheet');
  sheet.style.display='block'; sheet.setAttribute('aria-hidden','false');
  document.body.classList.add('no-scroll');
}

/* =========================
   Kebab overlay manager (with reposition/flip)
========================= */
const kebabOverlay = $('#kebabOverlay');
const kebabBackdrop = $('#kebabBackdrop');
let openMenuEl = null;
let anchorBtnEl = null;

function computeMenuPosition(anchorRect, menuSize, pad=8){
  const vw = window.innerWidth, vh = window.innerHeight;
  let left = anchorRect.right - menuSize.w;
  let top  = anchorRect.bottom + 8;
  if(left < pad) left = pad;
  if(left + menuSize.w > vw - pad) left = vw - pad - menuSize.w;
  if(top + menuSize.h > vh - pad){
    const flippedTop = anchorRect.top - 8 - menuSize.h;
    if(flippedTop >= pad) top = flippedTop;
    else top = Math.max(pad, vh - pad - menuSize.h);
  }
  return {left, top};
}

function openKebabMenu(menuEl, anchorBtn){
  closeKebabMenu();
  anchorBtnEl = anchorBtn; openMenuEl = menuEl;
  if(!menuEl.querySelector('.kebab-close')){
    const x = document.createElement('button');
    x.type='button'; x.className='kebab-close'; x.textContent='Ã—';
    x.setAttribute('aria-label','Close');
    menuEl.prepend(x);
  }
  menuEl.style.display = 'flex';
  kebabOverlay.hidden = false; kebabOverlay.setAttribute('aria-hidden','false');
  document.body.classList.add('menu-lock');
  requestAnimationFrame(()=>{
    const r = anchorBtn.getBoundingClientRect();
    const mw = Math.min(360, Math.max(210, window.innerWidth*0.6));
    const mh = Math.min(520, Math.max(220, window.innerHeight*0.6));
    const pos = computeMenuPosition(r, {w:mw, h:mh});
    menuEl.style.left = pos.left + 'px';
    menuEl.style.top  = pos.top  + 'px';
  });
  document.addEventListener('keydown', onKbdClose);
}

function closeKebabMenu(){
  if(!openMenuEl) return;
  openMenuEl.style.display = 'none';
  openMenuEl = null; anchorBtnEl = null;
  kebabOverlay.hidden = true; kebabOverlay.setAttribute('aria-hidden','true');
  document.body.classList.remove('menu-lock');
  document.removeEventListener('keydown', onKbdClose);
}

function onKbdClose(e){ if(e.key === 'Escape') closeKebabMenu(); }
kebabBackdrop.addEventListener('click', closeKebabMenu, {passive:true});
window.addEventListener('resize', ()=>{
  if(openMenuEl && anchorBtnEl){
    const r = anchorBtnEl.getBoundingClientRect();
    const rect = {w: openMenuEl.offsetWidth, h: openMenuEl.offsetHeight};
    const pos = computeMenuPosition(r, rect);
    openMenuEl.style.left = pos.left + 'px';
    openMenuEl.style.top  = pos.top  + 'px';
  }
}, {passive:true});
window.addEventListener('scroll', ()=>{
  if(openMenuEl && anchorBtnEl){
    const r = anchorBtnEl.getBoundingClientRect();
    const rect = {w: openMenuEl.offsetWidth, h: openMenuEl.offsetHeight};
    const pos = computeMenuPosition(r, rect);
    openMenuEl.style.left = pos.left + 'px';
    openMenuEl.style.top  = pos.top  + 'px';
  }
}, {passive:true});

/* =========================
   Indicators (clear + add)
========================= */
function addHeroIndicators(){
  if(!seesAll()) return;
  $$('.hero').forEach(h=>{
    h.querySelectorAll('.aud-indicators').forEach(n=>n.remove());
    const id = h.dataset.heroId;
    const f = getSettings()?.heroFlags?.[id];
    if(!f?.aud) return;
    const ind = document.createElement('div');
    ind.className = 'aud-indicators';
    ind.innerHTML = `
      <span class="aud-dot bronze ${f.aud.bronze?'on':''}" title="Beginner"></span>
      <span class="aud-dot silver ${f.aud.silver?'on':''}" title="Intermediate"></span>
      <span class="aud-dot gold   ${f.aud.gold  ?'on':''}" title="Advanced"></span>`;
    h.appendChild(ind);
  });
}
function addHeadingIndicators(){
  if(!seesAll()) return;
  $$('.divider').forEach(div=>{
    div.querySelectorAll('.aud-indicators-head').forEach(n=>n.remove());
    let aud = {bronze:false, silver:false, gold:false};
    const heroes = div.nextElementSibling?.querySelectorAll?.('.hero') || [];
    heroes.forEach(h=>{
      const f = getSettings()?.heroFlags?.[h.dataset.heroId];
      if(f?.aud){
        aud.bronze ||= !!f.aud.bronze;
        aud.silver ||= !!f.aud.silver;
        aud.gold   ||= !!f.aud.gold;
      }
    });
    const el = document.createElement('div');
    el.className = 'aud-indicators-head';
    el.innerHTML = `
      <span class="aud-dot bronze ${aud.bronze?'on':''}" title="Beginner"></span>
      <span class="aud-dot silver ${aud.silver?'on':''}" title="Intermediate"></span>
      <span class="aud-dot gold   ${aud.gold  ?'on':''}" title="Advanced"></span>`;
    div.appendChild(el);
  });
}

/* =========================
   Boot
========================= */
applyArchiveVisibility(); 
applyArchiveSkin();
paintArchive();
paintPage();
updateFooterModeControls();

/* =========================
   Footer & global handlers
========================= */
$('#archiveToggle').addEventListener('click',()=>{
  const isOpen=dock.classList.contains('open');
  dock.classList.toggle('open', !isOpen);
  dock.classList.toggle('collapsed', isOpen);
  $('#archiveToggle').textContent = !isOpen ? 'Close' : 'Archived';
  if(!isOpen) lockBody(); else unlockBody();
});

$('#devToggle').addEventListener('click', ()=>{
  if(!isAdmin()) return;
  document.body.classList.toggle('config-on');
  updateFooterModeControls(); paintPage(); paintArchive();
});

function uuidId(){return 'div_'+Math.random().toString(36).slice(2,9);}
$('#addHeadingBtn').addEventListener('click',()=>{
  if(!(isAdmin() && devModeOn())) return;
  const title=prompt('Heading title','Section'); if(title==null) return;
  const s=getSettings(); s.pageOrder.push({type:'divider', id:uuidId(), title:title.trim()||'Section', aud:{bronze:true,silver:true,gold:true}, fontSize:22, rowSize:'m'});
  saveSettings(s); paintPage();
});

/* =========================
   Delegated clicks (page)
========================= */
document.addEventListener('click',(e)=>{
  // Course entry by clicking tile (ignore when clicking controls)
  const hero = e.target.closest('.hero');
  if(hero && !e.target.closest('.kebab, .kebab-menu, .cfg-arrow')){
    const id=hero.dataset.heroId; const n=Number(((id||'').match(/\d+/)||[])[0]||0);
    const url = (n>=1 && n<=50) ? `courses/${n}.html` : '';
    openSubSheet(labelFor(id), url); return;
  }

  // Divider kebab toggle -> overlayed menu
  const divKebab = e.target.closest('.div-kebab');
  if(divKebab){
    const menu=divKebab.nextElementSibling;
    if(menu){
      if(menu === openMenuEl){ closeKebabMenu(); }
      else{ openKebabMenu(menu, divKebab); }
    }
    return;
  }

  // Hero kebab toggle -> overlayed menu
  const keb = e.target.closest('.kebab:not(.div-kebab)');
  if(keb){
    const menu=keb.nextElementSibling;
    if(menu){
      if(menu === openMenuEl){ closeKebabMenu(); }
      else{ openKebabMenu(menu, keb); }
    }
    return;
  }

  // Divider kebab actions
  const dmb = e.target.closest('.div-menu button.opt');
  if(dmb){
    if(!(isAdmin() && devModeOn())) return;
    const s=getSettings();
    const id=dmb.getAttribute('data-div-id');
    const idx=s.pageOrder.findIndex(it=>it.type==='divider' && it.id===id);
    if(idx<0) return;
    const obj=s.pageOrder[idx];

    const kind = dmb.dataset.divm;
    if(kind==='rename'){
      closeKebabMenu();
      openEditDialog({type:'divider', id}, obj.title||'Heading', obj.color||'', Number(obj.fontSize||22), obj.fontFamily||"system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif");
      return;
    }
    if(kind==='size'){
      const size=dmb.dataset.size||'m';
      obj.rowSize=size; saveSettings(s); paintPage(); closeKebabMenu(); return;
    }
    if(kind==='aud'){
      const key=dmb.dataset.aud;
      const next=!obj.aud?.[key];
      obj.aud = {...(obj.aud||{bronze:true,silver:true,gold:true}), [key]:next};
      saveSettings(s); paintPage(); closeKebabMenu(); return;
    }
    if(kind==='remove'){
      s.pageOrder.splice(idx,1); saveSettings(s); paintPage(); closeKebabMenu(); return;
    }
  }

  // Divider arrows
  const divAct = e.target.dataset.divAct;
  if(divAct){
    if(!(isAdmin() && devModeOn())) return;
    const id = e.target.dataset.divId;
    const s = getSettings();
    const idx = s.pageOrder.findIndex(it=>it.type==='divider' && it.id===id);
    if(idx<0) return;
    const dir = (divAct==='up') ? -1 : 1;
    const to  = Math.min(Math.max(0, idx + dir), s.pageOrder.length - 1);
    if (to !== idx) {
      const obj = s.pageOrder.splice(idx,1)[0];
      s.pageOrder.splice(to,0,obj);
      saveSettings(s); paintPage();
    }
    return;
  }

  // Hero kebab menu actions
  const menuBtn = e.target.closest('.kebab-menu button.opt');
  if(menuBtn && !menuBtn.closest('.div-menu')){
    const forId = menuBtn.closest('.kebab-menu')?.dataset?.for;
    const s=getSettings(); const f=s.heroFlags[forId];
    if(!(isAdmin() && devModeOn())) return;

    const act = menuBtn.dataset.menu;
    if(act==='shape'){
      const shape = menuBtn.dataset.shape;
      s.heroFlags[forId] = {...f, shape};
      saveSettings(s); paintPage(); closeKebabMenu();
    }else if(act==='rename'){
      closeKebabMenu();
      const st = styleFor(forId);
      openEditDialog({type:'hero', id:forId}, s.heroLabels[forId] || `#${numberFromId(forId)}`, st.color, st.size, st.font);
    }else if(act==='move'){
      const dest = (f.place==='page') ? 'archive' : 'page';
      s.heroFlags[forId]={...f, place:dest};
      if(dest==='page'){
        if(!s.pageOrder.some(it=>it.type==='hero' && it.id===forId)) s.pageOrder.push({type:'hero',id:forId});
      }else{
        s.pageOrder = s.pageOrder.filter(it=>!(it.type==='hero' && it.id===forId));
      }
      saveSettings(s); paintPage(); paintArchive(); closeKebabMenu();
    }else if(act==='toggle'){
      const order=['live','off','dev'];
      const ni=(order.indexOf(f.state)+1)%order.length;
      s.heroFlags[forId]={...f, state:order[ni]};
      saveSettings(s); paintPage(); paintArchive(); closeKebabMenu();
    }else if(act==='photo'){
      const url = prompt('Image path (under /images ...)', 'images/your-folder/your-image.jpg'); if(!url) return;
      s.heroAssets[forId]={...(s.heroAssets[forId]||{}), heroCard:{src:url, crop:{cx:0,cy:0,scale:1}}};
      saveSettings(s); paintPage(); closeKebabMenu();
    }
    return;
  }

  // Archive list actions
  const actToggle = e.target.closest('#archiveList [data-act="toggle"]');
  const actMove = e.target.closest('#archiveList [data-act="move"]');
  if(actToggle || actMove){
    if(!(isAdmin() && devModeOn())) return;
    const row = e.target.closest('.row'); const id=row.dataset.heroId;
    const s=getSettings(); const f=s.heroFlags[id];
    if(actToggle){
      const order=['live','off','dev'];
      const ni=(order.indexOf(f.state)+1)%order.length;
      s.heroFlags[id]={...f, state:order[ni]};
    }else if(actMove){
      s.heroFlags[id]={...f, place:'page'};
      if(!s.pageOrder.some(it=>it.type==='hero' && it.id===id)) s.pageOrder.push({type:'hero',id});
    }
    saveSettings(s); paintPage(); paintArchive();
  }
}, {passive:false});

/* =========================
   Course sheet close
========================= */
$('#courseClose')?.addEventListener('click', ()=>{ 
  const sheet=$('#courseSheet'); sheet.style.display='none'; sheet.setAttribute('aria-hidden','true');
  $('#courseFrame').src=''; document.body.classList.remove('no-scroll');
});
$('#courseSheet')?.addEventListener('click', e=>{ if(e.target.id==='courseSheet') $('#courseClose')?.click(); });
document.addEventListener('keydown', e=>{ if(e.key==='Escape' && $('#courseSheet')?.style.display==='block') $('#courseClose')?.click(); });

})();
</script>
</html>