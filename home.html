<!DOCTYPE html>
<html lang="en-AU">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="color-scheme" content="dark" />
<title>Home — FAOA</title>

<style>
:root{
  --ink:#eef3ff; --ink-dim:#cfd3e1; --muted:rgba(238,243,255,.78);
  --bg:#000; --panel:#0a0c10; --stroke:rgba(255,255,255,.18);
  --blue:#0A84FF; --green:#32d74b; --red:#ff3b30; --chip:#1b1f2a;
  --gap:12px; --r:14px; --maxw:1240px; --nav-h:68px; --hero-pad:16px;
}

/* Resets / base */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{
  height:100%; margin:0; background:var(--bg); color:var(--ink);
  font:16px -apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,sans-serif;
  overscroll-behavior-y:contain; overflow-x:hidden; user-select:none; -webkit-user-select:none;
}
a{ color:inherit; text-decoration:none }
button{ user-select:none; -webkit-user-select:none; cursor:pointer }
body.lock{ position:fixed; width:100% }

/* Background */
.bg{ position:fixed; inset:0; z-index:-1; background:#000 url("./assets/home-bg.jpg") center/cover no-repeat }

/* Top bar */
.nav{
  position:fixed; top:0; left:0; right:0; height:var(--nav-h);
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  padding:8px 12px; z-index:50;
  background:linear-gradient(180deg,rgba(0,0,0,.9),rgba(0,0,0,.55) 60%,rgba(0,0,0,.3));
  -webkit-backdrop-filter:blur(12px); backdrop-filter:blur(12px);
}
.title-tab{ font-weight:900; opacity:.92 }

/* Avatar pill */
.avatarTab{
  display:flex; flex-direction:column; align-items:flex-start; justify-content:center;
  padding:6px 12px; border-radius:12px; min-width:132px; height:44px;
  font-weight:900; line-height:1.1; text-align:left; border:1px solid var(--stroke);
  background:#222; color:#eef3ff;
}
.avatarTab .name{ font-size:15px; font-weight:900 }
.avatarTab .lvl{ font-size:12px; opacity:.95; text-transform:capitalize }

/* Layout */
.wrap{ max-width:var(--maxw); margin:0 auto; padding:calc(var(--nav-h) + env(safe-area-inset-top) + 10px) 14px 160px }

/* Grid */
.grid{ display:grid; gap:12px }
@media (max-width:600px){ .grid{ grid-template-columns:1fr } }
@media (min-width:601px) and (max-width:900px){ .grid{ grid-template-columns:1fr 1fr } }
@media (min-width:901px) and (max-width:1180px){ .grid{ grid-template-columns:1fr 1fr 1fr } }
@media (min-width:1181px){ .grid{ grid-template-columns:1fr 1fr 1fr 1fr } }

/* Hero */
.hero{
  position:relative; overflow:hidden; background:#060708; border:1px solid var(--stroke);
  border-radius:16px; padding:var(--hero-pad); min-height:240px;
}
.hero .label{ font-weight:900; font-size:18px; opacity:.95; position:absolute; top:14px; left:16px; z-index:2 }

/* rename pencil */
.cfg-pin{
  position:absolute; top:10px; left:12px; z-index:5;
  width:28px; height:28px; border-radius:8px;
  border:1px solid var(--stroke); background:#121212; color:#fff; font-weight:900; line-height:1;
}
.hero.has-pencil .label{ left:46px } /* nudge label when pencil is present */

.ctrls{ position:absolute; top:10px; right:10px; display:flex; gap:8px; z-index:5 }
.chip{
  height:28px; padding:0 12px; border-radius:999px; border:1px solid var(--stroke);
  background:var(--chip); color:#fff; font-weight:800; font-size:12px; white-space:nowrap
}
.chip[disabled]{ opacity:.55; filter:grayscale(.15) }
.badge-live{ background:#0a0 }
.badge-off{ background:#b00020 }
.badge-dev{ background:var(--blue); color:#000; border-color:transparent }

.hero-arrows{ display:none; position:absolute; right:10px; top:50%; transform:translateY(-50%); z-index:4; flex-direction:column; gap:6px }
.config-on .hero .hero-arrows{ display:flex }
.hero-arrows .cfg-arrow{
  height:24px; padding:0 6px; border-radius:8px; border:1px solid var(--stroke);
  background:#161922; color:#fff; font-weight:900; font-size:12px
}

/* Buttons */
.btn{
  display:inline-flex; align-items:center; justify-content:center; min-width:120px; height:40px; padding:0 14px;
  border-radius:12px; border:1px solid var(--stroke); font-weight:900; background:#0f1116; color:var(--ink)
}
.btn.blue{ background:var(--blue); border-color:transparent; color:#000 }
.btn.grey{ background:#3a3a3a; color:#fff; border-color:var(--stroke) }

/* CTA + audience */
.cta-left{ position:absolute; left:16px; bottom:16px; display:flex; flex-direction:column; align-items:flex-start; gap:8px; z-index:2 }
.aud-line{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
.aud-chip{
  height:28px; padding:0 12px; border-radius:999px; border:1px solid var(--stroke);
  background:#141416; color:#fff; font-weight:800; font-size:12px; opacity:.9
}
.aud-chip.on{ opacity:1; filter:brightness(1.22) }
.aud-chip.on::after{ content:" ✓"; font-weight:900 }
.aud-chip.bronze{ box-shadow:inset 0 0 0 2px #b87333 }
.aud-chip.silver{ box-shadow:inset 0 0 0 2px #c0c7d1 }
.aud-chip.gold{   box-shadow:inset 0 0 0 2px #ffd700 }

/* Read-only status pill (normal mode only for staff) */
.status-pill{
  position:absolute; top:12px; right:12px; height:28px; padding:0 12px; border-radius:999px;
  display:inline-flex; align-items:center; font-weight:900; z-index:4; border:1px solid rgba(255,255,255,.18)
}
.status-live{ background:#1c6b1c; color:#fff }
.status-off{ background:#5a0d12; color:#fff }
.status-dev{ background:var(--blue); color:#000; border-color:transparent }

/* Divider (Heading) */
.divider{
  position:relative; border:1px dashed var(--stroke); border-radius:14px; background:#0b0d12;
  padding:14px 16px 56px; min-height:58px; grid-column:1 / -1;
}
.divider .htext{ font-weight:900; opacity:.92 }
.divider .dctrls{ position:absolute; top:10px; right:10px; display:none; gap:6px }
.config-on .divider .dctrls{ display:flex }
.divider .aud-line{ position:absolute; left:16px; bottom:14px }

/* Compact headings when NOT in config mode */
:not(.config-on) .divider{ border:none; background:transparent; min-height:0; padding:0 2px 6px; margin:28px 2px 8px; display:flex; align-items:flex-end }
:not(.config-on) .divider .aud-line{ display:none }
:not(.config-on) .divider .htext{ padding:0; margin:0 }

/* Avatar Drawer */
#avatarSheet{
  position:fixed; inset:0; z-index:70; display:none;
  background:rgba(0,0,0,.55); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px)
}
#avatarSheet.open{ display:block }
#avatarSheet .panel{
  position:absolute; inset:0; margin:auto; width:100%; height:100%;
  background:#0f1116; border:1px solid var(--stroke); border-radius:0; padding:12px; overflow:auto;
}
#avatarClose{
  position:absolute; right:12px; top:12px; width:32px; height:32px; border-radius:10px; border:1px solid var(--stroke);
  background:#121212; color:#fff; font-weight:900; line-height:1; z-index:2;
}
@media (min-width:820px){
  #avatarSheet .panel{ width:min(780px, 92vw); height:min(86vh, 920px); right:12px; left:auto; top:calc(var(--nav-h) + 8px); bottom:auto; border-radius:14px }
}
.menu-list a{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 10px; border-bottom:1px solid rgba(255,255,255,.08)
}
.menu-list a:last-child{ border-bottom:none }

/* Subsheet (courses) */
#subSheet{
  position:fixed; inset:0; z-index:80; display:none;
  background:rgba(0,0,0,.75); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px)
}
#subSheet.open{ display:block }
#subSheet .inner{
  position:absolute; inset:0; background:#0f1116; border:none; border-radius:0; padding:0;
  display:flex; flex-direction:column
}
.sheet-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-bottom:1px solid var(--stroke) }
.sheet-close{ width:36px; height:36px; border-radius:10px; border:1px solid var(--stroke); background:#121212; color:#fff; font-weight:900 }
#subFrame{ flex:1 1 auto; width:100%; height:100%; border:none; background:#0b0c10; overflow:hidden }

/* Footer Dock (Developer only, single Archived chip) */
#archiveDock{
  position:fixed; left:0; right:0; bottom:0; z-index:75; background:var(--red); color:#fff; border-top:1px solid rgba(255,255,255,.25);
  transition:max-height .22s ease; overflow:hidden; overscroll-behavior:contain
}
#archiveDock .bar{
  display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 14px; font-weight:900;
  overflow-x:auto; white-space:nowrap
}
#archiveDock .bar::-webkit-scrollbar{ display:none }
#archiveDock .title{ display:inline-flex; align-items:center; gap:8px }
#archiveDock .content{ background:#160b0b; max-height:calc(60vh - 48px); overflow:auto }
#archiveDock .list{ padding:8px 12px 16px; display:flex; flex-direction:column; gap:8px }
#archiveDock .row{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:10px 12px; border:1px solid rgba(255,255,255,.28); background:#0d0d10; border-radius:10px
}
#archiveDock .row .num{ font-weight:900 }
#archiveDock .row .chip{ height:26px }
#archiveDock.collapsed{ max-height:48px }
#archiveDock.open{ max-height:80vh }

/* Footer controls */
.footer-chip{
  display:inline-flex; align-items:center; gap:8px; height:34px; padding:0 12px; border-radius:999px;
  border:1px solid var(--stroke); background:#1b1f2a; color:#fff; font-weight:800
}
.footer-select{
  appearance:none; background:#10131b; border:1px solid var(--stroke); color:#fff; height:34px;
  border-radius:999px; padding:0 38px 0 12px; font-weight:800
}
.footer-label{ opacity:.9; margin-left:10px; font-size:12px }

/* Completed / In-Progress / DEV priority order */
.hero.completed{ border:2px solid #888 }            /* completed = grey */
.hero.inprogress{ border:2px solid var(--green) }   /* in-progress = green */
.hero.devstate{ border:2px solid var(--blue) }      /* DEV = blue (highest) */

/* Hero art layer */
.hero .art{ position:absolute; inset:0; z-index:0; opacity:.92; pointer-events:none; overflow:hidden; border-radius:16px }
.hero .art img{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1);
  width:auto; height:110%; min-width:110%; user-select:none; pointer-events:none;
  filter:saturate(1.02) contrast(1.02) brightness(0.95);
}
.hero::after{
  content:""; position:absolute; inset:0; border-radius:16px; pointer-events:none;
  background:linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.45) 65%, rgba(0,0,0,.6));
  z-index:1;
}

/* Hide editor-only bits when not in dev */
.hide-when-normal{ display:none }
.config-on .hide-when-normal{ display:flex }

/* In normal view hide audience line entirely unless director-on-dev (unchanged) */
.normal-hide{ display:none }
.config-on .normal-hide{ display:flex }
</style>
</head>

<body ontouchstart="">
<div class="bg" aria-hidden="true"></div>

<header class="nav" role="navigation" aria-label="Primary">
  <div class="nav-left"><span class="title-tab">Courses</span></div>
  <div class="nav-right">
    <button id="avatarTab" class="avatarTab" aria-haspopup="dialog" aria-expanded="false">
      <span class="name" id="avatarName">User</span>
      <span class="lvl" id="avatarLvl">Admin</span>
    </button>
  </div>
</header>

<main class="wrap">
  <section class="grid" id="pageGrid"></section>
</main>

<!-- Avatar Drawer -->
<div id="avatarSheet" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="panel" role="document">
    <button id="avatarClose" aria-label="Close">×</button>
    <nav class="menu-list" id="avatarMenu">
      <a href="avatar/profile.html" data-pop="Profile">Profile<span>›</span></a>
      <a href="avatar/settings.html" data-pop="Settings">Settings<span>›</span></a>
      <a href="avatar/mydata.html" data-pop="My Data">My Data<span>›</span></a>
      <a href="avatar/statistics.html" data-pop="Statistics">Statistics<span>›</span></a>
      <a href="avatar/usersearch.html" data-pop="User Search">User Search<span>›</span></a>
    </nav>
  </div>
</div>

<!-- Subsheet (courses) -->
<div id="subSheet" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="inner" role="document">
    <div class="sheet-head">
      <h2 id="sheetTitle">—</h2>
      <button class="sheet-close" id="sheetClose" aria-label="Close" type="button">×</button>
    </div>
    <iframe id="subFrame" title="Panel"></iframe>
  </div>
</div>

<!-- Footer Dock (Developer only) -->
<div id="archiveDock" class="collapsed" aria-hidden="true">
  <div class="bar">
    <div class="title">
      <span id="archiveTitle">Developer Mode</span>
      <button class="footer-chip" id="devToggle" type="button">Developer: Off</button>

      <span class="footer-label">Cols</span>
      <select id="footerCols" class="footer-select">
        <option value="1">1</option><option value="2">2</option>
        <option value="3" selected>3</option><option value="4">4</option>
      </select>
    </div>

    <div class="title" style="gap:12px">
      <!-- Only one control: Archived/Close -->
      <button class="footer-chip" id="archiveToggle" type="button">Archived</button>
    </div>
  </div>

  <div class="content">
    <div class="list" id="archiveList"></div>
  </div>
</div>

<script>
(()=>{'use strict';

/* ===== utils & storage ===== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const store={
  get:(k,f)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):f }catch{ return f } },
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))
};
const K={ profile:'ao_profile', settings:'ao_settings', view:'ao_view' };

/* URL reset hook */
const Q=new URLSearchParams(location.search);
if(Q.get('reset')==='1'){
  localStorage.removeItem(K.settings);
  localStorage.removeItem(K.view);
}

/* Role labels */
const ROLE_LABEL = {
  bronze:'Beginner', silver:'Intermediate', gold:'Advanced',
  support:'Support', director:'Director', admin:'Admin'
};

/* ===== view settings (cols only) ===== */
function defaultView(){ return { cols:3 }; }
function getView(){
  const raw = store.get(K.view, defaultView()) || {};
  const cols = Math.min(4, Math.max(1, Number(raw.cols) || 3));
  return { cols };
}
function saveView(v){
  const cols = Math.min(4, Math.max(1, Number((v && v.cols) || 3)));
  store.set(K.view, { cols });
  applyView();
}
function applyView(){
  const v = getView();
  const grid = document.querySelector('#pageGrid, .grid');
  if(!grid) return;
  grid.style.gridTemplateColumns = `repeat(${v.cols}, 1fr)`;
  grid.style.gap = (v.cols >= 3 ? 36 : 18) + 'px';
  document.documentElement.style.setProperty('--hero-pad', '18px');
}

/* ===== roles ===== (profile only) with normalization */
const ROLE_MAP = { beginner:'bronze', intermediate:'silver', advanced:'gold' };
function normalizeRole(r){ r=String(r||'').toLowerCase(); return ROLE_MAP[r] || r; }
function baseRole(){
  const p = store.get(K.profile, { skill:'admin', displayName:'User' });
  return normalizeRole(p.skill || 'admin');
}
function getRole(){ return baseRole(); }
function isAdmin(){ return getRole()==='admin'; }
function isDirector(){ return getRole()==='director'; }
function isSupport(){ return getRole()==='support'; }

/* Edit permissions */
function devModeOn(){ return document.body.classList.contains('config-on'); }
function canDirectorDevEdit(flag){ return isDirector() && flag?.state==='dev'; } // director gets audience/photo on DEV (no rename)

/* Visibility helpers */
function seesAll(){ const r=getRole(); return r==='admin' || r==='support' || r==='director'; }
function canSeeStatusPill(){ return isAdmin() || isSupport() || isDirector(); } // hidden from bronze/silver/gold

/* ===== avatar paint ===== */
function paintAvatar(){
  const p=store.get(K.profile,{displayName:'User',skill:'admin'});
  $('#avatarName').textContent = p.displayName || 'User';
  const role=getRole();
  const friendly = ROLE_LABEL[role] || (role.charAt(0).toUpperCase()+role.slice(1));
  $('#avatarLvl').textContent = friendly || role;
  const map={bronze:'#b87333',silver:'#c0c7d1',gold:'#ffd700',support:'#6a4cff',director:'#6a4cff',admin:'#0A84FF'};
  const pill=$('#avatarTab');
  pill.style.background = map[role] || '#222';
  pill.style.color = (role==='gold'||role==='silver'||role==='admin') ? '#0b0c10' : '#eef3ff';
}

/* ===== avatar drawer & subsheet ===== */
const avatarBtn=$('#avatarTab'), avatarSheet=$('#avatarSheet');
function openDrawer(){ avatarSheet.classList.add('open'); avatarSheet.setAttribute('aria-hidden','false'); avatarBtn.setAttribute('aria-expanded','true'); lockBody(); }
function closeDrawer(){ avatarSheet.classList.remove('open'); avatarSheet.setAttribute('aria-hidden','true'); avatarBtn.setAttribute('aria-expanded','false'); unlockBody(); }
avatarBtn.addEventListener('click', openDrawer, {passive:true});
avatarSheet.addEventListener('click', e=>{ if(e.target===avatarSheet) closeDrawer(); }, {passive:true});
document.addEventListener('click', e=>{ if(e.target && e.target.id==='avatarClose') closeDrawer(); }, {passive:true});

const subSheet=$('#subSheet'), subFrame=$('#subFrame'), sheetTitle=$('#sheetTitle');
function openSubSheet(title,url,heroId){
  sheetTitle.textContent=title;
  if(!url){ alert('401 — Not linked yet'); return; }
  const origin = encodeURIComponent(location.origin);
  const hid = encodeURIComponent(heroId||'');
  subFrame.src = url + (url.includes('?')?'&':'?') + 'v=' + Date.now() + `&heroId=${hid}&parent=${origin}`;
  subSheet.classList.add('open'); subSheet.setAttribute('aria-hidden','false'); lockBody();
}
function closeSubSheet(){ subSheet.classList.remove('open'); subSheet.setAttribute('aria-hidden','true'); subFrame.src='about:blank'; unlockBody(); }
$('#sheetClose').addEventListener('click', closeSubSheet, {passive:true});
subSheet.addEventListener('click', e=>{ if(e.target===subSheet) closeSubSheet(); }, {passive:true});
$$('#avatarSheet [data-pop]').forEach(a=>a.addEventListener('click',e=>{
  e.preventDefault(); closeDrawer(); openSubSheet(a.dataset.pop, a.getAttribute('href'));
}, {passive:false}));

/* ===== settings & seed ===== */
function defaults(){
  const heroFlags={}, pageOrder=[];
  // co-1..co-6 on page with specific states/audiences
  // 1: live bronze only
  heroFlags['co-1']={state:'live',place:'page',aud:{bronze:true,silver:false,gold:false}};
  pageOrder.push({type:'hero',id:'co-1'});
  // 2: live silver only
  heroFlags['co-2']={state:'live',place:'page',aud:{bronze:false,silver:true,gold:false}};
  pageOrder.push({type:'hero',id:'co-2'});
  // 3: live gold only
  heroFlags['co-3']={state:'live',place:'page',aud:{bronze:false,silver:false,gold:true}};
  pageOrder.push({type:'hero',id:'co-3'});
  // 4: DEV, no audience
  heroFlags['co-4']={state:'dev',place:'page',aud:{bronze:false,silver:false,gold:false}};
  pageOrder.push({type:'hero',id:'co-4'});
  // 5: offline
  heroFlags['co-5']={state:'off',place:'page',aud:{bronze:true,silver:true,gold:true}};
  pageOrder.push({type:'hero',id:'co-5'});
  // 6: offline
  heroFlags['co-6']={state:'off',place:'page',aud:{bronze:true,silver:true,gold:true}};
  pageOrder.push({type:'hero',id:'co-6'});

  // co-7..co-50 offline in archive
  for(let i=7;i<=50;i++){
    const id=`co-${i}`;
    heroFlags[id]={state:'off',place:'archive',aud:{bronze:true,silver:true,gold:true}};
  }

  return { heroFlags, heroLabels:{}, heroAssets:{}, heroProgress:{}, heroStyle:{}, pageOrder, _seeded:true };
}
function sanitize(cfg){
  let c = (!cfg || typeof cfg!=='object') ? defaults() : {...cfg};
  c.heroFlags=c.heroFlags||{}; c.heroLabels=c.heroLabels||{}; c.heroAssets=c.heroAssets||{};
  c.heroProgress=c.heroProgress||{}; c.heroStyle=c.heroStyle||{}; c.pageOrder=Array.isArray(c.pageOrder)?c.pageOrder:[];
  // ensure references exist & pageOrder contains placed heroes
  for(let i=1;i<=50;i++){
    const id=`co-${i}`;
    if(!c.heroFlags[id]) c.heroFlags[id]={state:'off',place:'archive',aud:{bronze:true,silver:true,gold:true}};
    const onPage = c.heroFlags[id].place==='page';
    if(onPage && !c.pageOrder.some(it=>it.type==='hero' && it.id===id)) c.pageOrder.push({type:'hero',id});
  }
  // ensure at least one on page
  const hasPage = c.pageOrder.some(it=>it.type==='hero' && c.heroFlags[it.id]?.place==='page');
  if(!hasPage){
    ['co-1','co-2','co-3','co-4','co-5','co-6'].forEach(id=>{
      if(!c.pageOrder.some(it=>it.type==='hero' && it.id===id)) c.pageOrder.push({type:'hero',id});
    });
  }
  c.pageOrder=c.pageOrder.map(it=> it.type==='divider' ? ({aud:{bronze:true,silver:true,gold:true}, ...it}) : it);
  return c;
}
function getSettings(){ return sanitize(store.get(K.settings,null) || (store.set(K.settings,defaults()), store.get(K.settings))); }
function saveSettings(s){ store.set(K.settings,sanitize(s)); }
(function(){ const s=store.get(K.settings,null); store.set(K.settings, sanitize(s)); })();

/* ===== helpers ===== */
function numberFromId(id){ const m=String(id||'').match(/\d+/); return m?m[0]:'?'; }
function labelFor(id){ const s=getSettings(); return s.heroLabels[id] || `#${numberFromId(id)}`; }
function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

/* ===== DOM builders ===== */
function heroCard(id){
  const s=getSettings(); const f=s.heroFlags[id]; if(!f) return null;

  const completed = !!(s.heroProgress && s.heroProgress[id] && s.heroProgress[id].complete);
  const inprogress = !completed && !!(s.heroProgress && s.heroProgress[id] && s.heroProgress[id].inprogress);
  const art = (s.heroAssets && s.heroAssets[id] && s.heroAssets[id].heroCard) ? s.heroAssets[id].heroCard : null;

  const role = getRole();
  const devOn = devModeOn();

  /* Status pill vs chip rules */
  const showStatusPill = (!devOn) && canSeeStatusPill(); // staff-only, normal mode
  const statusPill = showStatusPill ? 
    `<span class="status-pill ${
      f.state==='live'?'status-live' : (f.state==='dev'?'status-dev':'status-off')
    }">${f.state==='live'?'Live':(f.state==='dev'?'Dev':'Offline')}</span>` : '';

  /* Controls visibility */
  const showArchiveChip = isAdmin() && devOn;
  const showStatusChipInDev = devOn && (isAdmin() || isSupport() || isDirector()); // visible to staff in dev; clickable only for admin
  const statusChipDisabled = !isAdmin(); // only admin toggles
  const showPhotoChip = (isAdmin() && devOn) || (canDirectorDevEdit(f)); // director gets photo when hero is DEV even in normal mode
  const showRenamePencil = (isAdmin() && devOn); // ADMIN ONLY
  const showAudienceLine = (isAdmin() && devOn) || (canDirectorDevEdit(f)); // director can edit audiences on DEV heroes

  /* Build controls (Archive | Status | Photo) */
  let ctrlsHTML = '';
  if (showArchiveChip || showStatusChipInDev || showPhotoChip){
    ctrlsHTML += `<div class="ctrls">`;
    if(showArchiveChip){
      ctrlsHTML += `<button class="chip" data-act="move" type="button">${f.place==='page'?'Archive':'Move to Page'}</button>`;
    }
    if(showStatusChipInDev){
      const editClass = f.state==='live'?'badge-live':(f.state==='dev'?'badge-dev':'badge-off');
      const editLabel = f.state==='live'?'Live':(f.state==='dev'?'Dev':'Offline');
      ctrlsHTML += `<button class="chip ${editClass}" data-act="toggle" type="button" ${statusChipDisabled?'disabled':''}>${editLabel}</button>`;
    }
    if(showPhotoChip){
      ctrlsHTML += `<button class="chip" data-act="pickart" type="button">Photo</button>`;
    }
    ctrlsHTML += `</div>`;
  }

  let btnLabel = 'Start', btnClass='blue';
  if(completed){ btnLabel='Complete'; btnClass='grey'; }
  else if(inprogress){ btnLabel='In Progress'; }

  const el=document.createElement('article'); el.className='hero'; el.dataset.heroId=id; el.dataset.place=f.place;
  const artLayer = (art && art.src) ? `<div class="art"><img alt="" src="${art.src}"></div>` : '';

  /* Apply label color if set */
  const labelColor = (s.heroStyle && s.heroStyle[id] && s.heroStyle[id].labelColor) ? `style="color:${s.heroStyle[id].labelColor}"` : '';

  el.innerHTML =
    `${artLayer}
     ${statusPill}
     ${showRenamePencil ? `<button class="cfg-pin" title="Rename" data-cfg-rename="${id}" type="button">✎</button>` : ``}
     ${(isAdmin() && devOn) ? `
       <div class="hero-arrows">
         <button class="cfg-arrow" data-sort="up" data-key="hero:${id}" type="button">▲</button>
         <button class="cfg-arrow" data-sort="down" data-key="hero:${id}" type="button">▼</button>
       </div>` : ``}
     <span class="label" ${labelColor}>${labelFor(id)}</span>
     ${ctrlsHTML}
     <div class="cta-left">
       <button class="btn ${btnClass}" data-act="enter" type="button">${btnLabel}</button>
       ${(showAudienceLine) ? `
         <div class="aud-line">
           <button class="aud-chip bronze ${f.aud.bronze?'on':''}" data-aud="bronze" type="button">Beginner</button>
           <button class="aud-chip silver ${f.aud.silver?'on':''}" data-aud="silver" type="button">Intermediate</button>
           <button class="aud-chip gold   ${f.aud.gold  ?'on':''}" data-aud="gold"   type="button">Advanced</button>
         </div>` : ``}
     </div>`;

  if(showRenamePencil){ el.classList.add('has-pencil'); }
  if(completed) el.classList.add('completed');
  else if(inprogress) el.classList.add('inprogress');
  if(f.state === 'dev') el.classList.add('devstate'); // DEV border (highest priority)

  if(art && art.crop){
    const img = el.querySelector('.art img');
    if(img){
      const cx = Number(art.crop.cx||0), cy = Number(art.crop.cy||0), sc = Number(art.crop.scale||1);
      img.style.transform = `translate(calc(-50% + ${cx}px), calc(-50% + ${cy}px)) scale(${sc})`;
    }
  }
  return el;
}

function dividerEl(obj){
  // Admin-only + Developer mode for tools and audience on headings
  const editable = isAdmin() && devModeOn();

  const tools = editable ? 
    `<div class="dctrls">
      <button class="chip" data-div-act="rename" data-div-id="${obj.id}" type="button">Rename</button>
      <button class="chip" data-div-act="color"  data-div-id="${obj.id}" type="button">Color</button>
      <button class="chip" data-div-act="up"     data-div-id="${obj.id}" type="button">▲</button>
      <button class="chip" data-div-act="down"   data-div-id="${obj.id}" type="button">▼</button>
      <button class="chip" data-div-act="remove" data-div-id="${obj.id}" type="button">Remove</button>
    </div>` : '';

  const audLine = editable ? 
    `<div class="aud-line">
      <button class="aud-chip bronze ${obj.aud?.bronze?'on':''}" data-div-aud="bronze" data-div-id="${obj.id}" type="button">Beginner</button>
      <button class="aud-chip silver ${obj.aud?.silver?'on':''}" data-div-aud="silver" data-div-id="${obj.id}" type="button">Intermediate</button>
      <button class="aud-chip gold   ${obj.aud?.gold  ?'on':''}" data-div-aud="gold"   data-div-id="${obj.id}" type="button">Advanced</button>
    </div>` : '';

  const el=document.createElement('div'); el.className='divider'; el.dataset.type='divider'; el.dataset.divId=obj.id;
  el.innerHTML=`<span class="htext" style="${obj.color?`color:${obj.color}`:''}">${obj.title||'Heading'}</span>${tools}${audLine}`;
  return el;
}

/* ===== paint page ===== */
function paintPage(){
  const grid=$('#pageGrid'); if(!grid) return;
  grid.innerHTML='';
  applyView(); paintAvatar();
  const s=getSettings(); const role=getRole();
  s.pageOrder.forEach(it=>{
    if(it.type==='hero'){
      const id=it.id; const f=s.heroFlags[id]; if(!f || f.place!=='page') return;
      if(!seesAll()){
        if(f.state!=='live') return;         // non-staff only see live
        if(!f.aud[role]) return;             // and only if their audience is on
      }
      const card = heroCard(id);
      if(card) grid.appendChild(card);
    }else if(it.type==='divider'){
      const aud=it.aud || {bronze:true,silver:true,gold:true};
      if(!seesAll()){ if(!aud[role]) return; }
      grid.appendChild(dividerEl(it));
    }
  });
}

/* ===== footer / archive ===== */
const dock=$('#archiveDock'), archiveList=$('#archiveList');

function applyArchiveVisibility(){
  // Developer dock visible to Admin only.
  if(isAdmin()){
    dock.style.display='block'; dock.setAttribute('aria-hidden','false');
  }else{
    dock.style.display='none'; dock.setAttribute('aria-hidden','true');
  }
}
function applyArchiveSkin(){
  $('#archiveTitle').textContent = 'Developer Mode';
  dock.style.background = 'var(--red)';
  dock.style.color = '#fff';
  updateFooterModeControls();
}

function updateFooterModeControls(){
  const devOn = devModeOn();
  $('#devToggle').textContent = `Developer: ${devOn?'On':'Off'}`;
}

function syncFooterViewControls(){
  const v=getView();
  $('#footerCols').value=String(v.cols||3);
}

/* archive list */
function paintArchive(){
  const s=getSettings(); const flags=s.heroFlags;
  archiveList.innerHTML='';
  const items=Object.entries(flags).filter(([id,f])=>f.place==='archive')
    .sort((a,b)=>Number(numberFromId(a[0]))-Number(numberFromId(b[0])));
  items.forEach(([id,f])=>{
    const row=document.createElement('div'); row.className='row'; row.dataset.heroId=id; row.dataset.place='archive';
    const statusLabel = (f.state==='live'?'Live':(f.state==='dev'?'Dev':'Offline'));
    const statusClass = (f.state==='live'?'badge-live':(f.state==='dev'?'badge-dev':'badge-off'));
    const controls = (isAdmin() && devModeOn()) ? `<div style="display:flex;gap:8px;align-items:center">
      <button class="chip" data-act="move" type="button">Move to Page</button>
      <button class="chip ${statusClass}" data-act="toggle" type="button">${statusLabel}</button>
    </div>` : `<div></div>`;
    row.innerHTML = `<span class="num">${labelFor(id)}</span>${controls}`;
    archiveList.appendChild(row);
  });
}

/* ===== body lock helpers (drawers/dock) ===== */
let savedScrollY=0;
function lockBody(){
  savedScrollY = window.scrollY || document.documentElement.scrollTop || 0;
  document.body.classList.add('lock');
  document.body.style.top = `-${savedScrollY}px`;
}
function unlockBody(){
  document.body.classList.remove('lock');
  document.body.style.top = '';
  window.scrollTo(0, savedScrollY||0);
}

/* ===== progress wiring: listen for child hero updates via postMessage =====
   Child course pages can send:
   window.parent.postMessage({type:'ao-progress', heroId:'co-4', status:'inprogress'|'complete'|'reset'}, '*');
   If heroId is omitted, we fall back to the ?heroId= param passed to the iframe URL.
*/
window.addEventListener('message', (evt)=>{
  const data = evt?.data || {};
  if(data && data.type==='ao-progress'){
    const s=getSettings();
    const heroId = data.heroId || (new URL(subFrame.src||'about:blank')).searchParams.get('heroId');
    if(!heroId || !s.heroFlags[heroId]) return;
    s.heroProgress = s.heroProgress || {};
    if(data.status==='inprogress'){
      s.heroProgress[heroId] = { inprogress:true, complete:false };
    }else if(data.status==='complete'){
      s.heroProgress[heroId] = { inprogress:false, complete:true };
    }else if(data.status==='reset'){
      delete s.heroProgress[heroId];
    }
    saveSettings(s); paintPage(); paintArchive();
  }
}, false);

/* ===== event wiring ===== */
applyView();
paintAvatar();

applyArchiveVisibility(); 
applyArchiveSkin();
paintArchive();
paintPage();
syncFooterViewControls();

/* Footer view controls */
$('#footerCols').addEventListener('change', e=>{ const v=getView(); v.cols=Number(e.target.value)||3; saveView(v); }, {passive:true});

/* Archive open/close + body lock */
$('#archiveToggle').addEventListener('click',()=>{
  const isOpen=dock.classList.contains('open');
  dock.classList.toggle('open', !isOpen);
  dock.classList.toggle('collapsed', isOpen);
  $('#archiveToggle').textContent = !isOpen ? 'Close' : 'Archived';
  if(!isOpen) lockBody(); else unlockBody();
}, {passive:true});

/* Developer mode toggle */
$('#devToggle').addEventListener('click', ()=>{
  if(!isAdmin()) return;
  document.body.classList.toggle('config-on');
  updateFooterModeControls(); paintPage(); paintArchive();
}, {passive:true});

/* Add Heading (footer) — optional: still available via dev tools if you re-add button later */
// function uuidId(){return 'div_'+Math.random().toString(36).slice(2,9);}

/* Page click handlers (delegate) */
document.addEventListener('click',(e)=>{
  const actEnter = e.target.closest('[data-act="enter"]');
  if(actEnter){
    const host=e.target.closest('[data-hero-id]'); const id=host?.dataset?.heroId||'';
    const n = Number(((id||'').match(/\d+/)||[])[0]||0);
    const url = (n>=1 && n<=50) ? `courses/${n}.html` : null;
    openSubSheet(labelFor(id), url, id); return;
  }

  const actToggle = e.target.closest('[data-act="toggle"]');
  if(actToggle){
    // Only Admin in Developer mode can toggle status
    if(!(isAdmin() && devModeOn())) return;
    const host=e.target.closest('[data-hero-id], .row'); const id=host.dataset.heroId;
    const s=getSettings(); const cur=s.heroFlags[id];
    const order=['live','off','dev'];
    const ni=(order.indexOf(cur.state)+1)%order.length;
    s.heroFlags[id]={...cur, state:order[ni]};
    saveSettings(s); paintPage(); paintArchive(); return;
  }

  const actMove = e.target.closest('[data-act="move"]');
  if(actMove){
    if(!(isAdmin() && devModeOn())) return;
    const host=e.target.closest('[data-hero-id], .row');
    const id=host.dataset.heroId; const s=getSettings(); const cur=s.heroFlags[id];
    const dest = (cur.place==='page') ? 'archive' : 'page';
    if(!confirm(`Move ${labelFor(id)} to ${dest==='page'?'Page':'Archive'}?`)) return;
    s.heroFlags[id]={...cur, place:dest};
    if(dest==='page'){ const exists=s.pageOrder.some(it=>it.type==='hero' && it.id===id); if(!exists) s.pageOrder.push({type:'hero',id}); }
    else{ s.pageOrder = s.pageOrder.filter(it=>!(it.type==='hero' && it.id===id)); }
    saveSettings(s); paintPage(); paintArchive(); return;
  }

  const audBtn=e.target.closest('[data-aud]');
  if(audBtn){
    // Admin+dev OR Director editing DEV hero (audience only)
    const hero=e.target.closest('[data-hero-id]'); const id=hero.dataset.heroId;
    const s=getSettings(); const f=s.heroFlags[id];
    if(!((isAdmin() && devModeOn()) || canDirectorDevEdit(f))) return;
    const key=audBtn.getAttribute('data-aud');
    const nextVal=!f.aud[key];
    if(!confirm(`${nextVal?'Allow':'Disallow'} ${cap(key)} audience for ${labelFor(id)}?`)) return;
    s.heroFlags[id]={...f, aud:{...f.aud, [key]:nextVal}}; saveSettings(s);
    paintPage(); paintArchive(); return;
  }

  if(e.target.matches('[data-cfg-rename]')){
    // ADMIN ONLY (in dev mode). Also do one-shot color prompt right after rename.
    if(!(isAdmin() && devModeOn())) return;
    const id=e.target.getAttribute('data-cfg-rename');
    const s=getSettings(); const curLabel=s.heroLabels[id] || `#${numberFromId(id)}`;
    const next=prompt('Hero label', curLabel);
    if(next!=null){
      const v=next.trim(); if(v) s.heroLabels[id]=v; else delete s.heroLabels[id];
      // one-shot color prompt (no persistent chip)
      const curColor=(s.heroStyle&&s.heroStyle[id]&&s.heroStyle[id].labelColor)||'#eef3ff';
      const color=prompt('Hero title colour (CSS value, e.g. #0A84FF or #ffd700)', curColor);
      if(color!=null){
        s.heroStyle = s.heroStyle || {};
        s.heroStyle[id] = {...(s.heroStyle[id]||{}), labelColor: color.trim()};
      }
      saveSettings(s); paintPage(); paintArchive();
    }
    return;
  }

  if(e.target.matches('.cfg-arrow')){
    // Reorder is Admin+dev only
    if(!(isAdmin() && devModeOn())) return;
    const key=e.target.dataset.key; const s=getSettings();
    const keys = s.pageOrder.map(it=> it.type==='hero' ? `hero:${it.id}` : `div:${it.id}`);
    const from = keys.indexOf(key); if(from<0) return;
    const dir = e.target.dataset.sort==='up' ? -1 : 1;
    const to = Math.min(Math.max(0, from+dir), keys.length-1);
    if(to!==from){
      const objFrom = s.pageOrder.splice(from,1)[0];
      s.pageOrder.splice(to,0,objFrom);
      saveSettings(s); paintPage();
    }
    return;
  }

  if(e.target.closest('[data-act="pickart"]')){
    // Admin+dev OR Director editing DEV hero (photo only)
    const host=e.target.closest('[data-hero-id]'); const id=host.dataset.heroId;
    const s=getSettings(); const f=s.heroFlags[id];
    if(!((isAdmin() && devModeOn()) || canDirectorDevEdit(f))) return;
    const url = prompt('Image path (under /images ...)', 'images/your-folder/your-image.jpg'); if(!url) return;
    s.heroAssets[id]={...(s.heroAssets[id]||{}), heroCard:{src:url, crop:{cx:0,cy:0,scale:1}}};
    saveSettings(s); paintPage(); return;
  }

  /* Divider tools — Admin-only + Dev mode; includes one-shot Color prompt after Rename if you prefer, but you asked color visible on pencil:
     For headings we keep a dedicated "Color" chip in dev (admin-only). If you want the same one-shot flow, replace 'color' case to prompt right after rename only. */
  const divAct = e.target.dataset.divAct;
  if(divAct){
    if(!(isAdmin() && devModeOn())) return;
    const id=e.target.dataset.divId;
    const s=getSettings();
    const idx=s.pageOrder.findIndex(it=>it.type==='divider' && it.id===id);
    if(idx<0) return;
    if(divAct==='rename'){
      const cur=s.pageOrder[idx].title||'Heading';
      const next=prompt('Heading title', cur);
      if(next!=null){ s.pageOrder[idx].title=(next.trim()||'Heading'); 
        // one-shot color prompt right after rename (matches your request)
        const curC = s.pageOrder[idx].color || '#eef3ff';
        const color = prompt('Heading colour (CSS value, e.g. #ffd700)', curC);
        if(color!=null){ s.pageOrder[idx].color = color.trim(); }
        saveSettings(s); paintPage(); 
      }
    }else if(divAct==='color'){
      // If you keep a dedicated color chip in dev, it still works:
      const cur = s.pageOrder[idx].color || '#eef3ff';
      const next = prompt('Heading colour (CSS value, e.g. #ffd700)', cur);
      if(next!=null){ s.pageOrder[idx].color = next.trim(); saveSettings(s); paintPage(); }
    }else if(divAct==='up' || divAct==='down'){
      const dir = divAct==='up' ? -1 : 1;
      const to = Math.min(Math.max(0, idx+dir), s.pageOrder.length-1);
      if(to!==idx){
        const obj = s.pageOrder.splice(idx,1)[0];
        s.pageOrder.splice(to,0,obj); saveSettings(s); paintPage();
      }
    }else if(divAct==='remove'){
      if(confirm('Remove this heading?')){
        s.pageOrder.splice(idx,1); saveSettings(s); paintPage();
      }
    }
  }
}, {passive:false});

/* ===== initial ===== */
updateFooterModeControls();

})();</script>
</body>
</html>