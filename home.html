<!DOCTYPE html>
<html lang="en-AU">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="color-scheme" content="dark" />
<title>Home — FAOA</title>

<style>
:root{
  --ink:#eef3ff; --ink-dim:#cfd3e1; --muted:rgba(238,243,255,.78);
  --bg:#000; --panel:#0a0c10; --stroke:rgba(255,255,255,.18);
  --blue:#0A84FF; --green:#32d74b; --red:#ff3b30; --chip:#1b1f2a;
  --gap:12px; --r:14px; --maxw:1240px; --nav-h:68px; --hero-pad:16px;
}

/* Resets / base */
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{
  height:100%; margin:0; background:var(--bg); color:var(--ink);
  font:16px -apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,sans-serif;
  overscroll-behavior-y:contain; overflow-x:hidden; user-select:none; -webkit-user-select:none;
}
a{ color:inherit; text-decoration:none }
button{ user-select:none; -webkit-user-select:none; cursor:pointer }
body.lock{ position:fixed; width:100% }

/* Background */
.bg{ position:fixed; inset:0; z-index:-1; background:#000 url("./assets/home-bg.jpg") center/cover no-repeat }

/* Top bar */
.nav{
  position:fixed; top:0; left:0; right:0; height:var(--nav-h);
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  padding:8px 12px; z-index:50;
  background:linear-gradient(180deg,rgba(0,0,0,.9),rgba(0,0,0,.55) 60%,rgba(0,0,0,.3));
  -webkit-backdrop-filter:blur(12px); backdrop-filter:blur(12px);
}
.title-tab{ font-weight:900; opacity:.92 }

/* Avatar pill */
.avatarTab{
  display:flex; flex-direction:column; align-items:flex-start; justify-content:center;
  padding:6px 12px; border-radius:12px; min-width:132px; height:44px;
  font-weight:900; line-height:1.1; text-align:left; border:1px solid var(--stroke);
  background:#222; color:#eef3ff;
}
.avatarTab .name{ font-size:15px; font-weight:900 }
.avatarTab .lvl{ font-size:12px; opacity:.95; text-transform:capitalize }

/* Layout */
.wrap{ max-width:var(--maxw); margin:0 auto; padding:calc(var(--nav-h) + env(safe-area-inset-top) + 10px) 14px 160px }

/* ===== Carousels (one row per heading) ===== */
.section{
  margin:26px 0 18px;
}
.section .htext{
  font-weight:900; font-size:18px; opacity:.95; display:block; margin:0 4px 10px;
}
.track{
  display:grid;
  grid-auto-flow:column;
  grid-auto-columns:clamp(180px, 28vw, 280px);
  gap:var(--gap);
  overflow-x:auto;
  padding:6px 2px 10px;
  scroll-snap-type:x mandatory;
}
.track::-webkit-scrollbar{ display:none }

/* Hero (square tiles) */
.hero{
  position:relative; overflow:hidden; background:#060708; border:1px solid var(--stroke);
  border-radius:16px; padding:var(--hero-pad);
  aspect-ratio:1/1; scroll-snap-align:start;
}
.hero .label{
  font-weight:900; font-size:18px; opacity:.95; position:absolute; top:14px; left:16px; z-index:2
}

/* rename pencil (Admin+Dev, OR Director on DEV) */
.cfg-pin{
  position:absolute; top:10px; left:12px; z-index:5;
  width:28px; height:28px; border-radius:8px;
  border:1px solid var(--stroke); background:#121212; color:#fff; font-weight:900; line-height:1;
}
.hero.has-pencil .label{ left:46px }

/* right-top chips (Archive / Status / Photo) */
.ctrls{ position:absolute; top:10px; right:10px; display:flex; gap:8px; z-index:5; align-items:center }
.chip{
  height:28px; padding:0 12px; border-radius:999px; border:1px solid var(--stroke);
  background:var(--chip); color:#fff; font-weight:800; font-size:12px; white-space:nowrap
}
.chip[disabled]{ opacity:.55; filter:grayscale(.15) }
.badge-live{ background:#0a0 }
.badge-off{ background:#b00020 }
.badge-dev{ background:var(--blue); color:#000; border-color:transparent }

/* Status pill (normal mode only for staff; hidden when showing Dev chip pair) */
.status-pill{
  position:absolute; top:12px; right:12px; height:28px; padding:0 12px; border-radius:999px;
  display:inline-flex; align-items:center; font-weight:900; z-index:4; border:1px solid rgba(255,255,255,.18)
}
.status-live{ background:#1c6b1c; color:#fff }
.status-off{ background:#5a0d12; color:#fff }
.status-dev{ background:var(--blue); color:#000; border-color:transparent }

/* Sorting arrows (admin+dev) */
.hero-arrows{ display:none; position:absolute; right:10px; top:50%; transform:translateY(-50%); z-index:4; flex-direction:column; gap:6px }
.config-on .hero .hero-arrows{ display:flex }
.hero-arrows .cfg-arrow{
  height:24px; padding:0 6px; border-radius:8px; border:1px solid var(--stroke);
  background:#161922; color:#fff; font-weight:900; font-size:12px
}

/* Buttons */
.btn{
  display:inline-flex; align-items:center; justify-content:center; min-width:120px; height:40px; padding:0 14px;
  border-radius:12px; border:1px solid var(--stroke); font-weight:900; background:#0f1116; color:var(--ink)
}
.btn.blue{ background:var(--blue); border-color:transparent; color:#000 }
.btn.grey{ background:#3a3a3a; color:#fff; border-color:var(--stroke) }

/* CTA + audience */
.cta-left{ position:absolute; left:16px; bottom:16px; display:flex; flex-direction:column; align-items:flex-start; gap:8px; z-index:2 }
.aud-line{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
.aud-chip{
  height:28px; padding:0 12px; border-radius:999px; border:1px solid var(--stroke);
  background:#141416; color:#fff; font-weight:800; font-size:12px; opacity:.9
}
.aud-chip.on{ opacity:1; filter:brightness(1.22) }
.aud-chip.on::after{ content:" ✓"; font-weight:900 }
.aud-chip.bronze{ box-shadow:inset 0 0 0 2px #b87333 }
.aud-chip.silver{ box-shadow:inset 0 0 0 2px #c0c7d1 }
.aud-chip.gold{   box-shadow:inset 0 0 0 2px #ffd700 }

/* Divider (Heading) */
.divider{ margin:26px 2px 10px; }
.divider .htext{ font-weight:900; opacity:.95; }

/* Avatar Drawer */
#avatarSheet{
  position:fixed; inset:0; z-index:70; display:none;
  background:rgba(0,0,0,.55); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px)
}
#avatarSheet.open{ display:block }
#avatarSheet .panel{
  position:absolute; inset:0; margin:auto; width:100%; height:100%;
  background:#0f1116; border:1px solid var(--stroke); border-radius:0; padding:12px; overflow:auto;
}
#avatarClose{
  position:absolute; right:12px; top:12px; width:32px; height:32px; border-radius:10px; border:1px solid var(--stroke);
  background:#121212; color:#fff; font-weight:900; line-height:1; z-index:2;
}
@media (min-width:820px){
  #avatarSheet .panel{ width:min(780px, 92vw); height:min(86vh, 920px); right:12px; left:auto; top:calc(var(--nav-h) + 8px); bottom:auto; border-radius:14px }
}
.menu-list a{
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 10px; border-bottom:1px solid rgba(255,255,255,.08)
}
.menu-list a:last-child{ border-bottom:none }

/* Subsheet (courses) */
#subSheet{
  position:fixed; inset:0; z-index:80; display:none;
  background:rgba(0,0,0,.75); -webkit-backdrop-filter:blur(6px); backdrop-filter:blur(6px)
}
#subSheet.open{ display:block }
#subSheet .inner{
  position:absolute; inset:0; background:#0f1116; border:none; border-radius:0; padding:0;
  display:flex; flex-direction:column
}
.sheet-head{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-bottom:1px solid var(--stroke) }
.sheet-close{ width:36px; height:36px; border-radius:10px; border:1px solid var(--stroke); background:#121212; color:#fff; font-weight:900 }
#subFrame{ flex:1 1 auto; width:100%; height:100%; border:none; background:#0b0c10; overflow:hidden }

/* Footer Dock (Developer only) */
#archiveDock{
  position:fixed; left:0; right:0; bottom:0; z-index:75; background:var(--red); color:#fff; border-top:1px solid rgba(255,255,255,.25);
  transition:max-height .22s ease; overflow:hidden; overscroll-behavior:contain
}
#archiveDock .bar{
  display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 14px; font-weight:900;
  overflow-x:auto; white-space:nowrap
}
#archiveDock .bar::-webkit-scrollbar{ display:none }
#archiveDock .title{ display:inline-flex; align-items:center; gap:8px }
#archiveDock .content{ background:#160b0b; max-height:calc(60vh - 48px); overflow:auto }
#archiveDock .list{ padding:8px 12px 16px; display:flex; flex-direction:column; gap:8px }
#archiveDock .row{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  padding:10px 12px; border:1px solid rgba(255,255,255,.28); background:#0d0d10; border-radius:10px
}
#archiveDock .row .num{ font-weight:900 }
#archiveDock .row .chip{ height:26px }
#archiveDock.collapsed{ max-height:48px }
#archiveDock.open{ max-height:80vh }

/* Footer chips */
.footer-chip{
  display:inline-flex; align-items:center; gap:8px; height:34px; padding:0 12px; border-radius:999px;
  border:1px solid var(--stroke); background:#1b1f2a; color:#fff; font-weight:800
}
.footer-label{ opacity:.9; margin-left:10px; font-size:12px }

/* Completed/In-Progress borders */
.hero.completed{ border:2px solid #888 }
.hero.inprogress{ border:2px solid var(--green) }

/* Hero art layer */
.hero .art{ position:absolute; inset:0; z-index:0; opacity:.92; pointer-events:none; overflow:hidden; border-radius:16px }
.hero .art img{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(1);
  width:auto; height:110%; min-width:110%; user-select:none; pointer-events:none;
  filter:saturate(1.02) contrast(1.02) brightness(0.95);
}
.hero::after{
  content:""; position:absolute; inset:0; border-radius:16px; pointer-events:none;
  background:linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.45) 65%, rgba(0,0,0,.6));
  z-index:1;
}

/* Hide editor-only bits when not in dev */
.hide-when-normal{ display:none }
.config-on .hide-when-normal{ display:inline-flex }

/* Simple palette popup */
.palette{
  position:fixed; inset:auto 12px 74px auto; z-index:90;
  background:#0f1116; border:1px solid var(--stroke); border-radius:12px; padding:10px; display:none;
  box-shadow:0 10px 30px rgba(0,0,0,.5)
}
.palette.open{ display:block }
.palette .row{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px }
.palette .sw{ width:28px; height:28px; border-radius:6px; border:1px solid rgba(255,255,255,.25); cursor:pointer }
.palette input{ width:140px; height:32px; background:#12151c; color:#fff; border:1px solid var(--stroke); border-radius:8px; padding:0 8px; font-weight:700 }
.palette .actions{ display:flex; gap:8px }
.palette .btn{ height:32px; min-width:auto; padding:0 10px }
</style>
</head>

<body ontouchstart="">
<div class="bg" aria-hidden="true"></div>

<header class="nav" role="navigation" aria-label="Primary">
  <div class="nav-left"><span class="title-tab">Courses</span></div>
  <div class="nav-right">
    <button id="avatarTab" class="avatarTab" aria-haspopup="dialog" aria-expanded="false">
      <span class="name" id="avatarName">User</span>
      <span class="lvl" id="avatarLvl">Admin</span>
    </button>
  </div>
</header>

<main class="wrap" id="mainWrap"><!-- sections render here --></main>

<!-- Avatar Drawer -->
<div id="avatarSheet" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="panel" role="document">
    <button id="avatarClose" aria-label="Close">×</button>
    <nav class="menu-list" id="avatarMenu">
      <a href="avatar/profile.html" data-pop="Profile">Profile<span>›</span></a>
      <a href="avatar/settings.html" data-pop="Settings">Settings<span>›</span></a>
      <a href="avatar/mydata.html" data-pop="My Data">My Data<span>›</span></a>
      <a href="avatar/statistics.html" data-pop="Statistics">Statistics<span>›</span></a>
      <a href="avatar/usersearch.html" data-pop="User Search">User Search<span>›</span></a>
    </nav>
  </div>
</div>

<!-- Subsheet (courses) -->
<div id="subSheet" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="inner" role="document">
    <div class="sheet-head">
      <h2 id="sheetTitle">—</h2>
      <button class="sheet-close" id="sheetClose" aria-label="Close" type="button">×</button>
    </div>
    <iframe id="subFrame" title="Panel"></iframe>
  </div>
</div>

<!-- Footer Dock (Developer only) -->
<div id="archiveDock" class="collapsed" aria-hidden="true">
  <div class="bar">
    <div class="title">
      <span id="archiveTitle">Developer Mode</span>
      <button class="footer-chip" id="devToggle" type="button">Developer: Off</button>
      <button class="footer-chip hide-when-normal" id="addHeadingBtn" type="button">Add Heading</button>
      <button class="footer-chip hide-when-normal" id="openPaletteBtn" type="button">Palette</button>
    </div>

    <div class="title" style="gap:12px">
      <button class="footer-chip" id="archiveToggle" type="button">Archive</button>
    </div>
  </div>

  <div class="content">
    <div class="list" id="archiveList"></div>
  </div>
</div>

<!-- Color palette popover -->
<div id="palette" class="palette" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="row" id="paletteSwatches"></div>
  <div class="row">
    <input id="paletteInput" placeholder="#hex or css" />
  </div>
  <div class="actions">
    <button class="btn blue" id="paletteApply" type="button">Apply</button>
    <button class="btn" id="paletteClose" type="button">Close</button>
  </div>
</div>

<script>
(()=>{'use strict';

/* ===== utils & storage ===== */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const store={
  get:(k,f)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):f }catch{ return f } },
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))
};
const K={ profile:'ao_profile', settings:'ao_settings', view:'ao_view' };

/* URL reset hook */
const Q=new URLSearchParams(location.search);
if(Q.get('reset')==='1'){
  localStorage.removeItem(K.settings);
  localStorage.removeItem(K.view);
}

/* Friendly role labels shown in pill */
const ROLE_LABEL = {
  bronze:'Beginner', silver:'Intermediate', gold:'Advanced',
  support:'Support', director:'Director', admin:'Admin'
};

function normalizeRole(r){ const map={beginner:'bronze', intermediate:'silver', advanced:'gold'}; r=String(r||'').toLowerCase(); return map[r]||r; }
function baseRole(){ const p=store.get(K.profile,{displayName:'User',skill:'admin'}); return normalizeRole(p.skill||'admin'); }
function getRole(){ return baseRole(); }
function isAdmin(){ return getRole()==='admin'; }
function isDirector(){ return getRole()==='director'; }
function isSupport(){ return getRole()==='support'; }
function devModeOn(){ return document.body.classList.contains('config-on'); }
function canDirectorDevEdit(flag){ return isDirector() && flag?.state==='dev'; }

/* ===== avatar paint ===== */
function paintAvatar(){
  const p=store.get(K.profile,{displayName:'User',skill:'admin'});
  $('#avatarName').textContent = p.displayName || 'User';
  const role=getRole();
  const friendly = ROLE_LABEL[role] || (role.charAt(0).toUpperCase()+role.slice(1));
  $('#avatarLvl').textContent = friendly || role;
  const map={bronze:'#b87333',silver:'#c0c7d1',gold:'#ffd700',support:'#6a4cff',director:'#6a4cff',admin:'#0A84FF'};
  const pill=$('#avatarTab');
  pill.style.background = map[role] || '#222';
  pill.style.color = (role==='gold'||role==='silver'||role==='admin') ? '#0b0c10' : '#eef3ff';
}

/* ===== avatar drawer & subsheet ===== */
const avatarBtn=$('#avatarTab'), avatarSheet=$('#avatarSheet');
function lockBody(){ lockBody._y=window.scrollY||document.documentElement.scrollTop||0; document.body.classList.add('lock'); document.body.style.top=`-${lockBody._y}px`; }
function unlockBody(){ document.body.classList.remove('lock'); document.body.style.top=''; window.scrollTo(0, lockBody._y||0); }
function openDrawer(){ avatarSheet.classList.add('open'); avatarSheet.setAttribute('aria-hidden','false'); avatarBtn.setAttribute('aria-expanded','true'); lockBody(); }
function closeDrawer(){ avatarSheet.classList.remove('open'); avatarSheet.setAttribute('aria-hidden','true'); avatarBtn.setAttribute('aria-expanded','false'); unlockBody(); }
avatarBtn.addEventListener('click', openDrawer, {passive:true});
avatarSheet.addEventListener('click', e=>{ if(e.target===avatarSheet) closeDrawer(); }, {passive:true});
document.addEventListener('click', e=>{ if(e.target && e.target.id==='avatarClose') closeDrawer(); }, {passive:true});

const subSheet=$('#subSheet'), subFrame=$('#subFrame'), sheetTitle=$('#sheetTitle');
function openSubSheet(title,url,heroId){
  sheetTitle.textContent=title;
  if(!url){ alert('401 — Not linked yet'); return; }
  const origin = encodeURIComponent(location.origin);
  const hid = encodeURIComponent(heroId||'');
  subFrame.src = url + (url.includes('?')?'&':'?') + 'v=' + Date.now() + `&heroId=${hid}&parent=${origin}`;
  subSheet.classList.add('open'); subSheet.setAttribute('aria-hidden','false'); lockBody();
}
function closeSubSheet(){ subSheet.classList.remove('open'); subSheet.setAttribute('aria-hidden','true'); subFrame.src='about:blank'; unlockBody(); }
$('#sheetClose').addEventListener('click', closeSubSheet, {passive:true});
subSheet.addEventListener('click', e=>{ if(e.target===subSheet) closeSubSheet(); }, {passive:true});
$$('#avatarSheet [data-pop]').forEach(a=>a.addEventListener('click',e=>{
  e.preventDefault(); closeDrawer(); openSubSheet(a.dataset.pop, a.getAttribute('href'));
}, {passive:false}));

/* ===== settings & seed ===== */
function defaults(){
  const heroFlags={}, pageOrder=[];
  // seed: some heroes, and one default heading to demonstrate rows
  pageOrder.push({type:'divider', id:'div_default', title:'All Courses', aud:{bronze:true,silver:true,gold:true}});
  for(let i=1;i<=10;i++){
    const id=`co-${i}`;
    heroFlags[id]={state: i<=8 ? 'live' : 'dev', place:'page', aud:{bronze:true,silver:true,gold:true}};
    pageOrder.push({type:'hero', id});
  }
  for(let i=11;i<=50;i++){
    const id=`co-${i}`;
    heroFlags[id]={state:'off',place:'archive',aud:{bronze:true,silver:true,gold:true}};
  }
  return { heroFlags, heroLabels:{}, heroAssets:{}, heroProgress:{}, heroStyle:{}, pageOrder, _seeded:true };
}
function sanitize(cfg){
  let c = (!cfg || typeof cfg!=='object') ? defaults() : {...cfg};
  c.heroFlags=c.heroFlags||{}; c.heroLabels=c.heroLabels||{}; c.heroAssets=c.heroAssets||{};
  c.heroProgress=c.heroProgress||{}; c.heroStyle=c.heroStyle||{}; c.pageOrder=Array.isArray(c.pageOrder)?c.pageOrder:[];
  // ensure refs exist
  for(let i=1;i<=50;i++){
    const id=`co-${i}`;
    if(!c.heroFlags[id]) c.heroFlags[id]={state:'off',place:'archive',aud:{bronze:true,silver:true,gold:true}};
  }
  // guarantee at least one divider
  if(!c.pageOrder.some(it=>it.type==='divider')){
    c.pageOrder.unshift({type:'divider', id:'div_default', title:'All Courses', aud:{bronze:true,silver:true,gold:true}});
  }
  // ensure any page heroes in pageOrder
  Object.keys(c.heroFlags).forEach(id=>{
    const f=c.heroFlags[id]; if(f.place==='page' && !c.pageOrder.some(it=>it.type==='hero'&&it.id===id)) c.pageOrder.push({type:'hero',id});
  });
  // default aud on dividers
  c.pageOrder=c.pageOrder.map(it=> it.type==='divider' ? ({aud:{bronze:true,silver:true,gold:true}, ...it}) : it);
  return c;
}
function getSettings(){ return sanitize(store.get(K.settings,null) || (store.set(K.settings,defaults()), store.get(K.settings))); }
function saveSettings(s){ store.set(K.settings,sanitize(s)); }

/* ===== helpers ===== */
function numberFromId(id){ const m=String(id||'').match(/\d+/); return m?m[0]:'?'; }
function labelFor(id){ const s=getSettings(); return s.heroLabels[id] || `#${numberFromId(id)}`; }
function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

/* ===== palette ===== */
const paletteEl = $('#palette');
const swatchesEl = $('#paletteSwatches');
const paletteInput = $('#paletteInput');
const PALETTE = [
  '#b87333','#c0c7d1','#ffd700', /* bronze/silver/gold */
  '#0A84FF','#32d74b','#ff3b30',
  '#ffffff','#e0e0e0','#9aa0a6','#5f6368','#202124','#000000'
];
let paletteTarget = null; // { type:'hero'|'divider', id }

function openPalette(target){ // target: {type,id, current}
  if(!isAdmin() || !devModeOn()) return;
  paletteTarget = target||null;
  paletteInput.value = (target?.current||'');
  // build swatches once
  if(!swatchesEl.dataset.ready){
    PALETTE.forEach(c=>{
      const b=document.createElement('button');
      b.type='button'; b.className='sw'; b.style.background=c;
      b.title=c; b.addEventListener('click', ()=>{ paletteInput.value=c; });
      swatchesEl.appendChild(b);
    });
    swatchesEl.dataset.ready='1';
  }
  paletteEl.classList.add('open');
  paletteEl.setAttribute('aria-hidden','false');
}
function closePalette(){
  paletteEl.classList.remove('open');
  paletteEl.setAttribute('aria-hidden','true');
  paletteTarget=null;
}
$('#paletteClose').addEventListener('click', closePalette, {passive:true});
$('#paletteApply').addEventListener('click', ()=>{
  if(!paletteTarget) return;
  const val = (paletteInput.value||'').trim();
  const s=getSettings();
  if(paletteTarget.type==='hero'){
    s.heroStyle = s.heroStyle || {};
    s.heroStyle[paletteTarget.id] = {...(s.heroStyle[paletteTarget.id]||{}), labelColor: val||undefined};
  }else if(paletteTarget.type==='divider'){
    const idx = s.pageOrder.findIndex(it=>it.type==='divider' && it.id===paletteTarget.id);
    if(idx>=0){ s.pageOrder[idx].color = val||undefined; }
  }
  saveSettings(s); paintPage(); closePalette();
}, {passive:false});

/* ===== DOM builders ===== */
function heroCard(id){
  const s=getSettings(); const f=s.heroFlags[id]; if(!f) return null;

  const completed = !!(s.heroProgress && s.heroProgress[id] && s.heroProgress[id].complete);
  const inprogress = !completed && !!(s.heroProgress && s.heroProgress[id] && s.heroProgress[id].inprogress);
  const art = (s.heroAssets && s.heroAssets[id] && s.heroAssets[id].heroCard) ? s.heroAssets[id].heroCard : null;

  const devOn = devModeOn();

  // Director on DEV (normal mode): show disabled Dev chip + Photo
  const showDirectorDevPair = (isDirector() && f.state==='dev' && !devOn);

  // Status pill (hide when showing director pair)
  const showStatusPill = (!devOn) && (isAdmin() || isSupport() || isDirector()) && !showDirectorDevPair;
  const statusPill = showStatusPill ? 
    `<span class="status-pill ${f.state==='live'?'status-live':(f.state==='dev'?'status-dev':'status-off')}">
      ${f.state==='live'?'Live':(f.state==='dev'?'Dev':'Offline')}
     </span>` : '';

  // Controls
  const showArchiveChip = isAdmin() && devOn;
  const showStatusChipInDev = devOn && (isAdmin() || isSupport() || isDirector()); // admin toggles
  const statusChipDisabled = !isAdmin();
  const showPhotoChip = (isAdmin() && devOn) || (isDirector() && f.state==='dev'); // director sees Photo on DEV
  // Pencil: Admin+Dev OR Director on DEV
  const showRenamePencil = (isAdmin() && devOn) || (isDirector() && f.state==='dev');
  // Audience: Admin+Dev OR Director on DEV
  const showAudienceLine = (isAdmin() && devOn) || (isDirector() && f.state==='dev');
  // Color chip for Admin+Dev (hero title color)
  const showColorChip = isAdmin() && devOn;

  // Build controls (Dev chip first, then Photo) to avoid overlap
  let ctrlsHTML = '';
  if (showDirectorDevPair || showArchiveChip || showStatusChipInDev || showPhotoChip || showColorChip){
    ctrlsHTML += `<div class="ctrls">`;
    if (showDirectorDevPair){
      ctrlsHTML += `<button class="chip badge-dev" type="button" disabled>Dev</button>`;
      if (showPhotoChip){ ctrlsHTML += `<button class="chip" data-act="pickart" type="button">Photo</button>`; }
    } else {
      if(showArchiveChip){
        ctrlsHTML += `<button class="chip" data-act="move" type="button">${f.place==='page'?'Archive':'Move to Page'}</button>`;
      }
      if(showStatusChipInDev){
        const editClass = f.state==='live'?'badge-live':(f.state==='dev'?'badge-dev':'badge-off');
        const editLabel = f.state==='live'?'Live':(f.state==='dev'?'Dev':'Offline');
        ctrlsHTML += `<button class="chip ${editClass}" data-act="toggle" type="button" ${statusChipDisabled?'disabled':''}>${editLabel}</button>`;
      }
      if(showPhotoChip){
        ctrlsHTML += `<button class="chip" data-act="pickart" type="button">Photo</button>`;
      }
      if(showColorChip){
        ctrlsHTML += `<button class="chip" data-act="color-hero" type="button">Color</button>`;
      }
    }
    ctrlsHTML += `</div>`;
  }

  let btnLabel = 'Start', btnClass='blue';
  if(completed){ btnLabel='Complete'; btnClass='grey'; }
  else if(inprogress){ btnLabel='In Progress'; }

  const el=document.createElement('article'); el.className='hero'; el.dataset.heroId=id; el.dataset.place=f.place;
  const artLayer = (art && art.src) ? `<div class="art"><img alt="" src="${art.src}"></div>` : '';

  const labelColor = (s.heroStyle && s.heroStyle[id] && s.heroStyle[id].labelColor) ? `style="color:${s.heroStyle[id].labelColor}"` : '';

  el.innerHTML =
    `${artLayer}
     ${statusPill}
     ${showRenamePencil ? `<button class="cfg-pin" title="Rename" data-cfg-rename="${id}" type="button">✎</button>` : ``}
     ${(isAdmin() && devOn) ? `
       <div class="hero-arrows">
         <button class="cfg-arrow" data-sort="up" data-key="hero:${id}" type="button">▲</button>
         <button class="cfg-arrow" data-sort="down" data-key="hero:${id}" type="button">▼</button>
       </div>` : ``}
     <span class="label" ${labelColor}>${labelFor(id)}</span>
     ${ctrlsHTML}
     <div class="cta-left">
       <button class="btn ${btnClass}" data-act="enter" type="button">${btnLabel}</button>
       ${(showAudienceLine) ? `
         <div class="aud-line">
           <button class="aud-chip bronze ${f.aud.bronze?'on':''}" data-aud="bronze" type="button">Beginner</button>
           <button class="aud-chip silver ${f.aud.silver?'on':''}" data-aud="silver" type="button">Intermediate</button>
           <button class="aud-chip gold   ${f.aud.gold  ?'on':''}" data-aud="gold"   type="button">Advanced</button>
         </div>` : ``}
     </div>`;

  if(showRenamePencil){ el.classList.add('has-pencil'); }
  if(completed) el.classList.add('completed');
  else if(inprogress) el.classList.add('inprogress');

  if(art && art.crop){
    const img = el.querySelector('.art img');
    if(img){
      const cx = Number(art.crop.cx||0), cy = Number(art.crop.cy||0), sc = Number(art.crop.scale||1);
      img.style.transform = `translate(calc(-50% + ${cx}px), calc(-50% + ${cy}px)) scale(${sc})`;
    }
  }
  return el;
}

function dividerEl(obj){
  const editable = isAdmin() && devModeOn();
  const colorStyle = obj.color ? `style="color:${obj.color}"` : '';
  const tools = editable ? 
    `<div class="dctrls" style="display:flex; gap:8px; margin-left:8px">
      <button class="chip" data-div-act="rename" data-div-id="${obj.id}" type="button">Rename</button>
      <button class="chip" data-div-act="color"  data-div-id="${obj.id}" type="button">Color</button>
      <button class="chip" data-div-act="up"     data-div-id="${obj.id}" type="button">▲</button>
      <button class="chip" data-div-act="down"   data-div-id="${obj.id}" type="button">▼</button>
      <button class="chip" data-div-act="remove" data-div-id="${obj.id}" type="button">Remove</button>
    </div>` : '';

  const el=document.createElement('div'); el.className='divider'; el.dataset.type='divider'; el.dataset.divId=obj.id;
  el.innerHTML=`<span class="htext" ${colorStyle}>${obj.title||'Heading'}</span>${tools}`;
  return el;
}

/* ===== paint page into rows (carousel per section) ===== */
function paintPage(){
  const wrap=$('#mainWrap'); if(!wrap) return;
  wrap.innerHTML='';
  const s=getSettings(); const role=getRole();

  let currentSection = null; // {container(track), id}

  function ensureSection(titleObj){
    // create a new section group with heading + track
    const section = document.createElement('section'); section.className='section';
    if(titleObj){
      section.appendChild(dividerEl(titleObj));
    }else{
      section.appendChild(Object.assign(document.createElement('div'), {className:'divider', innerHTML:'<span class="htext">All Courses</span>'}));
    }
    const track = document.createElement('div'); track.className='track'; section.appendChild(track);
    wrap.appendChild(section);
    currentSection = { container: track, id: (titleObj?.id||'default') };
  }

  // start with a default section until we see the first divider
  ensureSection(null);

  s.pageOrder.forEach(it=>{
    if(it.type==='divider'){
      // hide divider for non-staff if its audience forbids them
      const aud=it.aud || {bronze:true,silver:true,gold:true};
      if(!(isAdmin()||isSupport()||isDirector())){
        if(!aud[role]){ currentSection=null; return; }
      }
      ensureSection(it);
      return;
    }

    if(it.type==='hero'){
      const id=it.id; const f=s.heroFlags[id]; if(!f || f.place!=='page') return;
      // Non-staff: only live and allowed audience
      if(!(isAdmin()||isSupport()||isDirector())){
        if(f.state!=='live') return;
        if(!f.aud[role]) return;
      }
      const card=heroCard(id);
      if(card){
        currentSection.container.appendChild(card);
      }
    }
  });
}

/* ===== footer / archive ===== */
const dock=$('#archiveDock'), archiveList=$('#archiveList');

function applyArchiveVisibility(){
  if(isAdmin()){ dock.style.display='block'; dock.setAttribute('aria-hidden','false'); }
  else{ dock.style.display='none'; dock.setAttribute('aria-hidden','true'); }
}
function applyArchiveSkin(){
  $('#archiveTitle').textContent = 'Developer Mode';
  dock.style.background = 'var(--red)';
  dock.style.color = '#fff';
  updateFooterModeControls();
}
function updateFooterModeControls(){
  const devOn = devModeOn();
  $('#devToggle').textContent = `Developer: ${devOn?'On':'Off'}`;
  $('#addHeadingBtn').style.display = (isAdmin() && devOn) ? 'inline-flex' : 'none';
  $('#openPaletteBtn').style.display = (isAdmin() && devOn) ? 'inline-flex' : 'none';
}

/* archive list */
function paintArchive(){
  const s=getSettings(); const flags=s.heroFlags;
  archiveList.innerHTML='';
  const items=Object.entries(flags).filter(([id,f])=>f.place==='archive')
    .sort((a,b)=>Number(numberFromId(a[0]))-Number(numberFromId(b[0])));
  items.forEach(([id,f])=>{
    const row=document.createElement('div'); row.className='row'; row.dataset.heroId=id; row.dataset.place='archive';
    const statusLabel = (f.state==='live'?'Live':(f.state==='dev'?'Dev':'Offline'));
    const statusClass = (f.state==='live'?'badge-live':(f.state==='dev'?'badge-dev':'badge-off'));
    const controls = (isAdmin() && devModeOn()) ? `<div style="display:flex;gap:8px;align-items:center">
      <button class="chip" data-act="move" type="button">Move to Page</button>
      <button class="chip ${statusClass}" data-act="toggle" type="button">${statusLabel}</button>
    </div>` : `<div></div>`;
    row.innerHTML = `<span class="num">${labelFor(id)}</span>${controls}`;
    archiveList.appendChild(row);
  });
}

/* ===== event wiring ===== */
paintAvatar();
applyArchiveVisibility(); 
applyArchiveSkin();
paintArchive();
paintPage();

/* Archive open/close + body lock */
$('#archiveToggle').addEventListener('click',()=>{
  const isOpen=dock.classList.contains('open');
  dock.classList.toggle('open', !isOpen);
  dock.classList.toggle('collapsed', isOpen);
  if(!isOpen) lockBody(); else unlockBody();
}, {passive:true});

/* Developer mode toggle */
$('#devToggle').addEventListener('click', ()=>{
  if(!isAdmin()) return;
  document.body.classList.toggle('config-on');
  updateFooterModeControls(); paintPage(); paintArchive();
}, {passive:true});

/* Add Heading (footer) */
function uuidId(){return 'div_'+Math.random().toString(36).slice(2,9);}
$('#addHeadingBtn').addEventListener('click',()=>{
  if(!(isAdmin() && devModeOn())) return;
  const title=prompt('Heading title','Section'); if(title==null) return;
  const s=getSettings();
  s.pageOrder.push({type:'divider', id:uuidId(), title:title.trim()||'Section', aud:{bronze:true,silver:true,gold:true}});
  saveSettings(s); paintPage();
}, {passive:false});

/* Quick open palette (no target: just open to pick, won’t apply until used from color chips) */
$('#openPaletteBtn').addEventListener('click', ()=> openPalette(null), {passive:true});

/* Page click handlers (delegate) */
document.addEventListener('click',(e)=>{
  const actEnter = e.target.closest('[data-act="enter"]');
  if(actEnter){
    const host=e.target.closest('[data-hero-id]'); const id=host?.dataset?.heroId||'';
    const n = Number(((id||'').match(/\d+/)||[])[0]||0);
    const url = (n>=1 && n<=50) ? `courses/${n}.html` : null;
    openSubSheet(labelFor(id), url, id); return;
  }

  const actToggle = e.target.closest('[data-act="toggle"]');
  if(actToggle){
    if(!(isAdmin() && devModeOn())) return;
    const host=e.target.closest('[data-hero-id], .row'); const id=host.dataset.heroId;
    const s=getSettings(); const cur=s.heroFlags[id];
    const order=['live','off','dev'];
    const ni=(order.indexOf(cur.state)+1)%order.length;
    s.heroFlags[id]={...cur, state:order[ni]};
    saveSettings(s); paintPage(); paintArchive(); return;
  }

  const actMove = e.target.closest('[data-act="move"]');
  if(actMove){
    if(!(isAdmin() && devModeOn())) return;
    const host=e.target.closest('[data-hero-id], .row');
    const id=host.dataset.heroId; const s=getSettings(); const cur=s.heroFlags[id];
    const dest = (cur.place==='page') ? 'archive' : 'page';
    if(!confirm(`Move ${labelFor(id)} to ${dest==='page'?'Page':'Archive'}?`)) return;
    s.heroFlags[id]={...cur, place:dest};
    if(dest==='page'){ const exists=s.pageOrder.some(it=>it.type==='hero' && it.id===id); if(!exists) s.pageOrder.push({type:'hero',id}); }
    else{ s.pageOrder = s.pageOrder.filter(it=>!(it.type==='hero' && it.id===id)); }
    saveSettings(s); paintPage(); paintArchive(); return;
  }

  const audBtn=e.target.closest('[data-aud]');
  if(audBtn){
    const hero=e.target.closest('[data-hero-id]'); const id=hero.dataset.heroId;
    const s=getSettings(); const f=s.heroFlags[id];
    if(!((isAdmin() && devModeOn()) || canDirectorDevEdit(f))) return;
    const key=audBtn.getAttribute('data-aud');
    const nextVal=!f.aud[key];
    if(!confirm(`${nextVal?'Allow':'Disallow'} ${cap(key)} audience for ${labelFor(id)}?`)) return;
    s.heroFlags[id]={...f, aud:{...f.aud, [key]:nextVal}}; saveSettings(s);
    paintPage(); paintArchive(); return;
  }

  /* Pencil rename — Admin+Dev OR Director on DEV */
  const pin = e.target.closest('[data-cfg-rename]');
  if(pin){
    const id=pin.getAttribute('data-cfg-rename');
    const s=getSettings(); const f=s.heroFlags[id];
    const allow = (isAdmin() && devModeOn()) || (isDirector() && f.state==='dev');
    if(!allow) return;
    const cur=s.heroLabels[id] || `#${numberFromId(id)}`;
    const next=prompt('Hero label', cur);
    if(next!=null){
      const v=next.trim(); if(v) s.heroLabels[id]=v; else delete s.heroLabels[id];
      saveSettings(s); paintPage();
    }
    return;
  }

  /* Color HERO label (admin+dev) */
  const colorHeroBtn = e.target.closest('[data-act="color-hero"]');
  if(colorHeroBtn){
    if(!(isAdmin() && devModeOn())) return;
    const host=e.target.closest('[data-hero-id]'); const id=host?.dataset?.heroId; if(!id) return;
    const s=getSettings(); const cur = (s.heroStyle && s.heroStyle[id] && s.heroStyle[id].labelColor) || '';
    openPalette({type:'hero', id, current:cur});
    return;
  }

  /* Photo — Admin+Dev OR Director-on-DEV */
  const photoBtn=e.target.closest('[data-act="pickart"]');
  if(photoBtn){
    const host=e.target.closest('[data-hero-id]'); const id=host?.dataset?.heroId; if(!id) return;
    const s=getSettings(); const f=s.heroFlags[id]; if(!f) return;
    if(!((isAdmin() && devModeOn()) || canDirectorDevEdit(f))) return;
    const url = prompt('Image path (under /images ...)', 'images/your-folder/your-image.jpg');
    if(!url) return;
    s.heroAssets[id]={...(s.heroAssets[id]||{}), heroCard:{src:url, crop:{cx:0,cy:0,scale:1}}};
    saveSettings(s); paintPage(); return;
  }

  /* Divider tools — Admin+Dev */
  const divBtn = e.target.closest('[data-div-act]');
  if (divBtn) {
    if (!(isAdmin() && devModeOn())) return;
    const divAct = divBtn.dataset.divAct;
    const id     = divBtn.dataset.divId;
    const s      = getSettings();
    const idx = s.pageOrder.findIndex(it => it.type === 'divider' && it.id === id);
    if (idx < 0) return;

    if (divAct === 'rename') {
      const cur  = s.pageOrder[idx].title || 'Heading';
      const next = prompt('Heading title', cur);
      if (next != null) { s.pageOrder[idx].title = (next.trim() || 'Heading'); saveSettings(s); paintPage(); }
      return;
    }
    if (divAct === 'color') {
      const cur = s.pageOrder[idx].color || '';
      openPalette({type:'divider', id, current:cur});
      return;
    }
    if (divAct === 'up' || divAct === 'down') {
      const dir = (divAct === 'up') ? -1 : 1;
      const to  = Math.min(Math.max(0, idx + dir), s.pageOrder.length - 1);
      if (to !== idx) {
        const obj = s.pageOrder.splice(idx, 1)[0];
        s.pageOrder.splice(to, 0, obj);
        saveSettings(s); paintPage();
      }
      return;
    }
    if (divAct === 'remove') {
      if (confirm('Remove this heading?')) {
        s.pageOrder.splice(idx, 1);
        saveSettings(s); paintPage();
      }
      return;
    }
  }

}, {passive:false});

/* ===== initial ===== */
updateFooterModeControls();

})();</script>
</body>
</html>