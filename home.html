<!DOCTYPE html>
<html lang="en-AU">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="color-scheme" content="dark" />
<title>Home — FAOA</title>

<!-- Link to your external stylesheet -->
<link rel="stylesheet" href="styles.css" />

</head>
<body ontouchstart="">
<div class="bg home-bg" aria-hidden="true"></div>

<header class="nav" role="navigation" aria-label="Primary">
  <div class="nav-left"><span class="title-tab">Courses</span></div>
  <div class="nav-right">
    <button id="avatarTab" class="avatarTab btn ghost" aria-haspopup="dialog" aria-expanded="false">
      <span class="name" id="avatarName">User</span>
      <span class="lvl" id="avatarLvl">Admin</span>
      <span class="dot" id="avatarInitials">•</span>
    </button>
  </div>
</header>

<!-- Config toolbar -->
<div id="cfgbar" class="cfgbar" aria-hidden="true">
  <button class="cfgbtn blue" id="addHeadingBtn" type="button">Add Heading</button>
  <button class="cfgbtn" id="exitCfgBtn" type="button">Exit Developer</button>
</div>

<main class="wrap">
  <section class="grid" id="pageGrid"></section>
</main>

<!-- Avatar Drawer -->
<div id="avatarSheet" role="dialog" aria-modal="true" aria-hidden="true" class="sheet">
  <div class="panel" role="document">
    <nav class="menu-list" id="avatarMenu">
      <a href="avatar/profile.html" data-pop="Profile">Profile<span>›</span></a>
      <a href="avatar/settings.html" data-pop="Settings">Settings<span>›</span></a>
      <a href="avatar/mydata.html" data-pop="My Data">My Data<span>›</span></a>
      <a href="avatar/statistics.html" data-pop="Statistics">Statistics<span>›</span></a>
      <a href="avatar/usersearch.html" data-pop="User Search">User Search<span>›</span></a>
      <!-- Developer/Director toggles removed per your request -->
    </nav>
  </div>
</div>

<!-- Subsheet -->
<div id="subSheet" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="inner" role="document">
    <div class="sheet-head">
      <h2 id="sheetTitle">—</h2>
      <button class="sheet-close" id="sheetClose" aria-label="Close" type="button">×</button>
    </div>
    <iframe id="subFrame" title="Panel"></iframe>
  </div>
</div>

<!-- Mode Footer (repurposed Archive Footer) -->
<div id="archiveDock" class="collapsed" aria-hidden="true">
  <div class="bar">
    <span id="footerLabel">Mode</span>
    <div id="footerControls" aria-label="Footer Controls">
      <!-- Populated by JS based on role -->
    </div>
  </div>
  <!-- Full-screen drawer content (archive list preserved) -->
  <div class="content" aria-hidden="true">
    <div class="drawer-head">
      <strong>Archived</strong>
      <span class="count" id="countArchive">0</span>
      <button class="chip" id="drawerCloseBtn" type="button">Close</button>
    </div>
    <div class="list" id="archiveList"></div>
  </div>
</div>

<script>
(()=>{'use strict';
/* ===== utils & storage ===== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const store={get:(k,f)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):f}catch{return f}},
             set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};
const K={ profile:'ao_profile', settings:'ao_settings', directorMode:'ao_director_mode' };

/* URL reset hook */
const Q=new URLSearchParams(location.search);
if(Q.get('reset')==='1'){ localStorage.removeItem(K.settings); localStorage.removeItem(K.directorMode); }

/* Roles + Director Mode */
function getRole(){ const p=store.get(K.profile,{skill:'admin',displayName:'User'}); return (p.skill||'admin').toLowerCase(); }
function isAdmin(){ return getRole()==='admin'; }
function isDirector(){ return getRole()==='director'; }
function directorMode(){ return !!store.get(K.directorMode,false); }
function seesAll(){ const r=getRole(); return r==='admin' || r==='director' || r==='support'; }

/* Avatar paint */
function paintAvatar(){
  const p=store.get(K.profile,{displayName:'User',skill:'admin'});
  $('#avatarName').textContent = p.displayName || 'User';
  const role=(p.skill||'admin').toLowerCase();
  $('#avatarLvl').textContent = role.charAt(0).toUpperCase()+role.slice(1);
  const map={bronze:'#b87333',silver:'#c0c7d1',gold:'#ffd700',support:'#6a4cff',director:'#333',admin:'#0A84FF'};
  const pill=$('#avatarTab'); pill.style.background= map[role] || '#222';
  pill.style.color = (role==='gold'||role==='silver'||role==='admin') ? '#0b0c10' : '#eef3ff';
}
paintAvatar();

/* Build avatar menu: REMOVE mode toggles */
(function buildAvatarMenu(){
  const menu = $('#avatarMenu');
  // ensure no lingering dev/dir entries; older markup may include
  const cfg = $('#cfgToggle'); if(cfg) cfg.remove();
  const dir = $('#dirToggle'); if(dir) dir.remove();
})();

/* Mark body with admin class & hide config bar initially */
if(isAdmin()){ document.body.classList.add('admin'); }
else{
  document.body.classList.remove('admin','config-on');
  $('#cfgbar').setAttribute('aria-hidden','true');
}

/* Avatar drawer + subsheet */
const avatarBtn=$('#avatarTab'), avatarSheet=$('#avatarSheet');
function openDrawer(){ avatarSheet.classList.add('open'); avatarSheet.setAttribute('aria-hidden','false'); avatarBtn.setAttribute('aria-expanded','true'); }
function closeDrawer(){ avatarSheet.classList.remove('open'); avatarSheet.setAttribute('aria-hidden','true'); avatarBtn.setAttribute('aria-expanded','false'); }
avatarBtn.addEventListener('click', openDrawer, {passive:true});
avatarSheet.addEventListener('click', e=>{ if(e.target===avatarSheet) closeDrawer(); }, {passive:true});

const subSheet=$('#subSheet'), subFrame=$('#subFrame'), sheetTitle=$('#sheetTitle');
function openSubSheet(title,url){
  sheetTitle.textContent=title;
  if(!url){ alert('401 — Not linked yet'); return; }
  subFrame.src=url+(url.includes('?')?'&':'?')+'v='+Date.now();
  subSheet.classList.add('open'); subSheet.setAttribute('aria-hidden','false');
}
function closeSubSheet(){ subSheet.classList.remove('open'); subSheet.setAttribute('aria-hidden','true'); subFrame.src='about:blank'; }
$('#sheetClose').addEventListener('click', closeSubSheet, {passive:true});
subSheet.addEventListener('click', e=>{ if(e.target===subSheet) closeSubSheet(); }, {passive:true});
$$('#avatarSheet [data-pop]').forEach(a=>a.addEventListener('click',e=>{
  e.preventDefault(); closeDrawer(); openSubSheet(a.dataset.pop, a.getAttribute('href'));
}, {passive:false}));

/* ===== settings & flags ===== */
function defaults(){
  const heroFlags={}, pageOrder=[];
  for(let i=1;i<=10;i++){
    const id=`co-${i}`;
    heroFlags[id]={state:'live',place:'page',aud:{bronze:true,silver:true,gold:true}};
    pageOrder.push({type:'hero',id});
  }
  for(let i=11;i<=50;i++){
    const id=`co-${i}`;
    heroFlags[id]={state:'off',place:'archive',aud:{bronze:true,silver:true,gold:true}};
  }
  return { heroFlags, heroLabels:{}, pageOrder, _seeded:true };
}
function sanitize(cfg){
  if(!cfg || typeof cfg!=='object') return defaults();
  cfg.heroFlags=cfg.heroFlags||{};
  cfg.heroLabels=cfg.heroLabels||{};
  cfg.pageOrder=Array.isArray(cfg.pageOrder)?cfg.pageOrder:[];
  for(let i=1;i<=50;i++){
    const id=`co-${i}`;
    if(!cfg.heroFlags[id]) cfg.heroFlags[id]={state:'off',place:i<=10?'page':'archive',aud:{bronze:true,silver:true,gold:true}};
    const onPage = cfg.heroFlags[id].place==='page';
    if(onPage && !cfg.pageOrder.some(it=>it.type==='hero' && it.id===id)) cfg.pageOrder.push({type:'hero',id});
  }
  cfg.pageOrder=cfg.pageOrder.map(it=> it.type==='divider' ? ({aud:{bronze:true,silver:true,gold:true}, ...it}) : it);
  return cfg;
}
function getSettings(){ return sanitize(store.get(K.settings,null) || (store.set(K.settings,defaults()), store.get(K.settings))); }
function saveSettings(s){ store.set(K.settings,sanitize(s)); }

/* SELF-HEAL if empty */
(function repairIfEmpty(){
  const s = store.get(K.settings,null);
  if(!s){ store.set(K.settings, defaults()); return; }
  const cfg = sanitize(s);
  const hasPage = cfg.pageOrder.some(it=> it.type==='hero' && cfg.heroFlags[it.id]?.place==='page');
  const hasArchive = Object.values(cfg.heroFlags).some(f=>f.place==='archive');
  if(!hasPage && !hasArchive){ store.set(K.settings, defaults()); }
  else{ store.set(K.settings, cfg); }
})();

function numberFromId(id){ const m=id.match(/\d+/); return m?m[0]:'?'; }
function labelFor(id){ const s=getSettings(); return s.heroLabels[id] || `#${numberFromId(id)}`; }
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}

/* DOM builders */
function heroCard(id){
  const s=getSettings(); const f=s.heroFlags[id]; if(!f) return null;

  /* completion + hero art */
  const completed = !!(s.heroProgress && s.heroProgress[id] && s.heroProgress[id].complete);
  const art = (s.heroAssets && s.heroAssets[id] && s.heroAssets[id].heroCard) ? s.heroAssets[id].heroCard : null;

  // Permission booleans
  const showMove = isAdmin(); // admin only
  const showLiveAdmin = isAdmin();
  const showLiveDirector = isDirector() && directorMode();
  const showAnyLive = showLiveAdmin || showLiveDirector;
  const showAudience = isAdmin() || (isDirector() && directorMode());

  // Build controls HTML
  let ctrlsHTML = '';
  if(showAnyLive || showMove){
    ctrlsHTML += `<div class="ctrls">`;
    if(showAnyLive){
      const label = f.state==='live'?'Live':'Offline';
      const cls   = f.state==='live'?'badge-live':'badge-off';
      const ro    = showLiveDirector && !showLiveAdmin ? ' disabled aria-disabled="true" ' : '';
      ctrlsHTML += `<button class="chip ${cls}" data-act="toggle" ${ro} type="button">${label}</button>`;
    }
    if(showMove){
      /* rename Move -> Archive */
      const isOnPage = f.place==='page';
      const btnLabel = isOnPage ? 'Archive' : 'Published';
      ctrlsHTML += `<button class="chip" data-act="move" type="button">${btnLabel}</button>`;
    }
    ctrlsHTML += `</div>`;
  }

  const el=document.createElement('article'); el.className='hero'; el.dataset.heroId=id; el.dataset.place=f.place;

  const artLayer = (art && art.src) ? `<div class="art"><img alt="" src="${art.src}"></div>` : '';
  const tick = completed ? `` : ''; // remove visual tick, per latest preference

  el.innerHTML=`
    ${artLayer}
    ${tick}
    <button class="cfg-pin" title="Rename" data-cfg-rename="${id}" type="button">✎</button>
    <div class="hero-arrows">
      <button class="cfg-arrow" data-sort="up" data-key="hero:${id}" type="button">▲</button>
      <button class="cfg-arrow" data-sort="down" data-key="hero:${id}" type="button">▼</button>
    </div>
    <span class="label">${labelFor(id)}</span>
    ${ctrlsHTML}
    <div class="cta-left">
      <button class="btn blue" data-act="enter" type="button">${completed?'Completed':'Start'}</button>
      ${showAudience?`
        <div class="aud-line">
          <button class="aud-chip bronze ${f.aud.bronze?'on':''}" data-aud="bronze" type="button">Bronze</button>
          <button class="aud-chip silver ${f.aud.silver?'on':''}" data-aud="silver" type="button">Silver</button>
          <button class="aud-chip gold   ${f.aud.gold  ?'on':''}" data-aud="gold"   type="button">Gold</button>
        </div>`:''}
    </div>`;

  if(completed) el.classList.add('completed');
  if(art && art.crop){
    const img = el.querySelector('.art img');
    if(img){
      const cx = Number(art.crop.cx||0), cy = Number(art.crop.cy||0), sc = Number(art.crop.scale||1);
      img.style.transform = `translate(calc(-50% + ${cx}px), calc(-50% + ${cy}px)) scale(${sc})`;
    }
  }
  return el;
}

function dividerEl(obj){
  const tools = isAdmin() ? `
    <div class="dctrls">
      <button class="cfgbtn" data-div-act="rename" data-div-id="${obj.id}" type="button">Rename</button>
      <button class="cfgbtn" data-div-act="up" data-div-id="${obj.id}" type="button">▲</button>
      <button class="cfgbtn" data-div-act="down" data-div-id="${obj.id}" type="button">▼</button>
      <button class="cfgbtn" data-div-act="remove" data-div-id="${obj.id}" type="button">Remove</button>
    </div>` : '';

  const audLine = isAdmin() ? `
    <div class="aud-line">
      <button class="aud-chip bronze ${obj.aud?.bronze?'on':''}" data-div-aud="bronze" data-div-id="${obj.id}" type="button">Bronze</button>
      <button class="aud-chip silver ${obj.aud?.silver?'on':''}" data-div-aud="silver" data-div-id="${obj.id}" type="button">Silver</button>
      <button class="aud-chip gold   ${obj.aud?.gold  ?'on':''}" data-div-aud="gold"   data-div-id="${obj.id}" type="button">Gold</button>
    </div>` : '';

  const el=document.createElement('div'); el.className='divider'; el.dataset.type='divider'; el.dataset.divId=obj.id;
  el.innerHTML=`<span class="htext">${obj.title||'Heading'}</span>${tools}${audLine}`;
  return el;
}

/* Paint page respecting visibility */
function paintPage(){
  const grid=$('#pageGrid'); grid.innerHTML='';
  const s=getSettings(); const role=getRole();
  s.pageOrder.forEach(it=>{
    if(it.type==='hero'){
      const id=it.id; const f=s.heroFlags[id]; if(!f || f.place!=='page') return;
      if(!seesAll()){
        if(f.state!=='live') return;
        if(!f.aud[role]) return;
      }
      grid.appendChild(heroCard(id));
    }else if(it.type==='divider'){
      const aud=it.aud || {bronze:true,silver:true,gold:true};
      if(!seesAll()){ if(!aud[role]) return; }
      grid.appendChild(dividerEl(it));
    }
  });
}

/* ===== Mode Footer (repurpose archive dock) ===== */
const dock=$('#archiveDock'), archiveList=$('#archiveList'), countArchive=$('#countArchive');
const footerControls = $('#footerControls');
const footerLabel = $('#footerLabel');

function applyFooterRoleSkin(){
  dock.classList.remove('role-admin','role-director');
  if(isAdmin()) dock.classList.add('role-admin');
  if(isDirector()) dock.classList.add('role-director');
  // Label text on collapsed footer
  footerLabel.textContent = isAdmin() ? 'Developer Mode' : (isDirector() ? 'Director Mode' : 'Mode');
}

function applyFooterVisibility(){
  if(isAdmin() || isDirector()){ dock.style.display='block'; dock.setAttribute('aria-hidden','false'); }
  else{ dock.style.display='none'; dock.setAttribute('aria-hidden','true'); }
}

/* Build footer controls dynamically */
function buildFooterControls(){
  footerControls.innerHTML = '';

  // Mode toggle
  const modeBtn = document.createElement('button');
  modeBtn.className='chip';
  modeBtn.id='modeToggle';
  const modeOn = isAdmin() ? document.body.classList.contains('config-on') : directorMode();
  modeBtn.textContent = (modeOn?'Disable ':'Enable ') + (isAdmin()?'Developer':'Director') + ' Mode';
  modeBtn.addEventListener('click',()=>{
    if(isAdmin()){
      document.body.classList.toggle('config-on');
      $('#cfgbar').setAttribute('aria-hidden', document.body.classList.contains('config-on')?'false':'true');
    }else if(isDirector()){
      store.set(K.directorMode, !directorMode());
    }
    // rebuild text to reflect state
    buildFooterControls();
    paintPage(); paintArchive();
  });

  // View as (audience simulation; does not change stored profile)
  const viewAs = document.createElement('select');
  viewAs.id='viewAsSelect';
  viewAs.className='chip';
  ['learner','bronze','silver','gold','support','director','admin'].forEach(opt=>{
    const o=document.createElement('option'); o.value=opt; o.textContent='View as: '+opt;
    viewAs.appendChild(o);
  });
  // preview: temporarily override seesAll() logic by setting a data attr
  viewAs.addEventListener('change',()=>{
    document.documentElement.setAttribute('data-viewas', viewAs.value);
    paintPage();
  });

  // Add heading
  const addHeading = document.createElement('button');
  addHeading.className='chip';
  addHeading.textContent='Add Heading';
  addHeading.addEventListener('click',()=>{
    if(!isAdmin()) return;
    const title=prompt('Heading title','Section'); if(title==null) return;
    const s=getSettings(); s.pageOrder.push({type:'divider', id:uuidId(), title:title.trim()||'Section', aud:{bronze:true,silver:true,gold:true}});
    saveSettings(s); paintPage();
  });

  // Open Drawer (archive)
  const openDrawerBtn = document.createElement('button');
  openDrawerBtn.className='chip';
  openDrawerBtn.textContent='Open Drawer';
  openDrawerBtn.addEventListener('click', ()=> openArchiveDrawer());

  // Exit Mode (turn off only)
  const exitBtn = document.createElement('button');
  exitBtn.className='chip';
  exitBtn.textContent='Exit Mode';
  exitBtn.addEventListener('click', ()=>{
    if(isAdmin()){
      document.body.classList.remove('config-on');
      $('#cfgbar').setAttribute('aria-hidden','true');
    }
    if(isDirector()){
      store.set(K.directorMode,false);
    }
    buildFooterControls();
    paintPage(); paintArchive();
  });

  footerControls.appendChild(modeBtn);
  footerControls.appendChild(viewAs);
  footerControls.appendChild(addHeading);
  footerControls.appendChild(openDrawerBtn);
  footerControls.appendChild(exitBtn);
}

/* Footer collapse/expand behavior */
function collapseFooter(){
  dock.classList.remove('open','fullsheet','drawer-open');
  dock.classList.add('collapsed');
  $('.content').setAttribute('aria-hidden','true');
}
function expandFooter(){
  dock.classList.remove('collapsed','fullsheet','drawer-open');
  dock.classList.add('open');
}

function openArchiveDrawer(){
  dock.classList.add('drawer-open','fullsheet');
  $('.content').setAttribute('aria-hidden','false');
}
function closeArchiveDrawer(){
  dock.classList.remove('fullsheet','drawer-open');
  $('.content').setAttribute('aria-hidden','true');
}

dock.addEventListener('click',(e)=>{
  // Clicks on the bar toggle between collapsed and open (but do not toggle mode)
  const withinBar = e.target.closest('.bar');
  const withinContent = e.target.closest('.content');
  if(withinBar && !withinContent){
    if(dock.classList.contains('collapsed')) expandFooter();
    // If already open, keep open; controls inside bar handle actions
  }
}, {passive:true});

$('#drawerCloseBtn').addEventListener('click', (e)=>{ e.stopPropagation(); closeArchiveDrawer(); }, {passive:false});

/* Archive list */
function paintArchive(){
  const s=getSettings(); const flags=s.heroFlags;
  archiveList.innerHTML='';
  const items=Object.entries(flags).filter(([id,f])=>f.place==='archive')
    .sort((a,b)=>Number(numberFromId(a[0]))-Number(numberFromId(b[0])));
  countArchive.textContent=items.length;
  items.forEach(([id,f])=>{
    const controls = `
      <div style="display:flex;gap:8px;align-items:center">
        ${(isAdmin()|| (isDirector()&&directorMode()))?`<button class="chip ${f.state==='live'?'badge-live':'badge-off'}" ${isAdmin()?'':'disabled aria-disabled="true"'} data-act="toggle" type="button">${f.state==='live'?'Live':'Offline'}</button>`:''}
        ${isAdmin()?`<button class="chip" data-act="move" type="button">Published</button>`:''}
      </div>`;
    const row=document.createElement('div'); row.className='row'; row.dataset.heroId=id; row.dataset.place='archive';
    row.innerHTML=`<span class="num">${labelFor(id)}</span>${controls}`;
    archiveList.appendChild(row);
  });
}

/* Initial footer state */
applyFooterRoleSkin();
applyFooterVisibility();
buildFooterControls();
collapseFooter();

/* Config toolbar add heading button (still supported here) */
function uuidId(){return 'div_'+Math.random().toString(36).slice(2,9);}
$('#addHeadingBtn').addEventListener('click',()=>{
  if(!isAdmin()) return;
  const title=prompt('Heading title','Section'); if(title==null) return;
  const s=getSettings(); s.pageOrder.push({type:'divider', id:uuidId(), title:title.trim()||'Section', aud:{bronze:true,silver:true,gold:true}});
  saveSettings(s); paintPage();
}, {passive:false});
$('#exitCfgBtn').addEventListener('click',()=>{ document.body.classList.remove('config-on'); $('#cfgbar').setAttribute('aria-hidden','true'); buildFooterControls(); }, {passive:true});

/* Click handlers with confirmations */
document.addEventListener('click',(e)=>{
  // Start (OPEN courses/1–50.html in subsheet)
  if(e.target.closest('[data-act="enter"]')){
    const host=e.target.closest('[data-hero-id]'); const id=host?.dataset?.heroId||'';
    const n = Number(((id||'').match(/\d+/)||[])[0]||0);
    const url = (n>=1 && n<=50) ? `courses/${n}.html` : null;
    openSubSheet(labelFor(id), url); return;
  }
  // Live toggle (Admin only). Directors see read-only chip in Director Mode.
  if(e.target.closest('[data-act="toggle"]')){
    if(!isAdmin()) return;
    const host=e.target.closest('[data-hero-id], .row'); const id=host.dataset.heroId;
    const s=getSettings(); const cur=s.heroFlags[id];
    const next = cur.state==='live' ? 'off' : 'live';
    if(!confirm(`Are you sure you want to set this to ${next==='live'?'LIVE':'OFFLINE'}?`)) return;
    s.heroFlags[id]={...cur, state:next};
    saveSettings(s); paintPage(); paintArchive(); return;
  }
  // Move (page<->archive) — Admin only — label already adjusted in heroCard()
  if(e.target.closest('[data-act="move"]')){
    if(!isAdmin()) return;
    const host=e.target.closest('[data-hero-id], .row');
    const id=host.dataset.heroId; const s=getSettings(); const cur=s.heroFlags[id];
    const dest = (cur.place==='page') ? 'archive' : 'page';
    if(!confirm(`Move ${labelFor(id)} to ${dest==='page'?'Page':'Archive'}?`)) return;
    s.heroFlags[id]={...cur, place:dest};
    if(dest==='page'){ const exists=s.pageOrder.some(it=>it.type==='hero' && it.id===id); if(!exists) s.pageOrder.push({type:'hero',id}); }
    else{ s.pageOrder = s.pageOrder.filter(it=>!(it.type==='hero' && it.id===id)); }
    saveSettings(s); paintPage(); paintArchive(); return;
  }
  // Audience chips on heroes — Admin OR Director (in Director Mode)
  const audBtn=e.target.closest('[data-aud]');
  if(audBtn){
    if(!(isAdmin() || (isDirector() && directorMode()))) return;
    const key=audBtn.getAttribute('data-aud');
    const hero=e.target.closest('[data-hero-id]'); const id=hero.dataset.heroId;
    const s=getSettings(); const cur=s.heroFlags[id]; const nextVal=!cur.aud[key];
    if(!confirm(`${nextVal?'Allow':'Disallow'} ${cap(key)} audience for ${labelFor(id)}?`)) return;
    s.heroFlags[id]={...cur, aud:{...cur.aud, [key]:nextVal}}; saveSettings(s);
    paintPage(); paintArchive(); return;
  }
  // Audience chips on headings — Admin only (and shown in Config)
  if(e.target.dataset.divAud){
    if(!isAdmin()) return;
    const key=e.target.dataset.divAud; const id=e.target.dataset.divId;
    const s=getSettings(); const idx=s.pageOrder.findIndex(it=>it.type==='divider' && it.id===id); if(idx<0) return;
    const cur=s.pageOrder[idx].aud || {bronze:true,silver:true,gold:true}; const nextVal=!cur[key];
    if(!confirm(`${nextVal?'Allow':'Disallow'} ${cap(key)} audience for heading "${s.pageOrder[idx].title||'Heading'}"?`)) return;
    s.pageOrder[idx].aud={...cur,[key]:nextVal}; saveSettings(s); paintPage(); return;
  }
  // Rename hero label — Admin only
  if(e.target.matches('[data-cfg-rename]')){
    if(!isAdmin()) return;
    const id=e.target.getAttribute('data-cfg-rename');
    const s=getSettings(); const cur=s.heroLabels[id] || `#${numberFromId(id)}`;
    const next=prompt('Hero label', cur);
    if(next!=null){ const v=next.trim(); if(v) s.heroLabels[id]=v; else delete s.heroLabels[id]; saveSettings(s); paintPage(); paintArchive(); }
    return;
  }
  // Divider actions (rename / remove / arrows) — Admin only
  if(e.target.dataset.divAct){
    if(!isAdmin()) return;
    const id=e.target.getAttribute('data-div-id'); const s=getSettings();
    const idx=s.pageOrder.findIndex(it=>it.type==='divider' && it.id===id); if(idx<0) return;
    const act=e.target.dataset.divAct;
    if(act==='rename'){
      const next=prompt('Heading title', s.pageOrder[idx].title||'Heading');
      if(next!=null){ s.pageOrder[idx].title=next.trim()||'Heading'; saveSettings(s); paintPage(); }
    }else if(act==='remove'){
      if(confirm('Remove this heading?')){ s.pageOrder.splice(idx,1); saveSettings(s); paintPage(); }
    }else if(act==='up' || act==='down'){
      const to = act==='up' ? Math.max(0, idx-1) : Math.min(s.pageOrder.length-1, idx+1);
      if(to!==idx){ const [it]=s.pageOrder.splice(idx,1); s.pageOrder.splice(to,0,it); saveSettings(s); paintPage(); }
    }
    return;
  }
  // Hero sort arrows — Admin only
  if(e.target.matches('.cfg-arrow')){
    if(!isAdmin()) return;
    const key=e.target.dataset.key; const s=getSettings();
    const keys = s.pageOrder.map(it=> it.type==='hero' ? `hero:${it.id}` : `div:${it.id}`);
    const from = keys.indexOf(key); if(from<0) return;
    const dir = e.target.dataset.sort==='up' ? -1 : 1;
    const to = Math.min(Math.max(0, from+dir), keys.length-1);
    if(to!==from){
      const objFrom = s.pageOrder[from];
      s.pageOrder.splice(from,1);
      s.pageOrder.splice(to,0,objFrom);
      saveSettings(s); paintPage();
    }
    return;
  }
}, {passive:false});

/* Initial render */
applyFooterRoleSkin();
applyFooterVisibility();
buildFooterControls();
paintPage(); paintArchive();

})();
</script>
</body>
</html>